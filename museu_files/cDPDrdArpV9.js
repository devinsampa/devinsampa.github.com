/*1320918526,176820666*/

if (window.CavalryLogger) { CavalryLogger.start_js(["rtITg"]); }

var ChannelRebuildReasons={Unknown:0,AsyncError:1,TooLong:2,Refresh:3,RefreshDelay:4,UIRestart:5,NeedSeq:6,PrevFailed:7,IFrameLoadGiveUp:8,IFrameLoadRetry:9,IFrameLoadRetryWorked:10,PageTransitionRetry:11,IFrameLoadMaxSubdomain:12,NoChannelInfo:13,NoChannelHost:14,ChannelUnknown:100,ChannelNoCUser:101,ChannelInvalidCUser:102,ChannelInvalidChanstr:103,ChannelChDistribTimeout:104,ChannelGetChannelOther:105,ChannelNodeShutdown:106,ChannelTermination:107,ChannelUserMismatch:108,ChannelUserMismatchShady:109,ChannelBadXs:110,ChannelSeqNeg:111,ChannelSeqTooBig:112,ChannelSeqTooSmall:113,ChannelUnexpectedJoin:114,ChannelInvalidXsCookie:115,ChannelRelocate:116,ChannelWrongPartition:117};
var CrossDocument={};(function(){CrossDocument.setListener=function(eventHandler){if(window.postMessage){if(window.addEventListener){window.addEventListener('message',eventHandler,false);}else window.onmessage=eventHandler;}else if(document.postMessage)document.addEventListener('message',eventHandler,false);};CrossDocument.mkPostMessage=function(targetWindow,targetDocument,msgHandler){if(window.postMessage){if("object"==typeof window.postMessage){return function(message,origin){targetWindow.postMessage(message,origin);};}else return bind(targetWindow,targetWindow.postMessage);}else if(document.postMessage){return bind(targetDocument,targetDocument.postMessage);}else return bind(targetWindow,msgHandler);};CrossDocument.targetOrigin=function(parent){if(window.postMessage||document.postMessage){var parentLoc=parent.location;var parentHost=parentLoc.hostname;if(parentHost=='facebook.com'||parentHost.substring(parentHost.length-13)=='.facebook.com')return parentLoc.protocol+'//'+parentLoc.host;}else return null;};var _handleMessage=function(msgCallback,msgStr){if(!msgStr||msgStr.charAt(0)!='{')return;var msg=eval('('+msgStr+')');return msgCallback(msg);};CrossDocument.mkEventHandler=function(msgCallback){return function(event){event=event||window.event;var domain=(event.domain||event.origin);if(domain.substring(domain.length-13)!='.facebook.com'&&domain.substring(domain.length-15)!='://facebook.com'&&domain!='facebook.com')return;return _handleMessage(msgCallback,event.data);};};CrossDocument.mkMessageHandler=function(msgCallback){return function(msgStr){return _handleMessage(msgCallback,msgStr);};};})();
Dcode=function(){var a,d={},b={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};function c(){var f=[];for(var e in b){d[b[e]]=e;f.push(b[e]);}f.reverse();a=new RegExp(f.join("|"),'g');}return {encode:function(e){c();return encodeURIComponent(e).replace(/([_A-Z])|%../g,function(g,f){return f?'%'+f.charCodeAt(0).toString(16):g;}).toLowerCase().replace(a,function(f){return d[f];});},decode:function(e){return decodeURIComponent(e.replace(/[_A-Z]/g,function(f){return b[f];}));}};}();
Dcode_deprecated=function(){var a,d={},b={_:'%',A:'%22%3a',B:'%2c%22',C:'%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',D:'%7b%22',E:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a',F:'ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',G:'%2c%22ch%22%3a%7b%22h%22%3a%22channel',H:'%22%2c%22p%22%3a80%2c%22sub%22%3a%5b',I:'%7d%7d',J:'%7b%22v%22%3a2%2c%22time%22%3a1',K:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a1%2c%22ts%22%3a1',L:'%5d%2c%22p%5f',M:'%22%3a0%2c%22',N:'%22%3a%7b%22i%22%3a0%2c%22all%46lids%22%3a%5bnull%5d',O:'0000',P:'%22%3a1',Q:'%7d',R:'%2c%22pt%22%3a0%2c%22vis%22%3a0%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a0%2c%22ct%22%3a0%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c2bl%22%3a%7b%22ac%22%3a0%2c%22ut',S:'%22%3a%7b%22ol%22%3a%2d1%2c%22exp%22%3a1',T:'fl%22%3a%5b%22%2d1%22%5d%2c%22all%46lids%22%3a%5b%22%2d1%22%5d',U:'ud%22%3a900%2c%22lc%22%3a0%2c%22cvr%22%3a%7b',V:'%2c%22ut%22%3a1',W:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls',X:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a0%2e',Y:'%22%3a%7b%22n%22%3a%22%',Z:'%2c%22ud%22%3a'};function c(){var f=[];for(var e in b){d[b[e]]=e;f.push(b[e]);}f.reverse();a=new RegExp(f.join("|"),'g');}return {encode:function(e){c();return encodeURIComponent(e).replace(/([_A-Z])|%../g,function(g,f){return f?'%'+f.charCodeAt(0).toString(16):g;}).toLowerCase().replace(a,function(f){return d[f];});},decode:function(e){return decodeURIComponent(e.replace(/[_A-Z]/g,function(f){return b[f];}));}};}();
function CookieManager(b,a){this.version=b;this.cookieName='presence';this.dictEncode=a;this.storers={};Arbiter.inform('presence-cookie-manager/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);}CookieManager.prototype={register:function(b,a){this.storers[b]=a;},store:function(){var a=this._getCookie();if(a&&a.v&&this.version<a.v){presence.versionShutdown();return;}var b={v:this.version,time:parseInt(presence.getTime()*.001)};for(var d in this.storers)b[d]=this.storers[d]();var c=JSON.stringify(b);if(this.dictEncode)c='E'+Dcode.encode(c);if(presence.hasUserCookie(false))setCookie(this.cookieName,c,null);},clear:function(){clearCookie(this.cookieName);},_getCookie:function(){try{var data=getCookie(this.cookieName);if(this.lastD===data){return this.lastV;}else{this.lastD=data;this.lastV=null;}if(data&&data.charAt(0)=='E'){data=Dcode.decode(data.substring(1));}else if(data&&data.charAt(0)=='D')data=Dcode_deprecated.decode(data.substring(1));if(data){this.lastV=JSON.parse(data);return this.lastV;}}catch(a){}return null;},getSubCookie:function(b){var a=this._getCookie();if(!a)return null;return a[b];},setCheckUserCookie:function(a){this.requireUserCookie=a;}};
var ChatUserInfos=window.ChatUserInfos||{};function getUserInfo(a){return window.ChatUserInfos[a]&&copy_properties({},window.ChatUserInfos[a]);}function setUserInfo(a,b){var c=window.ChatUserInfos[a];if(c&&(c.name!=b.name||c.firstName!=b.firstName||c.thumbSrc!=b.thumbSrc))JSLogger.create('user_infos').warn('changed',{oldInfo:c,newInfo:b});window.ChatUserInfos[a]=copy_properties({},b);}
var ChatConfig=window.ChatConfig||(function(){var a={};var b=false;require.ensure(['ChatConfigInitialData'],function(c){ChatConfig.set(c);});return {get:function(d,c){return d in a?a[d]:c;},set:function(c){if(arguments.length>1){var d={};d[c]=arguments[1];c=d;}else if(!b){define('ChatConfig',[],window.ChatConfig);b=true;}copy_properties(a,c);},getDebugInfo:function(){return a;}};})();
__d("presence-arbiter-message",[],function(b,c,d,a){b.PresenceMessage=c.exports={STARTED:'presence/started',SHUTDOWN:'presence/shutdown',RESTARTED:'presence/restarted',WINDOW_RESIZED:'presence/window-resized',TAB_CLOSED:'presence/tab-closed',TAB_OPENED:'presence/tab-opened',PRESENCE_UPDATER_READY:'presence/updater-ready',getAppMessageType:function(e,f){return 'presence/app_message:'+e+':'+f;},getArbiterMessageType:function(e){return 'presence/message:'+e;}};},3);
var PresencePrivacy=window.PresencePrivacy||(function(){var a='/ajax/chat/privacy/settings.php';var b='/ajax/chat/privacy/online_policy.php';var c='/ajax/chat/privacy/visibility.php';var j={};var u;var l={};var m;var i;var k;var r=[];var p=false;function d(){return Chat.getLogger('blackbird');}function g(v,w){if(v==Env.user)return;switch(w){case PresencePrivacy.WHITELISTED:case PresencePrivacy.BLACKLISTED:case PresencePrivacy.UNLISTED:break;default:return;}j[v]=w;PresencePrivacy.inform('privacy-changed');}function h(v){switch(v){case PresencePrivacy.ONLINE:case PresencePrivacy.OFFLINE:break;default:return;}u=v;PresencePrivacy.inform('privacy-changed');PresencePrivacy.inform('privacy-user-presence-changed');Arbiter.inform('chat/visibility-changed',{sender:this});}function f(v){switch(v){case PresencePrivacy.ONLINE_TO_WHITELIST:case PresencePrivacy.ONLINE_TO_BLACKLIST:break;default:return;}i=v;PresencePrivacy.inform('privacy-user-presence-changed');PresencePrivacy.inform('privacy-changed');}function s(w,v){r.push({uri:w,data:v});if(!p){next=r.shift();t(next.uri,next.data);}}function t(w,v){p=true;v.window_id=presence.getWindowID();new AsyncRequest().setURI(w).setData(v).setHandler(q.bind(this,w,v)).setErrorHandler(n.bind(this,v)).setTransportErrorHandler(n.bind(this,v)).setFinallyHandler(o.bind(this)).setAllowCrossPageTransition(true).send();}function q(x,v,w){if(x===a){var z=w.payload.user_availabilities;PresencePrivacy.inform('privacy-availability-changed',{user_availabilities:z});for(var y in z)l[y]=v.setting;}else{if(x===c){m=v.visibility;}else if(x===b)k=v.online_policy;PresencePrivacy.inform('privacy-user-presence-response');}d().log('set_update_response',{data:v,response:w});}function n(v,x){var w=false;if(u!==m){u=m;w=true;}if(i!==k){i=k;w=true;}if(w)PresencePrivacy.inform('privacy-user-presence-changed');copy_properties(j,l);r=[];d().log('set_error_response',{data:v,response:x});}function o(v){p=false;if(r.length>0){next=r.shift();t(next.uri,next.data);}}function e(y,v){var x=v.obj;if(x.window_id===presence.getWindowID())return;var w=x.data;if(x.event=='access_control_entry'){g(w.target_id,w.setting);l[w.target_id]=w.setting;}else{if(x.event=='visibility_update'){var z=!!w.visibility?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;h(z);m=z;}else if(x.event=='online_policy_update'){f(w.online_policy);k=w.online_policy;}PresencePrivacy.inform('privacy-user-presence-response');}d().log('channel_message_received',{data:v.obj});}return copy_properties(new Arbiter(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(x,v,w){u=m=x;i=k=v;j=copy_properties({},w);l=copy_properties({},w);p=false;this.inform('initialized',this,Arbiter.BEHAVIOR_PERSISTENT);this.inform('privacy-changed');this.inform('privacy-user-presence-changed');d().log('initialized',{visibility:x,policy:v});Arbiter.subscribe(PresenceMessage.getArbiterMessageType('privacy_changed'),e.bind(this));Arbiter.subscribe(window.channel.ON_CONFIG,function(z,y){var za=y.getConfig('visibility')?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;h(za);d().log('config_visibility',{vis:za});}.bind(this));Arbiter.subscribe('channel/visibility-config',function(y,z){var za=z?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;if(za!=u){h(za);d().log('config_visibility_old_channel',{vis:za});}}.bind(this));},setVisibility:function(w){m=u;h(w);var v={visibility:w};s(c,v);d().log('set_visibility',{data:v});return w;},getVisibility:function(){return u;},setDefaultOnlinePolicy:function(w){k=i;f(w);var v={online_policy:w};s(b,v);d().log('set_online_policy',{data:v});return w;},getDefaultOnlinePolicy:function(){return i;},getFriendVisibility:function(v){return j[v]||PresencePrivacy.UNLISTED;},allows:function(v){if(this.getVisibility()===PresencePrivacy.OFFLINE)return false;var w=this.getDefaultOnlinePolicy();return w===PresencePrivacy.ONLINE_TO_WHITELIST?j[v]==PresencePrivacy.WHITELISTED:j[v]!=PresencePrivacy.BLACKLISTED;},setFriendVisibility:function(y,z){if(y.length>0){for(var w=0;w<y.length;w++){var x=y[w];l[x]=j[x];g(x,z);}var v={users:y,setting:z};s(a,v);d().log('set_friend_visibility',{data:v});}return z;},allow:function(v){var w=this.getDefaultOnlinePolicy()===PresencePrivacy.ONLINE_TO_WHITELIST?PresencePrivacy.WHITELISTED:PresencePrivacy.UNLISTED;return this.setFriendVisibility([v],w);},disallow:function(v){var w=this.getDefaultOnlinePolicy()===PresencePrivacy.ONLINE_TO_BLACKLIST?PresencePrivacy.BLACKLISTED:PresencePrivacy.UNLISTED;return this.setFriendVisibility([v],w);},getBlacklist:function(){var w=[];for(var v in j)if(j[v]===PresencePrivacy.BLACKLISTED)w.push(v);return w;},getWhitelist:function(){var w=[];for(var v in j)if(j[v]===PresencePrivacy.WHITELISTED)w.push(v);return w;},getMapForTest:function(){return j;},setMapForTest:function(v){j=v;}});})();
var AvailableList=window.AvailableList||(function(){var b=5;var e=60000;var f='/ajax/chat/buddy_list.php';var d=5000;var c=1800000;var a=.005;var zg=0;var zn=false;var y=0;var zf=false;var zd=null;var u=null;var k=null;var t=0;var s=0;var j=null;var ze={};var r=false;var zb={};var zc={};var x={};var l=null;var v={'0':2,'1':1,'-1':0,'2':3};var zh={0:-1,1:1,2:0,3:2};function o(){return Chat.isOnline()?(zn?zd:u):null;}function h(zp,zt,zq,zs){if(zp==Env.user)return;switch(zt){case AvailableList.OFFLINE:case AvailableList.IDLE:case AvailableList.ACTIVE:case AvailableList.MOBILE:break;default:return;}var zr=AvailableList.get(zp)!=zt;if(zq){zb[zp]=zt;zc[zp]=zs||(presence.getTime()+e);delete ze[zp];}else ze[zp]=zt;if(zr){zg++;if(!k)k=zi.defer();}}function w(zq,zr,zp){l({observer:presence.user,observee:zq,status:zr,latency:zp});}function zk(zp){j=zp;Arbiter.inform('buddylist/count-changed',zp);}function zl(zp){s=new Date();x=Object.from(zp);}function zj(zs){if(presence.isShutdown||!Chat.isOnline()){AvailableList._poller.stop();return;}t=new Date();var zq=false;if(new Date()-s>c)zq=true;zf=true;var zp=[];for(var zr in ChatUserInfos)zp.push(zr);zs.setHandler(za).setErrorHandler(z).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:Env.user,available_user_info_ids:zp,force_render:true,fetch_mobile:zq}).setURI(f).setAllowCrossPageTransition(true);}function za(zt){var zs=zt.getPayload();var zp=zs.buddy_list;if(!zp){z(zt);return;}presence.updateServerTime(zs.time);AvailableList.updateTime=presence.getTime();y=0;zf=false;if(zp.forcedRender)AvailableList.haveFullList=true;if(zp.availableCount!=null)zk(zp.availableCount);if(zp.mobile_friends!=null)zl(zp.mobile_friends);var zv=zp.userInfos;if(zv)for(var zq in zv)setUserInfo(zq,zv[zq]);var zr=zp.nowAvailableList;var zw=zp.wasAvailableIDs;for(var zu in ze)if(AvailableList.get(zu)!==AvailableList.OFFLINE)zw.push(zu);if(zw){zw.forEach(function(zx){if(!(zr&&(zx in zr))&&(ze[zx]!=AvailableList.OFFLINE)&&((zx in zb)&&(zb[zx]==AvailableList.OFFLINE)))w(zx,AvailableList.OFFLINE,presence.getTime()+e-zc[zx]);ze[zx]=AvailableList.OFFLINE;});zi.defer();}r=zp.userIsIdle;zr&&AvailableList.addLegacyAvailableList(zr);if(zp.newAvailableList){AvailableList.presenceData=zp.newAvailableList;AvailableList.haveFullList=true;}zo();presenceCookieManager.store();}function z(zp){if(presence.checkMaintenanceError(zp))return;y++;zf=false;if(y>=b){zk(0);Arbiter.inform('buddylist/update-error');}}function n(){var zp={};AvailableList.getAvailableIDs().forEach(function(zq){zp[zq]={i:AvailableList.isIdle(zq)?1:0};});return zp;}function zo(){if(AvailableList.haveFullList)Arbiter.inform('buddylist/updated');}function zi(){k=null;if(AvailableList.haveFullList)zk(AvailableList.getAvailableIDs().length);Arbiter.inform('buddylist/availability-changed');}function i(zp,zr){for(var zq in zp){var zt;var zs;if(zr){zt=v[zp[zq].ol];zs=zp[zq].exp;}else if(!zp[zq]){zt=AvailableList.OFFLINE;}else if(zp[zq].i){zt=AvailableList.IDLE;}else if(zp[zq].m){zt=AvailableList.MOBILE;}else zt=AvailableList.ACTIVE;h(zq,zt,zr,zs);}}function q(){zm();if(Chat.isOnline()){AvailableList.update();}else g();}function g(){AvailableList.haveFullList=false;t=0;s=0;j=null;ze={};zb={};zc={};x={};zg++;zi();}function zm(){AvailableList._poller&&AvailableList._poller.setTimePeriod(o());}function m(){var zp={};Chat.getActiveFriendChats().forEach(function(zt){var zs=AvailableList.get(zt);if(zs)zp[zt]={i:zs==AvailableList.IDLE?1:0,m:zs==AvailableList.MOBILE?1:0};});var zq={ac:j,ut:parseInt(AvailableList.updateTime*.001,10),ud:zd*.001};var zr=AvailableList.getLegacyOverlay();if(!is_empty(zr))zq.uo=zr;if(!is_empty(zp))zq.al=zp;return zq;}function p(zq,zp){zp.chat_config=ChatConfig.getDebugInfo();zp.available_list_debug_info={};AvailableList.getAvailableIDs().forEach(function(zr){zp.available_list_debug_info[zr]=AvailableList.getDebugInfo(zr);});}return {OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,haveFullList:false,init:function(zw,zr,zv,zu,zs,zp,zq,zt){l=EagleEye.createLogger('presence-status',presence.sitevars.BUDDY_STATUS_LOG_FRAC||a);AvailableList.updateTime=zw;AvailableList.haveFullList=zr;if(zr&&zt)zl(zt);i(zv,true);AvailableList.addLegacyAvailableList(zp);zd=zu;u=zs;AvailableList._poller=new Poller(o(),zj,true);Arbiter.subscribe('chat-options/initialized',zm);zk(zq);Arbiter.subscribe(JSLogger.DUMP_EVENT,p);Arbiter.subscribe('presence/restarted',AvailableList.update);Arbiter.subscribe('presence-cookie-manager/initialized',function(zx,zy){zy.register('bl',m);});if(ChatConfig.get('blackbird')){PresencePrivacy.subscribe('privacy-changed',zi);PresencePrivacy.subscribe('privacy-availability-changed',function(zy,zx){for(var zz in zx.user_availabilities)this.set(zz,zx.user_availabilities[zz]);}.bind(this));PresencePrivacy.subscribe('privacy-user-presence-response',AvailableList.update);}else Arbiter.subscribe('chat/visibility-changed',q);if(AvailableList.haveFullList){t=new Date();}else if(zn)AvailableList.update();Arbiter.inform('available-list/initialized',AvailableList,Arbiter.BEHAVIOR_PERSISTENT);},get:function(zp){if(zp==Env.user)return AvailableList.ACTIVE;var zq=AvailableList.OFFLINE;if(zp in zb&&(presence.getTime()<zc[zp]||!(zp in ze))){zq=zb[zp];}else if(zp in ze)zq=ze[zp];if(ChatConfig.get('blackbird')&&!PresencePrivacy.allows(zp))zq=AvailableList.OFFLINE;if(zq==AvailableList.OFFLINE)if(x[zp])zq=AvailableList.MOBILE;return zq;},isUserIdle:function(){return r;},isReady:function(){return AvailableList.haveFullList;},set:function(zp,zq){h(zp,zq,true);window.presence&&presence.doSync();},update:function(){if(new Date()-t<d){!zf&&zo.defer();return;}zn=true;zm();AvailableList._poller&&AvailableList._poller.requestNow();},getRev:function(){return zg;},isIdle:function(zp){return AvailableList.get(zp)==AvailableList.IDLE;},getCount:function(){return j;},getAvailableIDs:function(){var zp,zq=[];for(zp in ze)if(AvailableList.get(zp)!==AvailableList.OFFLINE)zq.push(zp);for(zp in zb){if(zp in ze)continue;if(AvailableList.get(zp)!==AvailableList.OFFLINE)zq.push(zp);}for(zp in x){if(zp in ze||zp in zb)continue;zq.push(zp);}return zq;},getLegacyOverlay:function(){var zq={};for(var zp in zb)if(zc[zp]>presence.getTime())zq[zp]={exp:zc[zp],ol:zh[zb[zp]]};return zq;},addLegacyOverlay:function(zp){i(zp,true);window.presence&&presence.doSync();},addLegacyAvailableList:function(zp){i(zp,false);},getDebugInfo:function(zp){var zq;if(ChatUserInfos[zp])zq=ChatUserInfos[zp].name;return {id:zp,presence:ze[zp],overlay:zb[zp],overlayTime:zc[zp],mobile:x[zp],name:zq};}};})();
if(!window.Chat){var Chat={openTab:function(a,b,d,c){if(window.External&&External.Chat&&External.Chat.openWindow)External.Chat.openWindow(a);this._trackOpenTabClick(a,c);Chat._withComponent('chatDisplay',function(e){e.focusTab(a,true,b,b,d);});},_trackOpenTabClick:function(b,c){if(c&&c=='ordered_list'||c=='more_online_friends'||c=='online_friends'||c=='typeahead'){var a={target:b,source:c};new AsyncSignal('/ajax/chat/ct.php',a).send();}},openMultichatTab:function(d,b,a,e,f,c){Chat._withComponent('chatDisplay',function(g){g.createMultichatTab(d,b,a,e,f,true,c);});},loadTabFragile:function(b,c,a,d){Chat._withComponent('chatDisplay',function(e){e.loadTabFragile(b,c,a,d);});},openBuddyList:function(){Chat._withComponent('buddyListNub',function(a){a.show();});},closeBuddyList:function(){Chat._withComponent('buddyListNub',function(a){a.hide();});},toggleSidebar:function(){Chat._withComponent('sidebar',function(a){a.toggle();});},goOnline:function(a){if(ChatConfig.get('blackbird')){PresencePrivacy.subscribe('initialized',function(){if(PresencePrivacy.getVisibility()===PresencePrivacy.OFFLINE){Chat.getLogger('blackbird').log('chat_go_online');PresencePrivacy.setVisibility(PresencePrivacy.ONLINE);}a&&a();});return;}Arbiter.subscribe('chat-options/initialized',function(event,b){if(Chat.isOnline()){a&&a();}else{if(a)var c=Arbiter.subscribe('chat/visibility-changed',function(){Arbiter.unsubscribe(c);a();});b.sendVisibility(true);}});},isOnline:function(){if(ChatConfig.get('blackbird'))return PresencePrivacy&&PresencePrivacy.getVisibility()===PresencePrivacy.ONLINE;return window.chatOptions&&chatOptions.visibility;},squelchTab:function(a,b){Chat._withComponent('chatDisplay',function(c){c.setSquelchedTab(a,true);c.closeTab(a);});},unsquelchTab:function(a){Chat._withComponent('chatDisplay',function(b){b.setSquelchedTab(a,false);});},getActiveChats:function(){if(!window.chatDisplay)return [];return keys(chatDisplay.tabs);},hasFocusedChat:function(){return chatDisplay.hasFocusedTab();},getActiveFriendChats:function(){var a=this.getActiveChats();return a.filter(function(b){return chatDisplay.tabs[b]&&chatDisplay.tabs[b].getPostType()=='friend';});},getLogger:function(a){var b=window.channel_manager||window.channelManager;if(b&&b.getLogger)return b.getLogger(a);return JSLogger.create(a);},_componentInitEvents:{chatDisplay:'chat-display/loaded',buddyListDisplay:'buddylist-display/initialized',buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'},_withComponent:function(b,a){Arbiter.subscribe(Chat._componentInitEvents[b],function(event,c){a(c);});}};copy_properties(Chat,{updateUserInfo:bagofholding,setUserInfo:bagofholding});}
(function(){window.ChannelManager=function(b,e,d,a,c){this.user=e;this.iframeLoadMaxRetries=1;this.iframeLoadMaxSubdomain=6;this.expectResponseTimeout=5000;this.retryInterval=d;this.channelConfig=a;this._init(b,c);Arbiter.subscribe(JSLogger.DUMP_EVENT,function(event,f){f.transportVersion=1;});};ChannelManager.CONN_LOG_INTERVAL=10000;ChannelManager.prototype={_init:function(c,e){this.channelManagerId=rand32();this.config={};this.channel={};this.isActionRequest=true;this.isReady=false;this.isRebuilding=false;this.iframeIsLoaded=false;this.iframeEverLoaded=false;this.iframeCheckFailedCount=0;this.shouldClearSubdomain=false;this.subframe=c;Event.listen(this.subframe,'load',this._iframeLoadCheck.bind(this));this.postMessage=null;var a=presenceCookieManager.getSubCookie('ch');if(e){this.iframeSubdomain=null;}else{this.iframeSubdomain=0;if(a&&a.sub){for(var b=0;b<a.sub.length;b++)if(!a.sub[b]){this.iframeSubdomain=b;break;}if(b==a.sub.length)if(b==this.iframeLoadMaxSubdomain&&URI().isSecure()){this.iframeSubdomain=null;this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadMaxSubdomain);}else this.iframeSubdomain=a.sub.length;}}this.handleIframeEvent=CrossDocument.mkEventHandler(this._handleIframeMessage.bind(this));this.handleIframeMessage=CrossDocument.mkMessageHandler(this._handleIframeMessage.bind(this));CrossDocument.setListener(this.handleIframeEvent.bind(this));presenceCookieManager.register('ch',this._getCookieInfo.bind(this));if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',this._onUnload.bind(this));Event.listen(window,'pageshow',this.rebuild.bind(this,ChannelRebuildReasons.Refresh));}else onunloadRegister(this._onUnload.bind(this));this._connLogger=EagleEye.createLogger('channel-connectivity',this.getConfig('CONNECTIVITY_SAMPLING',.01));this._connTime=Env.start;this._connT=2000;this._connectivity={};(this._connSample=this._connSample.bind(this))();(this._connLog=this._connLog.bind(this))();var d=0;UserActivity.subscribe(function(){if(new Date()-d>3000){d=new Date();this.setActionRequest(true);}}.bind(this));},_connSample:function(){var a=new Date(),b=this._connState||'idle';var c=a-this._connTime;this._connAdd(b,c);this._connTime=a;setTimeout(this._connSample,1000*(1+Math.random()),false);},_connAdd:function(a,b){this._connectivity[a]=(this._connectivity[a]||0)+b;},_connLog:function(){this._connLogger(this._connectivity);this._connectivity={};this._connT=Math.min(60000,2*this._connT);setTimeout(this._connLog,this._connT,false);},sendIframeMessage:function(b){if(!this.postMessage)return;var c=JSON.stringify(b);try{this.postMessage(c,this.targetOrigin);}catch(a){this.getLogger().error('iframe_msg_error',a);}},_handleIframeMessage:function(h){var g=this.channel.currentSeq;var c={old_seq:g};if('seq' in h){c.new_seq=h.seq;c.seq_gap=h.seq-g;this.channel.currentSeq=h.seq;presence.doSync();}switch(h.t){case 'init':this._connState=null;this.iframeLoaded();break;case 'log':break;case 'reconnect':if(window.loaded){this.getLogger().error('refresh_'+h.reason);this.rebuild(h.reason);this.channel.shutdownHandler(true);}break;case 'connectivity':delete h.t;if('state' in h){this._connState=h.state;delete h.state;}for(var f in h)this._connAdd(f,h[f]);break;case 'fullReload':this.getLogger().error('full_reload',c);presenceCookieManager.clear();Arbiter.inform('channel/invalid_history');break;case 'msg':var a=this.channel;if(h.msgs){var i=h.msgs;var j=0;for(var e=0;e<i.length;e++)if(i[e].seq!==-1)j++;var k=a.currentSeq-j;for(var e=0;e<i.length;e++){if(k>=g){var b=i[e].msg;try{a.msgHandler(a.name,b);}catch(d){this.getLogger().error('msg_handling_error',d);}}if(i[e].seq!==-1)k++;}}else{var i=h.ms;var k=a.currentSeq-i.length;for(var e=0;e<i.length;e++,k++)if(k>=g){var b=i[e];try{a.msgHandler(a.name,b);}catch(d){this.getLogger().error('msg_handling_error',d);}}}break;default:this.getLogger().error('unknown_msg_type',{type:h.t});presence.permaShutdown();this.stop();break;}},_onUnload:function(){this.shouldClearSubdomain=true;presence.doSync(true);},addChannel:function(a,d,b,f,e,c){if(this.channel.name){this.getLogger().error('addchannel_called_twice');return;}this.channel={name:a,currentSeq:d,msgHandler:b,startHandler:f,shutdownHandler:e,restartHandler:c};presence.doSync();},_getCookieInfo:function(){var b={};if(this.config.host){b.h=this.config.host;if(this.config.port)b.p=this.config.port;if(null!==this.iframeSubdomain){var a=presenceCookieManager.getSubCookie('ch');var e=(a&&a.sub)?a.sub:[];var d=e.length;if(this.shouldClearSubdomain){e[this.iframeSubdomain]=0;}else{e[this.iframeSubdomain]=1;for(var c=d;c<=this.iframeSubdomain;c++)if(!e[c])e[c]=0;}b.sub=e;}b[this.channel.name]=this.channel.currentSeq;}b.ri=this.retryInterval;return b;},getConfig:function(c,b){var a=this.channelConfig;return a&&(c in a)?a[c]:b;},stop:function(){this.stopped=true;this.setReady(false);},setReady:function(a){this.isReady=a;var b={type:'isReady',isReady:a,isActionRequest:this.isActionRequest};if(a&&this.isActionRequest)this.isActionRequest=false;if(a){b.channelName=this.channel.name;b.currentSeq=this.channel.currentSeq;b.channelManagerId=this.channelManagerId;b.channelConfig=this.channelConfig;}this.sendIframeMessage(b);},setActionRequest:function(a){this.sendIframeMessage({type:'isActionRequest',isActionRequest:a});},expectResponse:function(){this.sendIframeMessage({type:'expectResponse',newTimeout:this.expectResponseTimeout});},_iframeUrl:function(a,c,b){var d;if(null===this.iframeSubdomain){d='';}else{d=this.iframeSubdomain;d+=URI().isSecure()?'-':'.';}return new URI().setDomain(d+a+'.facebook.com').setPort(c).setPath(b).setSecure(URI().isSecure()).toString();},iframeGetJS:function(){this.getLogger().log('iframe_resources');return this.config.resources;},getLogger:function(a){a=a||'channel0';return JSLogger.create(a);},iframeLoad:function(a,c){this.isReady=c;this.iframeIsLoaded=false;this.config=a;var e=this._iframeUrl(a.host,a.port,a.path);clearTimeout(this._checkTimer);this._checkTimer=this._iframeCheck.bind(this).defer(this.getConfig('IFRAME_LOAD_TIMEOUT',30000),false);var d=null;window.onchanneliframeready=this.iframeGetJS.bind(this);if(!ua.ie()||ua.ie()<8)try{d=this.subframe.contentDocument;}catch(b){}if(d){try{d.location.replace(e);}catch(b){this.getLogger().error('error_setting_location',b);}}else if(this.subframe.contentWindow){this.subframe.src=e;}else if(this.subframe.document){this.subframe.src=e;}else this.getLogger().error('error_setting_subframe_url');this.getLogger().debug('iframe_location',{url:e});},_iframeLoadCheck:function(){try{this.subframe.contentWindow.document.body.innerHTML;}catch(a){this.getLogger().error('iframe_load_check_error',{count:this.iframeCheckFailedCount,error:a.toString()});}},iframeLoaded:function(){if(!this.iframeIsLoaded){this.iframeIsLoaded=true;this.postMessage=CrossDocument.mkPostMessage(this.subframe.contentWindow,this.subframe.contentDocument,this.subframe.contentWindow.channelUplink.handleParentMessage);this.targetOrigin='*';this.setReady(this.isReady);if(this.iframeCheckFailedCount){this.channel.restartHandler(false);this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadRetryWorked);}else this.channel.startHandler();this.iframeCheckFailedCount=0;this.iframeEverLoaded=true;}},_iframeCheck:function(){delete this._checkTimer;if(!this.iframeIsLoaded){this.iframeCheckFailedCount++;var a=this.config;this.config={};presenceCookieManager.store();if(this.iframeCheckFailedCount<=this.iframeLoadMaxRetries){this.rebuild(ChannelRebuildReasons.IFrameLoadRetry);}else{this.channel.shutdownHandler();this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadGiveUp);}}else this.retryInterval=0;},_sendDummyReconnect:function(b){var a=new AsyncRequest().setURI('/ajax/presence/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);a.specifiesWriteRequiredParams()&&a.send();},_rebuildResponse:function(c){var b=c.getPayload();if(!b.user_channel){this.getLogger().error('invalid_channel_name',{name:this.channel.name});presence.permaShutdown();this.stop();return;}var a=b.user_channel;this.getLogger().debug('rebuild_response',{channel:a,seq:b.seq,host:b.host,port:b.port});this.channel.currentSeq=b.seq;this.isRebuilding=false;if(b.path!=this.config.path||b.host!=this.config.host){this.iframeLoad(b,true);}else this.setReady(true);presenceCookieManager.store();Arbiter.inform('channel/visibility-config',b.visibility);this.channel.restartHandler(true);},_retryRebuild:function(c,a){var d=this.getConfig('MAX_RETRY_INTERVAL',60000);var e=this.getConfig('MIN_RETRY_INTERVAL',10000);if(a){this.retryInterval=d;}else if(this.retryInterval==0){this.retryInterval=e;}else this.retryInterval=Math.min(d,this.retryInterval*2);var b=this.retryInterval*(.75+Math.random()*.5)|0;this.getLogger().warn('manager_retrying',{delay:b});setTimeout(this._rebuildSend.bind(this,c),this.retryInterval,false);},_rebuildError:function(a,b){this.channel.shutdownHandler(true);this.getLogger().error('rebuild_error',{error:b.getErrorDescription()});if(presence.checkMaintenanceError(b)){this.getLogger().warn('mgr_maint_check_giveup');}else if(presence.checkLoginError(b)){if(presence.inPopoutWindow){this._retryRebuild(ChannelRebuildReasons.PrevFailed,true);}else this.getLogger().warn('mgr_login_check_giveup');}else this._retryRebuild(ChannelRebuildReasons.PrevFailed,false);},_rebuildTransportError:function(a,b){this.channel.shutdownHandler(true);this.getLogger().error('rebuild_transport_error',{error:b.getErrorDescription()});this._retryRebuild(a,false);},_rebuildSend:function(b){if(!presence.hasUserCookie(true))return;if(typeof b!='number')b=ChannelRebuildReasons.Unknown;this.getLogger().debug('sending_rebuild');var a=new AsyncRequest().setURI('/ajax/presence/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setHandler(this._rebuildResponse.bind(this)).setErrorHandler(this._rebuildError.bind(this,b)).setTransportErrorHandler(this._rebuildTransportError.bind(this,b)).setOption('suppressErrorAlerts',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);return a.specifiesWriteRequiredParams()&&a.send();},rebuild:function(a){if(this.stopped)return;if(this.isRebuilding){this.getLogger().debug('already_rebuilding');return;}this.setReady(false);this.isRebuilding=true;this.getLogger().debug('rebuilding');if(a==ChannelRebuildReasons.RefreshDelay)this.retryInterval=this.channelConfig.MAX_RETRY_INTERVAL;setTimeout(this._rebuildSend.bind(this,a),this.retryInterval,false);}};}());
function TinyPresence(g,c,b,a,e,d,f){this.user=g;this.name=c;this.firstName=b;this.alias=a;this.sitevars=f;this.updateServerTime(e);this.pageLoadTime=this.getTime();this._init(d);}TinyPresence.prototype={cookiePollTime:2000,shutdownDelay:5000,restartDelay:3000,_init:function(a){this.stateStorers=[];this.stateLoaders=[];this._syncTimeout=null;this.cookiePoller=null;this.heartbeat=null;this.stateUpdateTime=0;this.loaded=false;this.isShutdown=false;this.isShuttingDown=false;this.isRestarting=false;this.isPermaShutdown=false;this.shutdownTime=0;this.syncPaused=0;presenceCookieManager.register('state',this._getCookieData.bind(this));Arbiter.subscribe("page_transition",this.checkRebuild.bind(this));this.load();},init:function(){var b={ON_CONNECT:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});this.restart();},ON_SHUTDOWN:function(d,c){switch(d){case channel.HINT_AUTH:return this.loginShutdown();case channel.HINT_CONN:return this.connectionShutdown();case channel.HINT_MAINT:return this.maintenanceShutdown();default:return this.permaShutdown();}}};for(var a in b)Arbiter.subscribe(channel[a],b[a].bind(this));},getWindowID:function(){if(!this.windowID)this.windowID=rand32()+1;return this.windowID;},updateServerTime:function(a){this.timeSkew=Date.now()-a;},getTime:function(){return Date.now()-this.timeSkew;},debug:function(a){},warn:function(a){this.logError("13003:warning:"+a);},error:function(a){this.logError("13002:error:"+a);},logError:function(a){window.EagleEye&&EagleEye.log('realtime-error',{data:a});},load:function(){var b=presenceCookieManager.getSubCookie('state');if(!b){this.debug('presence: got null state cookie, loading with current state');this._load(this._getCookieData());return;}try{this._load(b);}catch(a){this.error('presence: got load exception: '+a.toString());this._load(this._getCookieData());}},_load:function(b){this.syncPaused++;this.stateUpdateTime=verifyNumber(b.ut);if(!this.cookiePoller)this.cookiePoller=setInterval(this._pollCookie.bind(this),this.cookiePollTime);this.state=b;for(var a=0;a<this.stateLoaders.length;a++)this.stateLoaders[a](b);this.syncPaused--;this._loaded();},_loaded:function(){this.loaded=true;},_pollCookie:function(){var a=presenceCookieManager.getSubCookie('state');if(!a)return;if(a.ut>this.stateUpdateTime){this.load(a);return;}},_getCookieData:function(){var b={ut:this.stateUpdateTime};for(var a=0;a<this.stateStorers.length;a++)b=this.stateStorers[a](b);this.state=b;return this.state;},doSync:function(a){if(this.syncPaused)return;if(a){this._doSync();}else if(!this._syncTimeout)this._syncTimeout=this._doSync.bind(this).defer();},_doSync:function(){clearTimeout(this._syncTimeout);this._syncTimeout=null;this.stateUpdateTime=Date.now();presenceCookieManager.store();this._load(this.state);},pauseSync:function(){this.syncPaused++;},resumeSync:function(){this.syncPaused--;this.doSync();},handleMsg:function(a,b){this._handleMsg.bind(this,a,b).defer();},_handleMsg:function(a,b){if(typeof b=='string'){if(b=='shutdown'){this.connectionShutdown();}else if(b=='restart')if(this.isShutdown)this.restart();return;}if(this.isShutdown)return false;if(!b.type)return;Arbiter.inform(PresenceMessage.getArbiterMessageType(b.type),{sender:this,channel:a,obj:b});},checkRebuild:function(){if(!window.channel_manager)if(this.isShutdown&&!this.isPermaShutdown)channelManager.rebuild(ChannelRebuildReasons.PageTransitionRetry);},getErrorDescription:function(a){var c=a.getError();var b=a.getErrorDescription();if(!b)b=_tx("An error occurred.");if(c==1357001)b=_tx("Your session has timed out. Please log in.");return b;},checkLoginError:function(a){var b=a.getError();if(b==1357001||b==1357004||b==1348009){this.loginShutdown();return true;}return false;},checkMaintenanceError:function(a){if(a.getError()==1356007){this.maintenanceShutdown();return true;}return false;},permaShutdown:function(){this.isPermaShutdown=true;var a=_tx("Facebook {Chat} is experiencing technical problems.",{Chat:_tx("Chat")});this.shutdown(false,a,"perma_shutdown");},loginShutdown:function(){var a=_tx("Your session has timed out. Please log in.");this.shutdown(false,a,"login_shutdown");},connectionShutdown:function(b){var a=_tx("Could not connect to Facebook {Chat} at this time.",{Chat:_tx("Chat")});this.shutdown(b,a,"connection_shutdown");},maintenanceShutdown:function(){var a=_tx("Facebook {Chat} is down for maintenance at this time.",{Chat:_tx("Chat")});this.shutdown(false,a,"maintenance_shutdown");channelManager.stop();},versionShutdown:function(){var a=_tx("Please refresh the page to get the latest version of Facebook {Chat}.",{Chat:_tx("Chat")});this.shutdown(false,a,"version_shutdown");channelManager.stop();},shutdown:function(d,c,a){this.isRestarting=false;this.isShuttingDown=true;var b=Date.now();this.shutdownTime=b;if(!d){this._shutdown(c,0,a);}else setTimeout(this._shutdown.bind(this,c,b,a),this.shutdownDelay,false);},_shutdown:function(b,c,a){if(!this.isShuttingDown&&c==this.shutdownTime)return;if(c&&this.isShutdown)return;if(typeof b!='string'||!b)b=_tx("Facebook {Chat} is experiencing technical problems.",{Chat:_tx("Chat")});if(typeof a!='string'||!a)a="undefined";this.warn("presence:displaying_shutdown:"+a);if(this.isShutdown)return;this.logError("13001:shutdown:presence:"+a);this.isShutdown=true;Arbiter.inform(PresenceMessage.SHUTDOWN,{sender:this,reason:b});},restart:function(a){this.isShuttingDown=false;this.isRestarting=true;if(!a){this._restart(0);}else this._restart.bind(this,this.shutdownTime).defer(this.restartDelay,false);},_restart:function(a){if(!this.isRestarting||(a&&a!=this.shutdownTime))return;this.debug("presence: restarting");this.isShutdown=false;this.load();Arbiter.inform(PresenceMessage.RESTARTED,{sender:this});},start:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});},registerStateStorer:function(a){this.stateStorers.push(a);},registerStateLoader:function(a){this.stateLoaders.push(a);},hasUserCookie:function(a){var b=this.user==getCookie('c_user');if(!b&&a)this.permaShutdown();return b;}};
function Presence(g,c,b,a,e,d,f){this.parent.construct(this,g,c,b,a,e,d,f);}Class.extend(Presence,'TinyPresence');Presence.prototype={_init:function(c){try{this.holder=$('fbDockChat');}catch(a){}this.parent._init(c);var d=ua.safari();this.isSafari2=(d&&d<500);var b=ua.firefox();this.isFF2=(b&&b<3);this.isWindows=ua.windows();define('presence',[],this);},_load:function(a){this.parent._load(a);this.parent._loaded();},_loaded:bagofholding,renderLink:function(b,c,a){return '<a href="'+b+'"'+(a?a:'')+'>'+c+'</a>';},_shutdown:function(c,d,b){this.parent._shutdown(c,d,b);if((!this.isShuttingDown&&d===this.shutdownTime)||(d&&this.isShutdown))return;if(Chat.isOnline())CSS.addClass(this.holder,'presence_error');try{var errorNub=$('fbChatErrorNub');TooltipLink.setTooltipText(DOM.find(errorNub,'a.fbNubButton'),c);}catch(a){}},_restart:function(a){this.parent._restart(a);if(!this.isRestarting||(a&&a!=this.shutdownTime))return;CSS.removeClass(this.holder,'presence_error');},isOnline:function(){return this.state&&this.state.vis;}};function getFirstName(c){var d=c.split(" ");var b=d[0];var a=b.length;if(typeof d[1]!='undefined'&&(a==1||(a==2&&b.indexOf('.')!=-1)||(a==3&&b.toLowerCase()=='the')))b+=' '+d[1];return b;}
function LiveMessageReceiver(a){this.eventName=a;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.restartHandler=null;this.registered=false;this.appId=1;}LiveMessageReceiver.prototype.setAppId=function(a){this.appId=a;return this;};LiveMessageReceiver.prototype.setHandler=function(a){this.handler=a;this._dirty();return this;};LiveMessageReceiver.prototype.setRestartHandler=function(a){this.restartHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype.setShutdownHandler=function(a){this.shutdownHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype._dirty=function(){if(this.registered){this.unregister();this.register();}};LiveMessageReceiver.prototype.register=function(){var b=function(d,c){return this.handler(c);}.bind(this);var a=PresenceMessage.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=Arbiter.subscribe(a,b);if(this.shutdownHandler)this.subs.shut=Arbiter.subscribe(channel.ON_SHUTDOWN,this.shutdownHandler);if(this.restartHandler)this.subs.restart=Arbiter.subscribe(PresenceMessage.RESTARTED,this.restartHandler);this.registered=true;return this;};LiveMessageReceiver.prototype.unregister=function(){if(!this.subs)return this;for(var a in this.subs)if(this.subs[a])Arbiter.unsubscribe(this.subs[a]);this.subs=null;this.registered=false;return this;};LiveMessageReceiver.route=function(b){var a=function(c){var d=PresenceMessage.getAppMessageType(b.app_id,b.event_name);Arbiter.inform(d,c,Arbiter.BEHAVIOR_PERSISTENT);};if(b.hasCapture){new AsyncRequest().setHandler(function(c){a(c.getPayload());}).setAllowCrossPageTransition(true).handleResponse(b.response);}else a(b.response);};if(!window.initLiveMessageReceiver){window.initLiveMessageReceiver=true;onloadRegister(function(){Arbiter.subscribe(PresenceMessage.getArbiterMessageType('app_msg'),function(a,b){if(b.obj.event_name=='beep_event'){Bootloader.loadComponents('beeper',function(){Beeper.ensureInitialized();LiveMessageReceiver.route(b.obj);});}else LiveMessageReceiver.route(b.obj);});});}
var ChatQuietLinks={silence:function(b){if(ua.firefox()>=4||ua.chrome())var a=Event.listen(document,'mousemove',function(){this._removeLinkHrefs(b);a.remove();}.bind(this));},_removeLinkHrefs:function(d){var c=DOM.scry(d,'a');for(var b=0;b<c.length;b++){var a=c[b].getAttribute('href');if(!a||a.charAt(0)=='#')c[b].removeAttribute('href');}}};
var OrderedFriendsList=window.OrderedFriendsList||(function(){var a=[];var b={};var c=false;return copy_properties(new Arbiter(),{init:function(d){this.init=bagofholding;a=d;a.forEach(function(f,e){b[f]=e;});c=true;this.inform('initialized',{},Arbiter.BEHAVIOR_PERSISTENT);},contains:function(d){return d in b;},compare:function(d,e){var h=OrderedFriendsList.getRank(d);var i=OrderedFriendsList.getRank(e);if(h!==i)return h-i;var f=((ChatUserInfos[d]||{}).name||'~').toLowerCase();var g=((ChatUserInfos[e]||{}).name||'~').toLowerCase();if(f!==g)return f<g?-1:1;return 0;},getList:function(){var d=$A(a);d=d.filter(function(e){return !ChatUserInfos[e]||ChatUserInfos[e].type=="friend";});return d;},getRank:function(d){return d in b?b[d]:a.length;},isReady:function(){return c;}});})();
__d("ShortProfiles",["InitialChatUserInfos","arbiter"],function(p,q,r,o){var m=r('InitialChatUserInfos');var a=r('arbiter');var b=new a();var c=[];var g=false;var i=false;var j=JSLogger.create('short_profiles');function d(){if(!c.length||g)return;g=true;e.defer();}function n(s){var t=[];$A(s).forEach(function(u){var za={};for(var x=0,z=u.ids.length;x<z;x++){var y=u.ids[x];if(m[y]){za[y]=m[y];}else{za=null;break;}}if(za){var zb={};for(var v in za)zb[v]=copy_properties({},za[v]);try{u.fun(zb);}catch(w){j.error('callback_error',{e:w});}}else t.push(u);});return t;}function e(t){b.inform('fetch');var s=n(c);c=[];if(!s.length)return;var v={};s.forEach(function(w){w.ids.forEach(function(x){if(!m[x])v[x]=true;});});var u=keys(v);new AsyncRequest('/ajax/chat/user_info.php').setData({ids:u}).setHandler(function(w){l(w,s);}).setErrorHandler(k).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}function h(){g=false;d();}function l(u,s){for(var t in u.payload){var v=u.payload[t];if(!v.type)v.type='friend';m[t]=v;}if(s)n(s);c=n(c);h();b.inform('updated');}function k(){j.error('fetch_error');h();}function f(){if(!i){i=true;new AsyncRequest('/ajax/chat/user_info_all.php').setData({viewer:Env.user}).setHandler(l).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}q.exports=copy_properties(b,{get:function(t,s){this.getMulti([t],function(u){s(u[t],t);});},getMulti:function(u,t){var s={ids:u,fun:t};var v=n([s]);if(v.length){c.push(s);d();}},hasAll:function(){return i;},fetchAll:function(){f();},set:function(s,t){var u=m[s];if(u&&(u.name!=t.name||u.firstName!=t.firstName||u.thumbSrc!=t.thumbSrc))j.warn('changed',{oldInfo:u,newInfo:t});m[s]=copy_properties({},t);}});});
define('ChatOnlineFriends',[],function(){var a=function(){};a.prototype={chatFriends:{},chatStatuses:['chatOnline','chatIdle','chatMobile','chatOffline'],_subscribe:function(event,b){this._tokens.push(Arbiter.subscribe(event,b));},clickHandler:function(event){var d=event.getTarget();var c=Parent.byClass(d,'uiListItem');if(c){var b=this.chatFriends[c.id];if(Chat.isOnline()){Chat.openTab(b.user_id,b.name,'friend','online_friends');}else goURI(b.uri);return false;}},onunload:function(){this._tokens.forEach(function(b){Arbiter.unsubscribe(b);});},_setStatus:function(b,c){if(CSS.hasClass(b,c))return;this.chatStatuses.forEach(function(d){CSS.conditionClass(b,d,d==c);});},initTypeahead:function(c,b){c.subscribe('reset',function(){CSS.show(b);});c.subscribe('query',function(d,e){if(e.value){CSS.hide(b);}else CSS.show(b);});},init:function(e,f,b,d,c){this._initShared(e,f,b,c);this._facepile=d.firstChild;this._faceFutures&&this._hideAllFaces();this._faceFutures=[];OrderedFriendsList.subscribe('initialized',function(){this._orderedFriends=OrderedFriendsList.getList();this._hashedFriends=Object.from(this._orderedFriends);this._subscribe(['available-list/initialized','buddylist/availability-changed','chat-options/initialized'],this.update.shield(this));}.bind(this));Event.listen(d,'click',this.clickHandlerClientRendering.bind(this));Event.listen(DOM.find(b,'.fbChatGoOnlineLink'),'click',function(event){Chat.goOnline(Chat.openBuddyList);event.kill();});AvailableList.update();},_initShared:function(d,e,b,c){this.maxElements=d;this._faceTmpl=c;this._tokens=[];onleaveRegister(this.onunload.bind(this));this.initTypeahead(e,DOM.find(b,'div.fbFriendsOnlineFacepile'));},update:function(){var h=ge('chatFriendsOnline');if(h)CSS.conditionClass(h,'isOffline',!Chat.isOnline());if(!Chat.isOnline()||!AvailableList.isReady())return;AvailableList.getAvailableIDs().forEach(function(i){if(!this._hashedFriends[i]){this._orderedFriends.push(i);this._hashedFriends[i]=true;}}.bind(this));var c=0;for(var f=0;f<this._orderedFriends.length;f++){var e=this._orderedFriends[f];var b=AvailableList.get(e);var d=this._faceFutures[f];var g=c<this.maxElements;if(b&&g){if(!d){d=this._makeFace(f);this._faceFutures[f]=d;}c++;}this._updateFace(d,g,this._mapChatStatus(b));}},_mapChatStatus:function(b){switch(b){case AvailableList.OFFLINE:return 'chatOffline';case AvailableList.IDLE:return 'chatIdle';case AvailableList.ACTIVE:return 'chatOnline';case AvailableList.MOBILE:return 'chatMobile';}},_updateFace:function(c,d,b){c&&c(function(e){this._setStatus(e,b);CSS.conditionShow(e,d);}.bind(this));},_makeFace:function(d){var e=null;var b=null;var c=this._orderedFriends[d];require.ensure(['ShortProfiles'],function(f){f.get(c,function(l){b=this._faceTmpl.render();DataStore.set(b,'friendID',c);var k=XHPTemplate.getNode(b,'img');var m=k.cloneNode(false);m.setAttribute('src',l.thumbSrc);DOM.replace(k,m);var g=XHPTemplate.getNode(b,'anchor');TooltipLink.setTooltipText(g,l.name);e&&e(b);var h=false;for(var j=d+1;j<this._orderedFriends.length&&!h;j++){var i=this._faceFutures[j];var n=i&&i();if(n){this._facepile.insertBefore(b,n);h=true;}}if(!h)this._facepile.appendChild(b);}.bind(this));}.bind(this));return function faceFuture(f){if(f)if(b){f(b);}else e=f;return b;};},clickHandlerClientRendering:function(event){var d=event.getTarget();var b=Parent.byClass(d,'uiFacepileItem');if(b){var c=DataStore.get(b,'friendID');if(c&&Chat.isOnline()){require.ensure(['ShortProfiles'],function(e){e.get(c,function(f){Chat.openTab(c,f.name,'friend','online_friends');});});return false;}}},_hideAllFaces:function(){this._faceFutures.forEach(function(b){b&&b(function(c){DOM.remove(c);});});}};return a;});
function ChatOptions(b,a){this._jslog=JSLogger.create('chat_options');this._jslog.log('server',{vis:b});this.visibility=!!b;this._lastVisibilityChangeTime=0;this.settings=a;}ChatOptions.prototype={load:function(){presence.registerStateStorer(this._storeState.bind(this));presence.registerStateLoader(this._loadState.bind(this));if(!ChatConfig.get('blackbird')){Arbiter.subscribe(window.channel.ON_CONFIG,function(b,a){var c=a.getConfig('visibility');this._jslog.log('vis_chan_config',{new_vis:c});this.setVisibility(c);}.bind(this));Arbiter.subscribe('channel/visibility-config',function(a,b){this._jslog.log('vis_chan_config',{new_vis:b});this.setVisibility(b);}.bind(this));}Arbiter.subscribe(PresenceMessage.getArbiterMessageType('visibility'),function(a,b){var c=b.obj;if(c.window_id===presence.getWindowID())return;this._jslog.log('vis_chan_message',{new_vis:c.visibility,window_id:c.window_id});this.setVisibility(c.visibility);}.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('setting'),function(a,b){var c=b.obj;if(c.window_id===presence.getWindowID())return;this.setSetting(c.setting,!!c.value);}.bind(this));Arbiter.inform('chat-options/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);define('ChatOptions',[],this);},_storeState:function(a){a.vis=this.visibility?1:0;a.vct=this._lastVisibilityChangeTime;a.bls=this.getSetting('sticky_buddylist');a.blc=this.getSetting('compact_buddylist');a.snd=this.getSetting('sound');return a;},_loadState:function(b){if(!ChatConfig.get('blackbird')){var a=verifyNumber(b.vct);var c=Math.max(Env.rep_lag,ChatConfig.get('presence_cookie_setting_cache_window'));if(new Date()-a<c&&this._lastVisibilityChangeTime<a){if(b.vis!=this.visibility){this._jslog.log('vis_load',{new_vis:b.vis});this.setVisibility(!!b.vis);}this._lastVisibilityChangeTime=a;}}this.setSetting('sticky_buddylist',b.bls);this.setSetting('compact_buddylist',b.blc);this.setSetting('sound',b.snd);},setVisibility:function(a){if(a===this.visibility)return;this.visibility=a;this._lastVisibilityChangeTime=Date.now();Arbiter.inform('chat/visibility-changed',{sender:this});presence.doSync();},_onVisibilityResponse:function(a){this._jslog.log('vis_send_success',{new_vis:a});if(a)this.setVisibility(a);},_onVisibilityError:function(a){this._jslog.log('vis_send_error',{old_vis:a});this.setVisibility(a);},toggleVisibility:function(){this.sendVisibility(!this.visibility);},sendVisibility:function(b){this._jslog.log('vis_send',{old_vis:this.visibility,new_vis:b});if(this.visibility==b)return;var a={visibility:b,notify_ids:Chat.getActiveFriendChats(),window_id:presence.getWindowID()};if(!b)this.setVisibility(b);new AsyncRequest(chatDisplay.visibilityURL).setHandler(this._onVisibilityResponse.shield(this,b)).setErrorHandler(this._onVisibilityError.shield(this,!b)).setData(a).setAllowCrossPageTransition(true).send();Arbiter.inform(b?'chat/connect':'chat/disconnect');},getSetting:function(a){return this.settings[a];},setSetting:function(a,b){if(this.getSetting(a)==b)return;this.settings[a]=b;Arbiter.inform('chat/option-changed',{name:a,value:b});}};
var ChatSidebar=window.ChatSidebar||(function(){var b;var i=false;var j=false;var l=false;var k=false;var q;var n;var s;var w;var x;var m;var c=null;var u=null;var y=null;var p=null;var a=32;function e(z){switch(z){case channel.HINT_AUTH:return _tx("Your session has timed out. Please log in.");case channel.HINT_CONN:return _tx("Could not connect to Facebook {Chat} at this time.",{Chat:_tx("Chat")});case channel.HINT_MAINT:return _tx("Facebook {Chat} is down for maintenance at this time.",{Chat:_tx("Chat")});default:return _tx("Facebook {Chat} is experiencing technical problems.",{Chat:_tx("Chat")});}}function o(){if(p){clearTimeout(p);p=null;}p=setTimeout(function(){p=null;},ChatConfig.get('mute_warning_time_msec'),false);}function f(zd,z){if(zd===channel.ON_SHUTDOWN){c=e(z);}else if(zd===PresenceMessage.RESTARTED||(zd===channel.ON_ENTER_STATE&&(z.state==='pull'||z.nextState==='pull'))){c=null;}else if(zd===channel.ON_ENTER_STATE&&(z.state==='ping'||z.nextState==='ping')){var zc=z.delay||0;if(y){y.remove();y=null;}c=$N('div',_tx("Unable to connect."));DOM.appendContent(c,$N('br'));if(zc>1000){if(zc>ChatConfig.get('warning_countdown_threshold_msec')){var zb=$N('a',{href:'#'},_tx("Try again"));DOM.appendContent(c,zb);y=Event.listen(zb,'click',function(event){event.prevent();if(CSS.hasClass(event.getTarget(),reconnectClassName)){clearTimeout(u);u=null;c=$N('div',_tx("Unable to connect."));DOM.appendContent(c,$N('div',_tx("Reconnecting...")));g();setTimeout(function(){if(channel_manager.state!='ping')channel_manager.enterState('ping!');},ChatConfig.get('channel_manual_reconnect_defer_msec'),false);}});}else DOM.appendContent(c,$N('div',_tx("Reconnecting in {secs}...",{secs:Math.floor(zc/1000)})));var za=z.delay-1000;u=setTimeout(bind(null,f,zd,{state:z.state,nextState:z.nextState,delay:za}),1000,false);}else{clearTimeout(u);u=null;DOM.appendContent(c,$N('div',_tx("Reconnecting...")));}}g();}function d(){return Chat.getLogger('blackbird');}function g(){var zf=ChatConfig.get('blackbird')?PresencePrivacy.getVisibility()===PresencePrivacy.ONLINE:Chat.isOnline();var z=false;if(!zf){var za='fbChatGoOnlineLink';var ze=ChatConfig.get('blackbird')?_tx("Go online"):_tx("available");var zb=$N('a',{href:'#',className:za},ze);var zd=$N('div',zb);var zc=zd.innerHTML;var zg=ChatConfig.get('blackbird')?_tx("{=Go online} to see who's online to chat.",{'=Go online':zc}):_tx("You are unavailable to chat. Let friends see you as {=available}?",{'=available':zc});DOM.setContent(n,HTML(zg));Event.listen(n,'click',function(event){if(CSS.hasClass(event.getTarget(),za)){if(Chat.isOnline())d().error('sidebar_go_online_while_online');d().log('sidebar_go_online');ChatConfig.get('blackbird')?PresencePrivacy.setVisibility(PresencePrivacy.ONLINE):Chat.goOnline();return false;}});CSS.addClass(s,'offline');}else{CSS.removeClass(s,'offline');DOM.empty(n);z=(c!=null);}if(z&&!p){CSS.addClass(s,'error');DOM.setContent(n,c);}else CSS.removeClass(s,'error');r();}function h(){if(!ChatSidebar.isVisible()&&k)return;l=false;CSS.hide(s);CSS.removeClass(document.documentElement,'sidebarMode');q.hide();w.getCore().reset();Arbiter.inform('sidebar/hide',ChatSidebar);}function r(){OrderedFriendsList.subscribe('initialized',function(){var za=ChatSidebar.shouldShowSidebar();CSS.conditionClass(document.documentElement,'sidebarCapable',za);if(ChatSidebar.isEnabled()&&za){CSS.setStyle(s,'height',x.y+'px');t();var z=x.y;$A(s.childNodes).forEach(function(zb){if(zb!==b)z-=Vector2.getElementDimensions(zb).y;});CSS.setStyle(b,'height',z+'px');this._maxItems=Math.floor((z-8)/a);q.setNumTopFriends(this._maxItems);w.getData().setMaxResults(this._maxItems);Arbiter.inform('sidebar/resized',ChatSidebar);}else h();k=true;});}function t(){if(ChatSidebar.isVisible())return;l=true;CSS.show(s);CSS.addClass(document.documentElement,'sidebarMode');q.show();Arbiter.inform('sidebar/show',ChatSidebar);}function v(){chatOptions.setSetting('sidebar_mode',ChatSidebar.isEnabled());new AsyncRequest('/ajax/chat/settings.php').setHandler(bagofholding).setErrorHandler(bagofholding).setData({sidebar_mode:ChatSidebar.isEnabled()}).setAllowCrossPageTransition(true).send();}return {init:function(za,z,zb){ChatSidebar.init=bagofholding;s=za;q=z;w=zb;b=DOM.find(za,'div.fbChatSidebarBody');n=DOM.find(za,'div.fbChatSidebarMessage div.message');z.setScrollContainer(DOM.find(b,'div.uiScrollableAreaWrap'));z.subscribe(['render','show','hide'],debounce(function(){var zc=z.getRoot();var zd=ScrollableArea.getInstance(zc);zd&&zd.adjustGripper();}));ChatQuietLinks.silence(za);Event.listen(window,'resize',r);Arbiter.subscribe('chat/visibility-changed',g);Arbiter.subscribe('chat/option-changed',function(zd,zc){if(zc.name=="sidebar_mode"){i=!!chatOptions.getSetting('sidebar_mode');r();}});if(ChatConfig.get('blackbird'))PresencePrivacy.subscribe('privacy-user-presence-changed',g);zb.subscribe(['respond','reset'],function(zc,zd){if(l)if(zd&&zd.value&&zd.value===zb.getCore().getValue()&&zb.getView().isVisible()){q.hide();}else q.show();});zb.getData().subscribe('beforeQuery',r);Arbiter.subscribe([PresenceMessage.RESTARTED,channel.ON_SHUTDOWN],f);if(ChatConfig.get('channel_disconnect_warning')){Arbiter.subscribe(channel.ON_ENTER_STATE,f);Arbiter.subscribe('time_check',o);}Arbiter.subscribe('buddylist-nub/initialized',function(zc,zd){Event.listen(zd.getButton(),'click',function(event){ChatSidebar.enable();return !ChatSidebar.shouldShowSidebar();});});Arbiter.subscribe('chat-options/initialized',function(zc,zd){i=!!zd.getSetting('sidebar_mode');g();Arbiter.inform('sidebar/initialized',ChatSidebar,Arbiter.BEHAVIOR_PERSISTENT);});},disable:function(){if(!ChatSidebar.isEnabled())return;i=false;v();h();},enable:function(){if(ChatSidebar.isEnabled())return;i=true;v();r();!function(){if(ChatSidebar.isVisible())w.getCore().getElement().focus();}.defer();},hide:function(){j=true;h();},unhide:function(){j=false;r();},getBody:function(){return b;},getRoot:function(){return s;},getVisibleWidth:function(){return s&&s.offsetWidth||0;},isEnabled:function(){return i;},isViewportCapable:function(){x=Vector2.getViewportDimensions();return x.x>ChatConfig.get('sidebar.minimum_width');},shouldShowSidebar:function(){return ChatSidebar.isViewportCapable()&&!j&&OrderedFriendsList.getList().length>ChatConfig.get('sidebar.min_friends');},isVisible:function(){return l;},resize:r,toggle:function(){ChatSidebar.isEnabled()?ChatSidebar.disable():ChatSidebar.enable();}};})();
add_properties('TypeaheadBehaviors',{chatTypeahead:function(c){var a=c.getElement();var b=c.getView().getElement();c.subscribe('focus',function(){c.getData().refreshData();});c.subscribe('blur',function(d){c.getCore().reset();});c.subscribe('respond',function(d,e){if(e.value&&e.value===c.getCore().getValue()){if(!e.results.length){var f=$N('div',{className:'noResults'},_tx("Friend not found."));DOM.setContent(b,f);}CSS.addClass(a,'hasValue');}});c.subscribe('reset',function(){CSS.removeClass(a,'hasValue');});c.subscribe('select',function(d,e){Chat.openTab(e.selected.uid,e.selected.text,e.selected.type,'typeahead');if(!ChatConfig.get('blackbird'))Chat.goOnline();});c.subscribe('highlight',function(d,f){if(f.index>=0){var i=c.getView().getItems()[f.index];if(i){var h=new Rect(i);var e=i.offsetParent;var g=h.boundWithin(new Rect(e)).getPositionVector();h.getPositionVector().sub(g).scrollElementBy(e);}}});}});
function ChatTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(ChatTypeaheadCore,'TypeaheadCore');ChatTypeaheadCore.prototype={handleTab:bagofholding,keydown:function(event){var a=Event.getKeyCode(event);if(a===KEYS.ESC){this.reset.shield(this).defer();return event.kill();}return this.parent.keydown(event);}};
function ChatTypeaheadDataSource(a){this.parent.construct(this,a);this.persistOnRefresh=a.persistOnRefresh!==false;this.showOfflineUsers=!!a.showOfflineUsers;}Class.extend(ChatTypeaheadDataSource,'DataSource');ChatTypeaheadDataSource.prototype={init:function(){OrderedFriendsList.subscribe('initialized',function(){this.parent.init();var a=Arbiter.subscribe(['available-list/initialized','buddylist/availability-changed'],this._update.shield(this));if(!this.persistOnRefresh)onleaveRegister(function(){Arbiter.unsubscribe(a);});}.bind(this));},bootstrap:function(){this.parent.bootstrap();if(this.showOfflineUsers)require.ensure(['ShortProfiles'],function(a){if(a.hasAll()){this._update();}else{a.fetchAll();this.inform('activity',{activity:true});var b=a.subscribe('updated',function(){this.inform('activity',{activity:false});this._update();}.bind(this));if(!this.persistOnRefresh)onleaveRegister(function(){a.unsubscribe(b);});}}.bind(this));},_update:function(){var c=this.value;this.dirty();var b=keys(ChatUserInfos).filter(function(d){return ChatUserInfos[d].type==='friend';});b.sort(OrderedFriendsList.compare);var a=[];b.forEach(function(e){if(e==Env.user)return;var d=AvailableList.get(e);if(!this.showOfflineUsers&&d!==AvailableList.ACTIVE)return;var f=ChatUserInfos[e];a.push({uid:e,text:f.name,tokens:f.additionalName,localized_text:f.name,additional_text:f.additionalName,photo:f.thumbSrc,availability:d,type:f.type});}.bind(this));if(a.length)this.addEntries(a);this.value=c;if(c)this.respond(c,this.buildUids(c,[],this._exclusions),true);},refreshData:function(){AvailableList.update();}};
add_properties('TypeaheadRenderers',{chat:function(a,b){var d='offline';switch(a.availability){case AvailableList.ACTIVE:d='active';break;case AvailableList.IDLE:d='idle';break;case AvailableList.MOBILE:d='mobile';break;}if(ChatConfig.get('blackbird')&&!PresencePrivacy.allows(a.uid))d='invis';var c=[];if(a.photo)c.push($N('img',{alt:'',src:a.photo}));if(a.text)c.push($N('span',{className:'text'},[a.text]));c.push($N('i',{className:d}));return $N('li',{className:'clearfix '+d},c);}});
function TypingIndicator(a,b,d,c){this.id=a;this.input=b;this.source=d;this.callback=null;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('typ'),this.onTyping.bind(this));this.remoteState=TypingDetector.INACTIVE;this.notifyTimer=null;c=c||{};this.notifyDelay=c.notifyDelay||this.notifyDelay;this._typingDetector=new TypingDetector(b);this._typingDetector.init(c);this._typingDetector.subscribe('change',this._stateChange.bind(this));}copy_properties(TypingIndicator.prototype,{notifyDelay:1000,setIgnoreEnter:function(a){var b=a?[KEYS.RETURN]:[];this._typingDetector.setIgnoreKeys(b);},resetState:function(){presence.debug('typing: ** RESET **');this.remoteState=TypingIndicator.INACTIVE;this._typingDetector.reset();clearTimeout(this.notifyTimer);this.notifyTimer=null;},_stateChange:function(a,b){if(b==TypingDetector.ACTIVE)presence.debug('typing:'+this.currentState+' -> '+b);if(b!=TypingDetector.QUITTING){clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.shield(this,b).defer(this.notifyDelay,false);}else this._notifyState(b,true);},_notifyState:function(d,b){var e=this.id;var c=Chat.isOnline()&&ChatUserInfos[e]&&ChatUserInfos[e].type=="friend";if(ChatConfig.get('blackbird'))c&=PresencePrivacy.allows(e);if(c&&d!=this.remoteState){this.remoteState=d;presence.debug('typing: notifyState('+d+')');if(!channelManager.iframeEverLoaded)return;var a={typ:d,to:e,source:this.source};new AsyncRequest().setHandler(this._onTypResponse.bind(this,e)).setErrorHandler(bagofholding).setData(a).setURI('/ajax/messaging/typ.php').setAllowCrossPageTransition(true).setOption('asynchronous',!b).send();}},_onTypResponse:function(c,b){var a=b.getPayload()||{};if(a.offline)AvailableList.set(c,AvailableList.OFFLINE);},setCallback:function(a){this.callback=a;},onTyping:function(b,a){this.callback&&this.callback(a.obj);}});
function VideoEvents(){}Function.mixin(VideoEvents,'Arbiter',{ACTIVATING:'videochat/activating',LOGGING_IN:'videochat/logging_in',GETTING_TOKEN:'videochat/getting_token',CONNECTING:'videochat/connecting',SLOW_CONDITIONS:'videochat/slow_conditions',CALL_INCOMING:'videochat/call_incoming',CALL_CONNECTED:'videochat/call_connected',GOT_CALLEE:'videochat/got_callee',CALL_HANDLED:'videochat/call_handled',CALLEE_ANSWERING:'videochat/callee_answering',FATAL_ERROR:'videochat/fatal_error',CALL_IN_PROGRESS:'videochat/call_in_progress',NOT_AVAILABLE:'videochat/not_available',SERVER_ERROR:'videochat/server_error',ACTIVATE_FAILED:'videochat/activate_failed',ACTIVATE_TIMED_OUT:'videochat/activate_failed_time',WRONG_VERSION_ERROR:'videochat/wrong_version',FATAL_PLUGIN_ERROR:'videochat/plugin_fatality',SILENT_PLUGIN_ERROR:'videochat/plugin_silent_fatality',START_CALL_UI:'videochat/start_call_ui',START_CALL:'videochat/start_call',ANSWER_CALL:'videochat/answer_call',IGNORE_CALL:'videochat/ignore_call',CANCEL_CALL:'videochat/cancel_call',INSTALL_COMPLETED:'videochat/install_completed',log:function(a){window.console&&console.log&&console.log(a);},warn:function(a){window.console&&console.warn&&console.warn(a);},error:function(a){window.console&&console.error&&console.error(a);}});
var VideoChatPlugin=function(){};Function.mixin(VideoChatPlugin,'Arbiter',{INSTALL_TYPES:{JAVA:0,MANUAL:1},isSupported:function(){var b=ua.windows()&&((ua.ie()>=7&&!ua.ie64())||ua.firefox()>=3.6||ua.chrome()>=5);var a=(ua.osx()>10.4)&&(ua.firefox()>=3.6||ua.chrome()>=5||ua.safari()>=500);return (b||a);},notifyFromApplet:function(b,a){Arbiter.inform(String(b),{args:String(a)});},isInstalled:function(){var a=false;if(VideoChatPlugin.isSupported())if(VideoChatPlugin.usesActiveX()){var c=null;try{c=new ActiveXObject('SkypeLimited.SkypeWebPlugin');a=!!c;}catch(b){}c=null;}else a=VideoChatPlugin._getInstalledVersion();return a;},usesActiveX:function(){return ua.ie()&&ua.windows()&&!ua.opera();},setLogger:function(a){VideoChatPlugin.log=a||bagofholding;},embed:function(a){Bootloader.loadComponents('VideoChatPluginCore',function(){VideoChatPlugin.embed(a);});},remove:bagofholding,_getInstalledVersion:function(){if(!navigator)return null;navigator.plugins.refresh(false);mimeHandler=navigator.mimeTypes['application/skypesdk-plugin'];return mimeHandler&&mimeHandler.enabledPlugin;}});
var VideoChatView={RINGTONE_PATH:'/sound/bling.mp3',WINDOW_NAME_COOKIE_KEY:'vcpwn',TARGET_ID_COOKIE_KEY:'vctid',inIncomingCall:false,inOutgoingCall:false,inManualInstall:false,tokens:[],init:function(){VideoChatView.subscribe(VideoEvents.CALL_INCOMING,VideoChatView._onIncomingCall);VideoChatView.subscribe(VideoEvents.START_CALL_UI,function(a,b){if(!VideoChatView.inOutgoingCall){VideoChatView.inOutgoingCall=true;if(VideoChatPlugin.isInstalled()){VideoChatView.onOutgoingCall(b.idTarget);}else VideoChatView._invokeCore('promptInstall',b.idTarget);}});if(VideoChatPlugin.isSupported())CSS.addClass(document.documentElement,'videoCallEnabled');onbeforeunloadRegister(function(){if((VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall)&&!VideoChatView.inManualInstall)return _tx("Leaving this page will end your call.");});onleaveRegister(function(){if(VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall){VideoEvents.inform(VideoEvents.CANCEL_CALL,{cause:'leave:page'});VideoChatView.inIncomingCall=false;VideoChatView.inOutgoingCall=false;}});VideoChatView._checkPriorState();},subscribe:function(b,a){VideoChatView.tokens.push(VideoEvents.subscribe(b,a));},onProfileButtonClick:function(a){VideoChatView._invokeCore('onProfileButtonClick',a);},unload:function(){while(VideoChatView.tokens.length)VideoEvents.unsubscribe(VideoChatView.tokens.pop());},mightReloadPostInstall:function(){return ua.windows();},_showDialog:function(b,a){new Dialog().setAllowCrossPageTransition(true).setTop(a?85:125).setFixed(true).setAsync(new AsyncRequest(b)).show();},_onIncomingCall:function(a,b){VideoChatView.inIncomingCall=true;VideoChatView._showDialog(URI('/ajax/chat/video/incoming_call.php').setQueryData({idTarget:b.idTarget,callId:b.callId}),true);},onOutgoingCall:function(a){VideoChatView.inOutgoingCall=true;VideoChatView._showDialog('/ajax/chat/video/outgoing_call.php?idTarget='+a);},_checkPriorState:function(){if(VideoChatView.mightReloadPostInstall()){var a=getCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);if(a){clearCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);var b=getCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(b){clearCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(getCookie(VideoChatView.TARGET_ID_COOKIE_KEY))return;if(VideoChatPlugin.isInstalled())VideoChatView.onOutgoingCall(b);}}}},_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatViewCore',function(){VideoChatView.initCore();VideoChatView[b].apply(VideoChatView,a);});}};
function PresenceIndicator(){}PresenceIndicator.prototype={init:function(b,a,d){this._id=b;this._firstname=a;this._tooltip=d;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._subscriptions=[Arbiter.subscribe(['available-list/initialized','buddylist/availability-changed'],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat-options/initialized','chat/visibility-changed'],this._updateVisibility.bind(this))];var c=Event.listen(this._tooltip,'click',function(){if(this._previousAvail!=AvailableList.OFFLINE)Chat.openTab(this._id);}.bind(this));onleaveRegister(function(){c.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){if(!AvailableList.isReady())return;var c;var b;var a=AvailableList.get(this._id);if(a===this._previousAvail)return;this._previousAvail=a;switch(a){case AvailableList.OFFLINE:c=ChatConfig.get('blackbird')?_tx("{name} is offline",{name:this._firstname}):_tx("{name} is unavailable",{name:this._firstname});b='offline';break;case AvailableList.IDLE:c=_tx("{name} is idle",{name:this._firstname});b='idle';break;case AvailableList.ACTIVE:c=ChatConfig.get('blackbird')?_tx("{name} is online",{name:this._firstname}):_tx("{name} is available",{name:this._firstname});b='online';break;case AvailableList.MOBILE:c=_tx("{name} is available on mobile",{name:this._firstname});b='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,c);CSS.setClass(this._image,b);},_updateVisibility:function(){if(Chat.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}};