/*1320939654,176820665*/

if (window.CavalryLogger) { CavalryLogger.start_js(["2zGMQ"]); }

__d("object-extensions",["object-core-utils","array-utils"],function(d,f,g,c){var b=g('object-core-utils').copy_properties;var e=g('array-utils').hasArrayNature;var a={object:function(i){var h=new Function();h.prototype=i;return new h();},isScalar:function(h){return (/string|number|boolean/).test(typeof h);},getKeys:function(j){var i=[];for(var h in j)i.push(h);return i;},getValues:function(i){var j=[];for(var h in i)j.push(i[h]);return j;},countKeys:function(j){var h=0;for(var i in j)h++;return h;},areEqual:function(h,i){return JSON.stringify(h)==JSON.stringify(i);},merge:function(){var i={};for(var h=0;h<arguments.length;h++)b(i,arguments[h]);return i;},coalesce:function(){for(var h=0;h<arguments.length;++h)if(arguments[h]!=null)return arguments[h];return null;}};Object.from=function(j,l){var k={};var i=e(l);if(typeof l=='undefined')l=true;for(var h=j.length;h--;)k[j[h]]=i?l[h]:l;return k;};f.exports=a;d.object=a.object;d.is_scalar=a.isScalar;d.keys=a.getKeys;d.values=a.getValues;d.count=a.countKeys;d.are_equal=a.areEqual;d.merge=a.merge;d.coalesce=a.coalesce;},3);
__d("array-extensions",["object-core-utils"],function(c,d,f,b){var a=f('object-core-utils').copy_properties;function e(g){return function(){if(this===c)throw new TypeError();return g.apply(this,arguments);};}a(Array.prototype,{map:function(h,g){if(this===c||typeof h!='function')throw new TypeError();var i;var j=this.length;var k=new Array(j);for(i=0;i<j;++i)if(i in this)k[i]=h.call(g,this[i],i,this);return k;},forEach:function(h,g){this.map(h,g);return this;},filter:function(h,g){h=h||function(m){return m;};if(this===c||typeof h!='function')throw new TypeError();var i,l,j=this.length,k=[];for(i=0;i<j;++i)if(i in this){l=this[i];if(h.call(g,l,i,this))k.push(l);}return k;},every:e(function(h,g){var k=new Object(this);var j=k.length;for(var i=0;i<j;i++)if(i in k)if(!h.call(g,k[i],i,k))return false;return true;}),some:e(function(h,g){var k=new Object(this);var j=k.length;for(var i=0;i<j;i++)if(i in k)if(h.call(g,k[i],i,k))return true;return false;}),reduce:null,reduceRight:null,sort:e(Array.prototype.sort),reverse:e(Array.prototype.reverse),concat:e(Array.prototype.concat),slice:e(Array.prototype.slice),indexOf:e(Array.prototype.indexOf||function(i,g){var h=this.length;g|=0;if(g<0)g+=h;for(;g<h;g++)if(g in this&&this[g]===i)return g;return -1;}),contains:function(g){return this.indexOf(g)!=-1;},remove:function(h){var g=this.indexOf(h);if(g!=-1)this.splice(g,1);}});Array.prototype.each=Array.prototype.forEach;Array.prototype.clone=Array.prototype.slice;},3);
function muffinize(d){var c='a';var b='d';var a=[c,b].join('');return d.replace(/muffin/g,a);}if(typeof console=='undefined')console={log:bagofholding,info:bagofholding,warn:bagofholding,debug:bagofholding,dir:bagofholding,error:bagofholding};window.Util=console;Util.assert=Util.assert||function(a,b){if(!a)throw b||'assert';};
window.onloadRegister=function(a){window.loaded?_runHook(a):_addHook('onloadhooks',a);};function onafterloadRegister(a){window.afterloaded?setTimeout(function(){_runHook(a);},0):_addHook('onafterloadhooks',a);}function _onloadHook(){!window.loaded&&window.CavalryLogger&&CavalryLogger.getInstance().setTimeStamp('t_prehooks');_runHooks('onloadhooks');!window.loaded&&window.CavalryLogger&&CavalryLogger.getInstance().setTimeStamp('t_hooks');window.loaded=true;Arbiter.inform('uipage_onload',true,Arbiter.BEHAVIOR_STATE);}function _onafterloadHook(){_runHooks('onafterloadhooks');window.afterloaded=true;}function _runHook(b){try{return b();}catch(a){}}function _runHooks(b){var d=b=='onbeforeleavehooks'||b=='onbeforeunloadhooks';var e=null;do{var a=window[b];if(!d)window[b]=null;if(!a)break;for(var c=0;c<a.length;c++)if(d){e=e||_runHook(a[c]);}else _runHook(a[c]);if(d)break;}while(window[b]);if(d&&e)return e;}function keep_window_set_as_loaded(){if(window.loaded==false){window.loaded=true;_runHooks('onloadhooks');}if(window.afterloaded==false){window.afterloaded=true;_runHooks('onafterloadhooks');}}Arbiter.registerCallback(_onloadHook,[OnloadEvent.ONLOAD_DOMCONTENT_CALLBACK,InitialJSLoader.INITIAL_JS_READY]);Arbiter.registerCallback(_onafterloadHook,[OnloadEvent.ONLOAD_DOMCONTENT_CALLBACK,OnloadEvent.ONLOAD_CALLBACK,InitialJSLoader.INITIAL_JS_READY]);Arbiter.subscribe(OnloadEvent.ONBEFOREUNLOAD,function(b,a){a.warn=_runHooks('onbeforeleavehooks')||_runHooks('onbeforeunloadhooks');if(!a.warn){window.loaded=false;window.afterloaded=false;}},Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(OnloadEvent.ONUNLOAD,function(b,a){_runHooks('onunloadhooks');},Arbiter.SUBSCRIBE_NEW);
void(0);
__d("cookie",[],function(c,d,e,b){var a={set:function(f,g,i,j){if(env_get('no_cookies')&&f!='tpa')return;var h;if(i){var k=new Date();h=new Date();h.setTime(k.getTime()+i);}document.cookie=f+"="+encodeURIComponent(g)+"; "+(i?"expires="+h.toGMTString()+"; ":"")+"path="+(j||'/')+"; domain="+window.location.hostname.replace(/^.*(\.facebook\..*)$/i,'$1');},clear:function(f){document.cookie=f+"=; expires=Thu, 01-Jan-1970 00:00:01 GMT; "+"path=/; domain="+window.location.hostname.replace(/^.*(\.facebook\..*)$/i,'$1');},get:function(i){var j=i+"=";var g=document.cookie.split(';');for(var h=0;h<g.length;h++){var f=g[h];while(f.charAt(0)==' ')f=f.substring(1,f.length);if(f.indexOf(j)===0)return decodeURIComponent(f.substring(j.length,f.length));}return null;}};d.exports=a;c.getCookie=a.get;c.setCookie=a.set;c.clearCookie=a.clear;},3);
__d("dom-html",["ua","eval-global"],function(c,d,e,b){var f=e('ua');function a(g){if(g&&g.__html)g=g.__html;if(!(this instanceof a)){if(g instanceof a)return g;return new a(g);}this._content=g;this._defer=false;this._extra_action='';this._nodes=null;this._inline_js=bagofholding;this._ie_clone_bug=false;return this;}a.isHTML=function(g){return g&&(g instanceof a||g.__html!==undefined);};a.replaceJSONWrapper=function(g){return g&&g.__html!==undefined?new a(g.__html):g;};copy_properties(a.prototype,{toString:function(){var g=this._content||'';if(this._extra_action)g+='<script type="text/javascript">'+this._extra_action+'</scr'+'ipt>';return g;},setAction:function(g){this._extra_action=g;return this;},getAction:function(){this._fillCache();var g=function(){this._inline_js();var h=e('eval-global').eval_global;h(this._extra_action);}.bind(this);if(this.getDeferred()){return g.defer.bind(g);}else return g;},setDeferred:function(g){this._defer=!!g;return this;},getDeferred:function(){return this._defer;},getContent:function(){return this._content;},getNodes:function(){this._fillCache();return this._nodes;},getRootNode:function(){return this.getNodes()[0];},ieCloneBug:function(){this._fillCache();return this._ie_clone_bug;},_fillCache:function(){if(null!==this._nodes)return;var j=this._content;if(!j){this._nodes=[];return;}j=j.replace(/(<(\w+)[^>]*?)\/>/g,function(r,s,t){return t.match(/^(abbr|br|col|img|input|link|meta|param|hr|area|embed)$/i)?r:s+'></'+t+'>';});var n=j.trim().toLowerCase(),q=document.createElement('div'),h=false;var p=(!n.indexOf('<opt')&&[1,'<select multiple="multiple" class="__WRAPPER">','</select>'])||(!n.indexOf('<leg')&&[1,'<fieldset class="__WRAPPER">','</fieldset>'])||(n.match(/^<(thead|tbody|tfoot|colg|cap)/)&&[1,'<table class="__WRAPPER">','</table>'])||(!n.indexOf('<tr')&&[2,'<table><tbody class="__WRAPPER">','</tbody></table>'])||((!n.indexOf('<td')||!n.indexOf('<th'))&&[3,'<table><tbody><tr class="__WRAPPER">','</tr></tbody></table>'])||(!n.indexOf('<col')&&[2,'<table><tbody></tbody><colgroup class="__WRAPPER">','</colgroup></table>'])||null;if(null===p){q.className='__WRAPPER';if(f.ie()){p=[0,'<span style="display:none">&nbsp;</span>',''];h=true;}else p=[0,'',''];}q.innerHTML=p[1]+j+p[2];while(p[0]--)q=q.lastChild;if(h)q.removeChild(q.firstChild);q.className!='__WRAPPER';if(0!==q.getElementsByTagName('option').length||0!==q.getElementsByTagName('object').length)this._ie_clone_bug=true;if(f.ie()){var o;if(!n.indexOf('<table')&&-1==n.indexOf('<tbody')){o=q.firstChild&&q.firstChild.childNodes;}else if(p[1]=='<table>'&&-1==n.indexOf('<tbody')){o=q.childNodes;}else o=[];for(var l=o.length-1;l>=0;--l)if(o[l].nodeName&&o[l].nodeName.toLowerCase()=='tbody'&&o[l].childNodes.length==0)o[l].parentNode.removeChild(o[l]);}var m=q.getElementsByTagName('script');var g=[];for(var k=0;k<m.length;k++)if(m[k].src){g.push(Bootloader.requestResource.bind(Bootloader,'js',m[k].src));}else g.push(eval_global.bind(null,m[k].innerHTML));for(var k=m.length-1;k>=0;k--)m[k].parentNode.removeChild(m[k]);var i=function(){for(var r=0;r<g.length;r++)g[r]();};this._nodes=$A(q.childNodes);this._inline_js=i;}});c.HTML=d.exports=a;},3);
__d("dom",["dom-core","array-utils","css-core","dom-html","object-extensions"],function(j,k,l,h){var a=l('dom-core').$;var b=l('array-utils').$A;var i=l('dom-core').ge;var d=l('css-core');var f=l('dom-html');var g=l('object-extensions');var e={find:function(m,o){var n=e.scry(m,o);return n[0];},scry:function(v,zh){if(!v)return [];var zi=zh.split(' ');var p=[v];var u=v===document;for(var y=0;y<zi.length;y++){if(p.length==0)break;if(zi[y]=='')continue;var zg=zi[y];var ze=[];var zp=false;if(zg.charAt(0)=='^')if(y==0){zp=true;zg=zg.slice(1);}else return [];zg=zg.replace(/\./g,' .');zg=zg.replace(/\#/g,' #');zg=zg.replace(/\[/g,' [');var zl=zg.split(' ');var zm=zl[0]||'*';var z=zl[1]&&zl[1].charAt(0)=='#';if(z){var t=i(zl[1].slice(1),true);if(t&&('*'==zm||t.tagName.toLowerCase()==zm))for(var zc=0;zc<p.length;zc++)if(zp&&e.contains(t,p[zc])){ze=[t];break;}else if(document==p[zc]||e.contains(p[zc],t)){ze=[t];break;}}else{var zo=[];var o=p.length;for(var za=0;za<o;za++){if(zp){var w=[];var s=p[za].parentNode;var m=zm=='*';while(e.isElementNode(s)){if(m||s.tagName.toLowerCase()==zm)w.push(s);s=s.parentNode;}}else var w=p[za].getElementsByTagName(zm);var x=w.length;for(var zd=0;zd<x;zd++)zo.push(w[zd]);}for(var zj=1;zj<zl.length;zj++){var zk=zl[zj];var zb=zk.charAt(0)=='.';var q=zk.substring(1);for(var za=0;za<zo.length;za++){var zn=zo[za];if(!zn)continue;if(zb){if(!d.hasClass(zn,q))delete zo[za];continue;}else{var r=zk.slice(1,zk.length-1);if(r.indexOf('=')==-1){if(zn.getAttribute(r)===null){delete zo[za];continue;}}else{var zf=r.split('=');var n=zf[0];var zq=zf[1];zq=zq.slice(1,zq.length-1);if(zn.getAttribute(n)!=zq){delete zo[za];continue;}}}}}for(var za=0;za<zo.length;za++)if(zo[za]){ze.push(zo[za]);if(zp)break;}}p=ze;}return p;},getText:(function(){var m=document.createElement('div'),n=m.textContent!=null?'textContent':'innerText';return function(o){if(!o){return '';}else if(e.isTextNode(o)){return o.data;}else return o[n];};})(),getSelection:function(){var n=window.getSelection,m=document.selection;if(n){return n()+'';}else if(m)return m.createRange().text;return null;},create:function(o,m,n){o=document.createElement(o);if(m){m=copy_properties({},m);if(m.style){copy_properties(o.style,m.style);delete m.style;}for(var p in m)if(p.toLowerCase().indexOf('on')==0){if(!(typeof m[p]!='function'))if(window.Event&&Event.listen){Event.listen(o,p.substr(2),m[p]);}else o[p]=m[p];delete m[p];}copy_properties(o,m);}if(n!=undefined)e.setContent(o,n);return o;},prependContent:function(o,n){if(!e.isNode(o))throw new Error('DOM.prependContent: reference element is not a node');var m=function(p){if(o.firstChild){o.insertBefore(p,o.firstChild);}else o.appendChild(p);};return e._addContent(n,m,o);},insertAfter:function(o,n){if(!e.isNode(o)||!o.parentNode)throw new Error('DOM.insertAfter: reference element is not a node');var m=function(p){if(o.nextSibling){o.parentNode.insertBefore(p,o.nextSibling);}else o.parentNode.appendChild(p);};return e._addContent(n,m,o.parentNode);},insertBefore:function(n,o){if(!e.isNode(o)||!o.parentNode)throw new Error('DOM.insertBefore: reference element is not a node or '+'does not have a parent.');var m=function(p){o.parentNode.insertBefore(p,o);};return e._addContent(n,m,o.parentNode);},setContent:function(n,m){if(!e.isNode(n))throw new Error('DOM.setContent: reference element is not a node');e.empty(n);return e.appendContent(n,m);},appendContent:function(o,n){if(!e.isNode(o))throw new Error('DOM.appendContent: reference element is not a node');var m=function(p){o.appendChild(p);};return e._addContent(n,m,o);},replace:function(o,n){if(!e.isNode(o)||!o.parentNode)throw new Error('DOM.replace: reference element must be a node with a'+' parent');var m=function(p){o.parentNode.replaceChild(p,o);};return e._addContent(n,m,o.parentNode);},remove:function(m){m=a(m);if(m.parentNode)m.parentNode.removeChild(m);},empty:function(m){m=a(m);while(m.firstChild)e.remove(m.firstChild);},contains:function(n,m){n=i(n);m=i(m);if(!n||!m){return false;}else if(n===m){return true;}else if(e.isTextNode(n)){return false;}else if(e.isTextNode(m)){return e.contains(n,m.parentNode);}else if(n.contains){return n.contains(m);}else if(n.compareDocumentPosition){return !!(n.compareDocumentPosition(m)&16);}else return false;},getRootElement:function(){var m=null;if(window.Quickling&&Quickling.isActive())m=i('content');return m||document.body;},isNode:function(m){return !!(m&&(typeof Node=='object'?m instanceof Node:typeof m=="object"&&typeof m.nodeType=='number'&&typeof m.nodeName=='string'));},isNodeOfType:function(n,o){var m=Object.from(b(o).join('|').toUpperCase().split('|'));return e.isNode(n)&&n.nodeName in m;},isElementNode:function(m){return e.isNode(m)&&m.nodeType==1;},isTextNode:function(m){return e.isNode(m)&&m.nodeType==3;},_addContent:function(p,m,y){p=f.replaceJSONWrapper(p);if(p instanceof f&&-1==p.toString().indexOf('<scr'+'ipt')&&''==y.innerHTML){var s=ua.ie();if(!s||(s>7&&!e.isNodeOfType(y,['table','tbody','thead','tfoot','tr','select','fieldset']))){var t=s?"<em style=\"display:none;\">&nbsp;</em>":"";y.innerHTML=t+p;s&&y.removeChild(y.firstChild);return b(y.childNodes);}}else if(e.isTextNode(y)){y.data=p;return [p];}var v,q=[],n=[];var r=document.createDocumentFragment();if(!(p instanceof Array))p=[p];for(var u=0;u<p.length;u++){v=f.replaceJSONWrapper(p[u]);if(v instanceof f){n.push(v.getAction());var x=v.getNodes(),o;for(var w=0;w<x.length;w++){o=(ua.safari()||(ua.ie()&&v.ieCloneBug()))?x[w]:x[w].cloneNode(true);q.push(o);r.appendChild(o);}}else if(g.isScalar(v)){var z=document.createTextNode(v);q.push(z);r.appendChild(z);}else if(e.isNode(v)){q.push(v);r.appendChild(v);}else if(!(v instanceof Array))v!==null;}m(r);for(var u=0;u<n.length;u++)n[u]();return q;}};function c(o,m,n){if(typeof m!='object'||e.isNode(m)||m instanceof Array||f.isHTML(m)){n=m;m=null;}return e.create(o,m,n);}j.$N=e.$N=c;j.DOM=k.exports=e;},3);
__d("css",["dom","css-core"],function(d,e,f,c){var b=f('dom');var a=f('css-core');copy_properties(a,{shown:function(g){return !a.hasClass(g,'hidden_elem');},toggle:function(g){a.conditionShow(g,!a.shown(g));},setClass:function(h,g){$(h).className=g||'';return h;},setStyle:function(g,h,i){switch(h){case 'opacity':g.style.opacity=i;g.style.filter=i!==''?'alpha(opacity='+i*100+')':'';break;case 'float':g.style.cssFloat=g.style.styleFloat=i;break;default:h=h.replace(/-(.)/g,function(j,k){return k.toUpperCase();});g.style[h]=i;}return g;},getStyle:function(h,j){h=$(h);j=j.replace(/-(.)/g,function(k,l){return l.toUpperCase();});function i(k){return k.replace(/([A-Z])/g,'-$1').toLowerCase();}if(window.getComputedStyle){var g=window.getComputedStyle(h,null);if(g)return g.getPropertyValue(i(j));}if(document.defaultView&&document.defaultView.getComputedStyle){var g=document.defaultView.getComputedStyle(h,null);if(g)return g.getPropertyValue(i(j));if(j=="display")return "none";}if(h.currentStyle)return h.currentStyle[j];return h.style&&h.style[j];},getStyleFloat:function(g,h){return parseFloat(a.getStyle(g,h),10);},getOpacity:function(g){g=$(g);var h=a.getStyle(g,'filter');var i=null;if(h&&(i=/(\d+(?:\.\d+)?)/.exec(h))){return parseFloat(i.pop())/100;}else if(h=a.getStyle(g,'opacity')){return parseFloat(h);}else return 1;},isFixed:function(g){while(g!==document.documentElement){if(a.getStyle(g,'position')==='fixed')return true;g=g.parentNode;}return false;},getScrollParent:function(g){while(g!==document.body){var h=a.getStyle(g,'overflow');if(h==='auto'||h==='scroll')return g;g=g.parentNode;}return window;}});e.exports=a;},3);
__d("uri",["dom","object-core-utils"],function(e,f,g,d){var a=g('dom');var c=g('object-core-utils').copy_properties;function b(h){if(!(this instanceof b))return new b(h||window.location.href);this.parse(h||'');}c(b,{getRequestURI:function(h,i){h=h===undefined||h;if(h&&window.PageTransitions&&PageTransitions.isInitialized()){return PageTransitions.getCurrentURI(!!i).getQualifiedURI();}else return new b(window.location.href);},getMostRecentURI:function(){if(window.PageTransitions&&PageTransitions.isInitialized()){return PageTransitions.getMostRecentURI().getQualifiedURI();}else return new b(window.location.href);},getNextURI:function(){if(window.PageTransitions&&PageTransitions.isInitialized()){return PageTransitions.getNextURI().getQualifiedURI();}else return new b(window.location.href);},expression:/(((\w+):\/\/)([^\/:]*)(:(\d+))?)?([^#?]*)(\?([^#]*))?(#(.*))?/,arrayQueryExpression:/^(\w+)((?:\[\w*\])+)=?(.*)/,explodeQuery:function(n){if(!n)return {};var o={};n=n.replace(/%5B/ig,'[').replace(/%5D/ig,']');n=n.split('&');for(var i=0,k=n.length;i<k;i++){var l=n[i].match(b.arrayQueryExpression);if(!l){var q=n[i].split('=');o[b.decodeComponent(q[0])]=q[1]===undefined?null:b.decodeComponent(q[1]);}else{var j=l[2].split(/\]\[|\[|\]/).slice(0,-1);var m=l[1];var r=b.decodeComponent(l[3]||'');j[0]=m;var p=o;for(var h=0;h<j.length-1;h++)if(j[h]){if(p[j[h]]===undefined)if(j[h+1]&&!j[h+1].match(/\d+$/)){p[j[h]]={};}else p[j[h]]=[];p=p[j[h]];}else{if(j[h+1]&&!j[h+1].match(/\d+$/)){p.push({});}else p.push([]);p=p[p.length-1];}if(p instanceof Array&&j[j.length-1]==''){p.push(r);}else p[j[j.length-1]]=r;}}return o;},implodeQuery:function(m,l,h){l=l||'';if(h===undefined)h=true;var n=[];if(m===null||m===undefined){n.push(h?b.encodeComponent(l):l);}else if(m instanceof Array){for(var j=0;j<m.length;++j)try{if(m[j]!==undefined)n.push(b.implodeQuery(m[j],l?(l+'['+j+']'):j));}catch(i){}}else if(typeof(m)=='object'){if(a.isNode(m)){n.push('{node}');}else for(var k in m)try{if(m[k]!==undefined)n.push(b.implodeQuery(m[k],l?(l+'['+k+']'):k));}catch(i){}}else if(h){n.push(b.encodeComponent(l)+'='+b.encodeComponent(m));}else n.push(l+'='+m);return n.join('&');},encodeComponent:function(k){var j=String(k).split(/([\[\]])/);for(var h=0,i=j.length;h<i;h+=2)j[h]=encodeURIComponent(j[h]);return j.join('');},decodeComponent:function(h){return decodeURIComponent(h.replace(/\+/g,' '));},INVALID_DOMAIN:'invalid.invalid',sanitizeDomain:function(h){var i=new RegExp('[\\x00-\\x2c\\x2f\\x3b-\\x40\\x5c\\x5e\\x60\\x7b-\\x7f'+'\\uFDD0-\\uFDEF\\uFFF0-\\uFFFF'+'\\u2047\\u2048\\uFE56\\uFE5F\\uFF03\\uFF0F\\uFF1F]');if(i.test(h)){return b.INVALID_DOMAIN;}else return h;}});c(b.prototype,{parse:function(i){var h=i.toString().match(b.expression);c(this,{protocol:h[3]||'',domain:b.sanitizeDomain(h[4]||''),port:h[6]||'',path:h[7]||'',query_s:h[9]||'',fragment:h[11]||''});return this;},setProtocol:function(h){this.protocol=h;return this;},getProtocol:function(){return this.protocol;},setQueryData:function(h){this.query_s=b.implodeQuery(h);return this;},addQueryData:function(h){return this.setQueryData(c(this.getQueryData(),h));},removeQueryData:function(i){if(!(i instanceof Array))i=[i];var k=this.getQueryData();for(var h=0,j=i.length;h<j;++h)delete k[i[h]];return this.setQueryData(k);},getQueryData:function(){return b.explodeQuery(this.query_s);},setFragment:function(h){this.fragment=h;return this;},getFragment:function(){return this.fragment;},setDomain:function(h){this.domain=b.sanitizeDomain(h);return this;},getDomain:function(){return this.domain;},setPort:function(h){this.port=h;return this;},getPort:function(){return this.port;},setPath:function(h){this.path=h;return this;},getPath:function(){return this.path.replace(/^\/+/,'/');},isEmpty:function(){return !(this.path||this.protocol||this.domain||this.port||this.query_s||this.fragment);},toString:function(){var h='';this.protocol&&(h+=this.protocol+'://');this.domain&&(h+=this.domain);this.port&&(h+=':'+this.port);if(this.domain&&!this.path)h+='/';this.path&&(h+=this.path);this.query_s&&(h+='?'+this.query_s);this.fragment&&(h+='#'+this.fragment);return h;},valueOf:function(){return this.toString();},isFacebookURI:function(){if(!b._facebookURIRegex)b._facebookURIRegex=new RegExp('(^|\\.)facebook\\.com([^.]*)$','i');return (!this.domain||b._facebookURIRegex.test(this.domain));},isQuicklingEnabled:function(){return window.Quickling&&Quickling.isActive()&&Quickling.isPageActive(this);},getRegisteredDomain:function(){if(!this.domain)return '';if(!this.isFacebookURI())return null;var i=this.domain.split('.');var h=i.indexOf('facebook');return i.slice(h).join('.');},getUnqualifiedURI:function(){return new b(this).setProtocol(null).setDomain(null).setPort(null);},getQualifiedURI:function(){var i=new b(this);if(!i.getDomain()){var h=b();i.setProtocol(h.getProtocol()).setDomain(h.getDomain()).setPort(h.getPort());}return i;},isSameOrigin:function(h){var i=h||window.location.href;if(!(i instanceof b))i=new b(i.toString());if(this.getProtocol()&&this.getProtocol()!=i.getProtocol())return false;if(this.getDomain()&&this.getDomain()!=i.getDomain())return false;return true;},go:function(h){goURI(this,h);},setSubdomain:function(i){var j=new b(this).getQualifiedURI();var h=j.getDomain().split('.');if(h.length<=2){h.unshift(i);}else h[0]=i;return j.setDomain(h.join('.'));},getSubdomain:function(){if(!this.getDomain())return '';var h=this.getDomain().split('.');if(h.length<=2){return '';}else return h[0];},setSecure:function(h){return this.setProtocol(h?'https':'http');},isSecure:function(){return this.getProtocol()=='https';}});e.URI=f.exports=b;},3);
if(!this.JSON)this.JSON={};(function(){function f(n){return n<10?'0'+n:n;}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+f(this.getUTCMonth()+1)+'-'+f(this.getUTCDate())+'T'+f(this.getUTCHours())+':'+f(this.getUTCMinutes())+':'+f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function')value=value.toJSON(key);if(typeof rep==='function')value=rep.call(holder,key,value);switch(typeof value){case 'string':return quote(value);case 'number':return isFinite(value)?String(value):'null';case 'boolean':case 'null':return String(value);case 'object':if(!value)return 'null';gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1)partial[i]=str(i,value)||'null';v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v)partial.push(quote(k)+(gap?': ':':')+v);}}}else for(k in value)if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v)partial.push(quote(k)+(gap?': ':':')+v);}v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}if(typeof JSON.stringify!=='function')JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1)indent+=' ';}else if(typeof space==='string')indent=space;rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number'))throw new Error('JSON.stringify');return str('',{'':value});};if(typeof JSON.parse!=='function')JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object')for(k in value)if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else delete value[k];}return reviver.call(holder,key,value);}text=String(text);cx.lastIndex=0;if(cx.test(text))text=text.replace(cx,function(a){return '\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);});if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}throw new SyntaxError('JSON.parse');};}());
__d("async",["eval-global"],function(global,module,require,exports){function AsyncRequest(uri){var dispatchResponse=bind(this,function(asyncResponse){try{this.clearStatusIndicator();if(!this.isRelevant()){invokeErrorHandler(1010);return;}if(this.initialHandler(asyncResponse)!==false){clearTimeout(this.timer);asyncResponse.jscc&&invoke_callbacks([asyncResponse.jscc]);if(this.handler)try{var suppress_onload=this.handler(asyncResponse);}catch(exception){asyncResponse.is_last&&this.finallyHandler(asyncResponse);throw exception;}if(suppress_onload!==AsyncRequest.suppressOnloadToken){var onload=asyncResponse.onload;if(onload)for(var ii=0;ii<onload.length;ii++)try{(new Function(onload[ii])).apply(this);}catch(exception){}if(this.lid)Arbiter.inform('tti_ajax',{s:this.lid,d:[this._sendTimeStamp||0,(this._sendTimeStamp&&this._responseTime)?(this._responseTime-this._sendTimeStamp):0]},Arbiter.BEHAVIOR_EVENT);var onafterload=asyncResponse.onafterload;if(onafterload)for(var ii=0;ii<onafterload.length;ii++)try{(new Function(onafterload[ii])).apply(this);}catch(exception){}}asyncResponse.is_last&&this.finallyHandler(asyncResponse);}}catch(exception){}});var dispatchErrorResponse=bind(this,function(asyncResponse,isTransport){try{this.clearStatusIndicator();var async_error=asyncResponse.getError();if(this._sendTimeStamp){var _duration=Date.now()-this._sendTimeStamp;var xfb_ip=this._xFbServer||'-';asyncResponse.logError('async_error',{duration:_duration,xfb_ip:xfb_ip});}else asyncResponse.logError('async_error');if((!this.isRelevant())||async_error===1010)return;if(async_error==1357008||async_error==1357007||async_error==1442002||async_error==1357001){var is_confirmation=false;if(async_error==1357008||async_error==1357007)is_confirmation=true;var payload=asyncResponse.getPayload();this._displayServerDialog(payload.__dialog,is_confirmation);}else if(this.initialHandler(asyncResponse)!==false){clearTimeout(this.timer);try{if(isTransport){this.transportErrorHandler(asyncResponse);}else this.errorHandler(asyncResponse);}catch(exception){this.finallyHandler(asyncResponse);throw exception;}this.finallyHandler(asyncResponse);}}catch(exception){}});var _interpretTransportResponse=bind(this,function(){if(this.getOption('suppressEvaluation')){var r=new AsyncResponse(this,this.transport);return {asyncResponse:r};}var _sendError=function(p,error_code,str){if(!window.send_error_signal)return;if(this._xFbServer){error_code='1008_'+error_code;}else error_code='1012_'+error_code;send_error_signal('async_xport_resp',error_code+':'+(this._xFbServer||'-')+':'+p.getURI()+':'+str.length+':'+str.substr(0,1600));};var shield="for (;;);";var shieldlen=shield.length;var text=this.transport.responseText;if(text.length<=shieldlen){_sendError(this,'empty',text);return {transportError:'Response too short on async to '+this.getURI()};}var offset=0;while(text.charAt(offset)==" "||text.charAt(offset)=="\n")offset++;offset&&text.substring(offset,offset+shieldlen)==shield;var safeResponse=text.substring(offset+shieldlen);try{var response=eval('('+safeResponse+')');}catch(exception){_sendError(this,'excep',text);return {transportError:'eval() failed on async to '+this.getURI()};}return interpretResponse(response);});var interpretResponse=bind(this,function(response){if(response.redirect)return {redirect:response.redirect};var r=new AsyncResponse(this);if(response.__ar!=1){r.payload=response;}else{copy_properties(r,response);if(response.tplts)if(window.DynaTemplate)DynaTemplate.registerTemplates(response.tplts);}return {asyncResponse:r};});var invokeResponseHandler=bind(this,function(interp){if(typeof(interp.redirect)!='undefined'){(function(){this.setURI(interp.redirect).send();}).bind(this).defer();return;}if(this.handler||this.errorHandler||this.transportErrorHandler)if(typeof(interp.asyncResponse)!='undefined'){var r=interp.asyncResponse;if(!this.isRelevant()){invokeErrorHandler(1010);return;}if(r.inlinejs){var eval_global=require('eval-global').eval_global;eval_global(r.inlinejs);}if(r.lid){this._responseTime=Date.now();if(window.CavalryLogger)this.cavalry=CavalryLogger.getInstance(r.lid);this.lid=r.lid;}if(r.getError()&&!r.getErrorIsWarning()){var fn=dispatchErrorResponse;}else var fn=dispatchResponse;Bootloader.setResourceMap(r.resource_map);if(r.bootloadable)Bootloader.enableBootload(r.bootloadable);fn=fn.shield(null,r);fn=fn.defer.bind(fn);var is_transitional=false;if(this.preBootloadHandler)is_transitional=this.preBootloadHandler(r);r.css=r.css||[];r.js=r.js||[];Bootloader.loadResources(r.css.concat(r.js),fn,is_transitional,this.getURI());}else if(typeof(interp.transportError)!='undefined'){if(this._xFbServer){invokeErrorHandler(1008);}else invokeErrorHandler(1012);}else invokeErrorHandler(1007);});var invokeErrorHandler=bind(this,function(explicitError){try{if(!window.loaded&&!this.getOption('handleErrorAfterUnload'))return;}catch(ex){return;}var r=new AsyncResponse(this);var err;try{err=explicitError||this.transport.status||1004;}catch(ex){err=1005;}if(this._requestAborted)err=1011;try{if(this.responseText=='')err=1002;}catch(ignore){}if(this.transportErrorHandler){var desc,summary;var silent=true;if(false===navigator.onLine){summary=_tx("No Network Connection");desc=_tx("Your browser appears to be offline. Please check your internet connection and try again.");err=1006;}else if(err>=300&&err<=399){summary=_tx("Redirection");desc=_tx("Your access to Facebook was redirected or blocked by a third party at this time, please contact your ISP or reload. ");redir_url=this.transport.getResponseHeader("Location");if(redir_url)goURI(redir_url,true);silent=true;}else{summary=_tx("Oops!");desc=_tx("Something went wrong. We're working on getting this fixed as soon as we can. You may be able to try again.");}!this.getOption('suppressErrorAlerts');copy_properties(r,{error:err,errorSummary:summary,errorDescription:desc,silentError:silent});dispatchErrorResponse(r,true);}});var handleResponse=function(response){var asyncResponse=this.interpretResponse(response);this.invokeResponseHandler(asyncResponse);};var onStateChange=function(){try{if(this.transport.readyState==4){AsyncRequest._inflightPurge();try{if(typeof(this.transport.getResponseHeader)!='undefined'&&this.transport.getResponseHeader('X-FB-Server'))this._xFbServer=this.transport.getResponseHeader('X-FB-Server');}catch(ex){}if(this.transport.status>=200&&this.transport.status<300){invokeResponseHandler(_interpretTransportResponse());}else if(ua.safari()&&(typeof(this.transport.status)=='undefined')){invokeErrorHandler(1002);}else if(window.Env&&window.Env.retry_ajax_on_network_error&&this.transport.status in {0:1,12029:1,12030:1,12031:1,12152:1}&&this.remainingRetries>0){--this.remainingRetries;delete this.transport;this.send(true);return;}else invokeErrorHandler();if(this.getOption('asynchronous')!==false)delete this.transport;}}catch(exception){try{if(!window.loaded)return;}catch(ex){return;}delete this.transport;if(this.remainingRetries>0){--this.remainingRetries;this.send(true);}else{!this.getOption('suppressErrorAlerts');if(window.send_error_signal)send_error_signal('async_xport_resp','1007:'+(this._xFbServer||'-')+':'+this.getURI()+':'+exception.message);invokeErrorHandler(1007);}}};var onJSONPResponse=function(data,more_chunked_response){var is_first=(this.is_first===undefined);this.is_first=is_first;if(this.transportIframe&&!more_chunked_response){if(this.cavalry)this.cavalry.collectBrowserTiming(this.transportIframe.contentWindow);(function(x){document.body.removeChild(x);}).bind(null,this.transportIframe).defer();}if(ua.ie()>=9&&window.JSON)data=window.JSON.parse(window.JSON.stringify(data));var r=this.interpretResponse(data);r.asyncResponse.is_first=is_first;r.asyncResponse.is_last=!more_chunked_response;this.invokeResponseHandler(r);return more_chunked_response;};copy_properties(this,{onstatechange:onStateChange,onjsonpresponse:onJSONPResponse,invokeResponseHandler:invokeResponseHandler,interpretResponse:interpretResponse,handleResponse:handleResponse,transport:null,method:'POST',uri:'',timeout:null,timer:null,initialHandler:bagofholding,handler:null,errorHandler:null,transportErrorHandler:null,timeoutHandler:null,finallyHandler:bagofholding,serverDialogCancelHandler:bagofholding,relativeTo:null,statusElement:null,statusClass:'',data:{},file:null,context:{},readOnly:false,writeRequiredParams:['post_form_id'],remainingRetries:0,option:{asynchronous:true,suppressErrorHandlerWarning:false,suppressEvaluation:false,suppressErrorAlerts:false,retries:0,jsonp:false,bundle:false,useIframeTransport:false,tfbEndpoint:true,handleErrorAfterUnload:false},userActionID:'-'});this.errorHandler=AsyncResponse.defaultErrorHandler;this.transportErrorHandler=bind(this,'errorHandler');if(uri!=undefined)this.setURI(uri);return this;}Arbiter.subscribe("page_transition",function(type,message){AsyncRequest._id_threshold=message.id;});copy_properties(AsyncRequest,{receiveJSONPResponse:function(id,data,more_chunked_response){if(this._JSONPReceivers[id]){if(!this._JSONPReceivers[id](data,more_chunked_response))delete this._JSONPReceivers[id];}else if(window.send_error_signal&&!more_chunked_response){var uri=(data.payload&&data.payload.uri)||'';send_error_signal('js_timeout_and_exception','00002:WrongSessionID:error:'+id+':'+uri);}},_bundleRequest:function(request){if(request.getOption('jsonp')||request.getOption('useIframeTransport')){request.setOption('bundle',false);return false;}else if(!request.uri.isFacebookURI()){request.setOption('bundle',false);return false;}else if(!request.getOption('asynchronous')){request.setOption('bundle',false);return false;}var path=request.uri.getPath();if(!AsyncRequest._bundleTimer)AsyncRequest._bundleTimer=setTimeout(function(){AsyncRequest._sendBundledRequests();},0);AsyncRequest._allBundledRequests.push([path,request]);return true;},_sendBundledRequests:function(){clearTimeout(AsyncRequest._bundleTimer);AsyncRequest._bundleTimer=null;var bundled_requests=AsyncRequest._allBundledRequests;AsyncRequest._allBundledRequests=[];if(bundled_requests.length==1){var request=bundled_requests[0][1];request.setOption('bundle',false).send();return request;}if(bundled_requests.length===0)return null;var data=[];for(var ii=0;ii<bundled_requests.length;ii++)data.push([bundled_requests[ii][0],URI.implodeQuery(bundled_requests[ii][1].data)]);var query_data={data:data};var request=new AsyncRequest();request.setURI('/ajax/proxy.php').setData(query_data).setMethod('POST').setInitialHandler(bagof(true)).setAllowCrossPageTransition(true).setHandler(function(r){var payload=r.getPayload();var responses=payload.responses;if(responses.length!=bundled_requests.length){return;}else for(var ii=0;ii<bundled_requests.length;ii++){var path=bundled_requests[ii][0];var request=bundled_requests[ii][1];request.id=this.id;if(responses[ii][0]!=path){request.invokeResponseHandler({transportError:'Wrong response order in bundled request to '+path});continue;}var asyncResponse=request.interpretResponse(responses[ii][1]);request.invokeResponseHandler(asyncResponse);}}).setTransportErrorHandler(function(response){var paths=[];var interp={transportError:response.errorDescription};for(var ii=0;ii<bundled_requests.length;ii++){var path=bundled_requests[ii][0];var request=bundled_requests[ii][1];paths.push(path);request.id=this.id;request.invokeResponseHandler(interp);}}).send();return request;},bootstrap:function(href,elem,is_post){var method='GET';var readonly=true;var data={};if(is_post||elem&&(elem.rel=='async-post'||elem.getAttribute&&elem.getAttribute('forcemethod')=='post')){method='POST';readonly=false;if(href){href=URI(href);data=href.getQueryData();href.setQueryData({});}}var status_elem=Parent.byClass(elem,'stat_elem')||elem;if(status_elem&&CSS.hasClass(status_elem,'async_saving'))return false;var async=new AsyncRequest(href).setReadOnly(readonly).setMethod(method).setData(data).setNectarModuleDataSafe(elem).setRelativeTo(elem);if(status_elem){async.setStatusElement(status_elem);var status_class=status_elem.getAttribute('data-status-class');status_class&&async.setStatusClass(status_class);}async.send();return false;},post:function(href,data){new AsyncRequest(href).setReadOnly(false).setMethod('POST').setData(data).send();return false;},getLastId:function(){return AsyncRequest._last_id;},_JSONPReceivers:{},_allBundledRequests:[],_bundleTimer:null,suppressOnloadToken:{},_last_id:2,_id_threshold:2,_inflight:[],_inflightAdd:bagofholding,_inflightPurge:bagofholding,_inflightEnable:function(){if(ua.ie()){copy_properties(AsyncRequest,{_inflightAdd:function(ar){this._inflight.push(ar);},_inflightPurge:function(){AsyncRequest._inflight=AsyncRequest._inflight.filter(function(ar){return ar.transport&&ar.transport.readyState<4;});}});onunloadRegister(function(){AsyncRequest._inflight.each(function(ar){if(ar.transport&&ar.transport.readyState<4){ar.transport.abort();delete ar.transport;}});});}}});copy_properties(AsyncRequest.prototype,{setMethod:function(m){this.method=m.toString().toUpperCase();return this;},getMethod:function(){return this.method;},setData:function(obj){this.data=obj;return this;},setFile:function(file){this.file=file;return this;},getData:function(){return this.data;},setContextData:function(key,value,enabled){enabled=enabled===undefined?true:enabled;if(enabled)this.context['_log_'+key]=value;return this;},_setUserActionID:function(){var ue=window.ArbiterMonitor&&ArbiterMonitor.getUE()||'-';this.userActionID=(window.EagleEye&&EagleEye.getSessionID()||'-')+'/'+ue;},setURI:function(uri){var uri_obj=URI(uri);if(this.getOption('useIframeTransport')&&!uri_obj.isFacebookURI())return this;if(!this.getOption('jsonp')&&!this.getOption('useIframeTransport')&&!uri_obj.isSameOrigin())return this;this._setUserActionID();if(!uri||uri_obj.isEmpty()){if(window.send_error_signal&&window.get_error_stack){var data={err_code:1013,vip:'-',duration:0,xfb_ip:'-',path:window.location.href,aid:this.userActionID};send_error_signal('async_error',JSON.stringify(data));send_error_signal('async_xport_stack','1013:'+window.location.href+'::'+get_error_stack());}return this;}this.uri=uri_obj;return this;},getURI:function(){return this.uri.toString();},setInitialHandler:function(fn){this.initialHandler=fn;return this;},setHandler:function(fn){if(!(typeof(fn)!='function'))this.handler=fn;return this;},getHandler:function(){return this.handler;},setErrorHandler:function(fn){if(!(typeof(fn)!='function'))this.errorHandler=fn;return this;},setTransportErrorHandler:function(fn){this.transportErrorHandler=fn;return this;},getErrorHandler:function(){return this.errorHandler;},getTransportErrorHandler:function(){return this.transportErrorHandler;},setTimeoutHandler:function(timeout,fn){if(!(typeof(fn)!='function')){this.timeout=timeout;this.timeoutHandler=fn;}return this;},resetTimeout:function(timeout){if(!(this.timeoutHandler===null))if(timeout===null){this.timeout=null;clearTimeout(this.timer);this.timer=null;}else{var clear_on_quickling_event=!this._allowCrossPageTransition;this.timeout=timeout;clearTimeout(this.timer);this.timer=this._handleTimeout.bind(this).defer(this.timeout,clear_on_quickling_event);}return this;},_handleTimeout:function(){this.abandon();this.timeoutHandler(this);},setNewSerial:function(){this.id=++AsyncRequest._last_id;return this;},setFinallyHandler:function(fn){this.finallyHandler=fn;return this;},setServerDialogCancelHandler:function(fn){this.serverDialogCancelHandler=fn;return this;},setPreBootloadHandler:function(fn){this.preBootloadHandler=fn;return this;},setReadOnly:function(readOnly){if(!(typeof(readOnly)!='boolean'))this.readOnly=readOnly;return this;},setFBMLForm:function(){this.writeRequiredParams=["fb_sig"];return this;},getReadOnly:function(){return this.readOnly;},setRelativeTo:function(element){this.relativeTo=element;return this;},getRelativeTo:function(){return this.relativeTo;},setStatusClass:function(c){this.statusClass=c;return this;},setStatusElement:function(element){this.statusElement=element;return this;},getStatusElement:function(){return ge(this.statusElement);},isRelevant:function(){if(this._allowCrossPageTransition)return true;if(!this.id)return true;return this.id>AsyncRequest._id_threshold;},clearStatusIndicator:function(){var statusElem=this.getStatusElement();if(statusElem){CSS.removeClass(statusElem,'async_saving');CSS.removeClass(statusElem,this.statusClass);}},addStatusIndicator:function(){var statusElem=this.getStatusElement();if(statusElem){CSS.addClass(statusElem,'async_saving');CSS.addClass(statusElem,this.statusClass);}},specifiesWriteRequiredParams:function(){return this.writeRequiredParams.every(function(param){this.data[param]=this.data[param]||Env[param]||(ge(param)||{}).value;if(this.data[param]!==undefined)return true;return false;},this);},setOption:function(opt,v){if(typeof(this.option[opt])!='undefined')this.option[opt]=v;return this;},getOption:function(opt){typeof(this.option[opt])=='undefined';return this.option[opt];},abort:function(){if(this.transport){var old_handler=this.getTransportErrorHandler();this.setOption('suppressErrorAlerts',true);this.setTransportErrorHandler(bagofholding);this._requestAborted=1;this.transport.abort();this.setTransportErrorHandler(old_handler);}},abandon:function(){clearTimeout(this.timer);this.setOption('suppressErrorAlerts',true).setHandler(bagofholding).setErrorHandler(bagofholding).setTransportErrorHandler(bagofholding);if(this.transport){this._requestAborted=1;this.transport.abort();}},setNectarData:function(nctrParams){if(nctrParams){if(this.data.nctr===undefined)this.data.nctr={};copy_properties(this.data.nctr,nctrParams);}return this;},setNectarModuleDataSafe:function(elem){if(this.setNectarModuleData)this.setNectarModuleData(elem);return this;},setNectarImpressionIdSafe:function(){if(this.setNectarImpressionId)this.setNectarImpressionId();return this;},setAllowCrossPageTransition:function(allow){this._allowCrossPageTransition=!!allow;if(this.timer)this.resetTimeout(this.timeout);return this;},send:function(isRetry){isRetry=isRetry||false;if(!this.uri)return false;!this.errorHandler&&!this.getOption('suppressErrorHandlerWarning');if(this.getOption('jsonp')&&this.method!='GET')this.setMethod('GET');if(this.getOption('useIframeTransport')&&this.method!='GET')this.setMethod('GET');this.timeoutHandler!==null&&(this.getOption('jsonp')||this.getOption('useIframeTransport'));if(!this.getReadOnly()){this.specifiesWriteRequiredParams();if(this.method!='POST')return false;}if(this.method=='POST'&&this.getOption('tfbEndpoint')){this.data.fb_dtsg=Env.fb_dtsg;this.data.lsd=getCookie('lsd');}if(!is_empty(this.context)&&this.getOption('tfbEndpoint')){copy_properties(this.data,this.context);this.data.ajax_log=1;}if(window.Env&&Env.force_param)copy_properties(this.data,Env.force_param);if(!this.getReadOnly()&&this.getOption('tfbEndpoint')&&this.method=='POST'&&this.data.post_form_id_source===undefined)this.data.post_form_id_source='AsyncRequest';if(window.Env)this.data.__user=Env.user;this._setUserActionID();if(this.getOption('bundle')&&AsyncRequest._bundleRequest(this))return true;this.setNewSerial();if(this.getOption('tfbEndpoint')){this.uri.addQueryData({__a:1});if(Env.fb_isb)this.uri.addQueryData({fb_isb:Env.fb_isb});}this.finallyHandler=async_callback(this.finallyHandler,'final');var uri_str,query;if(this.method=='GET'||this.file){uri_str=this.uri.addQueryData(this.data).toString();query='';}else{uri_str=this.uri.toString();query=URI.implodeQuery(this.data);}if(this.getOption('jsonp')||this.getOption('useIframeTransport')){uri_str=this.uri.addQueryData({__a:this.id}).toString();AsyncRequest._JSONPReceivers[this.id]=async_callback(bind(this,'onjsonpresponse'),'json');if(this.getOption('jsonp')){(function(){document.body.appendChild($N('script',{src:uri_str,type:"text/javascript"}));}).bind(this).defer();}else{var style={position:'absolute',top:'-9999999px',width:'80px',height:'80px'};this.transportIframe=$N('iframe',{src:"javascript:''",style:style});document.body.appendChild(this.transportIframe);this.transportIframe.src=uri_str;}return true;}if(this.transport)return false;var transport=null;try{transport=new XMLHttpRequest();}catch(ignored){}if(!transport)try{transport=new ActiveXObject("Msxml2.XMLHTTP");}catch(ignored){}if(!transport)try{transport=new ActiveXObject("Microsoft.XMLHTTP");}catch(ignored){}if(!transport)return false;transport.onreadystatechange=async_callback(bind(this,'onstatechange'),'xhr');if(!isRetry)this.remainingRetries=this.getOption('retries');if(window.send_error_signal||window.ArbiterMonitor)this._sendTimeStamp=this._sendTimeStamp||Date.now();this.transport=transport;try{this.transport.open(this.method,uri_str,this.getOption('asynchronous'));}catch(ex){return false;}var svn_rev=env_get('svn_rev');if(svn_rev)this.transport.setRequestHeader('X-SVN-Rev',String(svn_rev));if(this.method=='POST')this.transport.setRequestHeader('Content-Type','application/x-www-form-urlencoded');this.addStatusIndicator();query=this.file||query;this.transport.send(query);if(this.timeout!==null)this.resetTimeout(this.timeout);AsyncRequest._inflightAdd(this);return true;},_displayServerDialog:function(model,is_confirmation){Bootloader.loadComponents('dialog',function(){var dialog=new Dialog(model);if(is_confirmation)dialog.setHandler(this._displayConfirmationHandler.bind(this,dialog));dialog.setCancelHandler(function(){this.serverDialogCancelHandler.apply(this,arguments);this.finallyHandler.apply(this,arguments);}.bind(this)).setCloseHandler(this.finallyHandler.bind(this)).show();}.bind(this));},_displayConfirmationHandler:function(dialog){this.data.confirmed=1;copy_properties(this.data,dialog.getFormData());this.send();}});function AsyncResponse(request,payload){copy_properties(this,{error:0,errorSummary:null,errorDescription:null,onload:null,replay:false,payload:payload||null,request:request||null,silentError:false,is_last:true});return this;}copy_properties(AsyncResponse,{defaultErrorHandler:function(response){try{if(!response.silentError){AsyncResponse.verboseErrorHandler(response);}else response.logErrorByGroup('silent',10);}catch(ex){alert(response);}},verboseErrorHandler:function(response){try{var summary=response.getErrorSummary();var desc=response.getErrorDescription();response.logErrorByGroup('popup',10);if(response.silentError&&desc=='')desc=_tx("Something went wrong. We're working on getting this fixed as soon as we can. You may be able to try again.");Bootloader.loadComponents('dialog',function(){new Dialog().setTitle(summary).setBody(desc).setButtons([Dialog.OK]).setModal(true).show();});}catch(ex){alert(response);}}});copy_properties(AsyncResponse.prototype,{getRequest:function(){return this.request;},getPayload:function(){return this.payload;},getError:function(){return this.error;},getErrorSummary:function(){return this.errorSummary;},setErrorSummary:function(summary){summary=(summary===undefined?null:summary);this.errorSummary=summary;return this;},getErrorDescription:function(){return this.errorDescription;},getErrorIsWarning:function(){return this.errorIsWarning;},logError:function(category,extra){if(window.send_error_signal){var data={err_code:this.error,vip:(env_get('vip')||'-')};if(extra!==undefined){data.duration=extra.duration;data.xfb_ip=extra.xfb_ip;}var path=this.request.getURI();data.path=path||'-';data.aid=this.request.userActionID;if(path&&path.indexOf('scribe_endpoint.php')!=-1)category='async_error_double';send_error_signal(category,JSON.stringify(data));}},logErrorByGroup:function(suffix,log_rate){if(Math.floor(Math.random()*log_rate)==0)if(this.error==1357010||this.error<15000){this.logError('async_error_oops_'+suffix);}else this.logError('async_error_logic_'+suffix);}});global.AsyncRequest=module.exports=AsyncRequest;global.AsyncResponse=AsyncResponse;},3);
__d("data-store",[],function(i,j,k,h){var f={};var c={};var g=1;var b=1;function d(l){var m;if(typeof l=='string'){m='str_'+l;}else{m='elem_'+(l.__FB_TOKEN||(l.__FB_TOKEN=[g++]))[0];c[m]=l;}return f[m]||(f[m]={});}function e(l){if(!l.nodeName)return false;try{if(null!=l.offsetParent)return false;}catch(m){}if(document.documentElement.contains){return !document.documentElement.contains(l);}else return (document.documentElement.compareDocumentPosition(l)&b);}var a=window.DataStore||{set:function(n,m,o){var l=d(n);l[m]=o;return n;},get:function(p,o,n){var m=d(p),q=m[o];if(typeof q==='undefined'&&p.getAttribute){var l=p.getAttribute('data-'+o);q=(null===l)?undefined:l;}if((n!==undefined)&&(q===undefined))q=m[o]=n;return q;},remove:function(n,m){var l=d(n),o=l[m];delete l[m];return o;},cleanup:function(){var m,l;for(m in c){l=c[m];if(e(l)){delete f[m];delete c[m];}}}};i.DataStore=j.exports=a;},3);
function EmuController(a,b){this.impression=b;this.containerId=a;DataStore.set($(a),'emuController',this);return this;}copy_properties(EmuController,{fromContainer:function(a){var b=ge(a);if(!b)return null;return DataStore.get(b,'emuController');},getEventClass:function(a){return "emuEvent"+String(a).trim();}});copy_properties(EmuController.prototype,{EVENT_HANDLER_PATH:'/ajax/emu/end.php',CLICK:1,FAN:"fad_fan",event:function(c,b,d,a){var e={eid:this.impression,f:0,ui:this.containerId,en:c,a:1};if(b)e.ed=JSON.stringify(b);if(!a)var a=bagofholding;var f=new AsyncRequest().setURI(this.EVENT_HANDLER_PATH).setData(e).setErrorHandler(a);if(d)f.setHandler(d);f.send();},redirect:function(){var a={eid:this.impression,f:0,ui:this.containerId,en:this.CLICK,a:0,sig:Math.floor(Math.random()*65535)+65536};var b=new URI(this.EVENT_HANDLER_PATH);b.setQueryData(a);goURI(b);}});
var ShortClickHandlers={EVENT_NAME_CAME_BACK:'cameback',onclicked:function(a){if(this.onsite)return;if(a.button!==0||a.getModifiers().any)return;this.click_ts=(+new Date());if(this.listeners!==undefined)for(var b in this.listeners)this.listeners[b].remove();this.listeners={focus:Event.listen(window,'focus',ShortClickHandlers.oncameback.bind(this))};},oncameback:function(c){var b=(+new Date())-this.click_ts;this.listeners[c.type].remove();var a={click_ts:this.click_ts,length:b,trigger:c.type};this.sendData(ShortClickHandlers.EVENT_NAME_CAME_BACK,a);}};
function EmuTracker(a,c){this.base=EmuController.fromContainer(a);!this.base;this.onsite=c;var b=DOM.scry($(a),"a."+EmuController.getEventClass(EmuTracker.EVENT_CLICK));b.each(function(d){Event.listen(d,'click',ShortClickHandlers.onclicked.bind(this));}.bind(this));return this;}copy_properties(EmuTracker,{EVENT_CLICK:1});copy_properties(EmuTracker.prototype,{sendData:function(b,a){this.base.event(b,a);}});
var NavigationMessage={NAVIGATION_BEGIN:'NavigationMessage/navigationBegin',NAVIGATION_SELECT:'NavigationMessage/navigationSelect',NAVIGATION_FIRST_RESPONSE:'NavigationMessage/navigationFirstResponse',NAVIGATION_COMPLETED:'NavigationMessage/navigationCompleted',NAVIGATION_FAILED:'NavigationMessage/navigationFailed',NAVIGATION_COUNT_UPDATE:'NavigationMessage/navigationCount',NAVIGATION_FAVORITE_UPDATE:'NavigationMessage/navigationFavoriteUpdate',NAVIGATION_ITEM_REMOVED:'NavigationMessage/navigationItemRemoved',NAVIGATION_ITEM_HIDDEN:'NavigationMessage/navigationItemHidden',INTERNAL_LOADING_BEGIN:'NavigationMessage/internalLoadingBegin',INTERNAL_LOADING_COMPLETED:'NavigationMessage/internalLoadingCompleted'};
__d("DocumentTitle",["array-extensions","arbiter"],function(j,k,l,i){l('array-extensions');var a=l('arbiter');var m=document.title;var b=1500;var h=[];var g=0;var e=null;var f=true;function d(){if(h.length>0){if(f){c.set(h[g].title,true);g=++g%h.length;f=false;}else c.reset();}else{clearInterval(e);e=null;c.reset();}}var c={get:function(){return m;},set:function(n,o){document.title=n;if(!o){m=n;a.inform('update_title',n);}},reset:function(){c.set(c.get(),true);f=true;},blink:function(o){var n={title:o};h.push(n);if(e===null)e=setInterval(d,b);return {stop:function(){var p=h.indexOf(n);if(p>=0){h.splice(p,1);if(g>p){g--;}else if(g==p&&g==h.length)g=0;}}};}};j.DocumentTitle=k.exports=c;},3);
__d("notifications-counter",["arbiter","DocumentTitle"],function(e,f,g,d){var a=g('arbiter');var b=g('DocumentTitle');var c={messages:0,notifications:0,requests:0};e.NotificationCounter=f.exports={init:function(h){a.subscribe('update_title',this._handleUpdate.bind(this));a.subscribe('jewel/count-updated',this._handleCountUpdate.bind(this));this.counterInFront=h;},getCount:function(){var i=0;for(var j in c){var h=Number(c[j]);if(typeof c[j]=='string'&&isNaN(h))return c[j];if(isNaN(h)||h<0){JSLogger.create('jewels').error('bad_count',{jewel:j,count:c[j]});continue;}i+=h;}return i;},updateTitle:function(){var h=b.get();var i=this.getCount();if(i)if(this.counterInFront){h='('+i+') '+h;}else h=h+' ('+i+')';b.set(h,true);},_handleCountUpdate:function(i,h){c[h.jewel]=h.count;this.updateTitle();},_handleUpdate:function(i,h){this.updateTitle();}};},3);
(function(){if(!window.channel){window.channel={};}else if(channel.OK)return;var a='presence/';copy_properties(channel,{ON_CONNECT:a+'connect',ON_IDLE:a+'idle',ON_SHUTDOWN:a+'shutdown',ON_INVALID_HISTORY:a+'invalid_history',ON_CONFIG:a+'config',ON_ENTER_STATE:a+'enter_state',ON_EXIT_STATE:a+'exit_state',OK:'ok',ERROR:'error',ERROR_CONN:'error_conn',ERROR_MAX:'error_max',ERROR_MISSING:'error_missing',ERROR_MSG_TYPE:'error_msg_type',ERROR_SHUTDOWN:'error_shutdown',HINT_AUTH:'shutdown auth',HINT_CONN:'shutdown conn',HINT_MAINT:'shutdown maint',HINT_INVALID_STATE:'shutdown invalid state',reason_Unknown:0,reason_AsyncError:1,reason_TooLong:2,reason_Refresh:3,reason_RefreshDelay:4,reason_UIRestart:5,reason_NeedSeq:6,reason_PrevFailed:7,reason_IFrameLoadGiveUp:8,reason_IFrameLoadRetry:9,reason_IFrameLoadRetryWorked:10,reason_PageTransitionRetry:11,reason_IFrameLoadMaxSubdomain:12,reason_NoChannelInfo:13,reason_NoChannelHost:14,getArbiterType:function(b){return a+'message:'+b;}});})();
(function(){if(window.channel_cookie)return;window.channel_cookie={subdomainIndex:null,init:function(){var a=presenceCookieManager.getSubCookie('ch');this.retryInterval=presenceCookieManager.getSubCookie('ri')||0;if(!channel.getConfig('nosubdomain')){this.subdomainIndex=0;if(a&&a.sub){for(var b=0;b<a.sub.length;b++)if(!a.sub[b]){this.subdomainIndex=b;break;}if(b==a.sub.length)if(b==channel_manager.MAX_SUBDOMAINS&&URI().isSecure()){this.subdomainIndex=null;presence.error('channel: iframe max subdomains reached');channel_manager._sendIframeError(ChannelRebuildReasons.IFrameLoadMaxSubdomain);}else this.subdomainIndex=a.sub.length;}}presenceCookieManager.register('ch',this.getInfo.bind(this));var c=(function(){this._clearSubdomain=true;presence.doSync(true);}).bind(this);if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',c);}else onunloadRegister(c);},getInfo:function(){var b={};var c=channel.getConfig('host');var e=channel.getConfig('port');if(c){if(null!==this.subdomainIndex){var a=presenceCookieManager.getSubCookie('ch');var f=(a&&a.sub)?a.sub:[];var d=f.length;f[this.subdomainIndex]=this._clearSubdomain?0:1;b.sub=f.map(function(g){return g?1:0;});}b[channel.getConfig('user_channel')]=channel.getConfig('seq',0);}b.ri=this.retryInterval;return b;}};})();
(function(){if(!window.channel){window.channel={};}else if(channel.init)return;copy_properties(channel,{inner:function(){return this.manager.transport._iframe.contentWindow.transport;},_sitevars:{},_config:{userActive:Date.now(),sessionID:(Math.random()*2147483648|0).toString(16)},init:function(){channel_cookie.init();this._config.subdomainIndex=channel_cookie.subdomainIndex;this.log=bind(this,'_log','log');this.error=bind(this,'_log','error');this.warn=bind(this,'_log','warn');if(typeof(UserActivity)!='undefined')UserActivity.subscribe(function(){this._config.userActive=Date.now();}.bind(this));},_log:function(b,c){var d=this.manager&&this.manager.transport;var a='channel2:'+(d?(d.logName+':'):'');if(b=='log'){return false;}else if(b=='warn'){return presence.warn(a+c);}else if(b=='error')return presence.error(a+c);},log:function(a){this._log('log',a);},warn:function(a){this._log('warn',a);},error:function(a){this._log('error',a);},configure:function(){$A(arguments).each(copy_properties.bind(null,this._config));Arbiter.inform(channel.ON_CONFIG,this);},getConfig:function(b,a){return b in this._config?this._config[b]:a;}});})();
__d("animation",["css"],function(d,e,f,c){var a=f('css');function b(g){if(g==undefined)return;if(d==this){return new b(g);}else{this.obj=g;this._reset_state();this.queue=[];this.last_attr=null;}}b.resolution=20;b.offset=0;b.prototype._reset_state=function(){this.state={attrs:{},duration:500};};b.prototype.stop=function(){this._reset_state();this.queue=[];return this;};b.prototype._build_container=function(){if(this.container_div){this._refresh_container();return;}if(this.obj.firstChild&&this.obj.firstChild.__animation_refs){this.container_div=this.obj.firstChild;this.container_div.__animation_refs++;this._refresh_container();return;}var h=document.createElement('div');h.style.padding='0px';h.style.margin='0px';h.style.border='0px';h.__animation_refs=1;var g=this.obj.childNodes;while(g.length)h.appendChild(g[0]);this.obj.appendChild(h);this._orig_overflow=this.obj.style.overflow;this.obj.style.overflow='hidden';this.container_div=h;this._refresh_container();};b.prototype._refresh_container=function(){this.container_div.style.height='auto';this.container_div.style.width='auto';this.container_div.style.height=this.container_div.offsetHeight+'px';this.container_div.style.width=this.container_div.offsetWidth+'px';};b.prototype._destroy_container=function(){if(!this.container_div)return;if(!--this.container_div.__animation_refs){var g=this.container_div.childNodes;while(g.length)this.obj.appendChild(g[0]);this.obj.removeChild(this.container_div);}this.container_div=null;this.obj.style.overflow=this._orig_overflow;};b.ATTR_TO=1;b.ATTR_BY=2;b.ATTR_FROM=3;b.prototype._attr=function(g,j,i){g=g.replace(/-[a-z]/gi,function(k){return k.substring(1).toUpperCase();});var h=false;switch(g){case 'background':this._attr('backgroundColor',j,i);return this;case 'margin':j=b.parse_group(j);this._attr('marginBottom',j[0],i);this._attr('marginLeft',j[1],i);this._attr('marginRight',j[2],i);this._attr('marginTop',j[3],i);return this;case 'padding':j=b.parse_group(j);this._attr('paddingBottom',j[0],i);this._attr('paddingLeft',j[1],i);this._attr('paddingRight',j[2],i);this._attr('paddingTop',j[3],i);return this;case 'backgroundColor':case 'borderColor':case 'color':j=b.parse_color(j);break;case 'opacity':j=parseFloat(j,10);break;case 'height':case 'width':if(j=='auto'){h=true;}else j=parseInt(j,10);break;case 'borderWidth':case 'lineHeight':case 'fontSize':case 'marginBottom':case 'marginLeft':case 'marginRight':case 'marginTop':case 'paddingBottom':case 'paddingLeft':case 'paddingRight':case 'paddingTop':case 'bottom':case 'left':case 'right':case 'top':case 'scrollTop':case 'scrollLeft':j=parseInt(j,10);break;default:throw new Error(g+' is not a supported attribute!');}if(this.state.attrs[g]===undefined)this.state.attrs[g]={};if(h)this.state.attrs[g].auto=true;switch(i){case b.ATTR_FROM:this.state.attrs[g].start=j;break;case b.ATTR_BY:this.state.attrs[g].by=true;case b.ATTR_TO:this.state.attrs[g].value=j;break;}};b._get_box_width=function(i){var j=parseInt(a.getStyle(i,'paddingLeft'),10),k=parseInt(a.getStyle(i,'paddingRight'),10),g=parseInt(a.getStyle(i,'borderLeftWidth'),10),h=parseInt(a.getStyle(i,'borderRightWidth'),10);return i.offsetWidth-(j?j:0)-(k?k:0)-(g?g:0)-(h?h:0);};b._get_box_height=function(i){var k=parseInt(a.getStyle(i,'paddingTop'),10),j=parseInt(a.getStyle(i,'paddingBottom'),10),g=parseInt(a.getStyle(i,'borderTopWidth'),10),h=parseInt(a.getStyle(i,'borderBottomWidth'),10);return i.offsetHeight-(k?k:0)-(j?j:0)-(g?g:0)-(h?h:0);};b.prototype.to=function(g,h){if(h===undefined){this._attr(this.last_attr,g,b.ATTR_TO);}else{this._attr(g,h,b.ATTR_TO);this.last_attr=g;}return this;};b.prototype.by=function(g,h){if(h===undefined){this._attr(this.last_attr,g,b.ATTR_BY);}else{this._attr(g,h,b.ATTR_BY);this.last_attr=g;}return this;};b.prototype.from=function(g,h){if(h===undefined){this._attr(this.last_attr,g,b.ATTR_FROM);}else{this._attr(g,h,b.ATTR_FROM);this.last_attr=g;}return this;};b.prototype.duration=function(g){this.state.duration=g?g:0;return this;};b.prototype.checkpoint=function(h,g){if(h===undefined)h=1;this.state.checkpoint=h;this.queue.push(this.state);this._reset_state();this.state.checkpointcb=g;return this;};b.prototype.blind=function(){this.state.blind=true;return this;};b.prototype.hide=function(){this.state.hide=true;return this;};b.prototype.show=function(){this.state.show=true;return this;};b.prototype.ease=function(g){this.state.ease=g;return this;};b.prototype.go=function(){var h=(new Date()).getTime();this.queue.push(this.state);for(var g=0;g<this.queue.length;g++){this.queue[g].start=h-b.offset;if(this.queue[g].checkpoint)h+=this.queue[g].checkpoint*this.queue[g].duration;}b.push(this);return this;};b.prototype._show=function(){a.show(this.obj);};b.prototype._hide=function(){a.hide(this.obj);};b.prototype._frame=function(s){var i=true;var r=false;var u=false;var t;function j(v){return document.documentElement[v]||document.body[v];}for(var k=0;k<this.queue.length;k++){var h=this.queue[k];if(h.start>s){i=false;continue;}if(h.checkpointcb){this._callback(h.checkpointcb,s-h.start);h.checkpointcb=null;}if(h.started===undefined){if(h.show)this._show();for(var g in h.attrs){if(h.attrs[g].start!==undefined)continue;switch(g){case 'backgroundColor':case 'borderColor':case 'color':t=b.parse_color(a.getStyle(this.obj,g=='borderColor'?'borderLeftColor':g));if(h.attrs[g].by){h.attrs[g].value[0]=Math.min(255,Math.max(0,h.attrs[g].value[0]+t[0]));h.attrs[g].value[1]=Math.min(255,Math.max(0,h.attrs[g].value[1]+t[1]));h.attrs[g].value[2]=Math.min(255,Math.max(0,h.attrs[g].value[2]+t[2]));}break;case 'opacity':t=a.getOpacity(this.obj);if(h.attrs[g].by)h.attrs[g].value=Math.min(1,Math.max(0,h.attrs[g].value+t));break;case 'height':t=b._get_box_height(this.obj);if(h.attrs[g].by)h.attrs[g].value+=t;break;case 'width':t=b._get_box_width(this.obj);if(h.attrs[g].by)h.attrs[g].value+=t;break;case 'scrollLeft':case 'scrollTop':t=(this.obj===document.body)?j(g):this.obj[g];if(h.attrs[g].by)h.attrs[g].value+=t;h['last'+g]=t;break;default:t=parseInt(a.getStyle(this.obj,g),10)||0;if(h.attrs[g].by)h.attrs[g].value+=t;break;}h.attrs[g].start=t;}if((h.attrs.height&&h.attrs.height.auto)||(h.attrs.width&&h.attrs.width.auto)){if(ua.firefox()<3)u=true;this._destroy_container();for(var g in {height:1,width:1,fontSize:1,borderLeftWidth:1,borderRightWidth:1,borderTopWidth:1,borderBottomWidth:1,paddingLeft:1,paddingRight:1,paddingTop:1,paddingBottom:1})if(h.attrs[g])this.obj.style[g]=h.attrs[g].value+(typeof h.attrs[g].value=='number'?'px':'');if(h.attrs.height&&h.attrs.height.auto)h.attrs.height.value=b._get_box_height(this.obj);if(h.attrs.width&&h.attrs.width.auto)h.attrs.width.value=b._get_box_width(this.obj);}h.started=true;if(h.blind)this._build_container();}var o=(s-h.start)/h.duration;if(o>=1){o=1;if(h.hide)this._hide();}else i=false;var q=h.ease?h.ease(o):o;if(!r&&o!=1&&h.blind)r=true;if(u&&this.obj.parentNode){var p=this.obj.parentNode;var n=this.obj.nextSibling;p.removeChild(this.obj);}for(var g in h.attrs)switch(g){case 'backgroundColor':case 'borderColor':case 'color':this.obj.style[g]='rgb('+b.calc_tween(q,h.attrs[g].start[0],h.attrs[g].value[0],true)+','+b.calc_tween(q,h.attrs[g].start[1],h.attrs[g].value[1],true)+','+b.calc_tween(q,h.attrs[g].start[2],h.attrs[g].value[2],true)+')';break;case 'opacity':a.setStyle(this.obj,'opacity',b.calc_tween(q,h.attrs[g].start,h.attrs[g].value));break;case 'height':case 'width':this.obj.style[g]=q==1&&h.attrs[g].auto?'auto':b.calc_tween(q,h.attrs[g].start,h.attrs[g].value,true)+'px';break;case 'scrollLeft':case 'scrollTop':var l=this.obj===document.body;t=l?j(g):this.obj[g];if(h['last'+g]!==t){delete h.attrs[g];}else{var m=b.calc_tween(q,h.attrs[g].start,h.attrs[g].value,true);if(!l){m=this.obj[g]=m;}else{if(g=='scrollLeft'){d.scrollTo(m,j('scrollTop'));}else d.scrollTo(j('scrollLeft'),m);m=j(g);}h['last'+g]=m;}break;default:this.obj.style[g]=b.calc_tween(q,h.attrs[g].start,h.attrs[g].value,true)+'px';break;}if(o==1){this.queue.splice(k--,1);this._callback(h.ondone,s-h.start-h.duration);}}if(u)p[n?'insertBefore':'appendChild'](this.obj,n);if(!r&&this.container_div)this._destroy_container();return !i;};b.prototype.ondone=function(g){this.state.ondone=g;return this;};b.prototype._callback=function(g,h){if(g){b.offset=h;g.call(this);b.offset=0;}};b.calc_tween=function(g,h,i,j){return (j?parseInt:parseFloat)((i-h)*g+h,10);};b.parse_color=function(g){var h=/^#([a-f0-9]{1,2})([a-f0-9]{1,2})([a-f0-9]{1,2})$/i.exec(g);if(h){return [parseInt(h[1].length==1?h[1]+h[1]:h[1],16),parseInt(h[2].length==1?h[2]+h[2]:h[2],16),parseInt(h[3].length==1?h[3]+h[3]:h[3],16)];}else{var i=/^rgba? *\(([0-9]+), *([0-9]+), *([0-9]+)(?:, *([0-9]+))?\)$/.exec(g);if(i){if(i[4]==='0'){return [255,255,255];}else return [parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10)];}else if(g=='transparent'){return [255,255,255];}else throw 'Named color attributes are not supported.';}};b.parse_group=function(g){g=trim(g).split(/ +/);if(g.length==4){return g;}else if(g.length==3){return [g[0],g[1],g[2],g[1]];}else if(g.length==2){return [g[0],g[1],g[0],g[1]];}else return [g[0],g[0],g[0],g[0]];};b.push=function(g){if(!b.active)b.active=[];b.active.push(g);if(b.active.length===1){if(!b.requestAnimationFrame){var h=d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame;if(h)b.requestAnimationFrame=h.bind(d);}if(b.requestAnimationFrame){b.requestAnimationFrame(b._animate);}else b.timeout=setInterval(b._animate,b.resolution,false);}if(b.requestAnimationFrame)b._updateEndingTimer();b._animate(Date.now(),true);};b._updateEndingTimer=function(){if(!b.requestAnimationFrame)throw new Error('Ending timer only valid with requestAnimationFrame');var j=0;for(var g=0;g<b.active.length;g++){var l=b.active[g];for(var k=0;k<l.queue.length;k++){var h=l.queue[k].start+l.queue[k].duration;if(h>j)j=h;}}if(b.timeout){clearTimeout(b.timeout);delete b.timeout;}var i=Date.now();if(j>i)b.timeout=setTimeout(b._animate.shield(),j-i,false);};b._animate=function(j,i){j=j||Date.now();for(var h=(i===true)?b.active.length-1:0;h<b.active.length;h++)try{if(!b.active[h]._frame(j))b.active.splice(h--,1);}catch(g){b.active.splice(h--,1);}if(b.active.length===0){if(b.timeout){if(b.requestAnimationFrame){clearTimeout(b.timeout);}else clearInterval(b.timeout);delete b.timeout;}}else if(b.requestAnimationFrame)b.requestAnimationFrame(b._animate);};b.ease={};b.ease.begin=function(g){return Math.sin(Math.PI/2*(g-1))+1;};b.ease.end=function(g){return Math.sin(.5*Math.PI*g);};b.ease.both=function(g){return .5*Math.sin(Math.PI*(g-.5))+.5;};b.prependInsert=function(h,g){b.insert(h,g,DOM.prependContent);};b.appendInsert=function(h,g){b.insert(h,g,DOM.appendContent);};b.insert=function(i,g,h){a.setStyle(g,'opacity',0);h(i,g);b(g).from('opacity',0).to('opacity',1).duration(400).go();};d.animation=e.exports=b;},3);
__d("event-extensions",["event-form-bubbling","object-core-utils","data-store","object-extensions","parent"],function(i,m,o,h){o('event-form-bubbling');var g=o('object-core-utils').copy_properties;var b=o('data-store');var d=o('object-extensions');var e=o('parent');Event.DATASTORE_KEY='Event.listeners';if(!Event.prototype)Event.prototype={};function a(q){q=q||window.event||{};if(!q._inherits_from_prototype)for(var s in Event.prototype)try{q[s]=Event.prototype[s];}catch(r){}return q;}g(Event.prototype,{_inherits_from_prototype:true,stop:function(){this.cancelBubble=true;this.stopPropagation&&this.stopPropagation();return this;},prevent:function(){this.returnValue=false;this.preventDefault&&this.preventDefault();return this;},kill:function(){this.stop().prevent();return false;},getTarget:function(){var q=this.target||this.srcElement;return q?$(q):null;},getRelatedTarget:function(){var q=this.relatedTarget||(this.fromElement===this.srcElement?this.toElement:this.fromElement);return q?$(q):null;},getModifiers:function(){var q={control:!!this.ctrlKey,shift:!!this.shiftKey,alt:!!this.altKey,meta:!!this.metaKey};q.access=ua.osx()?q.control:q.alt;q.any=q.control||q.shift||q.alt||q.meta;return q;}});g(Event,{listen:function(r,za,t,x){if(typeof r=='string')r=$(r);if(typeof x=='undefined')x=Event.Priority.NORMAL;if(typeof za=='object'){var s={};for(var z in za)s[z]=Event.listen(r,z,za[z],x);return s;}if(za.match(/^on/i))throw new TypeError("Bad event name `"+event+"': use `click', not `onclick'.");za=za.toLowerCase();if(r.nodeName=='LABEL'&&za=='click'){var w=r.getElementsByTagName('input');r=w.length==1?w[0]:r;}var u=b.get(r,j,{});if(p[za]){var q=p[za];za=q.base;t=q.wrap(t);}f(r,za);var zb=u[za];if(!(x in zb))zb[x]=[];var v=zb[x].length,y=new c(t,zb[x],v);zb[x].push(y);return y;},stop:function(q){return a(q).stop();},prevent:function(q){return a(q).prevent();},kill:function(q){return a(q).kill();},getKeyCode:function(event){event=a(event);if(!event)return false;switch(event.keyCode){case 63232:return 38;case 63233:return 40;case 63234:return 37;case 63235:return 39;case 63272:case 63273:case 63275:return null;case 63276:return 33;case 63277:return 34;}if(event.shiftKey)switch(event.keyCode){case 33:case 34:case 37:case 38:case 39:case 40:return null;}return event.keyCode;},getPriorities:function(){if(!n){var q=d.getValues(Event.Priority);q.sort(function(r,s){return r-s;});n=q;}return n;},__fire:function(q,s,event){var r=Event.__getHandler(q,s);if(r)return r(a(event));},__getHandler:function(q,r){return b.get(q,Event.DATASTORE_KEY+r);}});var n=null,j=Event.DATASTORE_KEY;var k=function(q){return function(r){if(!DOM.contains(this,r.getRelatedTarget()))return q.call(this,r);};};var p={mouseenter:{base:'mouseover',wrap:k},mouseleave:{base:'mouseout',wrap:k}};var f=function(q,w){var r='on'+w;var u=l.bind(q);var t=b.get(q,j);if(w in t)return;t[w]={};if(q.addEventListener){q.addEventListener(w,u,false);}else if(q.attachEvent)q.attachEvent(r,u);b.set(q,j+w,u);if(q[r]){var v=q===document.documentElement?Event.Priority._BUBBLE:Event.Priority.TRADITIONAL;var s=q[r];q[r]=null;Event.listen(q,w,s,v);}if(q.nodeName==='FORM'&&w==='submit')Event.listen(q,w,Event.__bubbleSubmit.curry(q),Event.Priority._BUBBLE);};var l=function(event){event=a(event);var x=event.type;if(!b.get(this,j))throw new Error("Bad listenHandler context.");var y=b.get(this,j)[x];if(!y)throw new Error("No registered handlers for `"+x+"'.");if(x=='click'){var s=e.byTag(event.getTarget(),'a');var z=user_action('click',s,event);if(window.ArbiterMonitor)ArbiterMonitor.initUA(z,[s]);}var u=Event.getPriorities();for(var t=0;t<u.length;t++){var v=u[t];if(v in y){var q=y[v];for(var r=0;r<q.length;r++){if(!q[r])continue;var w=q[r].fire(this,event);if(w===false){return event.kill();}else if(event.cancelBubble)event.stop();}}}return event.returnValue;};Event.Priority={URGENT:-20,TRADITIONAL:-10,NORMAL:0,_BUBBLE:1000};function c(r,q,s){this._handler=r;this._container=q;this._index=s;}c.prototype={remove:function(){delete this._handler;delete this._container[this._index];},fire:function(q,event){return this._handler.call(q,event);}};i.$E=h.$E=a;},3);
var Button=(function(){var b='uiButtonDisabled';var a='uiButtonDepressed';var d='button:blocker';var c='href';function e(j,i){var h=DataStore.get(j,d);if(i){if(h){h.remove();DataStore.remove(j,d);}}else if(!h)DataStore.set(j,d,Event.listen(j,'click',bagof(false),Event.Priority.URGENT));}function f(h){var i=Parent.byClass(h,'uiButton');if(!i)throw new Error('invalid use case');return i;}function g(h){return DOM.isNodeOfType(h,'a');}return {getInputElement:function(h){h=f(h);if(g(h))throw new Error('invalid use case');return DOM.find(h,'input');},isEnabled:function(h){return !CSS.hasClass(f(h),b);},setEnabled:function(k,h){k=f(k);CSS.conditionClass(k,b,!h);if(g(k)){var i=k.href;var l=DataStore.get(k,c,'#');if(h){if(!i)k.href=l;}else{if(i&&i!==l)DataStore.set(k,c,i);k.removeAttribute('href');}e(k,h);}else{var j=Button.getInputElement(k);j.disabled=!h;e(j,h);}},setDepressed:function(i,h){CSS.conditionClass(f(i),a,h);},isDepressed:function(h){return CSS.hasClass(f(h),a);},setLabel:function(i,h){i=f(i);if(g(i)){var j=DOM.find(i,'span.uiButtonText');DOM.setContent(j,h);}else Button.getInputElement(i).value=h;CSS.conditionClass(i,'uiButtonNoText',!h);},setIcon:function(i,h){if(!DOM.isNode(h))return;CSS.addClass(h,'customimg');i=f(i);var j=DOM.scry(i,'.img')[0];if(j!=h)if(j){DOM.replace(j,h);}else DOM.prependContent(i,h);}};})();
__d("css-support",["css-core"],function(c,d,e,b){var a=e('css-core');copy_properties(a,{supportsBorderRadius:function(){var h=['KhtmlBorderRadius','OBorderRadius','MozBorderRadius','WebkitBorderRadius','msBorderRadius','borderRadius'];var i=false,f=document.createElement('div');for(var g=h.length;g>=0;g--)if(i=f.style[h[g]]!==undefined)break;a.supportsBorderRadius=bagof(i);return i;}});d.exports=a;},3);
__d("control-dom",["data-store","dom-core"],function(e,f,g,d){var c=g('data-store');var a=g('dom-core').$;function b(h){this.root=a(h);this.updating=false;c.set(h,'DOMControl',this);}b.prototype={getRoot:function(){return this.root;},beginUpdate:function(){if(this.updating)return false;this.updating=true;return true;},endUpdate:function(){this.updating=false;},update:function(h){if(!this.beginUpdate())return this;this.onupdate(h);this.endUpdate();},onupdate:function(h){}};b.getInstance=function(h){return c.get(h,'DOMControl');};e.DOMControl=f.exports=b;},3);
add_properties('Input',{focus:function(a){try{a.focus();}catch(b){}},isEmpty:function(a){return !(/\S/).test(a.value||'')||CSS.hasClass(a,'DOMControl_placeholder');},getValue:function(a){return Input.isEmpty(a)?'':a.value;},setValue:function(b,d){CSS.removeClass(b,'DOMControl_placeholder');b.value=d||'';var c=b.getAttribute('maxlength');if(c>0)Bootloader.loadComponents('maxlength-form-listener',function(){Input.enforceMaxLength(b,c);});var a=DOMControl.getInstance(b);a&&a.resetHeight&&a.resetHeight();},setPlaceholder:function(a,b){a.setAttribute('title',b);a.setAttribute('placeholder',b);if(a==document.activeElement)return;if(Input.isEmpty(a)){CSS.conditionClass(a,'DOMControl_placeholder',b);a.value=b||'';}},reset:function(a){var b=a!==document.activeElement?(a.getAttribute('placeholder')||''):'';a.value=b;CSS.conditionClass(a,'DOMControl_placeholder',b);a.style.height='';},setSubmitOnEnter:function(a,b){CSS.conditionClass(a,'enter_submit',b);},getSubmitOnEnter:function(a){return CSS.hasClass(a,'enter_submit');}});
__d("vector",["event-extensions"],function(f,g,h,e){var a=h('event-extensions').$E;function b(j,k,i){copy_properties(this,{x:parseFloat(j),y:parseFloat(k),domain:i||'pure'});}copy_properties(b.prototype,{toString:function(){return '('+this.x+', '+this.y+')';},add:function(k,l){if(arguments.length==1){if(k.domain!='pure')k=k.convertTo(this.domain);return this.add(k.x,k.y);}var i=parseFloat(k);var j=parseFloat(l);return new b(this.x+i,this.y+j,this.domain);},mul:function(i,j){if(typeof(j)=="undefined")j=i;return new b(this.x*i,this.y*j,this.domain);},sub:function(i,j){if(arguments.length==1){return this.add(i.mul(-1));}else return this.add(-i,-j);},distanceTo:function(i){return this.sub(i).magnitude();},magnitude:function(){return Math.sqrt((this.x*this.x)+(this.y*this.y));},convertTo:function(i){if(i!='pure'&&i!='viewport'&&i!='document')return new b(0,0);if(i==this.domain)return new b(this.x,this.y,this.domain);if(i=='pure')return new b(this.x,this.y);if(this.domain=='pure')return new b(0,0);var j=b.getScrollPosition('document');var k=this.x,l=this.y;if(this.domain=='document'){k-=j.x;l-=j.y;}else{k+=j.x;l+=j.y;}return new b(k,l,i);},setElementPosition:function(i){var j=this.convertTo('document');i.style.left=parseInt(j.x)+'px';i.style.top=parseInt(j.y)+'px';return this;},setElementDimensions:function(i){return this.setElementWidth(i).setElementHeight(i);},setElementWidth:function(i){i.style.width=parseInt(this.x,10)+'px';return this;},setElementHeight:function(i){i.style.height=parseInt(this.y,10)+'px';return this;},scrollElementBy:function(i){if(i==document.body){window.scrollBy(this.x,this.y);}else{i.scrollLeft+=this.x;i.scrollTop+=this.y;}return this;}});copy_properties(b,{getEventPosition:function(j,i){i=i||'document';j=a(j);var l=j.pageX||(j.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft));var m=j.pageY||(j.clientY+(document.documentElement.scrollTop||document.body.scrollTop));var k=new b(l,m,'document');return k.convertTo(i);},getScrollPosition:function(i){i=i||'document';var j=document.body.scrollLeft||document.documentElement.scrollLeft;var k=document.body.scrollTop||document.documentElement.scrollTop;return new b(j,k,'document').convertTo(i);},getElementPosition:function(k,j){j=j||'document';if(!k)return;if(!('getBoundingClientRect' in k))return new b(0,0,'document');var m=k.getBoundingClientRect(),i=document.documentElement,l=Math.round(m.left)-i.clientLeft,n=Math.round(m.top)-i.clientTop;return new b(l,n,'viewport').convertTo(j);},getElementDimensions:function(i){return new b(i.offsetWidth||0,i.offsetHeight||0);},getViewportDimensions:function(){var i=(window&&window.innerWidth)||(document&&document.documentElement&&document.documentElement.clientWidth)||(document&&document.body&&document.body.clientWidth)||0;var j=(window&&window.innerHeight)||(document&&document.documentElement&&document.documentElement.clientHeight)||(document&&document.body&&document.body.clientHeight)||0;return new b(i,j,'viewport');},getDocumentDimensions:function(){var i=(document&&document.documentElement&&document.documentElement.scrollWidth)||(document&&document.body&&document.body.scrollWidth)||0;var j=(document&&document.documentElement&&document.documentElement.scrollHeight)||(document&&document.body&&document.body.scrollHeight)||0;return new b(i,j,'document');},deserialize:function(j){var i=j.split(',');return new b(i[0],i[1]);}});function c(i){return b.getElementPosition(i,'document').x;}function d(i){return b.getElementPosition(i,'document').y;}f.elementY=d;f.elementX=c;f.Vector2=g.exports=b;},3);
add_properties('Form',{getInputs:function(a){a=a||document;return [].concat($A(DOM.scry(a,'input')),$A(DOM.scry(a,'select')),$A(DOM.scry(a,'textarea')),$A(DOM.scry(a,'button')));},getSelectValue:function(a){return a.options[a.selectedIndex].value;},setSelectValue:function(b,c){for(var a=0;a<b.options.length;++a)if(b.options[a].value==c){b.selectedIndex=a;break;}},getRadioValue:function(b){for(var a=0;a<b.length;a++)if(b[a].checked)return b[a].value;return null;},getElements:function(a){return $A(a.tagName=='FORM'?a.elements:Form.getInputs(a));},getAttribute:function(b,a){return (b.getAttributeNode(a)||{}).value||null;},setDisabled:function(b,a){Form.getElements(b).forEach(function(c){if(c.disabled!=undefined){var d=DataStore.get(c,'origDisabledState');if(a){if(d===undefined)DataStore.set(c,'origDisabledState',c.disabled);c.disabled=a;}else{if(d!==true)c.disabled=false;DataStore.remove(c,'origDisabledState');}}});},bootstrap:function(d,e){var f=(Form.getAttribute(d,'method')||'GET').toUpperCase();e=Parent.byTag(e,'button')||e;var h=Parent.byClass(e,'stat_elem')||d;if(CSS.hasClass(h,'async_saving'))return;if(e&&(e.form!==d||(e.nodeName!='INPUT'&&e.nodeName!='BUTTON')||e.type!='submit')){var i=DOM.scry(d,'.enter_submit_target')[0];var b=e;i&&(e=i);}var c=Form.serialize(d,e);Form.setDisabled(d,true);var a=Form.getAttribute(d,'ajaxify')||Form.getAttribute(d,'action');trackReferrer(d,a);var g=new AsyncRequest(a);g.setData(c).setNectarModuleDataSafe(d).setReadOnly(f=='GET').setMethod(f).setRelativeTo(d).setStatusElement(h).setInitialHandler(Form.setDisabled.curry(d,false)).setFinallyHandler(Form.setDisabled.curry(d,false)).send();},serialize:function(b,c){var a={};Form.getElements(b).forEach(function(d){if(d.name&&!d.disabled&&d.type!='submit')if(!d.type||((d.type=='radio'||d.type=='checkbox')&&d.checked)||d.type=='text'||d.type=='password'||d.type=='hidden'||d.tagName=='TEXTAREA'){var h;if(d.name=='post_form_id')h=Env.post_form_id;Form._serializeHelper(a,d.name,h||Input.getValue(d));}else if(d.tagName=='SELECT')for(var e=0,f=d.options.length;e<f;++e){var g=d.options[e];if(g.selected)Form._serializeHelper(a,d.name,g.value);}});if(c&&c.name&&'submit'==c.type&&DOM.contains(b,c)&&DOM.isNodeOfType(c,['input','button']))Form._serializeHelper(a,c.name,c.value);return Form._serializeFix(a);},_serializeHelper:function(a,d,e){var c=/([^\]]+)\[([^\]]*)\](.*)/.exec(d);if(c){a[c[1]]=a[c[1]]||{};if(c[2]==''){var b=0;while(a[c[1]][b]!=undefined)b++;}else b=c[2];if(c[3]==''){a[c[1]][b]=e;}else Form._serializeHelper(a[c[1]],b.concat(c[3]),e);}else a[d]=e;},_serializeFix:function(a){var e=[];for(var b in a){if(a[b] instanceof Object)a[b]=Form._serializeFix(a[b]);e.push(b);}if(e.length>0){var d=0,c=true;e.sort().each(function(g){if(g!=d++)c=false;});if(c){var f=[];e.each(function(g){f[g]=a[g];});return f;}}return a;},post:function(d,b,c){var a=document.createElement('form');a.action=d.toString();a.method='POST';a.style.display='none';if(c)a.target=c;if(ge('post_form_id'))b.post_form_id=$('post_form_id').value;b.fb_dtsg=Env.fb_dtsg;b.post_form_id_source='dynamic_post';Form.createHiddenInputs(b,a);DOM.getRootElement().appendChild(a);a.submit();return false;},createHiddenInputs:function(g,a,d,f){d=d||{};var c;var h=URI.implodeQuery(g,'',false);var i=h.split('&');for(var b=0;b<i.length;b++)if(i[b]){var j=i[b].split('=');var e=j[0];var k=j[1];if(e===undefined||k===undefined)continue;k=URI.decodeComponent(k);if(d[e]&&f){d[e].value=k;}else{c=$N('input',{type:'hidden',name:e,value:k});d[e]=c;a.appendChild(c);}}return d;},getFirstElement:function(b,g){g=g||['input[type="text"]','textarea','input[type="password"]','input[type="button"]','input[type="submit"]'];var f=[];for(var d=0;d<g.length;d++){f=DOM.scry(b,g[d]);for(var c=0;c<f.length;c++){var e=f[c];try{if(elementY(e)>0&&elementX(e)>0)return e;}catch(a){}}}return null;},focusFirst:function(b){var a=Form.getFirstElement(b);if(a){a.focus();return true;}return false;}});
function show(){for(var b=0;b<arguments.length;b++){var a=ge(arguments[b]);if(a&&a.style)a.style.display='';}return false;}function hide(){for(var b=0;b<arguments.length;b++){var a=ge(arguments[b]);if(a&&a.style)a.style.display='none';}return false;}function shown(a){a=ge(a);return (a.style.display!='none'&&!(a.style.display==''&&a.offsetWidth==0));}function toggle(){for(var b=0;b<arguments.length;b++){var a=$(arguments[b]);a.style.display=CSS.getStyle(a,"display")=='block'?'none':'block';}return false;}function toggleDisplayNone(){for(var b=0;b<arguments.length;b++){var a=$(arguments[b]);if(shown(a)){hide(a);}else show(a);}return false;}
function intl_locale_is_rtl(){return ('rtl'==CSS.getStyle(document.body,'direction'));}
__d("key-event-constants",[],function(c,d,e,b){var a={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,COMMA:188};c.KEYS=d.exports=a;},3);
var OverlayZIndexHelper={getZIndex:function(c,e){e=e||document.body;var b=[];while(c&&c!==e){b.push(c);c=c.parentNode;}if(c!==e)return 0;for(var d=b.length-1;d>=0;d--){var a=b[d];if(CSS.getStyle(a,'position')!='static'){var f=parseInt(CSS.getStyle(a,'z-index'),10);if(!isNaN(f))return f;}}return 0;}};
function Dialog(a){this._show_loading=true;this._auto_focus=true;this._submit_on_enter=false;this._fade_enabled=true;this._onload_handlers=[];this._top=125;this._uniqueID='dialog_'+Dialog._globalCount++;this._content=null;this._obj=null;this._popup=null;this._overlay=null;this._shim=null;this._hidden_objects=[];this._causal_elem=null;this._previous_focus=null;this._buttons=[];this._buildDialog();if(a)this._setFromModel(a);Dialog._init();}Class.makeFinal(Dialog);copy_properties(Dialog,{OK:{name:'ok',label:_tx("Okay")},CANCEL:{name:'cancel',label:_tx("Cancel"),className:'inputaux'},CLOSE:{name:'close',label:_tx("Close")},NEXT:{name:'next',label:_tx("Next")},SAVE:{name:'save',label:_tx("Save")},SUBMIT:{name:'submit',label:_tx("Submit")},CONFIRM:{name:'confirm',label:_tx("Confirm")},DELETE:{name:'delete',label:_tx("Delete")},_globalCount:0,_bottoms:[0],max_bottom:0,_updateMaxBottom:function(){Dialog.max_bottom=Math.max.apply(Math,Dialog._bottoms);}});copy_properties(Dialog,{OK_AND_CANCEL:[Dialog.OK,Dialog.CANCEL],_STANDARD_BUTTONS:[Dialog.OK,Dialog.CANCEL,Dialog.CLOSE,Dialog.SAVE,Dialog.SUBMIT,Dialog.CONFIRM,Dialog.DELETE],SIZE:{WIDE:555,STANDARD:445},_HALO_WIDTH:10,_BORDER_WIDTH:1,_PADDING_WIDTH:10,_PAGE_MARGIN:40,_stack:[],_isUsingCSSBorders:function(){return CSS.supportsBorderRadius()||ua.ie()<7;},newButton:function(e,d,b,c){var a={name:e,label:d};if(b)a.className=b;if(c)a.handler=c;return a;},getCurrent:function(){var a=Dialog._stack;return a.length?a[a.length-1]:null;},bootstrap:function(i,a,f,d,e,c){a=a||{};var j=c&&c.rel=='dialog-pipe';copy_properties(a,new URI(i).getQueryData());d=d||(f?'GET':'POST');var h=Parent.byClass(c,'stat_elem')||c;if(h&&CSS.hasClass(h,'async_saving'))return false;var g;if(j){g=new AjaxPipeRequest();}else g=new AsyncRequest().setReadOnly(!!f).setMethod(d).setRelativeTo(c).setStatusElement(h);g.setURI(i).setNectarModuleDataSafe(c).setData(a);var b=new Dialog(e).setCausalElement(c).setAsync(g,j);b.show();return false;},_init:function(){this._init=bagofholding;onleaveRegister(Dialog._tearDown.shield(null,false));Arbiter.subscribe('page_transition',Dialog._tearDown.shield(null,true));Event.listen(document.documentElement,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.ESC&&!event.getModifiers().any){if(Dialog._escape())event.kill();}else if(Event.getKeyCode(event)==KEYS.RETURN&&!event.getModifiers().any)if(Dialog._enter())event.kill();});Event.listen(window,'resize',function(event){var a=Dialog.getCurrent();a&&a._resetDialogObj();});},_findButton:function(a,c){if(a)for(var b=0;b<a.length;++b)if(a[b].name==c)return a[b];return null;},_tearDown:function(b){var c=Dialog._stack.clone();for(var a=c.length-1;a>=0;a--)if(!(b&&c[a]._cross_transition))c[a].hide();},_escape:function(){var d=Dialog.getCurrent();if(!d)return false;var e=d._semi_modal;var b=d._buttons;if(!b&&!e)return false;if(e&&!b){d.hide();return true;}var a;var c=Dialog._findButton(b,'cancel');if(d._cancelHandler){d.cancel();return true;}else if(c){a=c;}else if(b.length==1){a=b[0];}else return false;d._handleButton(a);return true;},_enter:function(){var b=Dialog.getCurrent();if(!b||!b._submit_on_enter)return false;if(document.activeElement!=b._frame)return false;var a=b._buttons;if(!a)return false;b._handleButton(a[0]);return true;},call_or_eval:function(obj,func,args){if(!func)return undefined;args=args||{};if(typeof(func)=='string'){var params=keys(args).join(', ');func=eval('({f: function('+params+') { '+func+'}})').f;}return func.apply(obj,values(args));}});copy_properties(Dialog.prototype,{_cross_transition:false,_fixed:false,_loading:false,_showing:false,show:function(){if(this._async_request&&this._show_loading){this.showLoading();}else{this._showing=true;this._update();}return this;},showLoading:function(){this._loading=true;CSS.addClass(this._frame,'dialog_loading_shown');this._renderDialog();return this;},hide:function(){if(!this._showing&&!this._loading)return this;this._showing=false;if(this._autohide_timeout){clearTimeout(this._autohide_timeout);this._autohide_timeout=null;}if(this._fade_enabled&&Dialog._stack.length<=1){this._fadeOut();}else this._hide();return this;},cancel:function(){if(!this._cancelHandler||this._cancelHandler()!==false)this.hide();},getRoot:function(){return this._obj;},getBody:function(){return DOM.scry(this._obj,'div.dialog_body')[0];},getButtonElement:function(a){if(typeof a=='string')a=Dialog._findButton(this._buttons,a);if(!a||!a.name)return null;var b=DOM.scry(this._popup,'input');var c=function(d){return d.name==a.name;};return b.filter(c)[0]||null;},getContentNode:function(){return DOM.find(this._content,'div.dialog_content');},getFormData:function(){return Form.serialize(this.getContentNode());},setAllowCrossPageTransition:function(a){this._cross_transition=a;return this;},setShowing:function(){this.show();return this;},setHiding:function(){this.hide();return this;},setTitle:function(d){var c=this._nodes.title;var b=this._nodes.title_inner;var a=this._nodes.content;DOM.setContent(b,this._format(d||''));CSS.conditionShow(c,!!d);CSS.conditionClass(a,'dialog_content_titleless',!d);return this;},setBody:function(a){DOM.setContent(this._nodes.body,this._format(a));return this;},setExtraData:function(a){this._extra_data=a;return this;},setReturnData:function(a){this._return_data=a;return this;},setShowLoading:function(a){this._show_loading=a;return this;},setFullBleed:function(a){this._full_bleed=a;this._updateWidth();CSS.conditionClass(this._obj,'full_bleed',a);return this;},setCausalElement:function(a){this._causal_elem=a;return this;},setUserData:function(a){this._user_data=a;return this;},getUserData:function(){return this._user_data;},setAutohide:function(a){if(a){if(this._showing){this._autohide_timeout=setTimeout(this.hide.shield(this),a);}else this._autohide=a;}else{this._autohide=null;if(this._autohide_timeout){clearTimeout(this._autohide_timeout);this._autohide_timeout=null;}}return this;},setSummary:function(b){var a=this._nodes.summary;DOM.setContent(a,this._format(b||''));CSS.conditionShow(a,!!b);return this;},setButtons:function(b){var g,c;if(!(b instanceof Array)){g=$A(arguments);}else g=b;for(var h=0;h<g.length;++h)if(typeof g[h]=='string'){c=Dialog._findButton(Dialog._STANDARD_BUTTONS,g[h]);g[h]=c;}this._buttons=g;var d=[];if(g&&g.length>0)for(var i=0;i<g.length;i++){c=g[i];var e=$N('input',{type:'button',name:c.name||'',value:c.label});var f=$N('label',{className:'uiButton uiButtonLarge uiButtonConfirm'},e);if(c.className){c.className.split(/\s+/).each(function(j){CSS.addClass(f,j);});if(CSS.hasClass(f,'inputaux')){CSS.removeClass(f,'inputaux');CSS.removeClass(f,'uiButtonConfirm');}if(CSS.hasClass(f,'uiButtonSpecial'))CSS.removeClass(f,'uiButtonConfirm');}if(c.icon)DOM.prependContent(f,$N('img',{src:c.icon,className:'img mrs'}));if(c.disabled)Button.setEnabled(f,false);Event.listen(e,'click',this._handleButton.bind(this,c.name));for(var a in c)if(a.indexOf('data-')===0&&a.length>5)e.setAttribute(a,c[a]);d.push(f);}DOM.setContent(this._nodes.buttons,d);this._updateButtonVisibility();return this;},setButtonsMessage:function(a){DOM.setContent(this._nodes.button_message,this._format(a||''));this._has_button_message=!!a;this._updateButtonVisibility();return this;},_updateButtonVisibility:function(){var a=this._buttons.length>0||this._has_button_message;CSS.conditionShow(this._nodes.button_wrapper,a);CSS.conditionClass(this._obj,'omitDialogFooter',!a);},setClickButtonOnEnter:function(b,a){this._clickOnEnterTarget=b;if(!this._clickOnEnterListener)this._clickOnEnterListener=Event.listen(this._nodes.body,'keypress',function(event){var c=event.getTarget();if(c&&c.id===this._clickOnEnterTarget)if(Event.getKeyCode(event)==KEYS.RETURN){this._handleButton(a);event.kill();}return true;}.bind(this));return this;},setStackable:function(b,a){this._is_stackable=b;this._shown_while_stacked=b&&a;return this;},setHandler:function(a){this._handler=a;return this;},setCancelHandler:function(a){this._cancelHandler=Dialog.call_or_eval.bind(null,this,a);return this;},setCloseHandler:function(a){this._close_handler=Dialog.call_or_eval.bind(null,this,a);return this;},clearHandler:function(){return this.setHandler(null);},setPostURI:function(b,a){if(a===undefined)a=true;if(a){this.setHandler(this._submitForm.bind(this,'POST',b));}else this.setHandler(function(){Form.post(b,this.getFormData());this.hide();}.bind(this));return this;},setGetURI:function(a){this.setHandler(this._submitForm.bind(this,'GET',a));return this;},setModal:function(a){this._modal=a;return this;},setSemiModal:function(a){if(a)this.setModal(true);this._semi_modal=a;return this;},setWideDialog:function(a){this._wide_dialog=a;this._updateWidth();return this;},setContentWidth:function(a){this._content_width=a;this._updateWidth();return this;},setTitleLoading:function(b){if(b===undefined)b=true;var a=DOM.find(this._popup,'h2.dialog_title');if(a)CSS.conditionClass(a,'loading',b);return this;},setSecure:function(a){CSS.conditionClass(this._nodes.title,'secure',a);return this;},setClassName:function(a){CSS.addClass(this._obj,a);return this;},setFadeEnabled:function(a){this._fade_enabled=a;return this;},setFooter:function(a){var b=this._nodes.footer;DOM.setContent(b,this._format(a||''));CSS.conditionShow(b,!!a);return this;},setAutoFocus:function(a){this._auto_focus=a;return this;},setTop:function(a){this._top=a;this._resetDialogObj();return this;},setFixed:function(a){this._fixed=a;this._resetDialogObj();return this;},onloadRegister:function(a){$A(a).forEach(function(b){if(typeof b=='string')b=new Function(b);this._onload_handlers.push(b.bind(this));}.bind(this));return this;},setAsyncURL:function(a){return this.setAsync(new AsyncRequest(a));},setAsync:function(a,i){var d=function(m){if(this._async_request!=a)return;this._async_request=null;var l=m.getPayload();var j=l;var k=function(){if(this._loading)this._showing=true;if(typeof j=='string'){this.setBody(j);}else this._setFromModel(j);this._update();}.bind(this);if(i){j=l.dialog;Bootloader.setResourceMap(l.resource_map);Bootloader.loadResources(l.css,k);}else k();}.bind(this);var b=a.getData();b.__d=1;a.setData(b);var h;if(i){a.setFirstResponseHandler(d);h=a.getAsyncRequest();}else{var f=a.getHandler()||bagofholding;a.setHandler(function(j){f(j);d(j);});h=a;}var e=h.getErrorHandler()||bagofholding;var g=h.getTransportErrorHandler()||bagofholding;var c=function(){this._async_request=null;if(this._showing){this._update();}else this._hide();}.bind(this);h.setAllowCrossPageTransition(this._cross_transition).setErrorHandler(function(j){c();e(j);}).setTransportErrorHandler(function(j){c();g(j);});a.send();this._async_request=a;this._update();return this;},_format:function(a){if(typeof a=='string'){a=HTML(a);}else a=HTML.replaceJSONWrapper(a);if(a instanceof HTML)a.setDeferred(true);return a;},_update:function(){if(!this._showing)return;if(this._autohide&&!this._async_request&&!this._autohide_timeout)this._autohide_timeout=setTimeout(bind(this,'hide'),this._autohide);if(this._async_request&&this._show_loading){this.showLoading();}else{CSS.removeClass(this._frame,'dialog_loading_shown');this._loading=false;this._renderDialog();this._runOnloads();this._previous_focus=document.activeElement;Input.focus(this._frame);}},_runOnloads:function(){for(var b=0;b<this._onload_handlers.length;++b)try{this._onload_handlers[b]();}catch(a){}this._onload_handlers=[];},_updateWidth:function(){var a=2*Dialog._BORDER_WIDTH;if(Dialog._isUsingCSSBorders())a+=2*Dialog._HALO_WIDTH;if(this._content_width){a+=this._content_width;if(!this._full_bleed)a+=2*Dialog._PADDING_WIDTH;}else if(this._wide_dialog){a+=Dialog.SIZE.WIDE;}else a+=Dialog.SIZE.STANDARD;this._popup.style.width=a+'px';},_renderDialog:function(){this._showDialog();this._submit_on_enter=false;if(this._auto_focus){var b=Form.getFirstElement(this._content,['input[type="text"]','textarea','input[type="password"]']);if(b){Form.focusFirst.bind(this,this._content).defer();}else this._submit_on_enter=true;}var a=Vector2.getElementDimensions(this._content).y+Vector2.getElementPosition(this._content).y;Dialog._bottoms.push(a);this._bottom=a;Dialog._updateMaxBottom();return this;},_buildDialog:function(){this._obj=$N('div',{className:'generic_dialog',id:this._uniqueID});this._obj.style.display='none';document.body.appendChild(this._obj);if(!this._popup)this._popup=$N('div',{className:'generic_dialog_popup'});this._popup.style.left=this._popup.style.top='';this._obj.appendChild(this._popup);if(ua.ie()<7&&!this._shim)Bootloader.loadComponents('iframe-shim',function(){this._shim=new IframeShim(this._popup);});this._buildDialogContainer();this._buildDialogContent();},_showDialog:function(){if(this._causal_elem){var d=OverlayZIndexHelper.getZIndex(this._causal_elem);CSS.setStyle(this._obj,'z-index',d>200?d:'');}if(this._modal){this._buildOverlay();}else if(this._overlay){DOM.remove(this._overlay);this._overlay=null;}if(this._obj&&this._obj.style.display){this._obj.style.visibility='hidden';this._obj.style.display='';this.resetDialogPosition();this._obj.style.visibility='';this._obj.dialog=this;}else this.resetDialogPosition();clearInterval(this.active_hiding);this.active_hiding=setInterval(this._activeResize.bind(this),500);var c=Dialog._stack;if(!c.length)Arbiter.inform('layer_shown',{type:'Dialog'});c.remove(this);c.push(this);for(var a=c.length-2;a>=0;a--){var b=c[a];if(!b._is_stackable&&!b._async_request){b._hide();}else if(!b._shown_while_stacked)b._hide(true);}return this;},_updateShim:function(){return this._shim&&this._shim.show();},_activeResize:function(){if(this.last_offset_height!=this._content.offsetHeight){this.last_offset_height=this._content.offsetHeight;this._updateShim();}},_buildDialogContainer:function(){CSS.addClass(this._obj,'pop_dialog');if(intl_locale_is_rtl())CSS.addClass(this._obj,'pop_dialog_rtl');var b;if(Dialog._isUsingCSSBorders()){b='<div class="pop_container_advanced">'+'<div class="pop_content" id="pop_content"></div>'+'</div>';}else b='<div class="pop_container">'+'<div class="pop_verticalslab"></div>'+'<div class="pop_horizontalslab"></div>'+'<div class="pop_topleft"></div>'+'<div class="pop_topright"></div>'+'<div class="pop_bottomright"></div>'+'<div class="pop_bottomleft"></div>'+'<div class="pop_content pop_content_old" id="pop_content"></div>'+'</div>';DOM.setContent(this._popup,HTML(b));var a=DOM.find(this._popup,'div.pop_content');a.setAttribute('tabIndex','0');a.setAttribute('role','alertdialog');this._frame=this._content=a;},_buildDialogContent:function(){var g=$N('div',{className:'dialog_loading'},_tx("Loading..."));var j=$N('span');var i=$N('h2',{className:'dialog_title hidden_elem',id:'title_'+this._uniqueID},j);var h=$N('div',{className:'dialog_summary hidden_elem'});var a=$N('div',{className:'dialog_body'});var d=$N('div');var b=$N('div',{className:'dialog_buttons_msg'});var c=$N('div',{className:'dialog_buttons clearfix hidden_elem'},[b,d]);var f=$N('div',{className:'dialog_footer hidden_elem'});var e=$N('div',{className:'dialog_content'},[h,a,c,f]);this._nodes={summary:h,body:a,buttons:d,button_message:b,button_wrapper:c,footer:f,content:e,title:i,title_inner:j};DOM.setContent(this._frame,[i,e,g]);},_buildOverlay:function(){if(this._overlay)return;this._overlay=$N('div',{className:'overlay'});if(this._semi_modal)Event.listen(this._obj,'click',function(a){if(!DOM.contains(this._popup,a.getTarget()))this.hide();}.bind(this));if(ua.ie()<7)this._overlay.style.height=Vector2.getDocumentDimensions().y+'px';this._obj.insertBefore(this._overlay,this._obj.firstChild);},resetDialogPosition:function(){if(!this._popup)return;this._resetDialogObj();this._updateShim();},_resetDialogObj:function(){var a=DOM.find(this._popup,'div.pop_content');var b=Vector2.getElementDimensions(a).y+(2*Dialog._HALO_WIDTH);var g=Vector2.getViewportDimensions().y-(2*Dialog._PAGE_MARGIN);var f=this._top;var e=Vector2.getScrollPosition().y;var c=g-b;if(c<0){f=Dialog._PAGE_MARGIN;}else if(f>c)f=Dialog._PAGE_MARGIN+(Math.max(c,0)/2);if(!this._fixed)f+=e;CSS.conditionClass(this._obj,'generic_dialog_fixed',this._fixed);var d=this._fixed&&c<0;CSS.conditionClass(this._obj,'generic_dialog_fixed_overflow',d);CSS.conditionClass(document.body,'generic_dialog_overflow_mode',d);CSS.setStyle(this._popup,'top',f+'px');if(this._fixed&&f-Vector2.getElementPosition(this._popup,'viewport').y>1){f+=e;CSS.setStyle(this._popup,'top',f+'px');}},_fadeOut:function(b){if(!this._popup)return;try{animation(this._obj).duration(0).checkpoint().to('opacity',0).hide().duration(250).ondone(this._hide.bind(this,b)).go();}catch(a){this._hide(b);}},_hide:function(d){if(this._obj)this._obj.style.display='none';this._updateShim();if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}if(this._hidden_objects.length){for(var b=0,c=this._hidden_objects.length;b<c;b++)this._hidden_objects[b].style.visibility='';this._hidden_objects=[];}clearInterval(this.active_hiding);if(this._bottom){var a=Dialog._bottoms;a.splice(a.indexOf(this._bottom),1);Dialog._updateMaxBottom();}if(this._previous_focus&&document.activeElement&&DOM.contains(this._obj,document.activeElement))Input.focus(this._previous_focus);if(d)return;this.destroy();},destroy:function(){var a=Dialog._stack;var b=(a[a.length-1]===this);a.remove(this);if(a.length){if(b)a[a.length-1]._showDialog();}else Arbiter.inform('layer_hidden',{type:'Dialog'});if(this._obj){DOM.remove(this._obj);this._obj=null;this._shim&&this._shim.hide();this._shim=null;}this._clickOnEnterListener&&this._clickOnEnterListener.remove();if(this._close_handler)this._close_handler({return_data:this._return_data});},_handleButton:function(a){if(typeof a=='string')a=Dialog._findButton(this._buttons,a);var b=Dialog.call_or_eval(a,a.handler);if(b===false)return;if(a.name=='cancel'){this.cancel();}else if(Dialog.call_or_eval(this,this._handler,{button:a})!==false)this.hide();},_submitForm:function(d,e,b){var c=this.getFormData();if(b)c[b.name]=b.label;if(this._extra_data)copy_properties(c,this._extra_data);var a=new AsyncRequest().setURI(e).setData(c).setMethod(d).setNectarModuleDataSafe(this._causal_elem).setReadOnly(d=='GET');this.setAsync(a);return false;},_setFromModel:function(c){var a={};copy_properties(a,c);for(var d in a){if(d=='onloadRegister'){this.onloadRegister(a[d]);continue;}var b=this['set'+d.substr(0,1).toUpperCase()+d.substr(1)];b.apply(this,$A(a[d]));}},_updateBottom:function(){var a=Vector2.getElementDimensions(this._content).y+Vector2.getElementPosition(this._content).y;Dialog._bottoms[Dialog._bottoms.length-1]=a;Dialog._updateMaxBottom();}});
var ConnectDialog={newInstance:function(i,o,f,e,g,a,k,l,j,n,h){var b=new Dialog();var m=new AsyncRequest().setURI('/ajax/profile/connect.php').setData({dialog:1,profile_id:i,source:o,pymk_score:k,pymk_source:l,pymk_page:j,show_confirmation_optout:n,precheck_confirmation_optout:h}).setFinallyHandler(function(){var p=b.getButtonElement('connect');if(p)p.focus();});for(var d in a)m.setContextData(d,a[d]);b.setAsync(m);var c={ondone_func:f,ondone_data:e,ondone_reload:g,pymk_score:k,pymk_source:l,pymk_page:j};ConnectDialog.prepare(b,c);return b;},prepare:function(a,b){copy_properties(a,b||{});a.setCloseHandler(ConnectDialog.deleteInstance);ConnectDialog.setInstance(a);},deleteInstance:function(){delete ConnectDialog.instance;},setInstance:function(a){ConnectDialog.instance=a;},getInstance:function(){return ConnectDialog.instance;}};
var XD={_callbacks:[],_opts:{autoResize:false,allowShrink:true,channelUrl:null,hideOverflow:false,newResizeMethod:false,resizeTimeout:100,resizeWidth:false,expectResizeAck:false,resizeAckTimeout:6000},_lastResizeAckId:0,_resizeCount:0,_resizeTimestamp:0,init:function(a){this._opts=copy_properties(copy_properties({},this._opts),a);if(this._opts.autoResize)this._startResizeMonitor();Arbiter.subscribe('Connect.Unsafe.resize.ack',function(c,b){if(!b.id)b.id=this._resizeCount;if(b.id>this._lastResizeAckId)this._lastResizeAckId=b.id;}.bind(this));},send:function(b,a){a=a||this._opts.channelUrl;if(!a)return;if(a.substr(0,4)!='http')return;var i=a+'&'+URI.implodeQuery(b),e='f'+(Math.random()*(1<<30)).toString(16).replace('.',''),c=document.body.appendChild(document.createElement('div')),h=false;c.style.position='absolute';c.style.top='-10000px';c.style.width='1px';c.style.height='1px';XD._callbacks[e]=function(){if(h){(function(){c.parentNode.removeChild(c);}).defer(3000);delete XD._callbacks[e];}};if(ua.ie()){var f,d=document.createElement('div');f='<iframe onload="XD._callbacks.'+e+'()"></iframe>';d.innerHTML=f;d.firstChild.setAttribute('src',i);f=d.innerHTML;c.innerHTML='<iframe src="javascript:false"></iframe>';h=true;(function(){c.innerHTML=f;}).defer();}else{var g=document.createElement('iframe');g.onload=XD._callbacks[e];c.appendChild(g);h=true;g.src=i;}},_computeSize:function(){return {width:this._opts.resizeWidth?this._calcWidth(XD.forced_min_width):0,height:this._calcHeight(this._opts.newResizeMethod)};},_calcHeight:function(d){var a=document.body,b=document.documentElement,c=0;if(d){c=Math.max(Math.max(a.offsetHeight,a.scrollHeight)+a.offsetTop,Math.max(b.offsetHeight,b.scrollHeight)+b.offsetTop);}else{if(ua.ie()){c=Math.max(a.offsetHeight,a.scrollHeight)+a.offsetTop;}else c=b.offsetHeight+b.offsetTop;if(window.Dialog)c=Math.max(c,Dialog.max_bottom);}return c;},_calcWidth:function(g){var a=document.body,e=document.documentElement,h=0;if(a.offsetWidth<a.scrollWidth){h=a.scrollWidth+a.offsetLeft;}else{var d=a.childNodes;for(var f=0;f<d.length;f++){var b=d[f];var c=b.offsetWidth+b.offsetLeft;if(c>h)h=c;}}if(g)h=Math.max(h,g);if(e.clientLeft>0)h+=(e.clientLeft*2);if(e.clientTop>0)height+=(e.clientTop*2);return h;},_startResizeMonitor:function(){var b,a=document.documentElement;if(this._opts.hideOverflow){a.style.overflow='hidden';document.body.style.overflow='hidden';}setInterval((function(){var f=this._computeSize();var g=Date.now();var c=this._lastResizeAckId<this._resizeCount&&(g-this._resizeTimestamp)>this._opts.resizeAckTimeout;if(!b||(this._opts.expectResizeAck&&c)||(this._opts.allowShrink&&b.width!=f.width)||(!this._opts.allowShrink&&b.width<f.width)||(this._opts.allowShrink&&b.height!=f.height)||(!this._opts.allowShrink&&b.height<f.height)){b=f;this._resizeCount++;this._resizeTimestamp=g;var e={type:'resize',height:f.height,ackData:{id:this._resizeCount}};if(f.width&&f.width!=0)e.width=f.width;try{if(URI(document.referrer).isFacebookURI()&&window.parent!=window&&window.name&&window.parent.location&&window.parent.location.toString&&URI(window.parent.location).isFacebookURI()){var iframes=window.parent.document.getElementsByTagName('iframe');for(var i=0;i<iframes.length;i=i+1)if(iframes[i].name==window.name){if(this._opts.resizeWidth)iframes[i].style.width=e.width+'px';iframes[i].style.height=e.height+'px';}}this.send(e);}catch(d){this.send(e);}}}).bind(this),this._opts.resizeTimeout);}};var UnverifiedXD=copy_properties({},XD);
WindowComm={_callbacks:{},makeHandler:function(a,c){c=c||'opener';var b='f'+(Math.random()*(1<<30)).toString(16).replace('.','');WindowComm._callbacks[b]=a;return new URI('/connect/window_comm.php').setQueryData({_id:b,_relation:c}).getQualifiedURI().toString();},_recv:function(b){var a=new URI(b).getQueryData();WindowComm._callbacks[a._id](a);}};
var PopupResizer={_opts:{allowShrink:true,timeout:100},init:function(a){copy_properties(PopupResizer._opts,a);setInterval(PopupResizer._resizeCheck,PopupResizer._opts.timeout);},_resizeCheck:function(){var e=Vector2.getViewportDimensions(),a=PopupResizer._getDocumentSize(),c=a.y-e.y,d=a.x-e.x;if(d<0)d=0;if(!PopupResizer._opts.allowShrink&&c<0)c=0;if(c||d)try{window.resizeBy(d,c);if(d)window.moveBy(d/-2,0);}catch(b){}},_getDocumentSize:function(){var a={x:ua.firefox()?document.documentElement.scrollWidth:document.body.scrollWidth,y:document.body.scrollHeight};if(a.x<=0||a.x>document.documentElement.scrollWidth)a.x=document.documentElement.scrollWidth;if(a.y<=0||a.y>document.documentElement.scrollHeight)a.y=document.documentElement.scrollHeight;if(window.Dialog&&Dialog.max_bottom&&Dialog.max_bottom>a.y)a.y=Dialog.max_bottom;return a;},open:function(i,b,j){var f=typeof window.screenX!='undefined'?window.screenX:window.screenLeft,g=typeof window.screenY!='undefined'?window.screenY:window.screenTop,e=typeof window.outerWidth!='undefined'?window.outerWidth:document.body.clientWidth,d=typeof window.outerHeight!='undefined'?window.outerHeight:(document.body.clientHeight-22),c=parseInt(f+((e-j)/2),10),h=parseInt(g+((d-b)/2.5),10),a=('width='+j+',height='+b+',left='+c+',top='+h);return window.open(i,'_blank',a);}};
ConnectLogin={init:function(a){this.appID=a.appID;this.addToProfile=a.addToProfile;this.oneClick=a.oneClick;this.channelUrl=a.channelUrl;XD.init(a);},login:function(a,c,b){if(this.oneClick&&!c){this._oneClick(a);}else this._openPopup(a,c,b);},logout:function(){XD.send({type:'logout'});},_oneClick:function(a){new AsyncRequest().setURI('/ajax/api/tos.php').setData({app_id:this.appID,grant_perm:1}).setHandler(function(b){ConnectLogin._refreshLoginStatus();a&&a();}).send();},_openPopup:function(c,e,d){d=d||{};var b=WindowComm.makeHandler(function(h){ConnectLogin._closePopup();if(ConnectLogin.appID)ConnectLogin._refreshLoginStatus();c&&c();}),a=WindowComm.makeHandler(function(h){ConnectLogin._closePopup();}),g=new URI('/login.php');g.setQueryData({api_key:this.appID,next:b,channel_url:a,cancel_url:a,req_perms:e,v:'1.0',fbconnect:1,add_to_profile:this.addToProfile,display:'popup'});g.addQueryData(d);var f=this._getSize(d);this._popup=PopupResizer.open(g.toString(),f.height,f.width);},_closePopup:function(){if(this._popup){this._popup.close();this._popup=null;}},_refreshLoginStatus:function(){if(this.channelUrl){XD.send({type:'refreshLoginStatus'});}else window.location.reload();},_getSize:function(a){if(a.social_plugin=='registration'){return {width:640,height:370};}else return {width:610,height:280};}};
function ContextualDialog(b){var a=new Dialog();copy_properties(a,ContextualDialog.prototype);a._buildDialog();a._setFromModel(b);return a;}ContextualDialog.prototype={setContext:function(a){this._context=a;this.resetDialogPosition();return this;},_buildDialogContainer:function(){CSS.addClass(this._obj,'contextual_dialog');this._content=this._frame=$N('div',{className:'contextual_dialog_content'});this._arrow=$N('div',{className:'arrow'});DOM.setContent(this._popup,[this._content,this._arrow]);},_resetDialogObj:function(){if(!this._context||!this._showing)return;var g=Vector2.getElementPosition(this._context);var k=this._context.offsetWidth,h=this._context.offsetHeight;var l=g.x,m=g.y+h;var i=Vector2.getViewportDimensions().x;var j=Vector2.getScrollPosition().x;var e=Vector2.getDocumentDimensions().x;var d=Vector2.getElementDimensions(this._popup).x;var f=0;var c;if(k<64){c=l+k/2;}else c=l+32;if(e>0&&e<d){f=-l;}else{if(i>0&&l+d>j+i){f=(j+i-d)-l;if(l+f<j)f=j-l;}if(e>0&&l+d>e)f=(e-d)-l;}l+=f;if(c-l<32){l=c-32;if(l<0)l=0;}var b=Vector2.getElementDimensions(this._arrow).x;var a=c-l-b/2;if(a<0)a=0;if(a>d-32)a=d-32;CSS.setStyle(this._arrow,'marginLeft',a+'px');new Vector2(l,m,'document').setElementPosition(this._popup);},_renderDialog:function(a){if(window!=top)this._auto_focus=false;Dialog.prototype._renderDialog.call(this,a);}};
__d("async-signal",[],function(c,d,e,b){function a(g,f){this.data=f||{};if(window.Env&&Env.tracking_domain&&g.charAt(0)=='/')g=Env.tracking_domain+g;this.uri=g;this.handler=null;}a.prototype.setHandler=function(f){this.handler=f;return this;};a.prototype.send=function(){var h=this.handler,g=this.data,l=this.uri,k=[],i=new Image(),f=document.getElementById('post_form_id');g.asyncSignal=Math.floor(Math.random()*10000)+1;if(f)g.post_form_id=f.value;if(window.Env){g.__user=Env.user;if(Env.fb_isb)g.fb_isb=Env.fb_isb;}for(var j in g)k.push(encodeURIComponent(j)+'='+encodeURIComponent(g[j]));if(l.indexOf('?')==-1)l+='?';l+=k.join('&');if(h)i.onload=i.onerror=(function(n,m){return function(){m((n.height==1));};})(i,h);i.src=l;return this;};c.AsyncSignal=d.exports=a;},3);
function detect_broken_proxy_cache(d,a){var b=getCookie(a);if((b!=d)&&(b!=null)&&(d!='0')){var c={c:'si_detect_broken_proxy_cache',m:a+' '+d+' '+b};var e=new URI('/common/scribe_endpoint.php').getQualifiedURI().toString();new AsyncSignal(e,c).send();}}
__d("ajaxpipe",["dom","arbiter","async","big-pipe"],function(g,h,i,f){var e=i('dom');var b=i('arbiter');var c=i('async');var d=i('big-pipe');function a(k,j){this._uri=k;this._query_data=j;this._request=new c();this._canvas_id=null;this._allow_cross_page_transition=true;}copy_properties(a.prototype,{setCanvasId:function(j){this._canvas_id=j;return this;},setURI:function(j){this._uri=j;return this;},setData:function(j){this._query_data=j;return this;},getData:function(j){return this._query_data;},setAllowCrossPageTransition:function(j){this._allow_cross_page_transition=j;return this;},setAppend:function(j){this._append=j;return this;},send:function(){this._request.setOption('useIframeTransport',true).setURI(this._uri).setData(copy_properties({ajaxpipe:1,ajaxpipe_token:Env.ajaxpipe_token},this._query_data)).setPreBootloadHandler(this._preBootloadHandler.bind(this)).setInitialHandler(this._onInitialResponse.bind(this)).setHandler(this._onResponse.bind(this)).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(this._allow_cross_page_transition);a._current_request=this._request;this._request.send();return this;},_preBootloadFirstResponse:function(j){return false;},_fireDomContentCallback:function(){this._arbiter.inform('ajaxpipe/domcontent_callback',true,b.BEHAVIOR_STATE);},_fireOnloadCallback:function(){this._arbiter.inform('ajaxpipe/onload_callback',true,b.BEHAVIOR_STATE);},_isRelevant:function(j){return this._request==a._current_request||this._jsNonBlock;},_preBootloadHandler:function(k){var j=k.getPayload();if(!j||j.redirect||!this._isRelevant(k))return false;var l=false;if(k.is_first){!this._append&&a.clearCanvas(this._canvas_id,this._constHeight);this._arbiter=new b();l=this._preBootloadFirstResponse(k);this.pipe=new d({arbiter:this._arbiter,rootNodeID:this._canvas_id,lid:this._request.lid,rrEnabled:k.payload.roadrunner_enabled,isAjax:true,domContentCallback:this._fireDomContentCallback.bind(this),onloadCallback:this._fireOnloadCallback.bind(this),domContentEvt:'ajaxpipe/domcontent_callback',onloadEvt:'ajaxpipe/onload_callback',jsNonBlock:this._jsNonBlock,displayCallback:this._displayCallback});}return l;},_redirect:function(k){if(k.redirect){if(k.force||!this.isPageActive(k.redirect)){var j=['ajaxpipe','ajaxpipe_token'].concat(this.getSanitizedParameters());go_or_replace(window.location,URI(k.redirect).removeQueryData(j),true);}else PageTransitions.go(k.redirect,true);return true;}else return false;},isPageActive:function(j){return true;},getSanitizedParameters:function(){return [];},_versionCheck:function(j){return true;},_onInitialResponse:function(k){var j=k.getPayload();if(!this._isRelevant(k))return false;if(!j)return true;if(this._redirect(j)||!this._versionCheck(j))return false;return true;},_processFirstResponse:function(k){var j=k.getPayload();if(ge(this._canvas_id)&&j.canvas_class!==null)CSS.setClass(this._canvas_id,j.canvas_class);},setFirstResponseCallback:function(j){this._firstResponseCallback=j;return this;},setFirstResponseHandler:function(j){this._processFirstResponse=j;return this;},_onResponse:function(k){var j=k.payload;if(!this._isRelevant(k))return c.suppressOnloadToken;if(k.is_first){this._processFirstResponse(k);this._firstResponseCallback&&this._firstResponseCallback();j.provides=j.provides||[];j.provides.push('uipage_onload');if(this._append)j.append=this._canvas_id;}if(j){if('content' in j.content&&this._canvas_id!==null&&this._canvas_id!='content'){j.content[this._canvas_id]=j.content.content;delete j.content.content;}d.pagelet_ids[j.id]=1;this.pipe.onPageletArrive(j);}if(k.is_last)a.restoreCanvas(this._canvas_id,this._constHeight);return c.suppressOnloadToken;},setNectarModuleDataSafe:function(j){this._request.setNectarModuleDataSafe(j);return this;},setFinallyHandler:function(j){this._request.setFinallyHandler(j);return this;},setErrorHandler:function(j){this._request.setErrorHandler(j);return this;},abort:function(){this._request.abort();if(a._current_request==this._request)a._current_request=null;this._request=null;return this;},setJSNonBlock:function(j){this._jsNonBlock=j;return this;},setDisplayCallback:function(j){this._displayCallback=j;return this;},setConstHeight:function(j){this._constHeight=j;return this;},getAsyncRequest:function(){return this._request;}});copy_properties(a,{clearCanvas:function(j,k){var l=ge(j);if(l){if(!k)l.style.minHeight='600px';e.empty(l);}},restoreCanvas:function(j,k){var l=ge(j);if(l)if(!k)l.style.minHeight='100px';},getCurrentRequest:function(){return a._current_request;},setCurrentRequest:function(j){a._current_request=j;},isActiveOnPage:function(j){return env_get('ajaxpipe_enabled');}});g.AjaxPipeRequest=h.exports=a;},3);
__d("link-controller",["event-extensions","data-store","parent","referrer-tracker"],function(k,l,m,j){m('event-extensions');var a=m('data-store');var b=m('parent');var c=m('referrer-tracker');var d='LinkControllerHandler';var h=[];var f=[];function e(event){var p=b.byTag(event.getTarget(),'a');var n=p&&p.getAttribute('href',2);if(!n||p.rel||!i(n)||a.get(p,d))return;var o=Event.listen(p,'click',function(q){if(n.charAt(n.length-1)=='#'){q.prevent();return;}c.trackReferrer(p,n);g(p,q);});a.set(p,d,o);}function g(q,event){if(q.target||event.getModifiers().any||(event.which&&event.which!=1))return;var n=h.concat(f);for(var o=0,p=n.length;o<p;o++)if(n[o](q,event)===false)return event.kill();}function i(n){var o=n.match(/^(\w+):/);return !o||o[1].match(/^http/i);}k.LinkController=l.exports={registerHandler:function(n){h.push(n);},registerFallbackHandler:function(n){f.push(n);}};Event.listen(document.documentElement,'mousedown',e);Event.listen(document.documentElement,'keydown',e);},3);
__d("dom-scroll",["dom","vector","bootloader"],function(f,g,h,e){var a=h('dom').$N;var d=h('vector');var b=h('bootloader');var c={getScrollState:function(){var l=d.getViewportDimensions();var i=d.getDocumentDimensions();var j=(i.x>l.x);var k=(i.y>l.y);j+=0;k+=0;return new d(j,k);},_scrollbarSize:null,_initScrollbarSize:function(){var i=a('p');i.style.width='100%';i.style.height='200px';var j=a('div');j.style.position='absolute';j.style.top='0px';j.style.left='0px';j.style.visibility='hidden';j.style.width='200px';j.style.height='150px';j.style.overflow='hidden';j.appendChild(i);document.body.appendChild(j);var k=i.offsetWidth;j.style.overflow='scroll';var l=i.offsetWidth;if(k==l)l=j.clientWidth;document.body.removeChild(j);c._scrollbarSize=k-l;if(c._scrollbarSize<5)c._scrollbarSize=15;},getScrollbarSize:function(){if(c._scrollbarSize===null)c._initScrollbarSize();return c._scrollbarSize;},scrollTo:function(n,i,l,j,k){if(typeof i=='undefined'||i===true)i=750;if(!(n instanceof d)){var o=d.getScrollPosition().x;var p=d.getElementPosition($(n)).y;p=p-Math.min(0,Math.max(d.getViewportDimensions().y/3,100));var m=ge('blueBar');if(m&&CSS.isFixed(m)&&!l&&!j)p-=d.getElementDimensions(m).y;n=new d(o,p,'document');}if(l){n.y-=d.getViewportDimensions().y/2;}else if(j){n.y-=d.getViewportDimensions().y;n.y+=j;}n=n.convertTo('document');if(i){b.loadComponents('animation',function(){var q=document.body;animation(q).to('scrollTop',n.y).to('scrollLeft',n.x).ease(animation.ease.end).duration(i).ondone(k).go();});}else if(window.scrollTo){window.scrollTo(n.x,n.y);k&&k.call(this);}}};f.DOMScroll=g.exports=c;},3);
__d("string-extensions",[],function(b,c,d,a){String.prototype.trim=function(){if(this==window)return null;return this.replace(/^\s*|\s*$/g,'');};a.trim=b.trim=function(f){try{return String(f.toString()).trim();}catch(e){return '';}};String.prototype.startsWith=function(e){if(this==window)return null;return this.substring(0,e.length)==e;};String.prototype.endsWith=function(e){if(this==window)return null;return this.length>=e.length&&this.substring(this.length-e.length)==e;};String.prototype.split=(function(e){return function(l,i){var f="";if(l===null||i===null){return [];}else if(typeof l=='string'){return e.call(this,l,i);}else if(l===undefined){return [this.toString()];}else if(l instanceof RegExp){if(!l._2||!l._1){f=l.toString().replace(/^[\S\s]+\//,"");if(!l._1)if(!l.global){l._1=new RegExp(l.source,"g"+f);}else l._1=1;}separator1=l._1===1?l:l._1;var m=(l._2?l._2:l._2=new RegExp("^"+separator1.source+"$",f));if(i===undefined||i<0){i=false;}else{i=Math.floor(i);if(!i)return [];}var j,k=[],h=0,g=0;while((i?g++<=i:true)&&(j=separator1.exec(this))){if((j[0].length===0)&&(separator1.lastIndex>j.index))separator1.lastIndex--;if(separator1.lastIndex>h){if(j.length>1)j[0].replace(m,function(){for(var n=1;n<arguments.length-2;n++)if(arguments[n]===undefined)j[n]=undefined;});k=k.concat(this.substring(h,j.index),(j.index===this.length?[]:j.slice(1)));h=separator1.lastIndex;}if(j[0].length===0)separator1.lastIndex++;}return (h===this.length)?(separator1.test("")?k:k.concat("")):(i?k:k.concat(this.substring(h)));}else return e.call(this,l,i);};})(String.prototype.split);},3);
var HistoryManager=window.HistoryManager||{_IFRAME_BASE_URI:'http://static.ak.facebook.com/common/history_manager.php',history:null,current:0,fragment:null,_setIframeSrcFragment:function(b){b=b.toString();var a=HistoryManager.history.length-1;HistoryManager.iframe.src=HistoryManager._IFRAME_BASE_URI+'?|index='+a+'#'+encodeURIComponent(b);return HistoryManager;},getIframeSrcFragment:function(){return decodeURIComponent(URI(HistoryManager.iframe.contentWindow.document.location.href).getFragment());},nextframe:function(a,b){if(b){HistoryManager._setIframeSrcFragment(a);return;}if(a!==undefined){HistoryManager.iframeQueue.push(a);}else{HistoryManager.iframeQueue.splice(0,1);HistoryManager.iframeTimeout=null;HistoryManager.checkURI();}if(HistoryManager.iframeQueue.length&&!HistoryManager.iframeTimeout){var c=HistoryManager.iframeQueue[0];HistoryManager.iframeTimeout=setTimeout(function(){HistoryManager._setIframeSrcFragment(c);},100,false);}},isInitialized:function(){return !!HistoryManager._initialized;},init:function(){if(!env_get('ALLOW_TRANSITION_IN_IFRAME')&&window!=window.top)return;if(HistoryManager._initialized)return HistoryManager;var b=URI();var a=b.getFragment()||'';if(a.charAt(0)==='!'){a=a.substr(1);b.setFragment(a);}if(URI.getRequestURI(false).getProtocol().toLowerCase()=='https')HistoryManager._IFRAME_BASE_URI='https://s-static.ak.facebook.com/common/history_manager.php';copy_properties(HistoryManager,{_initialized:true,fragment:a,orig_fragment:a,history:[b],callbacks:[],lastChanged:Date.now(),canonical:URI('#'),fragmentTimeout:null,user:0,iframeTimeout:null,iframeQueue:[],enabled:true,debug:bagofholding});if(window.history&&history.pushState){this.lastURI=document.URL;window.history.replaceState(this.lastURI,null);Event.listen(window,'popstate',function(c){if(c&&c.state&&HistoryManager.lastURI!=c.state){HistoryManager.lastURI=c.state;HistoryManager.lastChanged=Date.now();HistoryManager.notify(URI(c.state).getUnqualifiedURI().toString());}}.bind(HistoryManager));if(ua.safari()<534||ua.chrome()<=13){setInterval(HistoryManager.checkURI,42,false);HistoryManager._updateRefererURI(this.lastURI);}return HistoryManager;}HistoryManager._updateRefererURI(URI.getRequestURI(false));if(ua.safari()<500||ua.firefox()<2){HistoryManager.enabled=false;return HistoryManager;}if(ua.ie()<8){HistoryManager.iframe=document.createElement('iframe');copy_properties(HistoryManager.iframe.style,{width:'0',height:'0',frameborder:'0',left:'0',top:'0',position:'absolute'});onloadRegister(function(){HistoryManager._setIframeSrcFragment(a);document.body.insertBefore(HistoryManager.iframe,document.body.firstChild);});}else if('onhashchange' in window){Event.listen(window,'hashchange',function(){HistoryManager.checkURI.bind(HistoryManager).defer();});}else setInterval(HistoryManager.checkURI,42,false);return HistoryManager;},registerURIHandler:function(a){HistoryManager.callbacks.push(a);return HistoryManager;},setCanonicalLocation:function(a){HistoryManager.canonical=URI(a);return HistoryManager;},notify:function(c){if(c==HistoryManager.orig_fragment)c=HistoryManager.canonical.getFragment();for(var b=0;b<HistoryManager.callbacks.length;b++)try{if(HistoryManager.callbacks[b](c))return true;}catch(a){}return false;},checkURI:function(){if(Date.now()-HistoryManager.lastChanged<400)return;if(window.history&&history.pushState){var d=URI(document.URL).removeQueryData('ref').toString();var c=URI(HistoryManager.lastURI).removeQueryData('ref').toString();if(d!=c){HistoryManager.lastChanged=Date.now();HistoryManager.lastURI=d;if(ua.safari()<534)HistoryManager._updateRefererURI(d);HistoryManager.notify(URI(d).getUnqualifiedURI().toString());}return;}if(ua.ie()<8&&HistoryManager.iframeQueue.length)return;if(ua.safari()&&window.history.length==200){if(!HistoryManager.warned)HistoryManager.warned=true;return;}var a=URI().getFragment();if(a.charAt(0)=='!')a=a.substr(1);if(ua.ie()<8)a=HistoryManager.getIframeSrcFragment();a=a.replace(/%23/g,'#');if(a!=HistoryManager.fragment.replace(/%23/g,'#')){HistoryManager.debug([a,' vs ',HistoryManager.fragment,'whl: ',window.history.length,'QHL: ',HistoryManager.history.length].join(' '));for(var b=HistoryManager.history.length-1;b>=0;--b)if(HistoryManager.history[b].getFragment().replace(/%23/g,'#')==a)break;++HistoryManager.user;if(b>=0){HistoryManager.go(b-HistoryManager.current);}else HistoryManager.go('#'+a);--HistoryManager.user;}},_updateRefererURI:function(e){e=e.toString();if(e.charAt(0)!='/'&&e.indexOf('//')==-1)return;var d=new URI(window.location);if(d.isFacebookURI()){var a=d.getPath()+window.location.search;}else var a='';var c=URI(e).getQualifiedURI().setFragment(a).toString();var b=2048;if(c.length>b)c=c.substring(0,b)+'...';setCookie('x-referer',c);},go:function(c,e,f){if(window.history&&history.pushState){e||typeof(c)=='number';var h=URI(c).removeQueryData('ref').toString();HistoryManager.lastChanged=Date.now();this.lastURI=h;if(f){window.history.replaceState(c,null,h);}else window.history.pushState(c,null,h);if(ua.safari()<534)HistoryManager._updateRefererURI(c);return false;}HistoryManager.debug('go: '+c);if(e===undefined)e=true;if(!HistoryManager.enabled)if(!e)return false;if(typeof(c)=='number'){if(!c)return false;var b=c+HistoryManager.current;var d=Math.max(0,Math.min(HistoryManager.history.length-1,b));HistoryManager.current=d;b=HistoryManager.history[d].getFragment()||HistoryManager.orig_fragment;b=URI(b).removeQueryData('ref').getUnqualifiedURI().toString();HistoryManager.fragment=b;HistoryManager.lastChanged=Date.now();if(ua.ie()<8){if(HistoryManager.fragmentTimeout)clearTimeout(HistoryManager.fragmentTimeout);HistoryManager._temporary_fragment=b;HistoryManager.fragmentTimeout=setTimeout(function(){window.location.hash='#!'+b;delete HistoryManager._temporary_fragment;},750,false);if(!HistoryManager.user)HistoryManager.nextframe(b,f);}else if(!HistoryManager.user)go_or_replace(window.location,window.location.href.split('#')[0]+'#!'+b,f);if(e)HistoryManager.notify(b);HistoryManager._updateRefererURI(b);return false;}c=URI(c);if(c.getDomain()==URI().getDomain())c=URI('#'+c.getUnqualifiedURI());var a=HistoryManager.history[HistoryManager.current].getFragment();var g=c.getFragment();if(g==a||(a==HistoryManager.orig_fragment&&g==HistoryManager.canonical.getFragment())){if(e)HistoryManager.notify(g);HistoryManager._updateRefererURI(g);return false;}if(f)HistoryManager.current--;var i=(HistoryManager.history.length-HistoryManager.current)-1;HistoryManager.history.splice(HistoryManager.current+1,i);HistoryManager.history.push(URI(c));return HistoryManager.go(1,e,f);},getCurrentFragment:function(){var a=HistoryManager._temporary_fragment!==undefined?HistoryManager._temporary_fragment:URI.getRequestURI(false).getFragment();return a==HistoryManager.orig_fragment?HistoryManager.canonical.getFragment():a;}};var PageTransitions=window.PageTransitions||{_transition_handlers:[],_scroll_positions:{},_scroll_locked:false,isInitialized:function(){return !!PageTransitions._initialized;},_init:function(){if(!env_get('ALLOW_TRANSITION_IN_IFRAME')&&window!=window.top)return;if(PageTransitions._initialized)return PageTransitions;PageTransitions._initialized=true;var d=URI.getRequestURI(false);var a=d.getUnqualifiedURI();var e=URI(a).setFragment(null);var c=a.getFragment();if(c.charAt(0)==='!'&&e.toString()===c.substr(1))a=e;copy_properties(PageTransitions,{_current_uri:a,_most_recent_uri:a,_next_uri:a});var b;if(d.getFragment().startsWith('/')){b=d.getFragment();}else b=a;HistoryManager.init().setCanonicalLocation('#'+b).registerURIHandler(PageTransitions._historyManagerHandler);LinkController.registerFallbackHandler(PageTransitions._rewriteHref);LinkController.registerFallbackHandler(PageTransitions._onlinkclick);Event.listen(document.documentElement,'submit',PageTransitions._onformsubmit);Event.listen(window,'scroll',function(){if(!PageTransitions._scroll_locked)PageTransitions._scroll_positions[PageTransitions._current_uri]=Vector2.getScrollPosition();});return PageTransitions;},registerHandler:function(b,a){PageTransitions._init();a=a||5;if(!PageTransitions._transition_handlers[a])PageTransitions._transition_handlers[a]=[];PageTransitions._transition_handlers[a].push(b);},getCurrentURI:function(a){if(!PageTransitions._current_uri&&!a)return new URI(PageTransitions._most_recent_uri);return new URI(PageTransitions._current_uri);},getMostRecentURI:function(){return new URI(PageTransitions._most_recent_uri);},getNextURI:function(){return new URI(PageTransitions._next_uri);},_rewriteHref:function(a){var c=a.getAttribute('href');var b=_computeRelativeURI(PageTransitions._most_recent_uri.getQualifiedURI(),c).toString();if(c!=b)a.setAttribute('href',b);},_onlinkclick:function(a){_BusyUIManager.lookBusy(a);PageTransitions.go(a.getAttribute('href'));return false;},_onformsubmit:function(event){var a=event.getTarget();if(Form.getAttribute(a,'rel')||Form.getAttribute(a,'target'))return;var d=user_action('form',a,event);if(window.ArbiterMonitor)ArbiterMonitor.initUA(d,[a]);var c=new URI(Form.getAttribute(a,'action')||''),b=_computeRelativeURI(PageTransitions._most_recent_uri,c);a.setAttribute('action',b.toString());if((Form.getAttribute(a,'method')||'GET').toUpperCase()==='GET'){PageTransitions.go(b.addQueryData(Form.serialize(a)));event.kill();}},go:function(d,b){var a=new URI(d).removeQueryData('quickling').getQualifiedURI();var c=a.getUnqualifiedURI();delete PageTransitions._scroll_positions[c];!b&&user_action('uri',{href:a.toString()},null,'INDIRECT');_BusyUIManager.lookBusy();PageTransitions._loadPage(a,function(e){if(e){HistoryManager.go(a.toString(),false,b);}else go_or_replace(window.location,a,b);});},_historyManagerHandler:function(a){if(a.charAt(0)!='/')return false;user_action('h',{href:a},null);PageTransitions._loadPage(new URI(a),function(b){if(!b)go_or_replace(window.location,a,true);});return true;},_loadPage:function(e,c){if(URI(e).getFragment()&&are_equal(URI(e).setFragment(null).getQualifiedURI(),URI(PageTransitions._current_uri).setFragment(null).getQualifiedURI())){PageTransitions._current_uri=PageTransitions._most_recent_uri=e;PageTransitions.restoreScrollPosition();_BusyUIManager.stopLookingBusy();return;}var d=PageTransitions._scroll_positions[PageTransitions._current_uri];PageTransitions._current_uri=null;PageTransitions._next_uri=e;if(d)DOMScroll.scrollTo(d,false);var b=function(){PageTransitions._scroll_locked=true;var f=PageTransitions._handleTransition(e);c&&c(f);};var a=_runHooks('onbeforeleavehooks');if(a){_BusyUIManager.stopLookingBusy();PageTransitions._warnBeforeLeaving(a,b);}else b();},_handleTransition:function(g){window.onbeforeleavehooks=undefined;_BusyUIManager.lookBusy();if(!g.isSameOrigin())return false;var f=window.AsyncRequest&&AsyncRequest.getLastId();Arbiter.inform("pre_page_transition",{from:PageTransitions.getMostRecentURI(),to:g});for(var c=PageTransitions._transition_handlers.length-1;c>=0;--c){var b=PageTransitions._transition_handlers[c];if(!b)continue;for(var d=b.length-1;d>=0;--d)if(b[d](g)===true){var e={sender:this,uri:g,id:f};try{Arbiter.inform("page_transition",e);}catch(a){}return true;}else b.splice(d,1);}return false;},unifyURI:function(){PageTransitions._current_uri=PageTransitions._most_recent_uri=PageTransitions._next_uri;},transitionComplete:function(a){PageTransitions._executeCompletionCallback();_BusyUIManager.stopLookingBusy();PageTransitions.unifyURI();if(!a)PageTransitions.restoreScrollPosition();try{if(document.activeElement&&document.activeElement.nodeName==='A')document.activeElement.blur();}catch(b){}},_executeCompletionCallback:function(){if(PageTransitions._completionCallback)PageTransitions._completionCallback();PageTransitions._completionCallback=null;},setCompletionCallback:function(a){PageTransitions._completionCallback=a;},rewriteCurrentURI:function(b,a){PageTransitions.registerHandler(function(){if(b==PageTransitions.getMostRecentURI().getUnqualifiedURI().toString()){PageTransitions.transitionComplete();return true;}});PageTransitions.go(a,true);},_warnBeforeLeaving:function(b,a){new Dialog().setTitle(_tx("Are you sure you want to leave this page?")).setBody(htmlize(b)).setButtons([{name:'leave_page',label:_tx("Leave this Page"),handler:a},{name:'continue_editing',label:_tx("Stay on this Page"),className:'inputaux'}]).setModal(true).show();},restoreScrollPosition:function(){PageTransitions._scroll_locked=false;var c=PageTransitions._current_uri;var e=PageTransitions._scroll_positions[c];if(e){DOMScroll.scrollTo(e,false);return;}function d(f){return (f||null)&&(DOM.scry(document.body,"a[name='"+escape_js_quotes(f)+"']")[0]||ge(f));}var a=d(URI(c).getFragment());if(a){var b=Vector2.getElementPosition(a);b.x=0;DOMScroll.scrollTo(b);}}};function _computeRelativeURI(d,b){var e=new URI(),c=b;d=new URI(d);b=new URI(b);if(b.getDomain()&&!b.isFacebookURI())return c;var f=d;var a=['Protocol','Domain','Port','Path','QueryData','Fragment'];a.forEach(function(h){var g=h=='Path'&&f===d;if(g)e.setPath(_computeRelativePath(d.getPath(),b.getPath()));if(!is_empty(b['get'+h]()))f=b;if(!g)e['set'+h](f['get'+h]());});return e;}function _computeRelativePath(b,a){if(!a)return b;if(a.charAt(0)=='/')return a;var c=b.split('/').slice(0,-1);c[0]!=='';a.split('/').forEach(function(d){if(!(d=='.'))if(d=='..'){if(c.length>1)c=c.slice(0,-1);}else c.push(d);});return c.join('/');}function go_or_replace(a,d,c){var e=new URI(d);if(a.pathname=='/'&&e.getPath()!='/'&&e.isQuicklingEnabled()){var b=a.search?{}:{q:''};e=new URI().setPath('/').setQueryData(b).setFragment(e.getUnqualifiedURI()).toString();d=e.toString();}if(c&&!(ua.ie()<8)){a.replace(d);}else if(a.href==d){a.reload();}else a.href=d;}var _BusyUIManager=window._BusyUIManager||{_looking_busy:false,_original_cursors:[],lookBusy:function(a){if(a)_BusyUIManager._giveProgressCursor(a);if(_BusyUIManager._looking_busy)return;_BusyUIManager._looking_busy=true;_BusyUIManager._giveProgressCursor(document.documentElement);},stopLookingBusy:function(){if(!_BusyUIManager._looking_busy)return;_BusyUIManager._looking_busy=false;while(_BusyUIManager._original_cursors.length){var c=_BusyUIManager._original_cursors.pop();var b=c[0];var a=c[1];if(b.style)b.style.cursor=a||'';}},_giveProgressCursor:function(a){if(!ua.safari()){_BusyUIManager._original_cursors.push([a,a.style.cursor]);a.style.cursor='progress';}}};
function AsyncLayout(){}AsyncLayout.prototype={init:function(a){this.canvas_id=a;if(ge('rightCol'))this.auxiliary_id='rightCol';if(ge('headerArea'))this.header_id='headerArea';if(ge('toolbarContainer'))this.toolbar_id='toolbarContainer';this.waitingForAux=false;PageTransitions.registerHandler(this.catchPageTransition.bind(this));this.subscription=Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this.onNavigate.bind(this));return this;},catchPageTransition:function(a){Arbiter.unsubscribe(this.subscription);return false;},getCanvasID:function(a){return this.customCanvasID?this.customCanvasID:(a.sidecol?'contentCol':'contentArea');},onNavigate:function(c,a){var d=a.useAjaxPipe&&AjaxPipeRequest.isActiveOnPage(a.params.endpoint);a=a.params;if(a.endpoint){if(this.request){this.request.setFinallyHandler(bagofholding);this.request.abort();}if(this.sideRequest)this.sideRequest.abort();if(d){this.request=new AjaxPipeRequest().setURI(a.endpoint).setData(a).setCanvasId(this.getCanvasID(a)).setFinallyHandler(this.finallyHandler.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFirstResponseCallback(this.firstResponseCallback.bind(this)).send();}else{a.handled=true;this.waitingForAux=a.sidecol;var e=!!a.iframe;var b=new AsyncRequest().setOption('useIframeTransport',e).setURI(new URI(a.endpoint)).setReadOnly(true).setMethod('GET').setData(a).setHandler(this.onResponse.bind(this)).setErrorHandler(this.errorHandler.bind(this)).setFinallyHandler(this.finallyHandler.bind(this));this.request=b;b.send();}}},onSideResponse:function(b){var a=b.getPayload();if(a&&this.auxiliary_id)this.receivedAux(a);},receivedAux:function(a){!this.waitingForAux;this.waitingForAux=false;DOM.setContent($(this.auxiliary_id),HTML(a));},onResponse:function(e){var d=e.getPayload();if(d.redirect){goURI(d.redirect);}else{var c=d.html||d;DOM.setContent($(this.canvas_id),HTML(c));if(d.side_html&&this.auxiliary_id)this.receivedAux(d.side_html);if(this.header_id&&!d.keep_header){var b=$(this.header_id);DOM.setContent(b,HTML(d.header_html||''));CSS.conditionShow(b,d.header_html);}if(d.toolbar_html&&this.toolbar_id)DOM.setContent($(this.toolbar_id),HTML(d.toolbar_html));if(d.js)(new Function(d.js))();CSS.conditionClass('contentCol','hasRightCol',this.auxiliary_id&&!d.noRightSide);var f=ge('rightCol');if(f&&d.noRightSide)DOM.empty(f);}var a=e.getRequest().getData();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED,a.key);},errorHandler:function(a){AsyncResponse.verboseErrorHandler(a);Arbiter.inform(NavigationMessage.NAVIGATION_FAILED);this.request=null;},firstResponseCallback:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_FIRST_RESPONSE);},finallyHandler:function(a){this.request=null;PageTransitions.transitionComplete(true);Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}};
__d("UIPagelet",["dom","ajaxpipe","async"],function(e,f,g,d){var b=g('dom');var a=g('ajaxpipe');function c(j,k,h,i){this._id=j||null;this._element=ge(j||b.$N('div'));this._src=k||null;this._context_data=h||{};this._data=i||{};this._handler=bagofholding;this._request=null;this._use_ajaxpipe=false;this._is_bundle=true;this._allow_cross_page_transition=false;this._append=false;return this;}c.loadFromEndpoint=function(j,n,h,k){k=k||{};var i='/ajax/pagelet/generic.php/';if(k.intern)i='/intern'+i;var m=(i+j).replace(/\/+/g,'/');if(k.subdomain)m=URI(m).setSubdomain(k.subdomain);var l=new c(n,m,h).setUseAjaxPipe(k.usePipe).setBundleOption(j.substring(0,8)!='/intern/'&&k.bundle!==false).setAppend(k.append).setJSNonBlock(k.jsNonblock).setDisplayCallback(k.displayCallback).setConstHeight(k.constHeight).setAllowCrossPageTransition(k.crossPage);k.handler&&l.setHandler(k.handler);l.go();return l;};copy_properties(c.prototype,{getElement:function(h){h=h||false;if(h)this._element=ge(this._id);return this._element;},setHandler:function(h){this._handler=h;return this;},go:function(i,h){if(arguments.length>=2||typeof i=='string'){this._src=i;this._data=h||{};}else if(arguments.length==1)this._data=i;this.refresh();return this;},setAllowCrossPageTransition:function(h){this._allow_cross_page_transition=h;return this;},setBundleOption:function(h){this._is_bundle=h;return this;},refresh:function(j){var i=function(l){this._request=null;if(j&&this._id)this._element=ge(this._id);var k=HTML(l.getPayload());if(this._append){b.appendContent(this._element,k);}else b.setContent(this._element,k);this._handler();}.bind(this);if(this._use_ajaxpipe){this._request=new a();this._request.setCanvasId(this._id).setAppend(this._append).setConstHeight(this._constHeight).setJSNonBlock(this._jsNonblock).setDisplayCallback(this._displayCallback);}else{var h=g('async');this._request=new h().setMethod('GET').setReadOnly(true).setOption('bundle',this._is_bundle).setHandler(function(k){if(this._displayCallback){this._displayCallback(i.curry(k));}else i(k);});}this._request.setURI(this._src).setAllowCrossPageTransition(this._allow_cross_page_transition).setData({data:JSON.stringify(merge(this._context_data,this._data))}).send();return this;},cancel:function(){if(this._request)this._request.abort();},setUseAjaxPipe:function(h){this._use_ajaxpipe=!!h;return this;},setAppend:function(h){this._append=!!h;return this;},setJSNonBlock:function(h){this._jsNonblock=!!h;return this;},setDisplayCallback:function(h){this._displayCallback=h;return this;},setConstHeight:function(h){this._constHeight=!!h;return this;}});e.UIPagelet=f.exports=c;},3);
function FutureSideNav(){FutureSideNav.instance&&FutureSideNav.instance.uninstall();FutureSideNav.instance=this;}FutureSideNav.instance=null;FutureSideNav.getInstance=function(){return FutureSideNav.instance||new FutureSideNav();};FutureSideNav.prototype={init:function(c,b,a){this.root=c;this.items={};this.sections={};this.editor=null;this.editing=false;this.selected=null;this.loading=null;this.keyParam='sk';this.defaultKey=b;this.uri=URI.getRequestURI();this.ajaxPipe=a;this.ajaxPipeEndpoints={};this.sidecol=true;this._installed=true;this._handlePageTransitions=true;PageTransitions.registerHandler(function(d){return this._handlePageTransitions&&this.handlePageTransition(d);}.bind(this));this._eventHandlers=[];this._arbiterSubscriptions=[Arbiter.subscribe(NavigationMessage.NAVIGATION_COMPLETED,this.navigationComplete.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAILED,this.navigationFailed.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_COUNT_UPDATE,this.navigationCountUpdate.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_SELECT,this.navigationSelect.bind(this)),Arbiter.subscribe(PresenceMessage.getArbiterMessageType('nav_count'),this.navigationCountUpdateFromPresence.bind(this))];this._explicitHover=[];this._ensureHover('sideNavItem');this._eventHandlers.push(Event.listen(window,'resize',this._handleResize.bind(this)));this._checkNarrow();window.Selector&&this._arbiterSubscriptions.push(Selector.subscribe(['open','close'],function(f,d){var e=Parent.byClass(d.selector,'sideNavItem');e&&CSS.conditionClass(e,'editMenuOpened',f==='open');}));onleaveRegister(this.uninstall.bind(this));},_handleResize:(function(){var a;return function(){a&&clearTimeout(a);a=this._checkNarrow.bind(this).defer(200);};})(),_checkNarrow:function(){CSS.conditionClass(this.root,'uiNarrowSideNav',Vector2.getElementPosition(this.root).x<20);},_ensureHover:function(a){if(ua.ie()<8)Bootloader.loadComponents('explicit-hover',function(){this._explicitHover.push(new ExplicitHover(this.root,a));}.bind(this));},uninstall:function(){if(this._installed){this._installed=false;this._handlePageTransitions=false;this._arbiterSubscriptions.forEach(Arbiter.unsubscribe);this._eventHandlers.forEach(function(a){a.remove();});this._explicitHover.forEach(function(a){a.uninstall();});}},initSection:function(b,a){this._initItems(a);this._initSection(b);},addItem:function(a,b){this._initItem(a,b);},_initItems:function(b){var a=function(c,e){var d=this._initItem(c,e);$(c.children).forEach(function(f){a(f,d);});}.bind(this);$A(b).forEach(function(c){a(c,null);});},_initItem:function(a,d){var b=this.items[a.id]=this._constructItem(a,d);if(b.equals(this.selected)||a.selected)this.setSelected(b);var c=b.getLinkNode();c&&this._eventHandlers.push(Event.listen(c,'click',function(event){return !this.editing;}.bind(this)));return b;},_initSection:function(a){var b=this.sections[a.id]=this._constructSection(a);this._eventHandlers.push(Event.listen(b.node,'click',this.handleSectionClick.bind(this,b)));DOM.scry(b.node,'div.bookmarksMenuButton').forEach(CSS.show);return b;},_constructItem:function(a,b){return new FutureSideNavItem(a,b);},_constructSection:function(a){return new FutureSideNavSection(a);},handleSectionClick:function(c,event){var b=this._getEventTarget(event,'a');var a=this._getItemForNode(b);if(!b){return;}else if(CSS.hasClass(b.parentNode,'uiMenuItem')){this._handleMenuClick(c,a,b.parentNode,event);}else this._handleLinkClick(c,b,event);},_getEventTarget:function(event,a){var b=event.getTarget();if(b.tagName!==a.toUpperCase()){return Parent.byTag(b,a);}else return b;},_handleMenuClick:function(c,a,b,event){if(CSS.hasClass(b,'rearrange'))this.beginEdit(c);},_handleLinkClick:function(b,a,event){if(CSS.hasClass(a,'navEditDone')){this.editing?this.endEdit():this.beginEdit(b);event.kill();}},getItem:function(a){if(this._isCurrentPath(a)){return this._getItemForKey(this._getKey(a.getQueryData())||this.defaultKey);}else return this._getItemForPath(a.getPath());},getNodeForKey:function(b){var a=this._getItemForKey(b);if(a)return a.node;},_isCurrentPath:function(a){return a.getDomain()===this.uri.getDomain()&&a.getPath()===this.uri.getPath();},_getKey:function(a){return a[this.keyParam];},_getItemForNode:function(a){a=Parent.byClass(a,'sideNavItem');return a&&this.items[a.id];},_getItemForKey:function(a){return this._findItem(function(b){return b.matchKey(a);});},_getItemForPath:function(a){return this._findItem(function(b){return b.matchPath(a);});},_findItem:function(a){for(var b in this.items)if(a(this.items[b]))return this.items[b];},removeItem:function(a){if(a&&this.items[a.id]){DOM.remove(a.node);delete this.items[a.id];if(a.getTop().equals(this.selected&&this.selected.getTop()))goURI(URI.getRequestURI(),true);}},removeItemByKey:function(a){this.removeItem(this._getItemForKey(a));},moveItem:function(d,b,c){var a=DOM.find(d.node,'ul.uiSideNav');(c?DOM.prependContent:DOM.appendContent)(a,b.node);},setLoading:function(a){this.loading&&this.loading.hideLoading();this.loading=a;this.loading&&this.loading.showLoading();},setSelected:function(a){this.setLoading(null);if(this.selected){this.selected.hideSelected();this.selected.getTop().hideChildren();}this.selected=a;if(this.selected){this.selected.showSelected();this.selected.getTop().showChildren();}},handlePageTransition:function(c){var a=this.getItem(c);var b=a&&a.endpoint&&this._doPageTransition(a,c);return b;},_doPageTransition:function(a,b){this.setLoading(a);this._sendPageTransition(a.endpoint,copy_properties(this._getTransitionData(a,b),b.getQueryData()));return true;},_sendPageTransition:function(b,a){a.endpoint=b;Arbiter.inform(NavigationMessage.NAVIGATION_BEGIN,{useAjaxPipe:this._useAjaxPipe(b),params:a});},_getTransitionData:function(b,c){var a={};a.sidecol=this.sidecol;a.path=c.getPath();a[this.keyParam]=b.textKey;a.key=b.textKey;return a;},_useAjaxPipe:function(a){return this.ajaxPipe||this.ajaxPipeEndpoints[a];},navigationComplete:function(){this.loading&&this.setSelected(this.loading);if(Arbiter.inform('sidenav/scrolltop')!==false)DOMScroll.scrollTo(document.documentElement,false);},navigationFailed:function(){this.setLoading(null);},navigationSelect:function(c,a){var b=this._getItemForKey(this._getKey(a));if(a.asLoading){this.setLoading(b);}else this.setSelected(b);},navigationCountUpdate:function(c,a){var b=this._getItemForKey(a&&a.key);if(b)if(typeof a.count!=="undefined"){b.setCount(a.count,a.hide);}else if(typeof a.increment!=="undefined")b.incrementCount(a.increment,a.hide);},navigationCountUpdateFromPresence:function(b,a){a=a.obj;if(a&&a.class_name&&CSS.hasClass(this.root,a.class_name))this.navigationCountUpdate(b,a);},beginEdit:function(a){if(!this.editing){this.editing=true;CSS.addClass(this.root,'editMode');this._updateTrackingData();Bootloader.loadComponents('sortable-side-nav-js',this._initEditor.bind(this,a));}},endEdit:function(){if(this.editing){CSS.removeClass(this.root,'editMode');this.editor.endEdit();this.editor=null;this.editing=false;this._updateTrackingData();}},_updateTrackingData:function(a){var c=this.root.getAttribute('data-gt')||"{}";try{c=JSON.parse(c);if(this.editing){c.editing=true;}else delete c.editing;this.root.setAttribute('data-gt',JSON.stringify(c));}catch(b){}},_initEditor:function(a){this.editor=a.getEditor();this.editor.beginEdit();}};function FutureSideNavSection(a){this.id=a.id;this.node=this.node||$(a.id);this.editEndpoint=a.editEndpoint;}FutureSideNavSection.prototype={equals:function(a){return a&&a.id===this.id;},getEditor:function(){return new SortableSideNav(DOM.find(this.node,'ul.uiSideNav'),this.editEndpoint);}};function FutureSideNavItem(a,c){this.id=a.id;this.up=c;this.endpoint=a.endpoint;this.type=a.type;this.node=a.node||$(a.id);this.paths=a.path?$A(a.path):[];this.keys=a.key?$A(a.key):[];var b=this._findKeys(this.keys);this.numericKey=b.numeric||this.keys[0];this.textKey=b.text||this.keys[0];this._pathPattern=this._buildRegex(this.paths);this._keyPattern=this._buildRegex(this.keys);this.hideLoading();this.hideSelected();}FutureSideNavItem.prototype={equals:function(a){return a&&a.id===this.id;},getLinkNode:function(){return (DOM.scry(this.node,'a.item')[0]||DOM.scry(this.node,'a.subitem')[0]);},matchPath:function(a){return this._matchInput(this._pathPattern,a);},matchKey:function(a){return this._matchInput(this._keyPattern,a);},_matchInput:function(c,a){var b=c&&c.exec(a);return b&&b.slice(1);},getTop:function(){return this.isTop()?this:this.up.getTop();},isTop:function(a){return !this.up;},setCount:function(a,b){return this._updateCount(a,true);},incrementCount:function(a,b){return this._updateCount(a,false);},_updateCount:function(a,h,e){var c=DOM.scry(this.node,'span.count')[0];var d=c&&DOM.scry(c,'span.countValue')[0];if(d){var b=h?0:parseInt(DOM.getText(d),10);var i=Math.max(0,b+a);var f=this.isTop()?'hidden':'hiddenSubitem';DOM.setContent(d,i);e&&CSS.conditionClass(this.node,f,!i);CSS.conditionClass(c,'hidden_elem',!i);if(this.isTop()){var g=DOM.scry(this.node,'div.linkWrap')[0];if(g){CSS.conditionClass(g,'noCount',!i);CSS.conditionClass(g,'hasCount',i);}}}},showLoading:function(){CSS.addClass(this.node,'loading');},hideLoading:function(){CSS.removeClass(this.node,'loading');},showSelected:function(){CSS.addClass(this.node,'selectedItem');CSS.hasClass(this.node,'hider')&&CSS.addClass(this._getExpanderParent(),'expandedMode');},hideSelected:function(){CSS.removeClass(this.node,'selectedItem');},showChildren:function(){CSS.addClass(this.node,'open');},hideChildren:function(){CSS.removeClass(this.node,'open');},_getExpanderParent:function(){return Parent.byClass(this.node,'expandableSideNav');},_buildRegex:function(a){if(a.length){var b=a.map(function(c){if(typeof c==="string"){return c.replace(/([^a-z0-9_])/ig,'\\$1');}else if(c.regex)return c.regex;});return new RegExp('^(?:'+b.join('|')+')$');}},_findKeys:function(c){var e=/^(app|group|fl)_/;var a={};for(var b=0;b<c.length;b++){var d=e.test(c[b]);if(d&&!a.numeric){a.numeric=c[b];}else if(!d&&!a.text)a.text=c[b];if(a.numeric&&a.text)break;}return a;}};
var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(b){this.ensureInitialized();if(this.composer){var a=UIComposer.getInstance(this.composer.id);if(!b){a&&a.initialized&&a.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{a&&a.initialized&&a.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
var Base64=(function(){var c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';function d(e){e=(e.charCodeAt(0)<<16)|(e.charCodeAt(1)<<8)|e.charCodeAt(2);return String.fromCharCode(c.charCodeAt(e>>>18),c.charCodeAt((e>>>12)&63),c.charCodeAt((e>>>6)&63),c.charCodeAt(e&63));}var a='>___?456789:;<=_______'+'\0\1\2\3\4\5\6\7\b\t\n\13\f\r\16\17\20\21\22\23\24\25\26\27\30\31'+'______\32\33\34\35\36\37 !"#$%&\'()*+,-./0123';function b(e){e=(a.charCodeAt(e.charCodeAt(0)-43)<<18)|(a.charCodeAt(e.charCodeAt(1)-43)<<12)|(a.charCodeAt(e.charCodeAt(2)-43)<<6)|a.charCodeAt(e.charCodeAt(3)-43);return String.fromCharCode(e>>>16,(e>>>8)&255,e&255);}return {encode:function(f){f=unescape(encodeURI(f));var e=(f.length+2)%3;f=(f+'\0\0'.slice(e)).replace(/[\s\S]{3}/g,d);return f.slice(0,f.length+e-2)+'=='.slice(e);},decode:function(g){g=g.replace(/[^A-Za-z0-9+\/]/g,'');var f=(g.length+3)&3;g=(g+'AAA'.slice(f)).replace(/..../g,b);g=g.slice(0,g.length+f-3);try{return decodeURIComponent(escape(g));}catch(e){throw new Error('Not valid UTF-8');}},encodeObject:function(e){return Base64.encode(JSON.stringify(e));},decodeObject:function(e){return JSON.parse(Base64.decode(e));},encodeNums:function(e){return String.fromCharCode.apply(String,e.map(function(f){return c.charCodeAt((f|-(f>63))&-(f>0)&63);}));}};})();
function Overlay(){}!function(){var a=null;function b(d,e){var c;d.subscribe('show',function(){c=Event.listen(document.documentElement,'keydown',function(event){if(event.keyCode==KEYS.ESC&&(document.activeElement==document.body||DOM.contains(e,document.activeElement)))d.hide();});});d.subscribe('hide',function(){c.remove();c=null;});}copy_properties(Overlay,{getInstance:function(c){var d=Parent.byClass(c,'uiOverlay');return d?DataStore.get(d,'overlay'):null;},ARROW_OFFSET:15,ARROW_LENGTH:16,ARROW_CLASS:{bottom:'uiOverlayArrowBottom',top:'uiOverlayArrowTop',right:'uiOverlayArrowRight',left:'uiOverlayArrowLeft'}});Class.mixin(Overlay,'Arbiter',{_root:null,_transitionSubscription:null,_hideOnSubmit:false,_hideOnSuccess:true,_fadeOnShow:true,_fadeOnHide:true,_hasFooter:false,destroyOnHide:true,init:function(c){this._transitionSubscription=Arbiter.subscribe('page_transition',this.hide.shield(this),Arbiter.SUBSCRIBE_NEW);this._root=HTML(c).getRootNode();this._arrow=DOM.scry(this._root,'.uiOverlayArrow')[0]||null;this._overlay=DOM.scry(this._root,'div.uiOverlay')[0]||this._root;CSS.hide(this._root);DOM.appendContent(document.body,this._root);DataStore.set(this._overlay,'overlay',this);var d=DataStore.get(this._overlay,'width');d&&this.setWidth(d);this.setHideOnSubmit(DataStore.get(this._overlay,'hideonsubmit')=='true');this.setHideOnSuccess(DataStore.get(this._overlay,'hideonsuccess')!='false');this.setFadeOnShow(DataStore.get(this._overlay,'fadeonshow')!='false');this.setFadeOnHide(DataStore.get(this._overlay,'fadeonhide')!='false');this.setHideOnBlur(DataStore.get(this._overlay,'hideonblur')=='true');this.setDestroyOnHide(DataStore.get(this._overlay,'destroyonhide')!='false');this.setFixed(DataStore.get(this._overlay,'fixed')=='true');this._hasFooter=DataStore.get(this._overlay,'hasfooter',false);Event.listen(this._overlay,{click:this.click.bind(this),submit:this.submit.bind(this),mouseenter:this._onMouseEnter.bind(this),mouseleave:this._onMouseLeave.bind(this)});Arbiter.subscribe('Hovercard/show',function(e,f){this._onLayerShow(f.node);}.bind(this));Arbiter.subscribe('Hovercard/hide',function(e,f){this._onLayerHide(f.node);}.bind(this));Arbiter.subscribe('Overlay/show',function(e,f){if(f.overlay.getContext)this._onLayerShow(f.overlay.getContext());}.bind(this));Arbiter.subscribe('Overlay/hide',function(e,f){if(f.overlay.getContext)this._onLayerHide(f.overlay.getContext());}.bind(this));b(this,this._root);return this;},setHideOnBlur:function(c){if(!c&&this._hideOnBlurToken){this._removeHideOnBlurListener();this.unsubscribe(this._hideOnBlurToken);this._hideOnBlurToken=null;}else if(c&&!this._hideOnBlurToken){var d=this;var e=function(){(function(){d._hideOnBlurListener=Event.listen(document.documentElement,'click',function(event){if(!ContextualThing.containsIncludingLayers(d._overlay,event.getTarget()))d.setFadeOnHide(false).hide();});}).defer();};this.subscribe('hide',this._removeHideOnBlurListener.bind(this));this._hideOnBlurToken=this.subscribe('show',e);this._shown&&e();}return this;},_removeHideOnBlurListener:function(){this._hideOnBlurListener&&this._hideOnBlurListener.remove();this._hideOnBlurListener=null;},setDestroyOnHide:function(c){this.destroyOnHide=c;return this;},setHideOnSubmit:function(c){this._hideOnSubmit=c;return this;},setHideOnSuccess:function(c){this._hideOnSuccess=c;return this;},setFadeOnShow:function(c){this._fadeOnShow=c;return this;},setFadeOnHide:function(c){this._fadeOnHide=c;return this;},setWidth:function(c){this.width=parseInt(c,10);return this;},setFixed:function(c){this.fixed=c;return this;},getOverlay:function(){return this._overlay;},show:function(){if(!this._shown){CSS.show(this._root);CSS.setStyle(this._overlay,'opacity',0);DOM.appendContent(document.body,this._root);this.updatePosition();if(this._fadeOnShow!==false){animation(this._overlay).from('opacity',0).to('opacity',1).duration(100).ondone(CSS.setStyle.curry(this._overlay,'opacity','')).go();}else CSS.setStyle(this._overlay,'opacity','');this._shown=true;Arbiter.inform('layer_shown',{type:'Overlay'});Arbiter.inform('Overlay/show',{overlay:this});this.inform('show');}return this;},updatePosition:function(){if(this.width)CSS.setStyle(this._overlay,'width',this.width+'px');},hide:function(){if(!this._shown||this.inform('beforehide')===false)return;this._shown=false;var c=function(){if(this._root){DOM.remove(this._root);CSS.setStyle(this._overlay,'opacity','');}Arbiter.inform('layer_hidden',{type:'Overlay'});Arbiter.inform('Overlay/hide',{overlay:this});this.inform('hide');this.destroyOnHide&&this.destroy();}.bind(this);if(this._fadeOnHide!==false){animation(this._overlay).from('opacity',1).to('opacity',0).duration(250).ondone(c).go();}else c();},renderArrow:function(f,d){for(var e in Overlay.ARROW_CLASS)CSS.conditionClass(this._overlay,Overlay.ARROW_CLASS[e],f==e);CSS.conditionClass(this._overlay,'uiOverlayWithFooterArrowBottom',f=='bottom'&&this._hasFooter);if(f=='none')return;if(!this._arrow){this._arrow=$N('i',{className:'uiOverlayArrow'});DOM.appendContent(this._overlay,this._arrow);}CSS.setStyle(this._arrow,'top','');CSS.setStyle(this._arrow,'left','');CSS.setStyle(this._arrow,'right','');CSS.setStyle(this._arrow,'margin','');var h=f=='top'||f=='bottom';var g=h?(intl_locale_is_rtl()?'right':'left'):'top';d=d||0;CSS.setStyle(this._arrow,g,d+'%');var c=Overlay.ARROW_LENGTH+Overlay.ARROW_OFFSET*2;CSS.setStyle(this._arrow,'margin-'+g,-(c*d/100-Overlay.ARROW_OFFSET)+'px');},destroy:function(){Arbiter.unsubscribe(this._transitionSubscription);DOM.remove(this._root);DataStore.remove(this._root,'overlay');this._root=null;},click:function(d){var e=d.getTarget();var c=Parent.byTag(e,'input')||Parent.byTag(e,'button')||Parent.byTag(e,'a');if(c){a=c;if(CSS.hasClass(c,'uiOverlayCancelButton')){if(this.inform('cancel')!==false)this.hide();d.prevent();}}},submit:function(e){var f=e.getTarget();if(this.inform('submit')===false){e.kill();return;}var g=function(){if(this.inform('success')!==false&&this._hideOnSuccess)this.hide();}.bind(this);if(Form.getAttribute(f,'rel')==='async'){var h=(Form.getAttribute(f,'method')||'GET').toUpperCase();var d=Form.serialize(f,a);Form.setDisabled(f,true);var i=Parent.byClass(a,'stat_elem')||f;var c=Form.getAttribute(f,'ajaxify')||Form.getAttribute(f,'action');trackReferrer(f,c);if(this._hideOnSubmit){g();g=bagofholding;}new AsyncRequest(c).setData(d).setNectarModuleDataSafe(f).setReadOnly(h=='GET').setMethod(h).setStatusElement(i).setRelativeTo(f).setInitialHandler(Form.setDisabled.curry(f,false)).setHandler(g).setErrorHandler(function(j){if(this.inform('error',{response:j})!==false)AsyncResponse.defaultErrorHandler(j);}.bind(this)).send();e.kill();}else g();},_onMouseEnter:function(){this._fireMouseLeaveOnLayerHide=false;if(!this._layerNode)this.inform('mouseenter');},_onMouseLeave:function(){if(!this._layerNode)this.inform('mouseleave');this._fireMouseLeaveOnLayerHide=!!this._layerNode;},_onLayerShow:function(c){if(c&&DOM.contains(this._root,c))this._layerNode=c;},_onLayerHide:function(c){if(c&&this._layerNode===c){this._layerNode=null;if(this._fireMouseLeaveOnLayerHide)this._onMouseLeave();}}});}();
function ContextualDialogX(){this.parent.construct(this);return this;}Class.extend(ContextualDialogX,'Overlay');copy_properties(ContextualDialogX,{ARROW_INSET:22,TOP_MARGIN:8,BOTTOM_MARGIN:30,HALO_WIDTH:0,POSITION_TO_CLASS:{above:'uiContextualDialogAbove',below:'uiContextualDialogBelow',left:'uiContextualDialogLeft',right:'uiContextualDialogRight'},POSITION_TO_ARROW:{above:'bottom',below:'top',left:'right',right:'left'},getInstance:function(b){var a=DataStore.get(b,'ContextualDialogX');return a||Overlay.getInstance(b);}});ContextualDialogX.prototype={_scrollListener:null,init:function(c){this.parent.init(c);var b=DataStore.get.curry(this._root);this.setAlignH(b('alignh','left'));this.setOffsetX(b('offsetx',0));this.setOffsetY(b('offsety',0));this.setPosition(b('position'));var a=b('context');if(a){this.setContext($(a));}else{a=b('contextselector');if(a)this.setContext(DOM.find(document,a));}this._content=DOM.scry(this._root,'.uiContextualDialogContent')[0];var e=null;var d=null;this.subscribe('show',function(){var f=this.updatePosition.shield(this);e=Event.listen(window,'resize',f);d=Arbiter.subscribe('reflow',f);this._setupScrollListener(this._scrollParent);ContextualThing.register(this._root,this.context);}.bind(this));this.subscribe('hide',function(){e.remove();Arbiter.unsubscribe(d);this._teardownScrollListener();ContextualThing.remove(this._root);}.bind(this));Arbiter.subscribe('Hovercard/hide',function(f,g){if(Hovercard.contains(this.getContext()))this.hide();}.bind(this));},setAlignH:function(a){this.alignH=a;this._shown&&this.updatePosition();this.position&&this._updateArrow();return this;},getContent:function(){return this._content;},getContext:function(){return this.context;},setContext:function(a){a=$(a);if(this.context&&this.context!=a)DataStore.remove(this.context,'ContextualDialogX');this.context=a;var b=Parent.byClass(a,'fbPhotoSnowbox');if(b)b.appendChild(this._root);if(this._scrollListener&&this._scrollParent!==b){this._teardownScrollListener();this._setupScrollListener(b);}this._scrollParent=b;var c=OverlayZIndexHelper.getZIndex(a,b);CSS.setStyle(this._root,'z-index',c>200?c:'');DataStore.set(this.context,'ContextualDialogX',this);return this;},listen:function(b,a){return Event.listen(this._root,b,a);},setFixed:function(a){CSS.conditionClass(this._root,'uiContextualDialogFixed',a);return this.parent.setFixed(a);},setOffsetX:function(a){this.offsetX=parseInt(a,10)||0;this._shown&&this.updatePosition();return this;},setOffsetY:function(a){this.offsetY=parseInt(a,10)||0;this._shown&&this.updatePosition();return this;},setPosition:function(b){this.position=b;for(var a in ContextualDialogX.POSITION_TO_CLASS)CSS.conditionClass(this._root,ContextualDialogX.POSITION_TO_CLASS[a],b==a);this._shown&&this.updatePosition();this._updateArrow();return this;},updatePosition:function(){if(!this.context)return this;this.parent.updatePosition();var c=this.fixed?'viewport':'document';var g=Vector2.getElementPosition(this.context,c);var h=this._scrollParent;if(h)g=g.sub(Vector2.getElementPosition(h,'document')).add(h.scrollLeft,h.scrollTop);var a=Vector2.getElementDimensions(this.context);var k=this.position=='above'||this.position=='below';var d=intl_locale_is_rtl();if(d!=(this.position=='right'))g=g.add(a.x,0);if(this.position=='below')g=g.add(0,a.y);var f=new Vector2(0,0);var b=this.width+2*ContextualDialogX.HALO_WIDTH;if(k&&this.alignH=='center'){f=f.add((a.x-b)/2,0);}else{f=f.sub(k?ContextualDialogX.HALO_WIDTH:0,k?0:ContextualDialogX.HALO_WIDTH);var j=k?a.x:a.y;var e=2*(ContextualDialogX.ARROW_INSET+ContextualDialogX.HALO_WIDTH);if(j<e){var i=j/2-ContextualDialogX.ARROW_INSET;f=f.add(k?i:0,k?0:i);}}if(k&&this.alignH=='right')f=f.mul(-1,1).add(a.x-b,0);f=f.add(this.offsetX,this.offsetY);if(d)f=f.mul(-1,1);g=g.add(f);if(this.fixed)g=new Vector2(g.x,g.y,'document');g.setElementPosition(this._root);this._adjustVerticalPosition();return this;},scrollTo:function(){if(this.context)Bootloader.loadComponents('dom-scroll',function(){DOMScroll.scrollTo(this.context,true,true);}.bind(this));},destroy:function(){this.context&&DataStore.remove(this.context,'ContextualDialogX');this.parent.destroy();},_adjustVerticalPosition:function(){if(this.position!='left'&&this.position!='right'){CSS.setStyle(this._overlay,'top','');return;}var c=Vector2.getElementPosition(this._root,'viewport').y;var a=Vector2.getElementDimensions(this._overlay).y;var e=Vector2.getViewportDimensions().y;var d=ContextualDialogX.TOP_MARGIN;var b=Math.min(Math.max(0,c+a+ContextualDialogX.BOTTOM_MARGIN-e),Math.max(-d,c-d),a-2*ContextualDialogX.ARROW_INSET-2*ContextualDialogX.HALO_WIDTH);CSS.setStyle(this._overlay,'top',(-1*b)+'px');CSS.setStyle(this._arrow,'top',Overlay.ARROW_OFFSET+'px');CSS.setStyle(this._arrow,'marginTop',b+'px');},_updateArrow:function(){var a=0;if(this.position=='above'||this.position=='below')switch(this.alignH){case 'center':a=50;break;case 'right':a=100;break;}this.renderArrow(ContextualDialogX.POSITION_TO_ARROW[this.position],a);},_setupScrollListener:function(a){this._scrollListener=Event.listen(a||window,'scroll',this._adjustVerticalPosition.shield(this));},_teardownScrollListener:function(){this._scrollListener.remove();this._scrollListener=null;}};
if(!window.Toggler){window.Toggler=function(){this.init();};(function(){var e=[];var c;function d(){d=bagofholding;Event.listen(document.documentElement,'click',function(event){var f=event.getTarget();e.each(function(g){g.active&&!g.sticky&&!DOM.contains(g.getActive(),f)&&!g.inTargetFlyout(f)&&!g.inTargetContextualDialog(f)&&g.inActiveDialog()&&g.hide();});},Event.Priority.URGENT);}function a(g,f){if(g instanceof Toggler)return g;return Toggler.getInstance(f);}function b(g){var f=DOM.scry(g,'a[rel="toggle"]');if(f.length>0&&f[0].getAttribute('data-target'))return ge(f[0].getAttribute('data-target'));}Class.mixin(Toggler,'Arbiter',{init:function(){this.active=null;this.togglers={};this.setSticky(false);e.push(this);this.subscribe(['show','hide'],Toggler.inform.bind(Toggler));d();},show:function(h){var f=a(this,h);var i=f.active;if(h!==i){i&&f.hide();f.active=h;CSS.addClass(h,'openToggler');var g=DOM.scry(h,'a[rel="toggle"]');if(g.length>0&&g[0].getAttribute('data-target'))CSS.removeClass(ge(g[0].getAttribute('data-target')),'toggleTargetClosed');DOM.appendContent(h,f.getToggler('next'));DOM.prependContent(h,f.getToggler('prev'));f.inform('show',f);}},hide:function(i){var g=a(this,i);var f=g.active;if(f&&(!i||i===f)){CSS.removeClass(f,'openToggler');var h=DOM.scry(f,'a[rel="toggle"]');if(h.length>0&&h[0].getAttribute('data-target'))CSS.addClass(ge(h[0].getAttribute('data-target')),'toggleTargetClosed');values(g.togglers).each(DOM.remove);g.inform('hide',g);g.active=null;}},toggle:function(g){var f=a(this,g);if(f.active===g){f.hide();}else f.show(g);},getActive:function(){return a(this).active;},inTargetFlyout:function(g){var f=b(this.getActive());return f&&DOM.contains(f,g);},inTargetContextualDialog:function(i){var h=b(this.getActive());var g=ContextualDialogX.getInstance(i);var f=g&&g.getContext();return h&&f&&DOM.contains(h,f);},inActiveDialog:function(){var f=Dialog.getCurrent();return !f||DOM.contains(f.getRoot(),this.getActive());},getToggler:function(g){var f=a(this);if(!f.togglers[g])f.togglers[g]=$N('button',{className:'hideToggler',onfocus:function(){var h=DOM.scry(f.active,'a[rel="toggle"]')[0];h&&h.focus();f.hide();}});return this.togglers[g];},setSticky:function(g){var f=a(this);g=g!==false;if(g!==f.sticky){f.sticky=g;if(g){f._pt&&Arbiter.unsubscribe(f._pt);}else f._pt=Arbiter.subscribe('page_transition',f.hide.bind(f,null));}return f;}});copy_properties(Toggler,Toggler.prototype);copy_properties(Toggler,{bootstrap:function(f){var g=f.parentNode;Toggler.getInstance(g).toggle(g);},createInstance:function(g){var f=new Toggler().setSticky(true);DataStore.set(g,'toggler',f);return f;},getInstance:function(g){while(g){var f=DataStore.get(g,'toggler');if(f)return f;if(CSS.hasClass(g,'uiToggleContext'))return Toggler.createInstance(g);g=g.parentNode;}return (c=c||new Toggler());},listen:function(h,g,f){return Toggler.subscribe($A(h),function(j,i){if(i.getActive()===g)return f(j,i);});},subscribe:(function(f){return function(h,g){h=$A(h);if(h.contains('show'))e.each(function(i){if(i.getActive())g.curry('show',i).defer();});return f(h,g);};})(Toggler.subscribe.bind(Toggler))});})();}
function FutureHomeSideNav(){this.parent.construct(this);}Class.extend(FutureHomeSideNav,'FutureSideNav');FutureHomeSideNav.prototype={init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.seeAllEndpoint="/ajax/home/generic.php";this.typeSections={favorites:'pinnedNav',apps:'appsNav',groups:'groupsNav',pages:'pagesNav',lists:'listsNav',connect_apps:'connectNav'};this.switchingFromTitanFixedFrame=false;this._arbiterSubscriptions.push(Arbiter.subscribe('titan_fixed_frame_changed',this.handleFixedFrameChanged.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,this.updateFavorite.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FIRST_RESPONSE,this.navigationFirstResponse.bind(this)));this._ensureHover('homeSideNav');},initMoreLink:function(a){this._eventHandlers.push(Event.listen(a,'click',this._showMoreSections.bind(this,a)));},_showMoreSections:function(b){var a=DOM.scry(this.root,'div.belowThreshold');CSS.hide(b);a.forEach(function(c){CSS.removeClass(c,'belowThreshold');});},handleFixedFrameChanged:function(d,a,c){if(a){var b=function(e,f){UIPagelet.loadFromEndpoint(e,f,{fixed_frame:a,selected_key:c});};b('PinnedNavigationPagelet','pagelet_pinned_nav');b('BookmarkNavigationPagelet','pagelet_bookmark_nav');if(ge('chatFriendsOnline'))CSS.hide(ge('chatFriendsOnline'));}else this.switchingFromTitanFixedFrame=true;},handlePageTransition:function(a){if(this.switchingFromTitanFixedFrame){this.switchingFromTitanFixedFrame=false;return false;}else return this.parent.handlePageTransition(a);},_initSection:function(a){var d=this.parent._initSection(a);for(var e in this.typeSections){var c=this.typeSections[e];if(d.id==c){var b=DOM.scry(d.node,'div.navHeader')[0];if(b){var f='\/bookmarks\/('+e+')(\/)?';d.seeall=this._initItem({node:b,id:d.id,endpoint:this.seeAllEndpoint,key:['bookmarks'],path:[{regex:f}]});}}}return d;},_constructItem:function(a,b){return new FutureHomeSideNavItem(a,b);},_constructSection:function(a){return new FutureHomeSideNavSection(a);},getSection:function(a){return this.typeSections[a]&&this.sections[this.typeSections[a]];},_getItemForKey:function(a){var b=this.parent._getItemForKey("nf");if(b&&b.matchKey(a)){return b;}else return this.parent._getItemForKey(a);},_isCurrentPath:function(a){return ((a.getDomain()===this.uri.getDomain())&&(a.getPath()==='/'||a.getPath()==='/home.php'));},_handleMenuClick:function(c,a,b,event){if(CSS.hasClass(b,'favorite')){Arbiter.inform(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,{key:a.numericKey,favorite:!c.equals(this.getSection("favorites"))});}else this.parent._handleMenuClick(c,a,b,event);},removeItemByKey:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_REMOVED,a);this.parent.removeItemByKey(a);},toggleItemByKey:function(b,d){var c=this.getNodeForKey(b);if(!d){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_HIDDEN,b);c&&CSS.hide(c);}else c&&CSS.show(c);var a=this._getItemForKey(b);this.getSection(a.type).refresh();},removeItem:function(a){var b=this.getSection(a.type);this.parent.removeItem(a);b.refresh();},updateFavorite:function(g,b){var f=this._findItem(function(h){return h.matchKey(b.key)&&h.canFavorite();});var d=this.getSection("favorites");var a=bagofholding;var c=b.favorite?d.addEndpoint:d.removeEndpoint;if(!f){if(b.favorite){a=function(){UIPagelet.loadFromEndpoint('PinnedNavigationPagelet','pagelet_pinned_nav');};}else a=function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');};}else{var e=this.getSection(f.type);if(b.favorite){CSS.show(f.node);this.moveItem(d,f);f.showFavorite();}else{this.moveItem(e,f);f.hideFavorite();}e.refresh();d.refresh();b.key=f.numericKey;}new AsyncRequest().setURI(c).setData({id:b.key}).setHandler(a).send();},_doPageTransition:function(a,c){this._unloadStreams();var b=this.parent._doPageTransition(a,c);if(b&&(a.type=='groups'||a.type=='lists')){a.setCount(0);a.hideUnreadFace();}return b;},_unloadStreams:function(){var a=UIIntentionalStream&&UIIntentionalStream.instances;var b=['nile','global','friends','blade'];a&&b.forEach(function(c){a[c]&&a[c].unload();});},navigationFirstResponse:function(){this.setSelected(this.loading);}};function FutureHomeSideNavSection(a){this.parent.construct(this,a);this.editEndpoint='/ajax/bookmark/edit/';this.addEndpoint='/ajax/bookmark/add/';this.removeEndpoint='/ajax/bookmark/delete/';}Class.extend(FutureHomeSideNavSection,'FutureSideNavSection');FutureHomeSideNavSection.prototype={refresh:function(){var b=DOM.scry(this.node,'li.sideNavItem');var a=DOM.scry(this.node,'div.actionLinks');var c=b.some(CSS.shown);CSS.conditionShow(DOM.find(this.node,'div.navHeader'),c);a.length&&CSS.conditionShow(a[0],c);}};function FutureHomeSideNavItem(a,b){this.parent.construct(this,a,b);}Class.extend(FutureHomeSideNavItem,'FutureSideNavItem');FutureHomeSideNavItem.prototype={canFavorite:function(){return !!this._getFavoriteLabel();},showFavorite:function(){DOM.setContent(this._getFavoriteLabel(),_tx("Remove from Favorites"));},hideFavorite:function(){DOM.setContent(this._getFavoriteLabel(),_tx("Add to Favorites"));},hideUnreadFace:function(){var a=DOM.scry(this.node,'img.unreadProfileImg')[0];a&&CSS.hide(a);},_getFavoriteLabel:function(){return DOM.scry(this.node,'li.favorite span.itemLabel')[0];}};
function FutureProfileSideNav(){this.parent.construct(this);}Class.extend(FutureProfileSideNav,'FutureSideNav');FutureProfileSideNav.prototype={init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.altKeyParam='v';this.sidecol=false;},_constructItem:function(a,b){return new FutureProfileSideNavItem(a,b);},_doPageTransition:function(a,b){if(!this._profileChanged(b)&&!this._scopeChanged(a))return this.parent._doPageTransition(a,b);},_profileChanged:function(c){var b=c.getQueryData();var a=this.uri.getQueryData();return (b.id!==a.id||b.viewas!==a.viewas||b.and!==a.and);},_scopeChanged:function(a){return (!this.selected||a.layoutType!==this.selected.layoutType);},_getKey:function(a){return this.parent._getKey(a)||a[this.altKeyParam];}};function FutureProfileSideNavItem(a,b){this.parent.construct(this,a,b);this.layoutType=a.layouttype;}Class.extend(FutureProfileSideNavItem,'FutureSideNavItem');
function useFacebookReferer(b,a){var d=false;function e(){if(d)return;d=true;b.contentWindow.document.body.style.margin=0;a();}var c=(URI().isSecure()?'https://s-static.ak.facebook.com':'http://static.ak.facebook.com')+'/common/referer_frame.php';Event.listen(b,'load',e);b.src=c;}function useFacebookRefererHtml(b,a){useFacebookReferer(b,function(){b.contentWindow.document.body.innerHTML=a;});}
function htmlspecialchars(a){if(typeof(a)=='undefined'||a===null||!a.toString)return '';if(a===false){return '0';}else if(a===true)return '1';return a.toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#039;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}function htmlize(a){return htmlspecialchars(a).replace(/\r\n/g,'<br />').replace(/[\r\n]/g,'<br />');}function escape_js_quotes(a){if(typeof(a)=='undefined'||!a.toString)return '';return a.toString().replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/"/g,'\\x22').replace(/'/g,'\\\'').replace(/</g,'\\x3c').replace(/>/g,'\\x3e').replace(/&/g,'\\x26');}
if(typeof deconcept=="undefined")var deconcept={};if(typeof deconcept.util=="undefined")deconcept.util={};if(typeof deconcept.SWFObjectUtil=="undefined")deconcept.SWFObjectUtil={};deconcept.SWFObject=function(h,d,j,c,i,a,f,l,g,b){if(!document.getElementById)return;this.DETECT_KEY=b?b:'detectflash';this.skipDetect=deconcept.util.getRequestParameter(this.DETECT_KEY);this.params={};this.variables={};this.attributes=[];this.fallback_html='';this.fallback_js_fcn=function(){};if(h)this.setAttribute('swf',h);if(d)this.setAttribute('id',d);if(j)this.setAttribute('width',j);if(c)this.setAttribute('height',c);this.installedVer=deconcept.SWFObjectUtil.getPlayerVersion();if(i){if(!(i instanceof Array))i=[i];var k;i.each(function(n){k=new deconcept.PlayerVersion(n.toString().split('.'));if(k.major==this.installedVer.major){this.setAttribute('version',k);return;}else if(!this.getAttribute('version')||k.major<this.getAttribute('version').major)this.setAttribute('version',k);}.bind(this));}if(!window.opera&&document.all&&this.installedVer.major>7)if(!deconcept.unloadSet){deconcept.SWFObjectUtil.prepUnload=function(){__flash_unloadHandler=function(){};__flash_savedUnloadHandler=function(){};window.attachEvent("onunload",deconcept.SWFObjectUtil.cleanupSWFs);};window.attachEvent("onbeforeunload",deconcept.SWFObjectUtil.prepUnload);deconcept.unloadSet=true;}if(a)this.addParam('bgcolor',a);var e=f?f:'high';this.addParam('quality',e);this.setAttribute('useExpressInstall',false);this.setAttribute('doExpressInstall',false);var m=(l)?l:window.location;this.setAttribute('xiRedirectUrl',m);this.setAttribute('redirectUrl','');if(g)this.setAttribute('redirectUrl',g);this.setAttribute('useIframe',false);};deconcept.SWFObject.ieWorkaroundApplied=false;deconcept.SWFObject.ensureIEWorkaroundAttached=function(){if(!deconcept.SWFObject.ieWorkaroundApplied&&document.attachEvent){deconcept.SWFObject.ieWorkaroundApplied=true;document.attachEvent('onpropertychange',deconcept.SWFObject.onDocumentPropertyChange);}};deconcept.SWFObject.onDocumentPropertyChange=function(event){if(event.propertyName=="title"){var a=document.title;if(a!=null&&a.indexOf('#!')!=-1){a=a.substring(0,a.indexOf('#!'));document.title=a;}}};deconcept.SWFObject.prototype={useExpressInstall:function(a){this.xiSWFPath=!a?"/swf/expressinstall.swf":a;this.setAttribute('useExpressInstall',true);},setAttribute:function(a,b){this.attributes[a]=b;},getAttribute:function(a){return this.attributes[a]||"";},addParam:function(a,b){this.params[a]=b;},getParams:function(){return this.params;},addVariable:function(a,b){this.variables[a]=b;},getVariable:function(a){return this.variables[a]||"";},getVariables:function(){return this.variables;},getVariablePairs:function(){var b=[];var a;var c=this.getVariables();for(a in c)b[b.length]=a+"="+c[a];return b.join('&');},getSWFHTML:function(){var f,d,a;if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){if(this.getAttribute("doExpressInstall")){this.addVariable("MMplayerType","PlugIn");this.setAttribute('swf',this.xiSWFPath);}d={type:'application/x-shockwave-flash',src:this.getAttribute('swf'),width:this.getAttribute('width'),height:this.getAttribute('height'),style:this.getAttribute('style')||'',id:this.getAttribute('id'),name:this.getAttribute('id')};var c=this.getParams();for(var b in c)d[b]=c[b];a=this.getVariablePairs();if(a)d.flashvars=a;f=render_tag_as_htmlstring('embed',d,null);}else{if(this.getAttribute("doExpressInstall")){this.addVariable("MMplayerType","ActiveX");this.setAttribute('swf',this.xiSWFPath);}d={id:this.getAttribute('id'),classid:'clsid:D27CDB6E-AE6D-11cf-96B8-444553540000',width:this.getAttribute('width'),height:this.getAttribute('height'),style:this.getAttribute('style')||''};var e=render_tag_as_htmlstring('param',{name:'movie',value:this.getAttribute('swf')},null);var c=this.getParams();for(var b in c)e+=render_tag_as_htmlstring('param',{name:b,value:c[b]},null);a=this.getVariablePairs();if(a)e+=render_tag_as_htmlstring('param',{name:'flashvars',value:a},null);f=render_tag_as_htmlstring('object',d,e);}return f;},write:function(a){if(this.getAttribute('useExpressInstall')){var b=new deconcept.PlayerVersion([6,0,65]);if(this.installedVer.versionIsValid(b)&&!this.installedVer.versionIsValid(this.getAttribute('version'))){this.setAttribute('doExpressInstall',true);this.addVariable("MMredirectURL",escape(this.getAttribute('xiRedirectUrl')));document.title=document.title.slice(0,47)+" - Flash Player Installation";this.addVariable("MMdoctitle",document.title);}}var c=(typeof a=='string')?document.getElementById(a):a;if(!c)return false;CSS.addClass(c,'swfObject');c.setAttribute('data-swfid',this.getAttribute('id'));if(this.skipDetect||this.getAttribute('doExpressInstall')||this.installedVer.versionIsValid(this.getAttribute('version'))){if(!this.getAttribute('useIframe')){deconcept.SWFObject.ensureIEWorkaroundAttached();c.innerHTML=this.getSWFHTML();}else this._createIframe(c);return true;}else{if(this.getAttribute('redirectUrl')!="")document.location.replace(this.getAttribute('redirectUrl'));need_version=this.getAttribute('version').major+'.'+this.getAttribute('version').minor+'.'+this.getAttribute('version').rev;have_version=this.installedVer.major+'.'+this.installedVer.minor+'.'+this.installedVer.rev;this.fallback_js_fcn(have_version,need_version);c.innerHTML=this.fallback_html;}return false;},_createIframe:function(b){var a=$N('iframe',{width:this.getAttribute('width'),height:this.getAttribute('height'),frameBorder:0});DOM.empty(b);b.appendChild(a);useFacebookRefererHtml.bind(null,a,this.getSWFHTML()).defer();}};deconcept.SWFObjectUtil.getPlayerVersion=function(){var a=new deconcept.PlayerVersion([0,0,0]);if(navigator.plugins&&navigator.mimeTypes.length){for(var g=0;g<navigator.plugins.length;g++)try{var x=navigator.plugins[g];if(x.name=='Shockwave Flash'){PlayerVersion_tmp=new deconcept.PlayerVersion(x.description.replace(/([a-zA-Z]|\s)+/,"").replace(/(\s+(r|d)|\s+b[0-9]+)/,".").split("."));if(typeof a=='undefined'||PlayerVersion_tmp.major>a.major||(PlayerVersion_tmp.major==a.major&&(PlayerVersion_tmp.minor>a.minor||(PlayerVersion_tmp.minor==a.minor&&PlayerVersion_tmp.rev>a.rev))))a=PlayerVersion_tmp;}}catch(f){}}else if(navigator.userAgent&&navigator.userAgent.indexOf("Windows CE")>=0){var b=1;var c=3;while(b)try{c++;b=new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+c);a=new deconcept.PlayerVersion([c,0,0]);}catch(d){b=null;}}else{try{var b=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.7");}catch(e){try{var b=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");a=new deconcept.PlayerVersion([6,0,21]);b.AllowScriptAccess="always";}catch(e2){if(a.major==6)return a;}try{b=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");}catch(e3){}}if(b!=null)a=new deconcept.PlayerVersion(b.GetVariable("$version").split(" ")[1].split(","));}return a;};deconcept.PlayerVersion=function(a){this.major=a[0]!=null?parseInt(a[0]):0;this.minor=a[1]!=null?parseInt(a[1]):0;this.rev=a[2]!=null?parseInt(a[2]):0;};deconcept.PlayerVersion.prototype.versionIsValid=function(a){if(this.major<a.major)return false;if(this.major>a.major)return true;if(this.minor<a.minor)return false;if(this.minor>a.minor)return true;if(this.rev<a.rev)return false;return true;};deconcept.util={getRequestParameter:function(c){var d=document.location.search||document.location.hash;if(c==null)return d;if(d){var b=d.substring(1).split("&");for(var a=0;a<b.length;a++)if(b[a].substring(0,b[a].indexOf("="))==c)return b[a].substring((b[a].indexOf("=")+1));}return "";}};deconcept.SWFObjectUtil.cleanupSWFs=function(){var b=document.getElementsByTagName("OBJECT");for(var a=b.length-1;a>=0;a--){b[a].style.display='none';for(var c in b[a])if(typeof b[a][c]=='function')b[a][c]=function(){};}};if(!document.getElementById&&document.all)document.getElementById=function(a){return document.all[a];};var getQueryParamValue=deconcept.util.getRequestParameter;var FlashObject=deconcept.SWFObject;var SWFObject=deconcept.SWFObject;function spawn_flash_update_dialog(){new AsyncRequest().setURI('/ajax/flash_update_dialog.php').setMethod('GET').setReadOnly(true).send();}function setFlashFallback(d,g){var b=ge(d);var a=deconcept.SWFObjectUtil.getPlayerVersion();var e;g.each(function(h){h=new deconcept.PlayerVersion(h.toString().split('.'));if(h.major==a.major){e=h;return;}else if(typeof e=='undefined'||h.major<e.major)e=h;}.bind(this));if(b&&a.major>0){var c=a.major+'.'+a.minor+'.'+a.rev;var f=e.major+'.'+e.minor+'.'+e.rev;b.innerHTML=_tx("Flash {required-version} is required to view this content. Your current version is {current-version}. Please download the latest Flash Player.",{'required-version':f,'current-version':c});}}function showFlashErrorDialog(b,a){Bootloader.loadComponents('error-dialog',function(){ErrorDialog.show(b,a);});}function render_tag_as_htmlstring(f,b,c){var a=/^[A-Za-z0-9\-]+$/;Util.assert(f.match(a),'Invalid tag '+f);var e='<'+f;for(var d in b){Util.assert(d.match(a),'Invalid attr '+d);e+=' '+d+'="'+htmlspecialchars(b[d])+'"';}if(c===null){return e+'/>';}else return e+'>'+c+'</'+f+'>';}
function Flash(){}copy_properties(Flash,{INIT:'flash/init',READY:'flash/ready',FAILED:'flash/failed'});
function SimpleDrag(a){Event.listen(a,'mousedown',this._start.bind(this));}Class.mixin(SimpleDrag,'Arbiter',{_start:function(event){this.inform('start',event);var b=ua.ie()<9?document.documentElement:window;var a=Event.listen(b,{selectstart:Event.prevent,mousemove:this.inform.bind(this,'update'),mouseup:function(event){for(var c in a)a[c].remove();this.inform('end',event);}.bind(this)});return false;}});
function ScrollableArea(){}copy_properties(ScrollableArea,{getInstance:function(a){var b=Parent.byClass(a,'uiScrollableArea');return b?DataStore.get(b,'ScrollableArea'):null;}});ScrollableArea.prototype={init:function(a,b){b=b||{};this._elem=a;this._wrap=DOM.find(a,'div.uiScrollableAreaWrap');this._body=DOM.find(this._wrap,'div.uiScrollableAreaBody');this._track=DOM.find(a,'div.uiScrollableAreaTrack');this._gripper=DOM.find(this._track,'div.uiScrollableAreaGripper');this._options=b;this.adjustGripper();this._listeners=[Event.listen(this._wrap,'scroll',this._handleScroll.bind(this))];if(b.fade!==false)this._listeners.push(Event.listen(a,'mouseenter',this.adjustGripper.shield(this)),Event.listen(a,'mouseenter',this.showScrollbar.shield(this)),Event.listen(a,'mousemove',this._handleMousemove.bind(this)),Event.listen(a,'mouseout',this.hideScrollbar.shield(this)));this.initDrag();DataStore.set(this._elem,'ScrollableArea',this);if(!b.persistent)onleaveRegister(this.destroy.bind(this));},initDrag:function(){var a=new SimpleDrag(this._gripper);a.subscribe('start',function(b,event){if(!((event.which&&event.which===1)||(event.button&&event.button===1)))return;var d=this._getPageY(event);var e=this._gripper.offsetTop;var f=a.subscribe('update',function(g,event){var j=this._getPageY(event)-d;var i=this._elem.clientHeight;var h=this._body.offsetHeight;var p=this._track.offsetHeight;var k=i/h*p;var m=h-this._wrap.offsetHeight;var l=e+j;var n=p-k;l=Math.max(Math.min(l,n),0);var o=l/n*m;this._wrap.scrollTop=o;}.bind(this));var c=a.subscribe('end',function(){a.unsubscribe(f);a.unsubscribe(c);});}.bind(this));},adjustGripper:function(){var b=this._elem.clientHeight;var a=this._body.offsetHeight;var e=this._track.offsetHeight;var c=b/a*e;if(c<e){CSS.setStyle(this._gripper,'height',c+'px');var d=this._wrap.scrollTop/a*e;CSS.setStyle(this._gripper,'top',d+'px');CSS.show(this._gripper);}else CSS.hide(this._gripper);this._checkContentBoundaries();return this;},_checkContentBoundaries:function(){var a=this._wrap.scrollTop;var b=this._wrap.scrollHeight-this._wrap.clientHeight;CSS.conditionClass(this._elem,'contentBefore',a>0);CSS.conditionClass(this._elem,'contentAfter',a<b);},destroy:function(){this._listeners.forEach(function(a){a.remove();});this._listeners.length=0;},_getPageX:function(event){return event.pageX!=null?event.pageX:event.clientX+document.body.scrollLeft;},_getPageY:function(event){return event.pageY!=null?event.pageY:event.clientY+document.body.scrollTop;},_handleMousemove:function(event){var a=Vector2.getElementPosition(this._track).x;var b=Vector2.getElementDimensions(this._track).x;if(Math.abs(a+b/2-this._getPageX(event))<25){this.showScrollbar(false);}else this.hideScrollbar();},_handleScroll:function(event){this.adjustGripper();if(this._options.fade!==false)this.showScrollbar();},hideScrollbar:function(){if(!this._scrollbarVisible)return this;this._scrollbarVisible=false;if(this._hideTimeout){clearTimeout(this._hideTimeout);this._hideTimeout=null;}this._hideTimeout=function(){if(this._scrollbarAnimation){this._scrollbarAnimation.stop();this._scrollbarAnimation=null;}this._scrollbarAnimation=animation(this._track).from('opacity',1).to('opacity',0).duration(250).ondone(CSS.addClass.curry(this._track,'invisible_elem')).go();}.bind(this).defer(750);return this;},showScrollbar:function(a){if(this._scrollbarVisible)return this;this._scrollbarVisible=true;if(this._hideTimeout){clearTimeout(this._hideTimeout);this._hideTimeout=null;}if(this._scrollbarAnimation){this._scrollbarAnimation.stop();this._scrollbarAnimation=null;}CSS.setStyle(this._track,'opacity',1);CSS.removeClass(this._track,'invisible_elem');if(a!==false)this.hideScrollbar();return this;},scrollToBottom:function(){animation(this._wrap).to('scrollTop',this._wrap.scrollHeight).ease(animation.ease.end).go();}};
FriendRequestMessage={STATUS:'FriendRequest/change',UNFRIEND:'FriendRequest/unfriend',CANCEL:'FriendRequest/cancel',CANCELLING:'FriendRequest/cancelling',CANCEL_FAIL:'FriendRequest/cancelFail',SENT:'FriendRequest/sent',SENDING:'FriendRequest/sending',SEND_FAIL:'FriendRequest/sendFail',CONFIRM:'FriendRequest/confirm',CONFIRMING:'FriendRequest/confirming',CONFIRM_FAIL:'FriendRequest/confirmFail'};function FriendStatus(a,c,b){this.id=a;this.update(c,b);}FriendStatus.prototype={update:function(b,a){b&&(this.status=b);if(a){this.lists=$A(a).map(String);this._informListChange();}},isComplete:function(){return !!this.lists;},addToList:function(a){if(this.lists&&!this.lists.contains(a))this.lists.push(a);this._informListChange();},removeFromList:function(b){if(this.lists){var a=this.lists.indexOf(b);a!==-1&&this.lists.splice(a,1);}this._informListChange();},updateList:function(b,a){a?this.addToList(b):this.removeFromList(b);},_informListChange:function(){Arbiter.inform('FriendListMembershipChange',{uid:this.id,lists:this.lists});}};copy_properties(FriendStatus,{ARE_FRIENDS:1,INCOMING_REQUEST:2,OUTGOING_REQUEST:3,CAN_REQUEST:4});(function(){var a={};var b={};function c(f,d,e){if(!a[e.uid]){a[e.uid]=new FriendStatus(e.uid,f);}else a[e.uid].update(f);Arbiter.inform(FriendRequestMessage.STATUS,{uid:e.uid,status:f});}onloadRegister(function(){Arbiter.subscribe([FriendRequestMessage.CANCEL,FriendRequestMessage.UNFRIEND,FriendRequestMessage.SEND_FAIL],c.curry(FriendStatus.CAN_REQUEST));Arbiter.subscribe([FriendRequestMessage.CONFIRM_FAIL],c.curry(FriendStatus.INCOMING_REQUEST));Arbiter.subscribe([FriendRequestMessage.CANCEL_FAIL,FriendRequestMessage.SENT,FriendRequestMessage.SENDING],c.curry(FriendStatus.OUTGOING_REQUEST));Arbiter.subscribe([FriendRequestMessage.CONFIRM,FriendRequestMessage.CONFIRMING],c.curry(FriendStatus.ARE_FRIENDS));});copy_properties(FriendStatus,{CLOSE_FRIENDS:null,ACQUAINTANCES:null,getFriend:function(d,e){if(a[d]&&a[d].isComplete()){e(a[d]);}else if(b[d]){b[d].push(e);}else{b[d]=[e];new AsyncRequest().setURI("/ajax/friends/status.php").setData({friend:d}).setHandler(function(g){var f=g.getPayload();FriendStatus.initFriend(d,f.status,f.lists);}).send();}},initFriend:function(e,g,f){var d=a[e]||new FriendStatus(e);d.update(d.status||g,d.lists||f);a[e]=d;b[e]&&b[e].forEach(function(h){h(d);});b[e]=null;},setSpecialLists:function(d){FriendStatus.CLOSE_FRIENDS=d.close+'';FriendStatus.ACQUAINTANCES=d.acq+'';}});})();
var DynamicFriendListEducation=(function(){var h;var e;var d;var c;var a;var i;var g=function(){d&&d.hide();c&&c.hide();};var f=function(j){e.remove(j);g();a({accept_tag_education:true});};var b=function(){g();a({nux_cancel:true});};return {init:function(k,j){h=k;e=$A(j).map(String);PageTransitions.registerHandler(function(){g();h=false;a=undefined;e=[];});},showDialog:function(k,l,j){if(h&&e.contains(k)){g();Arbiter.inform('DynamicFriendListEducation/dialogOpen',{uid:l,flid:k});a=j;d=new Dialog().setAsync(new AsyncRequest('/ajax/friends/lists/smart_list_education.php').setMethod('GET').setData({flid:k,uid:l}).setReadOnly(true)).setHandler(f.bind(this,k)).setCloseHandler(function(){Arbiter.inform('DynamicFriendListEducation/dialogClosed',{uid:l,flid:k});}).setCancelHandler(function(){Arbiter.inform('DynamicFriendListEducation/dialogCancel',{uid:l,flid:k});}).show();}else j();},showContextualDialog:function(k,m,l,j){if(h&&e.contains(k)){g();i=l;a=j;new AsyncRequest('/ajax/friends/lists/smart_list_contextual_education.php').setMethod('GET').setData({flid:k,uid:m}).setReadOnly(true).send();}else j();},setContextualDialog:function(l,j,k,m){c=l;c.setContext(i);c.show();Event.listen(j,'click',f.bind(this,m));Event.listen(k,'click',b);}};})();
var FriendEditLists=(function(){var a=7;var c={};var m="/ajax/profile/removefriendconfirm.php";var b="/friends/ajax/remove_friend.php?type=friend&fbx=1";var h;function j(p,q,o){var r=c[p.id];var n=function(u){var t={action:o?'add_list':'del_list',to_friend:r.id,friendlists:[q],source:h};if(u)copy_properties(t,u);r.updateList(q,o);var v;if(o&&q==FriendStatus.CLOSE_FRIENDS){v=e(p,FriendStatus.ACQUAINTANCES);if(Menu.isItemChecked(v)){Menu.toggleItem(v);j(p,FriendStatus.ACQUAINTANCES,false);}}else if(o&&q==FriendStatus.ACQUAINTANCES){v=e(p,FriendStatus.CLOSE_FRIENDS);if(Menu.isItemChecked(v)){Menu.toggleItem(v);j(p,FriendStatus.CLOSE_FRIENDS,false);}}var w={flid:q,uid:r.id};var s=o?'FriendListHovercard/add':'FriendListHovercard/remove';Arbiter.inform(s,w);new AsyncRequest().setURI('/ajax/add_friend/action.php').setData(t).send();};if(o){DynamicFriendListEducation.showDialog(q,r.id,n);}else n();}function d(o){var n=DOM.scry(o,'input')[0];return n&&n.value;}function f(n,p,q){var o={uid:p.id};new AsyncRequest().setURI(b).setMethod('POST').setData({friend:p.id}).setHandler(Arbiter.inform.bind(Arbiter,FriendRequestMessage.CANCEL,o)).setErrorHandler(Arbiter.inform.bind(Arbiter,FriendRequestMessage.CANCEL_FAIL,o)).setStatusElement(q).send();}function e(n,o){var q=Menu.getItems(n);for(var p=0;p<q.length;p++)if(d(q[p])==o)return q[p];return null;}function k(n,o){var p=Menu.getItems(n);p.forEach(function(s){var r=d(s);var q=o.lists.contains(r);if(Menu.isItemChecked(s)!==q)Menu.toggleItem(s);});}function i(o){var p=Menu.getItems(o);var n=[];var s=[];var u=0;var t=0;p.forEach(function(x){if(CSS.hasClass(x,'neverHide')){CSS.removeClass(x,'underShowMore');u++;}else if(Menu.isItemChecked(x)){n.push(x);}else if(CSS.hasClass(x,'neverShow')||CSS.hasClass(x,'FriendListCreateTrigger')){CSS.addClass(x,'underShowMore');t++;}else s.push(x);});var w=a-u;var r=n.concat(s);var q=t;r.forEach(function(x){if(CSS.hasClass(x,'ShowMoreItem')){w--;return;}if(w){CSS.removeClass(x,'underShowMore');w--;}else{CSS.addClass(x,'underShowMore');q=true;}});CSS.conditionClass(o,'hasMoreFriendListItems',q);var v=DOM.scry(o,'.FriendListMenuShowMore');v.forEach(function(x){CSS.removeClass(x,'FriendListMenuShowMore');});}function l(o,p){var q=DOM.scry(o,'.FriendListUnfriend')[0];var n=DOM.scry(o,'.FriendListCancel')[0];if(n)CSS.conditionShow(n,p.status==FriendStatus.OUTGOING_REQUEST);if(q){CSS.conditionShow(q,p.status==FriendStatus.ARE_FRIENDS);DOM.find(q,'a').setAttribute('ajaxify',URI(m).addQueryData({uid:p.id}).toString());}}var g=function(){g=bagofholding;Arbiter.subscribe(FriendRequestMessage.STATUS,function(r,q){for(var p in c){var n=ge(p);var o=c[p];if(n&&o&&o.id==q.uid){k(n,o);l(n,o);i(n);}}});Menu.subscribe('select',function(n,o){if(CSS.hasClass(o.item,'ShowMoreItem')&&CSS.hasClass(o.menu,'FriendListMenu')){CSS.addClass(o.menu,'FriendListMenuShowMore');var p=ScrollableArea.getInstance(o.item);p&&p.adjustGripper().showScrollbar(false);}});};return {init:function(n,o,p){n=$(n);h=p;g();if(!c[n.id])Menu.subscribe('select',function(q,r){if(DOM.contains(n,r.item))if(Parent.byClass(r.item,'FriendListItem')){Menu.toggleItem(r.item);var s=d(r.item);j(n,s,Menu.isItemChecked(r.item));}else if(Parent.byClass(r.item,'FriendListCancel')){f(n,c[n.id],r.item);}else if(Parent.byClass(r.item,'FriendListUnfriend'))FriendListFlyoutController.hide(false);});CSS.addClass(n,'async_saving');FriendStatus.getFriend(o,function(q){k(n,q);l(n,q);c[n.id]=q;i(n);CSS.removeClass(n,'async_saving');}.bind(this));}};})();
var FriendListFlyoutController=(function(){var d;var e;var n;var a;var o;var v;var l;var s;var f;var c=1500;function h(x){if(DOM.isNodeOfType(x,['body','html']))return document.body;while((x=x.parentNode)&&x!==document.body)if(CSS.getStyle(x,'position')!=='static')return x;return document.body;}function m(x){while(x&&x!==document.body){if(CSS.getStyle(x,'position')==='fixed')return true;x=h(x);}return false;}function q(){clearTimeout(l);}function p(){if(a){CSS.removeClass(a,'selected');CSS.removeClass(a,'uiButtonHover');if(DataStore.get(a,'flfcloselistener')){var x=a;DataStore.set(a,'flfcloselistenertimeout',g.curry(x).defer(c));}}e=false;b();a=null;}function i(x){if(DOM.isNodeOfType(x,'label')&&CSS.hasClass(x,'uiButton'))x=Button.getInputElement(x);return DataStore.get(x,'profileid');}function b(){o&&o.remove();o=null;s&&Arbiter.unsubscribe(s);s=null;l&&clearTimeout(l);l=null;}function u(y){if(!d||e)return;d.setContext(y);var z=i(y);var x=DataStore.get(y,'flloc');FriendEditLists.init(n,z,x);CSS.addClass(y,'selected');CSS.addClass(y,'uiButtonHover');d.setFixed(m(y)).show();a=y;e=true;var za=DOM.scry(n,'div.uiScrollableArea')[0];za&&ScrollableArea.getInstance(za).adjustGripper().showScrollbar();b();o=Event.listen(y,'mouseleave',j);s=Arbiter.subscribe('Overlay/show',k);if(DataStore.get(y,'flfcloselistener'))clearTimeout(DataStore.remove(y,'flfcloselistenertimeout'));FriendStatus.getFriend(z,function(zc){var zb=DOM.scry(d.getContent(),'.FlyoutFriendListMenuNUX')[0];if(!zb)return;if(zc.status==FriendStatus.OUTGOING_REQUEST){CSS.show(zb);AsyncRequest.bootstrap('/ajax/friends/lists/nux_flyout.php',null,true);}else CSS.hide(zb);});}function t(x){a=x;v=u.curry(x).defer(100);o=Event.listen(x,'mouseleave',function(){clearTimeout(v);a=null;o&&o.remove();});}function j(){l=k.defer(150);}function w(){var y=Dialog.getCurrent();var x=y&&y.getBody();return !!(x&&DOM.scry(x,'.friendListDialogTourCarousel')[0]);}function k(){if(f||w())return;ua.ie()<8&&document.documentElement.focus();d&&d.hide();}function r(event){var x=Parent.byTag(event.getTarget(),'a');if(x&&CSS.hasClass(x,'FriendListActionItem'))j();}function g(y){var x=DataStore.remove(y,'flfcloselistener');x&&x();}return {init:function(x,y){FriendListFlyoutController.init=bagofholding;d=x;n=y;d.subscribe('mouseenter',q);d.subscribe('mouseleave',j);d.subscribe('hide',p);Event.listen(n,'click',r);Event.listen(document.documentElement,'mouseover',function(z){var za=Parent.byClass(z.getTarget(),'enableFriendListFlyout');if(za)if(a===za){clearTimeout(l);}else{e&&k();t(za);}});Arbiter.subscribe('DynamicFriendListEducation/dialogOpen',function(){f=true;});Arbiter.subscribe('DynamicFriendListEducation/dialogClosed',function(){f=false;j();});},show:function(x){u(x);},hide:function(x){x===false?k():j();},setActiveNode:function(x){e&&k();a=x;o=Event.listen(x,'mouseleave',function(){a=null;o&&o.remove();});},setCloseListener:function(y,x){DataStore.set(y,'flfcloselistener',x);if(a!=y)DataStore.set(y,'flfcloselistenertimeout',g.curry(y).defer(c));},setCloseListenerTimeout:function(x){c=x;}};})();
var AddFriendButton={ERROR_ALREADY_ADDED:1431005,init:function(q,o,r,i,p,j,l,m){var g=null;var f=DOM.scry(q,'.addButton')[0];var n=DOM.scry(q,'.outgoingButton')[0];var k=DOM.scry(q,'.incomingButton')[0];var h=DOM.scry(q,'.friendButton')[0];function b(s,v,u){var t=new URI(f.getAttribute('ajaxify'));var w='';var x=ge('fbRequestsUnwanted');if(x){w=x.value;x.value='';}new AsyncRequest().setURI(j).setData({to_friend:o,action:s,how_found:i,ref_param:p,outgoing_id:n.id,xids:t.getQueryData().xids,unwanted:w,logging_location:l,no_flyout_on_click:m}).setErrorHandler(v).setServerDialogCancelHandler(u).setRelativeTo(n).send();}function e(s,t){f&&CSS.hide(f);n&&CSS.hide(n);k&&CSS.hide(k);h&&CSS.hide(h);if(s)CSS.show(s);g&&CSS.removeClass(q,'fStatus'+g);g=t;CSS.addClass(q,'fStatus'+t);}function c(s){if(CSS.hasClass(s,'enableFriendListFlyout')){FriendListFlyoutController.show(s);}else FriendListFlyoutController.hide();}var d=Arbiter.subscribe(FriendRequestMessage.STATUS,function(t,s){if(s.uid!=o)return;switch(s.status){case FriendStatus.ARE_FRIENDS:return e(h,'Friends');case FriendStatus.INCOMING_REQUEST:return e(k,'Incoming');case FriendStatus.OUTGOING_REQUEST:return e(n,'Outgoing');case FriendStatus.CAN_REQUEST:return e(f,'Requestable');}});var a;if(r)a=Arbiter.subscribe(FriendRequestMessage.CONFIRM,function(s,t){t.uid==o&&goURI(r);});f&&Event.listen(f,'click',function(){Arbiter.inform(FriendRequestMessage.SENDING,{uid:o});if(m){FriendListFlyoutController.setActiveNode(n);}else c(n);b("add_friend",function(t){var s=t.error==AddFriendButton.ERROR_ALREADY_ADDED?FriendRequestMessage.SENT:FriendRequestMessage.SEND_FAIL;Arbiter.inform(s,{uid:o});FriendListFlyoutController.hide();AsyncResponse.defaultErrorHandler(t);},function(s){Arbiter.inform(FriendRequestMessage.SEND_FAIL,{uid:o});FriendListFlyoutController.hide();});});PageTransitions.registerHandler(function(){Arbiter.unsubscribe(d);a&&Arbiter.unsubscribe(a);});}};
var FriendButtonIcon={init:function(b,e,f){var d=DOM.find(e,'.defaultIcon');var c=DOM.find(e,'.closeIcon');var a=DOM.find(e,'.acqIcon');Arbiter.subscribe('FriendListMembershipChange',function(g,h){if(h.uid==f){var j=h.lists.contains(FriendStatus.CLOSE_FRIENDS);var i=h.lists.contains(FriendStatus.ACQUAINTANCES);if(j&&!i){Button.setIcon(b,c);}else if(i&&!j){Button.setIcon(b,a);}else Button.setIcon(b,d);}});}};
var Menu=function(){var i='menu:mouseover';var a=null;function b(k){return Parent.byClass(k,'uiMenu');}function c(k){return Parent.byClass(k,'uiMenuItem');}function d(k){if(document.activeElement){var l=c(document.activeElement);return k.indexOf(l);}return -1;}function e(k){return DOM.find(k,'a.itemAnchor');}function f(k){return CSS.hasClass(k,'checked');}function g(k){return !CSS.hasClass(k,'disabled');}function h(event){var k=document.activeElement;if(!k||!Parent.byClass(k,'uiMenu')||!DOM.isNodeOfType(k,['input','textarea'])){var l=c(event.getTarget());l&&Menu.focusItem(l);}}function j(k){Menu.inform('select',{menu:b(k),item:k});}onloadRegister(function(){var k={};k.click=function(event){var n=c(event.getTarget());if(n&&g(n)){j(n);var l=e(n);var m=l.href;var o=l.getAttribute('rel');return (o&&o!=='ignore')||(m&&m.charAt(m.length-1)!=='#');}};k.keydown=function(event){var u=event.getTarget();if(event.getModifiers().any)return;if(!a||DOM.isNodeOfType(u,['input','textarea']))return;var q=Event.getKeyCode(event);switch(q){case KEYS.UP:case KEYS.DOWN:var m=Menu.getEnabledItems(a);var o=d(m);Menu.focusItem(m[o+(q===KEYS.UP?-1:1)]);return false;case KEYS.SPACE:var t=c(u);if(t){j(t);event.prevent();}break;default:var l=String.fromCharCode(q).toLowerCase();var p=Menu.getEnabledItems(a);var o=d(p);var n=o;var r=p.length;while((~o&&(n=++n%r)!==o)||(!~o&&++n<r)){var s=Menu.getItemLabel(p[n]);if(s&&s.charAt(0).toLowerCase()===l){Menu.focusItem(p[n]);return false;}}}};Event.listen(document.body,k);});return copy_properties(new Arbiter(),{focusItem:function(k){if(k&&g(k)){this._removeSelected(b(k));CSS.addClass(k,'selected');e(k).focus();}},getEnabledItems:function(k){return Menu.getItems(k).filter(g);},getCheckedItems:function(k){return Menu.getItems(k).filter(f);},getItems:function(k){return DOM.scry(k,'li.uiMenuItem');},getItemLabel:function(k){return k.getAttribute('data-label',2)||'';},isItemChecked:function(k){return CSS.hasClass(k,'checked');},register:function(k,l){k=b(k);if(!DataStore.get(k,i))DataStore.set(k,i,Event.listen(k,'mouseover',h));if(l!==false)a=k;},setItemEnabled:function(l,k){if(!k&&!DOM.scry(l,'span.disabledAnchor')[0])DOM.appendContent(l,$N('span',{className:DOM.find(l,'a').className+' disabledAnchor'},HTML(e(l).innerHTML)));CSS.conditionClass(l,'disabled',!k);},toggleItem:function(l){var k=!Menu.isItemChecked(l);Menu.setItemChecked(l,k);},setItemChecked:function(l,k){CSS.conditionClass(l,'checked',k);e(l).setAttribute('aria-checked',k);},unregister:function(l){l=b(l);var k=DataStore.remove(l,i);k&&k.remove();a=null;this._removeSelected(l);},_removeSelected:function(k){Menu.getItems(k).filter(function(l){return CSS.hasClass(l,'selected');}).each(function(l){CSS.removeClass(l,'selected');});}});}();
var FriendListMenu={init:function(c){Menu.register(c,false);var d=DOM.find(c,'.FriendListCreateTrigger');var b=DOM.find(c,'.CreateListInputItem');var a=DOM.find(b,'.createListInput');Menu.subscribe('select',function(e,f){if(f.item==d){CSS.addClass(c,'FriendListMenuCreate');Input.focus(a);}});Event.listen(a,'blur',function(e){if(Input.isEmpty(a))CSS.removeClass(c,'FriendListMenuCreate');});Event.listen(a,'keydown',function(e){if(Event.getKeyCode(e)==KEYS.RETURN&&/[^\s]/.test(a.value))new AsyncRequest().setURI('/ajax/friends/lists/create.php').setData({name:a.value,id:c.id}).setHandler(function(){Input.reset(a);CSS.removeClass(c,'FriendListMenuCreate');}).send();});Arbiter.subscribe('friend-list/new',function(h,e){var g=HTML(e.new_li).getRootNode();DOM.insertBefore(g,d);var f=DOM.find(g,'input');if(e.id===c.id){Menu.focusItem(g);Menu.inform('select',{menu:Parent.byClass(g,'uiMenu'),item:g});}else Menu.toggleItem(g);});}};
var RestrictedFriendListEducation=(function(){var b;var a;function c(e,d){if(d.flid==b)if(e=='FriendListHovercard/add'){if(a)return;a=true;new AsyncRequest().setURI('/ajax/friends/lists/restricted_edu.php').setData({target:d.uid,flid:d.flid}).send();}else if(e=='RestrictedListNUX/okay')new AsyncRequest().setURI('/ajax/friends/lists/nux_log.php').setData(d).send();return true;}return {init:function(d){b=d;Arbiter.subscribe(['FriendListHovercard/add','RestrictedListNUX/okay'],c);}};})();
function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,g,h,e,d,b){copy_properties(this,{_name:a,_valueNode:$(g),_wrapperNode:$(h)||null,_statusClass:d,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var c=this._valueNode.firstChild;if(c){var f=parseInt(c.nodeValue,10);if(!isNaN(f))this._count=f;}this._statusNode=e?$(e):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!b)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});Class.mixin(CounterDisplay,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
function MenubarMessageController(b,a){}copy_properties(MenubarMessageController,{ensureInitialized:function(c,b,a){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(c,b);MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(d,c,a,b){this.menu=ge(c);this.fetchOnHover=b;var e=[CounterDisplay.EVENT_TYPE_ADJUST+'/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'/messages_unread'];Arbiter.subscribe(e,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messages_seen'),function(){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);});this._dirty=a;if(b)this.mouseOverListener=Event.listen($(d),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;},markSeen:function(a){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:a}).send();}});
var LiveTimer={restart:function(a){this.serverTime=a;this.localStartTime=Date.now()/1000;this.updateTimeStamps();},updateTimeStamps:function(){LiveTimer.timestamps=DOM.scry(document.body,'abbr.livetimestamp');LiveTimer.startLoop(20000);},addTimeStamps:function(a){if(!a||!LiveTimer.timestamps)return;if(DOM.isNodeOfType(a,'abbr')&&CSS.hasClass(a,'livetimestamp')){LiveTimer.timestamps.push(a);}else{var c=DOM.scry(a,'abbr.livetimestamp');for(var b=0;b<c.length;++b)LiveTimer.timestamps.push(c[b]);}LiveTimer.startLoop(0);},startLoop:function(a){this.stop();this.timeout=setTimeout(function(){LiveTimer.loop();},a);},stop:function(){clearTimeout(this.timeout);},updateNode:function(a,b){LiveTimer.updateNode=(ua.ie()<7)?function(c,d){c.nextSibling.nodeValue=d;}:function(c,d){c.firstChild.nodeValue=d;};LiveTimer.updateNode(a,b);},loop:function(d){if(d)LiveTimer.updateTimeStamps();var c=Math.floor(Date.now()/1000-LiveTimer.localStartTime);var a=-1;LiveTimer.timestamps&&LiveTimer.timestamps.each(function(g){var f=new Date(g.getAttribute('data-date'))/1000;var e=LiveTimer.renderRelativeTime(LiveTimer.serverTime+c,f);if(e.text)LiveTimer.updateNode(g,e.text);if(e.next!=-1&&(e.next<a||a==-1))a=e.next;});if(a!=-1){var b=Math.max(20000,a*1000);LiveTimer.timeout=setTimeout(function(){LiveTimer.loop();},b);}},renderRelativeTime:function(c,d){var e={text:"",next:-1};if(c-d>(12*3600)||(new Date(c*1000).getDay()!=new Date(d*1000).getDay()))return e;var f=c-d,b=Math.floor(f/60),a=Math.floor(b/60);if(b<1){e.text=_tx("a few seconds ago");e.next=60-f%60;return e;}if(a<1){if(b==1){e.text=_tx("about a minute ago");}else e.text=_tx("{number} minutes ago",{number:b});e.next=60-f%60;return e;}if(a!=11)e.next=3600-f%3600;if(a==1){e.text=_tx("about an hour ago");return e;}e.text=_tx("{number} hours ago",{number:a});return e;}};
GroupMall={init:function(a){this._mallNode=$('group_mall_'+a);this._composerPublishToken=Arbiter.subscribe('composer/publish',function(event,b){if(b.streamStory&&!ge(b.streamStory.id))this._addPostToUI(b.streamStory);}.bind(this));onleaveRegister(this._onleave.bind(this));this._navigationBeginToken=Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this._onleave.bind(this));},_onleave:function(){Arbiter.unsubscribe(this._navigationBeginToken);Arbiter.unsubscribe(this._composerPublishToken);},_addPostToUI:function(c){var a=Vector2.getElementDimensions(this._mallNode).y;DOM.prependContent(this._mallNode,c);var b=this._mallNode.firstChild;LiveTimer.startLoop(0);new animation(b).from('opacity',0).to('opacity',1).duration(300).go();}};
var UIIntentionalStreamMessage={INITIALIZE_COMPLETE:'UIIntentionalStream/initializeComplete',SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime',INSERT_STORIES:'UIIntentionalStream/updateLastRefreshTime'};
(function(){function a(e,g,c,b){var f;var d=function(){var h=arguments;var i=this;var j=function(){f=null;e.apply(i,h);};c&&d.reset();if(c||!f)f=setTimeout(j,g,b);};d.reset=function(){f&&clearTimeout(f);f=null;};return d;}window.debounce=function(c,d,b){return a(c,d,true,b);};window.throttle=function(c,d,b){return a(c,d,false,b);};})();function defer_until(c,b,g,a,h){var e=b();if(e){c(e);return null;}var f=Date.now();var d=setInterval(function(){e=b();if(!e){if(!g||(g<new Date()-f))return;h&&h();}clearInterval(d);c(e);},20,a);return d;}
UserActivity=window.UserActivity||{DEFAULT_IDLE_MS:5000,EVENT_INTERVAL_MS:500,_listen:function(){UserActivity._listen=bagofholding;UserActivity._lastActive=Date.now();var a=throttle(function(event){UserActivity._lastActive=Date.now();Arbiter.inform('useractivity/activity',event);},UserActivity.EVENT_INTERVAL_MS,false);Event.listen(document.body,{mouseover:a,keydown:a,click:a});},subscribeOnce:function(a){var b=UserActivity.subscribe(function(){UserActivity.unsubscribe(b);a();});},subscribe:function(a){return Arbiter.subscribe('useractivity/activity',a);},unsubscribe:function(a){Arbiter.unsubscribe(a);},isActive:function(a){return (new Date()-UserActivity._lastActive<(a||UserActivity.DEFAULT_IDLE_MS));}};onloadRegister(UserActivity._listen);
function UntrustedLink(a,d,b,c){this.dom=a;this.url=a.href;this.hash=d;this.func_get_params=c||function(){return {};};Event.listen(this.dom,'click',this.onclick.bind(this));Event.listen(this.dom,'mousedown',this.onmousedown.bind(this));Event.listen(this.dom,'mouseup',this.onmouseup.bind(this));Event.listen(this.dom,'mouseout',this.onmouseout.bind(this));this.onmousedown($E(b));}UntrustedLink.bootstrap=function(a,d,b,c){if(a.__untrusted)return;a.__untrusted=true;new UntrustedLink(a,d,b,c);};UntrustedLink.prototype.getRewrittenURI=function(){var a=copy_properties({u:this.url,h:this.hash},this.func_get_params(this.dom));var b=new URI('/l.php');return b.setQueryData(a).setSubdomain('www').setProtocol('http');};UntrustedLink.prototype.onclick=function(){(function(){this.dom.href=this.url;}).bind(this).defer(100);this.dom.href=this.getRewrittenURI();};UntrustedLink.prototype.onmousedown=function(a){if(a.button==2)this.dom.href=this.getRewrittenURI();};UntrustedLink.prototype.onmouseup=function(){this.dom.href=this.getRewrittenURI();};UntrustedLink.prototype.onmouseout=function(){this.dom.href=this.url;};
function URLScraper(a){this.input=a;this.enable();}Class.mixin(URLScraper,'Arbiter',{reset:function(){this.lastMatch=null;},enable:function(){if(this.events)return;var a=function(b){setTimeout(this.check.bind(this,b),30);};this.events=Event.listen(this.input,{paste:a.bind(this,false),keydown:a.bind(this,true)});},disable:function(){if(!this.events)return;for(var event in this.events)this.events[event].remove();this.events=null;},check:function(b){var c=this.input.value;if(b&&URLScraper.trigger(c))return;var a=URLScraper.match(c);if(a&&a!=this.lastMatch){this.lastMatch=a;this.inform('match',{url:a});}}});(function(){var a='!"#%&\'()*,-./:;<>?@[\\]^_`{|}',r='\u2000-\u206F\u00ab\u00bb';var o='(?:(?:ht|f)tps?)://',g='(?:(?:\\d{1,3}[.]){3}\\d{1,3})',s='(?:\\b)www\\d{0,3}[.]',j='[^\\s'+a+r+']',h='(?:(?:[.:\\-_%@]|'+j+')*'+j+')',p='(?:[.][a-z]{2,4})',n='(?::\\d+){0,1}',d='(?=[\/?#])';var f='(?:'+'(?:'+o+h+n+')|'+'(?:'+g+n+')|'+'(?:'+s+h+p+n+')|'+'(?:'+h+p+n+d+')'+')';var e='[\/#?]',c='\\([^\\s()<>]+\\)',l='[^\\s()<>'+r+']+',k='[^\\s'+a+r+']';var m='(?:'+'(?:'+e+')'+'(?:'+'(?:'+c+'|'+l+')*'+'(?:'+c+'|'+k+')'+')*'+')*';var i=new RegExp('('+'(?:'+f+')'+'(?:'+m+')'+')','im');var b=new RegExp('('+'(?:'+o+h+n+')|'+'(?:'+s+h+p+n+')'+')');var q=/[\s'";]/;URLScraper.match=function(u){var t=(i.exec(u)||[])[1]||null;if(t&&t.indexOf('@')!=-1){return (b.exec(t))?t:null;}else return t;};URLScraper.trigger=function(t){return !q.test(t.charAt(t.length-1));};})();
function html_hyperlink(g,h,i,e){if(typeof g==='undefined'||!g.toString)return '';if(typeof h!=='function')h=htmlize;if(typeof i!=='function')i=htmlize;var g=g.toString();var f=[];var b;while((b=URLScraper.match(g))){var d=g.indexOf(b);if(d>=0)f.push(h(g.substring(0,d)));var a=i(b);var c=b.replace(/"/g,'%22');if(!(/^[a-z][a-z0-9\-+.]+:\/\//i.test(b)))c='http://'+c;f.push('<a target="_blank" rel="nofollow" href="'+c+'"');if(e)f.push(' onmousedown="UntrustedLink.bootstrap(this, \''+Env.lhsh+'\', event)"');f.push('>'+a+'</a>');g=g.substring(d+b.length);}g&&f.push(h(g));return f.join('');}function nl2br(a){if(typeof(a)=='undefined'||!a.toString)return '';return a.toString().replace(/\n/g,'<br />');}function is_email(a){return /^([\w!.%+\-])+@([\w\-])+(?:\.[\w\-]+)+$/.test(a);}
function XHPTemplate(a){this._model=a;}XHPTemplate.prototype={render:function(){if(HTML.isHTML(this._model))this._model=DOM.setContent(document.createDocumentFragment(),this._model)[0];return this._model.cloneNode(true);},build:function(){return new XHPTemplateInstance(this.render());}};copy_properties(XHPTemplate,{getNode:function(b,a){return XHPTemplate.getNodes(b)[a];},getNodes:function(d){var c=DataStore.get(d,'XHPTemplate:nodes');if(!c){c={};var e=DOM.scry(d,'[data-jsid]');e.push(d);var a=e.length;while(a--){var b=e[a];c[b.getAttribute('data-jsid')]=b;b.removeAttribute('data-jsid');}DataStore.set(d,'XHPTemplate:nodes',c);}return c;}});function XHPTemplateInstance(a){this._root=a;this._populateNodes();}XHPTemplateInstance.prototype={_populateNodes:function(){this._nodes={};this._leaves={};var e=this._root.getElementsByTagName('*');for(var a=0,c=e.length;a<c;a++){var d=e[a];var b=d.getAttribute('data-jsid');if(b){d.removeAttribute('data-jsid');this._nodes[b]=d;this._leaves[b]=!d.childNodes.length;}}},getRoot:function(){return this._root;},getNode:function(a){return this._nodes[a];},setNodeProperty:function(c,a,b){this.getNode(c)[a]=b;return this;},setNodeContent:function(b,a){if(!this._leaves[b])throw new Error("Can't setContent on non-leaf node: "+b);DOM.setContent(this.getNode(b),a);return this;}};
var UFIOptimistic={COMMENT_SEND_EVENT:'ufi/comment',_commentSeqNo:0,init:function(a){this._commentTemplate=a;if(!this._loaded){Event.listen(document.documentElement,'click',this._clickHandler.bind(this),Event.Priority.URGENT);this._loaded=true;}},_clickHandler:function(event){var i=event.getTarget();var l=i.name=='comment'&&i.parentNode&&Parent.byClass(i,'optimistic_submit');if(!l)return true;var e=i.form;var k=DOM.find(e,'textarea');if(Input.isEmpty(k))return true;fc_uncollapse(e);var a=this._commentTemplate.render();var j=XHPTemplate.getNode(a,'text');DOM.setContent(j,HTML(htmlize(trim(k.value))));var c=DOM.scry(e,'ul.commentList')[0];if(!c)return true;CSS.show(c.parentNode);c.appendChild(a);var b=c.lastChild;var g=rand32();b.id='optimistic_comment_'+g+'_'+this._commentSeqNo++;var d=Form.serialize(e);d.comment_replace=b.id;d.comment=1;function h(){new AsyncRequest(Form.getAttribute(e,'action')).setData(d).setRelativeTo(e).setErrorHandler(function(m){CSS.addClass(b,'uiUfiCommentFailed');AsyncResponse.defaultErrorHandler(m);}).send();}Event.listen(XHPTemplate.getNode(a,'retry_link'),'click',h);h();k.value=k.style.height='';k.focus();var f=window.MentionsInput&&MentionsInput.getInstance(k);f&&f.reset();Arbiter.inform(UFIOptimistic.COMMENT_SEND_EVENT,{form:e});return false;}};
function TickerController(){}!function(){var c=1;var b=2;var a=3;var d=4;copy_properties(TickerController,{_instances:{},_activeInstance:null,_placeholders:{},_logPositionChange:false,getInstance:function(e){var f=Parent.byClass($(e),'fbFeedTicker');return f?TickerController._instances[f.id]:null;},isLoaded:function(e){var f=TickerController._placeholders[e.id];return !f||f.status==a;},show:function(i,e){e=e||bagofholding;for(var g in TickerController._instances){var k=ge(g);if(!k||k.parentNode.id==i.id)continue;TickerController.hide(k.parentNode);}TickerController._doPositionChange(i);CSS.show(i);var j=TickerController._placeholders[i.id];if(j&&j.status==c){TickerController._fetchTickerForPlaceholder(i,e);}else{var f=DOM.scry(i,'.fbFeedTicker')[0];var h=f&&TickerController.getInstance(f);TickerController._activeInstance=h;h&&h._poll();TickerController._placeholders[i.id]={status:d,callback:e};e();}},_doPositionChange:function(e){if(!TickerController._logPositionChange||CSS.shown(e))return;new AsyncSignal('/common/ods_endpoint.php',{k:'ticker.render.switch.'+e.id}).send();},hide:function(f){var e=DOM.scry(f,'.fbFeedTicker')[0];var g=e&&TickerController.getInstance(e);g&&g.hideActiveStory();CSS.hide(f);},hideStoriesByClass:function(e){for(var f in TickerController._instances)DOM.scry($(f),e).forEach(CSS.hide);},hideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.hideStory(e);},undoHideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.undoHideStory(e);},_fetchTickerForPlaceholder:function(g,e){var f={handler:function(){TickerController._placeholders[g.id].status=a;e();}};UIPagelet.loadFromEndpoint('TickerPagelet',g.id,TickerController._placeholders[g.id].pageletData,f);TickerController._placeholders[g.id].status=b;},registerStoryDialog:function(f,e){Arbiter.subscribe('ticker/init',function(){var g=ge(f);var h=g&&TickerController.getInstance(g);h&&h.registerStoryDialog(g,e);},Arbiter.SUBSCRIBE_ALL);},registerPlaceholder:function(g,f){var e=TickerController._placeholders[g];TickerController._placeholders[g]={status:c,pageletData:f};if(e&&e.status==d){TickerController.show($(g));e.callback();}}});}();TickerController.prototype={ADS_IDLE_MS:300000,FLYOUT_MAX_HEIGHT:450,FLYOUT_OFFSET_THRESHOLD:20,FLYOUT_COMMENT_OFFSET:15,FLYOUT_VIEWPORT_PADDING:75,FLYOUT_TARGET_HEIGHT_OFFSET:25,init:function(d,e,a){TickerController._instances[d.id]=this;TickerController._activeInstance=this;this._root=d;this._content=DOM.find(d,'.ticker_stream');this._stories=DOM.find(this._root,'.tickerActivityStories');this._scrollableArea=e;this._container=DOM.find(d,'div.uiScrollableAreaWrap');this._storyIDs=[];this._objectIDs=[];this._fetchedStories={};this._removedStoryIDs=[];var b=Date.now();this._lastUpdate=b;this._lastPull=b;this._lastInsert=b+a.firstCustomStoryDelay;this._lastCustomStory=0;this._pollOnly=false;this._needNonCustomStoryNum=0;this._autoloadStoryIndex=1;this._scrollTopThreshold=100;this._scrollTopPrompt=DOM.find(this._root,'.scrollTopPrompt');this._scrollTopPromptVisible=false;this._maxStoriesToKeep=50;this._minStoriesToKeep=25;this._tickerInSidebarMode=!!Parent.byClass(this._root,'fbChatSidebar');var c=$N('div',{className:'hidden_elem'});this._storyQueue=c;DOM.appendContent(this._root,c);this._initObjectIDs();this._initPageletCache(a);this._initConfig(a);this._resetMorePager();this._initListeners();this._initSubscriptions(a);Arbiter.inform('ticker/init',this,Arbiter.BEHAVIOR_PERSISTENT);this._poll();if(this._prefetchAfterLoad)this._fetchStories(this._getAllStories().slice(0,5));},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController(this._root.parentNode.id,this);if(this._cache){copy_properties(a,this._cache.loadData());this._cache.registerCleanup('Ticker/cleanup');}}},_initConfig:function(a){copy_properties(this,{_newest:a.newest,_page_newest:a.newest,_timeout:a.timeout,_heartbeatTimeout:Math.max(15000,a.heartbeatTimeout),_pullTimeout:Math.max(30000,a.pullTimeout),_insertTimeout:a.insertTimeout,_friendCount:a.friendCount,_maxQueueLength:a.maxQueueLength,_heartbeatEndpoint:a.heartbeatEndpoint,_maxCustomQueueLength:a.maxCustomQueueLength,_customStoryInsertTimeout:Math.max(5000,a.customStoryInsertTimeout),_nonCustomToCustomStoryRatio:a.nonCustomToCustomStoryRatio,_minForceUpdateInterval:Math.max(a.insertTimeout,a.minForceUpdateInterval),_popupOnHover:a.popupOnHover,_priorityAppId:a.priorityAppId,_prefetchOnHover:a.prefetchStoriesOnHover,_dark:a.dark,_userIdleTimeout:a.userIdleTimeout,_pollOnly:a.pollOnly,_tickerDebug:a.tickerDebug,_tickerSource:a.tickerSource,_prefetchAfterLoad:a.prefetchAfterLoad,_logFlyouts:a.logFlyouts});this._queueCustomStories(a.customStories);},_initListeners:function(){this._listeners=Event.listen(this._root,{click:this._handleClick.bind(this),keydown:this._handleKeydown.bind(this),mouseout:this._handleMouseout.bind(this),mouseover:this._handleMouseover.bind(this),mousedown:this._tickerDeClicker.bind(this)});this._listeners.scroll=Event.listen(this._container,'scroll',this._handleScroll.bind(this));this._initInfiniteScrollListener.bind(this).defer();},_initSubscriptions:function(a){onleaveRegister(this._cleanup.bind(this));this._subscriptions=[Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this._onNavHandler.bind(this)),Arbiter.subscribe(PresenceMessage.getArbiterMessageType('ticker_update'),this._handleTickerPush.bind(this)),Arbiter.subscribe('composer/publish',this._handleComposerPublish.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this._handleStoriesInserted.bind(this)),Arbiter.subscribe('Ticker/fixed',this._setFixed.bind(this,true)),Arbiter.subscribe('Ticker/unfixed',this._setFixed.bind(this,false)),Arbiter.subscribe('Ticker/resized',this._checkInfiniteScroll.bind(this)),Arbiter.subscribe(UFIOptimistic.COMMENT_SEND_EVENT,this._scrollDialogToBottom.bind(this)),Arbiter.subscribe('Ticker/chatOpened',this._handleChatOpened.bind(this))];if(a.pushChannel)this.setPushChannel(a.pushChannel);},_handleClick:function(event){var c=event.getTarget();if(this._getButtonFromNode(c)){this._handleActionButton(event);return;}var b=this._getStoryFromNode(c);var a=Parent.byClass(c,'tickerStoryAllowClick');if(!b||b==this._selectedStory||a)return;if(this._storyIsHidden(b))return;if(b==this._activeStory&&!this._selectedStory)this._selecting=true;this._clearNux();if(this._storyCanOpenExternally(b)){this._logUserAction(c,'click',event);this._openStoryExternally(b,event);return;}this._logUserAction(c,'flyout',event);this._activateStory(b,'click');this._selectStory(b);if(b.getAttribute('data-story-unselectable'))this._deactivateStory(b);},_handleMouseover:function(event){event.kill();this._setLocked(true);var d=event.getTarget();var c=this._getOpenableStory(d);if(!c)return;if(this._prefetchOnHover||this._popupOnHover)this._fetchStory(c);if(this._selectedStory)return;if(this._popupOnHover){this._clearHoverTimeouts();var b=this._storyCanOpenExternally(c)?500:1000;var a=this._activeStory?75:b;this._hoverShowTimeout=this._setTimeout(function(){this._activateStory(c,'hover');this._logUserAction(d,'flyout',event);}.bind(this),a);}},_handleMouseout:function(event){var c=event.getTarget();this._setLocked(false);if(c==this._getStoryFromNode(c)){var b=DOM.scry(c.parentNode,'.openToggler');for(var a=0;a<b.length;a++)Selector.toggle(b[a]);}this._scheduleHide();},_handleKeydown:function(event){this._tickerDeClicker(event);var d=this._activeStory;if(!d)return;var a=Event.getKeyCode(event);switch(a){case KEYS.UP:case KEYS.DOWN:var c=this._getAllStories();var b;if(event.getModifiers().any){b=a===KEYS.UP?0:c.length-1;}else b=c.indexOf(d)+(a===KEYS.UP?-1:1);d=c[b];break;case KEYS.ESC:this._deactivateStory(true);return;default:return;}if(!d)return;event.kill();this._activateStory(d,'keypress');this._selectStory(d);},_handleScroll:function(){!this._preventScrollDismiss&&this._deactivateStory(true);this._checkInfiniteScroll();if(!this._scrollLogged){this._scrollLogged=true;var b=this._stories.childNodes.length;var c=this._stories.getAttribute('data-gt');var a={ticker_scroll:1,number_stories:b,source:c};report_data('scroll',{gt:a});}},_handleStoriesInserted:function(){this._initInfiniteScrollListener();this._scrollableArea.adjustGripper();},_handleActionButton:function(event){var d=event.getTarget();var a=this._getButtonFromNode(d);var c=this._getOpenableStory(d);var b=this._getStoryDialog(c);if(b)var e=b.subscribe('beforehide',function(){b.unsubscribe(e);return false;});},_handleScrollToTopClick:function(){this._scrollToTop(this._poll.bind(this));},_scrollToTop:function(a){animation(this._container).to('scrollTop',0).ease(animation.ease.end).ondone(a).go();},_clearHoverTimeouts:function(){clearTimeout(this._hoverShowTimeout);clearTimeout(this._hoverHideTimeout);},_getAllStories:function(){return DOM.scry(this._root,'div.fbFeedTickerStory');},_getQueuedStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.queuedStory');},_getQueuedCustomStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.customStory');},_getButtonFromNode:function(a){return Parent.byClass(a,'tickerInlineOverlay');},_getStoryFromNode:function(a){return Parent.byClass(a,'fbFeedTickerStory');},_getOpenableStory:function(a){var b=this._getStoryFromNode(a);return this._storyCanOpenDialog(b)?b:null;},_getStoryDialog:function(a){return window.ContextualDialogX&&ContextualDialogX.getInstance(a)||null;},_getStoryDialogEndpoint:function(a){return a&&a.getAttribute('data-rel')=='async'&&a.getAttribute('data-ajaxify')||null;},_storyCanOpenDialog:function(a){return !!this._getStoryDialogEndpoint(a)&&!this._storyIsHidden(a);},_storyCanOpenExternally:function(a){return !!a.getAttribute('data-href')||!this._storyCanOpenDialog(a);},_storyIsHidden:function(a){return CSS.hasClass(a,'tickerStoryHidden');},hideActiveStory:function(){this._activeStory&&this.hideStory(this._activeStory);},hideStory:function(a){this._deactivateStory();CSS.addClass(a,'tickerStoryHidden');CSS.removeClass(a,'tickerStoryClickable');},undoHideStory:function(a){CSS.addClass(a,'tickerStoryClickable');CSS.removeClass(a,'tickerStoryHidden');},_scheduleHide:function(){if(this._popupOnHover&&!this._selectedStory){this._clearHoverTimeouts();this._hoverHideTimeout=this._setTimeout(this._deactivateStory.bind(this),100);}},_setScrollTopPromptVisible:function(a){this._scrollTopPromptVisible=a;CSS.conditionShow(this._scrollTopPrompt,a);if(a&&!this._listeners.scrollTop){this._listeners.scrollTop=Event.listen(this._scrollTopPrompt,{click:this._handleScrollToTopClick.bind(this)});}else if(!a&&this._listeners.scrollTop){this._listeners.scrollTop.click.remove();this._listeners.scrollTop=null;}},_isUserIdle:function(){return !UserActivity.isActive(this._userIdleTimeout);},_schedulePoll:function(){clearTimeout(this._pollToken);this._pollToken=this._setTimeout(this._poll.bind(this),this._timeout);},_poll:function(){this._debug('poll');if(!this._isTickerVisible()){this._debug('not polling: ticker not visible');return;}if(this._isUserIdle()){this._debug('not polling: idle');return UserActivity.subscribeOnce(this._poll.bind(this));}var e=!this._isScrolledToTop()&&this._getQueuedStories().length;this._setScrollTopPromptVisible(e);var d=Date.now();var j=d-this._lastInsert;if(j<this._insertTimeout||this._isLocked())return this._schedulePoll();var g=this._getQueuedStories();var a=this._getQueuedCustomStories();var i=g.length>0;var h=a.length>0&&(this._needNonCustomStoryNum===0||(!i&&(d-this._lastCustomStory)>this._customStoryInsertTimeout));if(h){this._insertStory(a.shift());this._lastCustomStory=d;this._needNonCustomStoryNum=this._nonCustomToCustomStoryRatio;this._debug('not polling: should insert custom story');return this._schedulePoll();}if(i){this._insertStory(g.shift());this._needNonCustomStoryNum--;if(this._needNonCustomStoryNum<0)this._needNonCustomStoryNum=0;this._debug('not polling: should insert story');return this._schedulePoll();}var b=a.length===0&&this._needNonCustomStoryNum===0&&this._nonCustomToCustomStoryRatio>0&&UserActivity.isActive(this.ADS_IDLE_MS)&&d-this._lastUpdate>this._minForceUpdateInterval;var c=d-this._lastUpdate>this._heartbeatTimeout;if(b||c){var f=false;if(c&&!this._pollOnly)f=(d-this._lastPull>this._pullTimeout);this._debug('polling for new stories');this.update({heartbeat:c,pull:f,fullpoll:this._pollOnly,needcustomstory:b});return;}this._schedulePoll();},update:function(b){var a={newest:(b.fullpoll||b.cache_update)?this._newest:this._page_newest,storyids:this._storyIDs,friendcount:this._friendCount,priorityappid:this._priorityAppId,source:this._tickerSource};copy_properties(a,b);new AsyncRequest().setURI(this._heartbeatEndpoint).setReadOnly(true).setOption('retries',0).setData(a).setHandler(this._handleResponse.bind(this)).setFinallyHandler(this._poll.bind(this)).setAllowCrossPageTransition(true).send();this._lastUpdate=Date.now();if(a.pull)this._lastPull=this._lastUpdate;this._storyIDs=[];},_insertStory:function(d,a,c){if(this._dark)return;this._lastInsert=Date.now();window.LiveTimer&&LiveTimer.addTimeStamps(d);if(a!==false){var b=c?this._fadeStoryIn:this._flyStoryIn;if(this._isScrolledToTop()){this._scrollToTop(b.bind(this,d));}else b.call(this,d);}else DOM.prependContent(this._stories,d);this._removeOldStories();},_removeOldStories:function(){var b=this._getAllStories();if(b.length<=this._maxStoriesToKeep)return;var a=this._minStoriesToKeep;b.slice(a).each(DOM.remove);this._resetMorePager();},_resetMorePager:function(){var b=this._getAllStories();if(!b||!b.length)return;var c=b[b.length-1].getAttribute('data-ticker-timestamp');var a=DOM.scry(this._root,'.tickerMorePager a')[0];if(!a||!c)return;var d=new URI(a.getAttribute('ajaxify'));d.addQueryData({oldest:c});a.setAttribute('ajaxify',d);},_setLocked:function(a){this._locked=a;},_isLocked:function(){return !!(this._scrollTopPromptVisible||this._locked||this._activeStory);},informAndRemoveStory:function(a,d,e){var b=this._getStoryFromNode(a);var c=b.getAttribute('data-story-key');DOM.setContent(b,d);CSS.addClass(b,'highlightedStory');this._setTimeout(this.removeStory.bind(this,c),e||6000);},_getStoryByStoryKey:function(b){var c=this._getAllStories();for(var a=0;a<c.length;a++){var d=c[a];if(d.getAttribute('data-story-key')==b)return d;}return null;},removeStory:function(c){this._removedStoryIDs[c]=true;var b=this._getStoryByStoryKey(c);if(!b)return;if(b==this._activeStory)this._deactivateStory();var a=this._getStoryDialog(b);a&&a.destroy();this._animateStoryOut(b);},_isScrolledToTop:function(){return this._container.scrollTop<=this._scrollTopThreshold;},_flyStoryIn:function(b){var c=$N('div',{style:{marginTop:'-1000px'}},b);CSS.setStyle(c,'opacity',0);DOM.prependContent(this._stories,c);var a=Vector2.getElementDimensions(c).y;CSS.setStyle(c,'marginTop','-'+a+'px');animation(c).to('marginTop',0).ease(animation.ease.end).checkpoint(.5).to('opacity',1).ondone(function(){DOM.replace(c,b);this._afterInsert(b);}.bind(this)).go();},_fadeStoryIn:function(a){animation(this._stories).to('opacity',.5).ondone(function(){DOM.prependContent(this._stories,a);animation(this._stories).to('opacity',1).ondone(function(){this._afterInsert(a);}.bind(this)).go();}.bind(this)).go();},_animateStoryOut:function(a){var b=$N('div',{style:{overflow:'hidden',position:'relative'}});DOM.insertBefore(b,a);DOM.appendContent(b,a);animation(b).to('top',20).to('height',0).to('opacity',0).ease(animation.ease.end).ondone(function(){DOM.remove.curry(b);Arbiter.inform('Ticker/animateOut');}.bind(this)).go();},_afterInsert:function(a){Arbiter.inform('Ticker/afterInsert');if(a.firstChild&&a.firstChild.firstChild&&a.firstChild.firstChild.id)Arbiter.inform('tickerad_'+a.firstChild.firstChild.id);},setPushChannel:function(a){this._pushSubscription&&Arbiter.unsubscribe(this._pushSubscription);this._pushSubscription=Arbiter.subscribe(PresenceMessage.getArbiterMessageType(a),this._handleTickerPush.bind(this));},setCurrentAppId:function(a){this._priorityAppId=a;},_handleTickerPush:function(e,a){if(this._isUserIdle()){this._debug('discarding story: user is idle');return;}var c=a.obj;if(c.delete_id){this.removeStory(c.delete_id);return;}var b=c.story_xhp;if(!b){this._debug('discarding story: no markup');return;}this._newest=c.story_time;var d=HTML(b).getRootNode();this.queueStory(d,c.flyout_js_cmds);},_handleComposerPublish:function(b,a){a.tickerMarkup&&this._insertStory(a.tickerMarkup);},_clearNux:function(){var a=DOM.scry(document.body,'div.tickerNUXContainer');if(a.length){a.each(function(c){var b=ContextualDialogX.getInstance(c);b&&b.hide();});new AsyncRequest().setURI('/ajax/feed/ticker/nux.php').send();}this._clearNux=bagofholding;},_logRender:function(){if(this._loggedRender)return;var a=this._tickerInSidebarMode;if(a||Parent.byClass(this._content,'home_right_column')){new AsyncSignal('/ajax/log_ticker_render.php',{sidebar_mode:a}).send();this._loggedRender=true;}},_isTickerVisible:function(){var a=(TickerController._activeInstance==this);a&&this._logRender();return a;},_handleResponse:function(c){var b=c.getPayload();if(b.newest)this._newest=this._page_newest=b.newest;if(b.content)if(b.cache_update&&this._cache){this._cache.insertStory(b.content);}else if(b.content instanceof Array){for(var a=0;a<b.content.length;a++)this.queueStoryMarkup(b.content[a]);}else this.queueStoryMarkup(b.content);if(b.custom_stories)this._queueCustomStories(b.custom_stories);},queueStoryMarkup:function(a){var b=HTML(a).getRootNode();this.queueStory(b);},dedupeStory:function(c){var b=c.getAttribute('data-story-key');var a=b&&(!!this._objectIDs[b]||!!this._removedStoryIDs[b]);if(a)this._debug('discarding story: duplicated object id');b&&(this._objectIDs[b]=true);return a;},queueStory:function(d,a){if(this._dark)return;if(this.dedupeStory(d))return;CSS.addClass(d,'queuedStory');DOM.appendContent(this._storyQueue,d);var b=a&&a.length;if(b)a.each(function(e){new Function(e).apply();});d.setAttribute('id',d.id+'_'+this._root.id);var c=this._getQueuedStories();c.slice(0,-this._maxQueueLength).each(DOM.remove);if(b)this._fetchedStories[d.id]=true;},_queueCustomStories:function(b){while(b.length){var c=b.shift();c=HTML(c).getRootNode();var d=c.getAttribute('data-story-key');if(this.dedupeStory(c))continue;CSS.addClass(c,'customStory');DOM.appendContent(this._storyQueue,c);}var a=this._getQueuedCustomStories();a.slice(0,-this._maxQueueLength).each(DOM.remove);},_cleanup:function(){TickerController._placeholders.pagelet_rhc_ticker=null;if(!Parent.byClass(this._content,'hasRightCol'))return;this._objectIDs=[];this._subscriptions.each(Arbiter.unsubscribe);this._pushSubscription&&Arbiter.unsubscribe(this._pushSubscription);for(var a in this._listeners)this._listeners[a]&&this._listeners[a].remove();clearTimeout(this._pollToken);this._pollToken=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();Arbiter.inform('Ticker/cleanup');},_onNavHandler:function(c,a){var b=a.params.key;if(b!='lf'&&b!='h')this._cleanup();},registerStoryDialog:function(b,a){this._fetchedStories[b.id]=true;a.setContext(b);a.subscribe('hide',this._deactivateStory.bind(this,true));a.subscribe('success',this._focusStory.bind(this,b));a.subscribe('beforehide',function(){if(this._selecting){this._selecting=false;return false;}}.bind(this));if(this._popupOnHover){a.subscribe('mouseenter',this._clearHoverTimeouts.bind(this));a.subscribe('mouseleave',this._scheduleHide.bind(this));a.subscribe('show',function(){this._highlightDialogScrollbar.bind(this,a).defer();var c=Event.listen(a.getContent(),'click',function(){this._selectStory(b);c.remove();}.bind(this));}.bind(this));}if(b==this._activeStory)this._openDialog(a);},_highlightDialogScrollbar:function(b){var c=DOM.scry(b.getContent(),'.uiScrollableArea')[0];var a=c&&ScrollableArea.getInstance(c);a&&a.adjustGripper().showScrollbar(false);},_openStoryExternally:function(c,event){this._deactivateStory();var a=c.getAttribute('data-href');if(!a||a=='#')return;if(c.getAttribute('data-story-rel')=='theater'){Bootloader.loadComponents('PhotoSnowbox',function(){PhotoSnowbox.bootstrap(a,c);});return;}var b=(event.which!=1||event.getModifiers().any);b?window.open(a,'_blank'):goURI(a);},_focusStory:function(a){clearTimeout(this._scrollDismissal);this._preventScrollDismiss=true;this._scrollDismissal=this._setTimeout(function(){this._preventScrollDismiss=false;}.bind(this),100);a.focus();},_selectStory:function(a){this._selectedStory=a;CSS.addClass(a,'tickerStorySelected');CSS.addClass(this._root,'tickerChildSelected');},_activateStory:function(c,b){this._clearHoverTimeouts();if(c==this._activeStory||!this._storyCanOpenDialog(c))return;this._deactivateStory();this._focusStory(c);this._activeStory=c;CSS.addClass(c,'tickerStoryActive');window.Toggler&&Toggler.hide();if(this._logFlyouts){b=b||'unknown';new AsyncSignal('/ajax/feed/ticker/flyout.php',{src:b}).send();}var a=this._getStoryDialog(c);if(a){this._openDialog(a);return;}this._fetchStory(c);},_deactivateStory:function(a){if(this._dialog)this._dialog.setFadeOnHide(a===true).hide();if(this._activeStory){CSS.removeClass(this._activeStory,'tickerStoryActive');CSS.removeClass(this._activeStory,'tickerStorySelected');CSS.removeClass(this._root,'tickerChildSelected');}this._dialog=this._selectedStory=this._activeStory=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();},_logUserAction:function(a,b,event){user_action(b,a,event,'FORCE',null);},_fetchStory:function(d){clearTimeout(this._fetchToken);var c=[];var a=this._getAllStories();var b=a.indexOf(d);[-2,-1,0,1,2].each(function(f){var e=a[b+f];e&&c.push(e);},this);this._fetchToken=setTimeout(this._fetchStories.bind(this,c),100);},_fetchStories:function(c){var a=[];var d;var b=function(e){clearTimeout(d);c.each(function(f){CSS.conditionClass(f,'tickerStoryFetching',e);});};c=c.filter(function(f){if(f.id in this._fetchedStories)return false;this._fetchedStories[f.id]=true;var e=this._getStoryDialogEndpoint(f);var g=URI(e).getQueryData();if(!e||!g)return false;g.uniq_id=f.getAttribute('id');g.referrer=this._tickerSource;a.push(g);return true;},this);if(!a.length)return;d=this._setTimeout(b.curry(true),500);new AsyncRequest('/ajax/feed/ticker/multi_story').setFinallyHandler(b.curry(false)).setErrorHandler(bagofholding).setData({stories:a}).setAllowCrossPageTransition(this._tickerInSidebarMode).send();},_tickerDeClicker:function(event){var d=event.getTarget();var b=Parent.byTag(d,'a');var c=this._getStoryFromNode(d);var a=this._getButtonFromNode(d);if(c&&b&&!a&&CSS.hasClass(c,'tickerStoryClickable')&&!CSS.hasClass(b,'tickerStoryAllowClick')&&!this._storyIsHidden(c)){b.setAttribute('rel','ignore');b.removeAttribute('onclick');b.removeAttribute('ajaxify');b.removeAttribute('href');}},_initInfiniteScrollListener:function(){var b=this._getAllStories();var a=Math.max(0,b.length-this._autoloadStoryIndex);this._infiniteScrollStory=b[a];this._checkInfiniteScroll();},_checkInfiniteScroll:function(){if(this._infiniteScrollStory){var a=Vector2.getElementPosition(this._infiniteScrollStory).y;var c=Vector2.getElementPosition(this._container).y+Vector2.getElementDimensions(this._container).y;if(a<c){var b=DOM.scry(this._root,'.tickerMorePager a')[0];b&&AsyncRequest.bootstrap(b.getAttribute('ajaxify'),b);this._infiniteScrollStory=null;this._autoloadStoryIndex=5;}}},_setFixed:function(b){if(!this._selectedStory)return;var a=this._getStoryDialog(this._selectedStory);if(a){a.setFixed(b);a.updatePosition();}},_setTimeout:function(b,a){return setTimeout(b,a,!this._tickerInSidebarMode);},_scrollDialogToBottom:function(){var a=this._dialog&&this._dialog.getContent();var c=a&&DOM.scry(a,'.uiScrollableAreaWrap')[0];var b=c&&ScrollableArea.getInstance(c);b&&b.scrollToBottom();},_openDialog:function(a){this._dialog=a.show();this._updateDialogPosition();this._writeSwfFrame(a);this._initCommentFocusListener.bind(this).defer();this._initContentResizeListener.bind(this).defer();this._stupidIE7VideoResizeHack(a);},_stupidIE7VideoResizeHack:function(a){if(ua.ie()===7){var b=DOM.scry(a.getContent(),'.uiVideoThumb .img');b.each(function(c){CSS.setStyle(c,'width','');});}},_updateDialogPosition:function(){var a=this._tickerInSidebarMode||!!Parent.byClass(this._root,'fixed_elem');this._dialog.setFixed(a);this._adjustFlyoutContentHeight();this._dialog.updatePosition();},_writeSwfFrame:function(b){var a=this._dialog&&this._dialog.getContent();var e=DOM.scry(a,'.swfObject')[0];if(!e)return;var d=e.getAttribute('data-swfid');if(d&&window[d]){var c=window[d];c.write(e);}},_initCommentFocusListener:function(){var a=this._dialog&&this._dialog.getContent();var b=a&&DOM.scry(a,'.tickerDialogFooter textarea')[0];if(!b)return;this._listeners.inputFocus=Event.listen(b,'focus',this._scrollDialogToBottom.bind(this));},_cleanupInputFocusListener:function(){if(this._listeners.inputFocus){this._listeners.inputFocus.remove();this._listeners.inputFocus=null;}},_initContentResizeListener:function(){var a=this._dialog&&this._dialog.getContent();if(!a)return;this._listeners.contentResize=Event.listen(a,'click',function(){this._dialog.updatePosition.bind(this._dialog).defer();}.bind(this));},_cleanupContentResizeListener:function(){if(this._listeners.contentResize){this._listeners.contentResize.remove();this._listeners.contentResize=null;}},_adjustFlyoutContentHeight:function(){var e=this._dialog&&this._dialog.getContent();var i=e&&DOM.scry(e,'.uiScrollableAreaWrap')[0];if(!i)return;var j=Vector2.getElementDimensions(i);var d=Vector2.getElementPosition(i);var l=DOM.scry(i,'.uiUfi .uiUfiComment');var f=Vector2.getViewportDimensions().y-this.FLYOUT_VIEWPORT_PADDING;var h=Math.min(this.FLYOUT_MAX_HEIGHT,f);var k=h-this.FLYOUT_TARGET_HEIGHT_OFFSET;for(var g=0;g<l.length;g++){var a=l[g];var c=Vector2.getElementPosition(a);var b=c.y-d.y;if(Math.abs(b-k)<=this.FLYOUT_OFFSET_THRESHOLD){k=b+this.FLYOUT_COMMENT_OFFSET;break;}}if(j.y>k){CSS.setStyle(i,'height',k+'px');CSS.setStyle(i,'max-height',null);}else{CSS.setStyle(i,'max-height',h+'px');CSS.setStyle(i,'height',null);}},_initObjectIDs:function(){stories=this._getAllStories();for(var b=0;b<stories.length;++b){var a=stories[b].getAttribute('data-story-key');a&&(this._objectIDs[a]=true);}},_handleChatOpened:function(){this._deactivateStory(true);},_debug:function(a){this._tickerDebug&&console.log('ticker: ',a);},getNewest:function(){return this._newest;}};
function HomeAdFirstRightColumnController(){}HomeAdFirstRightColumnController.prototype={init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,_tickerHeightOffset:200,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||500),_listeners:[],_subscriptions:[]});this._topOffset=0;this.PADDING_TICKER_TO_TOP=5;this.PADDING_RHC_TO_BOTTOM=60;this._sidebarIsHidden=true;this._listeners.push(Event.listen(window,'resize',this.handleResize.bind(this)));this._blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',this._handleScroll.bind(this)));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},_onNavHandler:function(c,a){var b=a.params.key;if(b!='lf'&&b!='h')this.cleanup();},reloadRightCol:function(){this.fixedScrollingContainer=ge('fixed_scrolling_container');this.fixedScrollingWrapper=DOM.scry(this.fixedScrollingContainer,'.fixed_scrolling_wrapper')[0];this.tickerPagelet=ge('pagelet_rhc_ticker');this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(!this._sidebarIsHidden||!this.tickerStream)return;this._topOffset=this.PADDING_TICKER_TO_TOP+this._blueBarHeight;var b=CSS.hasClass(document.documentElement,'tinyViewport');var c=Vector2.getElementPosition(this.fixedScrollingContainer,'viewport').y;var a=!b&&c<this._topOffset;if(a!==CSS.hasClass(this.fixedScrollingWrapper,'fixed_elem'))this._setFixedRightCol(a);},_setFixedRightCol:function(a){var c=a?this._topOffset+'px':'';CSS.setStyle(this.fixedScrollingWrapper,'top',c);CSS.conditionClass(this.fixedScrollingWrapper,'fixed_elem',a);var b=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(b);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var e=Vector2.getViewportDimensions().y;var b=Vector2.getElementDimensions(this.fixedScrollingWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y;var a=e-this._topOffset-b-this.PADDING_RHC_TO_BOTTOM;var d=Vector2.getElementDimensions(this.tickerStream).y;var c=Math.min(a,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',c+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;var a=function(){if(this.reloadRightCol())this.handleResize();};TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this._setFixedRightCol(false);TickerController.hide(this.tickerPagelet);}};
var HomeNavController={init:function(){Arbiter.subscribe(PresenceMessage.getArbiterMessageType('nav_update_counts'),this._updateCounts.bind(this));},updateCounts:function(b){for(var a=0;a<b.length;a++)Arbiter.inform(NavigationMessage.NAVIGATION_COUNT_UPDATE,b[a]);},expandGroups:function(){var a=ge('groupSideNavWrapper');if(a){CSS.addClass(a,'expandedMode');CSS.hide(DOM.find($('moreGroupsLink'),'.count'));new AsyncRequest('/ajax/groups/navigation/more_link/more_link.php').setMethod('post').setReadOnly(false).send();}},collapseGroups:function(){var a=ge('groupSideNavWrapper');if(a)CSS.removeClass(a,'expandedMode');},expandApps:function(){var a=ge('bookmarks_menu');if(a)CSS.addClass(a,'expandedMode');},collapseApps:function(){var a=ge('bookmarks_menu');if(a)CSS.removeClass(a,'expandedMode');},_lastSeenKey:null,resetGroupsAndApps:function(a){a=a||null;if(!a||!a.selected_key||a.selected_key!=this._lastSeenKey){this.collapseGroups();this.collapseApps();if(ge('groupSideNavWrapper'))UIPagelet.loadFromEndpoint('GroupsNavigationPagelet','pagelet_groups_nav',a);}this._lastSeenKey=(a&&a.selected_key)?a.selected_key:null;},_groupIDs:[],initGroupCounts:function(a,b){this._groupIDs=a;if(a&&a.length>0)Arbiter.subscribe(PresenceMessage.getArbiterMessageType('group_nav_update'),this._updateGroupCounts.bind(this));},_refreshGroupCounts:function(a){new AsyncRequest().setURI('/ajax/groups/navigation/update_counts/update_counts.php').setData({group_ids:a,nav_group_ids:this._groupIDs}).setMethod('post').send();},_updateGroupCounts:function(event,a){this._refreshGroupCounts([a.obj.group_id]);},_updateCounts:function(event,a){this.updateCounts(a.obj.items);}};
function SidebarTicker(){}SidebarTicker.prototype={init:function(){this._ticker=$('pagelet_ticker');this._initSubscriptions();CSS.addClass(document.documentElement,'ticker');if(CSS.hasClass(document.documentElement,'sidebarMode'))this._onSidebarShow();return this;},initResizeBehavior:function(b){var h=this._ticker;var d=h.parentNode;var c=this._saveResizedState.bind(this);var g;var i;var e;var f=function(k,event){g=event.clientY;i=h.offsetHeight;e=d.offsetHeight;};var j=function(m,event){var k=i+(event.clientY-g);var l=100-(((e-k)/e)*100);l=Math.max(10,Math.min(90,l));h.style.height=l+'%';if(m=='end'){c(l);Arbiter.inform('Ticker/resized');}window.ChatSidebar&&ChatSidebar.resize();};var a=new SimpleDrag(b);a.subscribe('start',f);a.subscribe(['update','end'],j);},_saveResizedState:function(a){new AsyncRequest('/ajax/feed/ticker/resize').setData({height:''+a}).setMethod('POST').send();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this))];},_onSidebarShow:function(){TickerController.show(this._ticker);}};
function HomeTickerFirstRightColumnController(){}HomeTickerFirstRightColumnController.prototype={_isFixed:false,_forcedStatic:false,init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||425),_tickerMinHeight:(a.tickerMinHeight||225),_tickerAbsMinHeight:(a.tickerAbsMinHeight||120),_listeners:[],_subscriptions:[]});this._listeners.push(Event.listen(window,'resize',throttle(this.handleResize.bind(this))));this.blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',throttle(this._handleScroll.bind(this))));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},reloadRightCol:function(){this.rightColumn=DOM.scry(ge('rightCol'),'div.home_right_column')[0];this.rightColumnWrapper=DOM.find(this.rightColumn,'div.rightColumnWrapper');this.egoPagelet=ge('pagelet_ego_pane');this.tickerPagelet=ge('pagelet_rhc_ticker');this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(this._forcedStatic||!this.tickerStream)return;this._topOffset=this.blueBarHeight+Vector2.getElementPosition(this.blueBar,'viewport').y;var b=this._topOffset;var c=Vector2.getElementPosition(this.rightColumn,'viewport').y;var a=c<=b;if(a!==this._isFixed)this._setFixed(a);},_setFixed:function(a){this._isFixed=a;var c=a?this._topOffset+'px':'';CSS.setStyle(this.rightColumnWrapper,'top',c);CSS.conditionClass(this.rightColumnWrapper,'fixed_elem',a);var b=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(b);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var i=Vector2.getViewportDimensions().y;var c=40;var d=61;var g=Vector2.getElementDimensions(this.rightColumnWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y;var h=Vector2.getElementDimensions(this.tickerStream).y;var b=i-g-c-this._topOffset-d;var a=this._tickerAbsMinHeight;var f=this._tickerMinHeight;this._forcedStatic=false;if(b<a){this._forcedStatic=true;this._setFixed(false);b=a;}else if(b<f)if(b>(f-d)){b=f;}else b+=d;var e=Math.min(b,h,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',e+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;var a=function(){if(this.reloadRightCol()){this._forcedStatic=false;this._handleScroll();this.handleResize();}};TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this._forcedStatic=true;this._setFixed(false);TickerController.hide(this.tickerPagelet);}};
function adjustImage(e,g){if(!g){var a=e.parentNode;while(a.parentNode&&(CSS.getStyle(a,'display')!='block'||a.offsetWidth==0))a=a.parentNode;g=a.offsetWidth;}var c=e.offsetWidth;if(c==0){var d=e.nextSibling,f=e.parentNode;document.body.appendChild(e);c=e.offsetWidth;if(d){f.insertBefore(e,d);}else f.appendChild(e);}if(c>g)try{if(ua.ie()<8){var img_div=document.createElement('div');img_div.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+e.src.replace('"','%22')+'", sizingMethod="scale")';img_div.style.width=g+'px';img_div.style.height=Math.floor(((g/e.offsetWidth)*e.offsetHeight))+'px';if(e.parentNode.tagName=='A')img_div.style.cursor='pointer';e.parentNode.insertBefore(img_div,e);e.parentNode.removeChild(e);}else throw 1;}catch(b){e.style.width=g+'px';}CSS.removeClass(e,'img_loading');}function imageConstrainSize(e,b,c,d){var a=new Image();a.onload=function(){if(a.width>0&&a.height>0){var k=a.width;var h=a.height;if(k>b||h>c){var g=c/b;var f=h/k;if(f>g){k=k*(c/h);h=c;}else{h=h*(b/k);k=b;}}var j=ge(d);if(j){var i=document.createElement('img');i.src=e;i.width=k;i.height=h;j.parentNode.insertBefore(i,j);j.parentNode.removeChild(j);}}};a.src=e;}function image_has_loaded(a){if(a.naturalWidth!==undefined){return a.complete&&a.width!=0;}else if(a.height==20&&a.width==20&&a.complete){return false;}else if(a.complete===undefined&&ua.safari()<500){var b=new Image();b.src=a.src;return b.complete;}return a.complete;}function image_has_failed(a){if((a.complete==null&&a.width==20&&a.height==20)||(a.mimeType!=null&&a.complete&&a.mimeType=='')||(a.naturalHeight!=null&&a.complete&&a.naturalHeight==0))return true;}
if(!window.JewelX){window.JewelX=function(){};copy_properties(JewelX,{_instancesByName:{},_resizeListener:null});Class.mixin(JewelX,'Arbiter',{init:function(a,b){JewelX._instancesByName[a]=this;this.name=a;this.root=b;this.countNew=0;this.initialCount=0;Toggler.listen(['show','hide'],this.root,function(d){var c=d==='show';c&&this._logFirstClick();this.hasNew()&&this.markSeen();this.reset();this.inform(c?'opened':'closed');Arbiter.inform(c?'layer_shown':'layer_hidden',{type:'Jewel'});}.bind(this));Arbiter.subscribe('jewel/count-updated',function(c,d){d.jewel==this.name&&this.update(d);}.bind(this));Arbiter.subscribe('jewel/count-initial',function(c,d){d.jewel==this.name&&this.setInitial(d);}.bind(this));Arbiter.subscribe('jewel/reset',function(c,d){d.jewel==this.name&&this.reset();}.bind(this));JewelX._resizeListener=JewelX._resizeListener||(function(){var c=null;return Event.listen(window,'resize',function(event){clearTimeout(c);c=Arbiter.inform.bind(Arbiter,'jewel/resize',event).defer(100,false);});})();},getRoot:function(){return this.root;},hasNew:function(){return CSS.hasClass(this.root,'hasNew');},isOpen:function(){return CSS.hasClass(this.root,'openToggler');},reset:function(){CSS.removeClass(this.root,'hasNew');},setContent:function(b){var a=DOM.find(this.root,'ul.jewelItemList');DOM.setContent(a,HTML(b));},update:function(b){this.countNew=b.count;var a=DOM.find(this.root,'span.jewelCount span');DOM.setContent(a,this.countNew);var c=isNaN(this.countNew)||this.countNew>0;CSS.conditionClass(this.root,'hasNew',c);this.inform('updated',b);},setInitial:function(a){this.initialCount=a;},markSeen:function(){Arbiter.inform('jewel/count-updated',{jewel:this.name,count:0},Arbiter.BEHAVIOR_STATE);this.inform('marked-seen');},_logFirstClick:function(){this._logFirstClick=bagofholding;report_data('jewel_click',{gt:{count:this.countNew,initial:this.initialCount,jewel:this.name}});}});}
__d("MessagingEvents",["arbiter"],function(c,d,e,b){var a=e('arbiter');onloadRegister(function(){var g={};MessagingEvents.subscribe('mark-as-read',function(h,i){(i.tids||i.chat_ids||[]).forEach(function(k){k=''+k;if(!(k in g)){g[k]=true;var l=function(){MessagingEvents.unsubscribe(m);clearTimeout(j);delete g[k];};var m=MessagingEvents.subscribe('read',function(n,o){if((o.tids||[]).contains(k)||(o.chat_ids||[]).contains(k))l();});var j=l.defer(60000);}});});var f=function(h){if(!is_empty(g))return;for(var i in h)MessagingEvents.inform('count/'+i,h[i]);};a.subscribe('presence/message:messaging',function(h,j){var k=copy_properties(j.obj);var event=k.event||'';delete k.type;delete k.event;MessagingEvents.inform(event,k);if('unread_counts' in k){var i=k.unread_counts;f({unread:i.inbox,other_unseen:i.other});}});a.subscribe('presence/message:inbox',function(h,i){var j=copy_properties(i.obj);delete j.type;f(j);});});c.MessagingEvents=d.exports=new a();},3);
function MessagesJewel(){}MessagesJewel.prototype={init:function(c,b){this.jewel=c;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbMessagesFlyout');this.newCountSpan=ge('newMessageCount');this.folder=b;var a=ge('messagesMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this,true));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/messages/fetched',this._overflowHandler.bind(this));MessagingEvents.subscribe('count/unread',this._updateInboxUnreadCount.bind(this));MessagingEvents.subscribe('count/unseen',this._updateInboxUnseenCount.bind(this));MessagingEvents.subscribe('count/other_unseen',this._updateInboxOtherUnseenCount.bind(this));},_markRead:function(a,b){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0});},_markSeenCallback:function(a,b){MenubarMessageController.instance.markSeen(this.folder);},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showMessages',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW MESSAGE",{num:this.countNew}):_tx("{num} NEW MESSAGES",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbMessagesItemList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));},_updateInboxOtherUnseenCount:function(a,b){CounterDisplay.setCount('other_unseen',b);},_updateInboxUnreadCount:function(a,b){CounterDisplay.setCount('messages_unread',b);},_updateInboxUnseenCount:function(a,b){CounterDisplay.setCount('messages_unseen',b);Arbiter.inform('jewel/count-updated',{jewel:'messages',count:b},Arbiter.BEHAVIOR_STATE);}};
function RequestsJewel(){}RequestsJewel.prototype={init:function(d,c,b){this.countNew=0;this.jewel=d;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbRequestsFlyout');this.newCountSpan=ge('newRequestCount');this.folder=c;this.doNewMarkRead=b;this._requestList={};this._requestCount=0;var a=ge('requestsMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('closed',this._clearNewItems.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));window.Unibeeper&&Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/handled'),this._removeRequest.bind(this));LinkController.registerHandler(this._handleLink.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/add'),this._addRequest.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/remove_old'),this._removeOldRequest.bind(this));Event.listen(this.jewelFlyout,'submit',function(e){var f=Parent.byClass(e.getTarget(),'objectListItem');if(f){CSS.removeClass(f,'jewelItemNew');CSS.addClass(f,'jewelItemResponded');}}.bind(this));return this;},fromDom:function(){DOM.scry(this.jewelFlyout,'.jewelItemList li.objectListItem').each(function(c){var b=c.getAttribute('id');var a=b&&parseInt(this._parseID(b).requester,10);if(a&&!isNaN(a)){this._requestList[a]=b;++this._requestCount;}}.bind(this));this._conditionShowEmptyMessage();},_parseID:function(a){var b=a.match(/^(\d+)_(\d+)/);return (b)?{requester:b[1],type:b[2]}:undefined;},_handleLink:function(b,event){var c=Parent.byClass(b,'jewelItemNew');if(c&&Parent.byClass(c,'fbRequestList')&&Parent.byClass(c,'beeperEnabled')){var a=this._parseID(c.id);a&&this._markSeenCallback(a.requester,a.type);Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});CSS.removeClass(c,'jewelItemNew');}return true;},_addRequest:function(a,b){if(!b||this._requestList[b.obj.from])return;var c=DOM.find(this.jewelFlyout,'.jewelItemList');elem=DOM.prependContent(c,b.obj.markup)[0];CSS.hide(DOM.find(c,'img.loadingIndicator'));var d={jewel:'requests',count:++this.countNew};Arbiter.inform('jewel/count-updated',d);this._requestList[b.obj.from]=elem.id;++this._requestCount;this._conditionShowEmptyMessage();},_removeOldRequest:function(a,b){if(!b)return;var d=this._requestList[b.obj.from];var c=d&&ge(d);if(c){CSS.hasClass(c,'jewelItemNew')&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});if(!CSS.hasClass(c,'jewelItemResponded')){DOM.remove(c);delete this._requestList[d];--this._requestCount;this._conditionShowEmptyMessage();}}},_markRead:function(){this.jewel.markSeen();this._clearNewItems();},_markSeenCallback:function(b,c){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:this.folder}).send();var a=typeof b!='undefined'&&typeof c!='undefined'?{requester:b,type:c}:{};this.doNewMarkRead&&new AsyncSignal('/ajax/requests/mark_read/',a).send();},_removeRequest:function(a,b){var c=b.obj.item_id;if(c){var d=ge(c);var e=d&&CSS.hasClass(d,'jewelItemNew');d?DOM.remove(d):false;e&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});}},_clearNewItems:function(a,b){DOM.scry(this.jewel.root,'li.jewelItemNew').each(function(c){CSS.removeClass(c,'jewelItemNew');});},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showRequests',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW REQUEST",{num:this.countNew}):_tx("{num} NEW REQUESTS",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_conditionShowEmptyMessage:function(){DOM.scry(this.jewelFlyout,'li.empty').each(function(a){CSS.conditionShow(a,this._requestCount<=0);}.bind(this));},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbRequestsList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));}};
add_properties('Input',{getSelection:function(b){if(!document.selection)return {start:b.selectionStart,end:b.selectionEnd};var d=document.selection.createRange();if(d.parentElement()!==b)return {start:0,end:0};var c=b.value.length;if(b.tagName=='INPUT'){return {start:-d.moveStart('character',-c),end:-d.moveEnd('character',-c)};}else{var e=d.duplicate();e.moveToElementText(b);e.setEndPoint('StartToEnd',d);var a=c-e.text.length;e.setEndPoint('StartToStart',d);return {start:c-e.text.length,end:a};}},setSelection:function(d,f,c){if(typeof c=='undefined')c=f;if(document.selection){if(d.tagName=='TEXTAREA'){var a=(d.value.slice(0,f).match(/\r/g)||[]).length;var b=(d.value.slice(f,c).match(/\r/g)||[]).length;f-=a;c-=a+b;}var e=d.createTextRange();e.collapse(true);e.moveStart('character',f);e.moveEnd('character',c-f);e.select();}else{d.selectionStart=f;d.selectionEnd=Math.min(c,d.value.length);Input.focus(d);}}});
add_properties('Input',{enforceMaxLength:function(c,e){var i=Input.getValue(c);var d=i.length;var f=d-e;if(f>0){var g;var a;try{g=Input.getSelection(c);a=g.end;}catch(b){g=null;a=0;}if(a>=f)d=a;var h=d-f;if(h&&(i.charCodeAt(h-1)&64512)===55296)h--;a=Math.min(a,h);Input.setValue(c,i.slice(0,h)+i.slice(d));if(g)Input.setSelection(c,Math.min(g.start,a),a);}}});onloadRegister(function(){function a(event){var b=event.getTarget();var c=parseInt(b.getAttribute('maxlength'),10);if(c>0&&DOM.isNodeOfType(b,['input','textarea']))Input.enforceMaxLength.bind(Input,b,c).defer();}Event.listen(document.documentElement,{keydown:a,paste:a});});
add_properties('Input',{setMaxLength:function(a,b){if(b>0){a.setAttribute('maxlength',b);Input.enforceMaxLength(a,b);}else a.removeAttribute('maxlength');}});
function TextInputControl(b){this.parent.construct(this,b);var a=this.getRoot();var c=function(){this.update.bind(this).defer();}.bind(this);Event.listen(a,{keydown:c,paste:c});}Class.extend(TextInputControl,'DOMControl');TextInputControl.prototype={setMaxLength:function(a){Input.setMaxLength(this.getRoot(),a);return this;},getValue:function(){return Input.getValue(this.getRoot());},isEmpty:function(){return Input.isEmpty(this.getRoot());},setValue:function(a){Input.setValue(this.getRoot(),a);this.update();return this;},clear:function(){return this.setValue('');},setPlaceholderText:function(a){Input.setPlaceholder(this.getRoot(),a);return this;}};
function TextMetrics(a){this._node=a;var b=this._shadow=$N('textarea',{className:'textMetrics'});var c=['fontSize','fontStyle','fontWeight','fontFamily','lineHeight','wordWrap'];c.each(function(d){CSS.setStyle(b,d,CSS.getStyle(a,d));});document.body.appendChild(b);}TextMetrics.prototype={measure:function(){var a=this._node;var b=this._shadow;var c=a.clientWidth-CSS.getStyleFloat(a,'paddingLeft')-CSS.getStyleFloat(a,'paddingRight');CSS.setStyle(b,'width',c+'px');b.value=a.value+'...';return {width:b.scrollWidth,height:b.scrollHeight};},destroy:function(){DOM.remove(this._shadow);}};
function TextAreaControl(a){this.autogrow=false;this.parent.construct(this,a);this.width=null;Event.listen(a,{focus:this._handleFocus.bind(this)});}Class.extend(TextAreaControl,'TextInputControl');Class.mixin(TextAreaControl,'Arbiter',{setAutogrow:function(a){this.autogrow=a;return this;},onupdate:function(){this.parent.onupdate();if(this.autogrow){var d=this.getRoot();if(!this.metrics)this.metrics=new TextMetrics(d);if(typeof this.minHeight==='undefined'){var c=CSS.getStyleFloat(d,'height');this.minHeight=c>0?c:d.offsetHeight-8;}if(typeof this.isBorderBox==='undefined')if(CSS.getStyle(d,'box-sizing')=='border-box'||CSS.getStyle(d,'-moz-box-sizing')=='border-box'||CSS.getStyle(d,'-webkit-box-sizing')=='border-box'){this.isBorderBox=true;this.borderBoxOffset=CSS.getStyleFloat(d,'padding-top')+CSS.getStyleFloat(d,'padding-bottom')+CSS.getStyleFloat(d,'border-top-width')+CSS.getStyleFloat(d,'border-bottom-width');}else this.isBorderBox=false;var b=this.metrics.measure();var a=Math.max(this.minHeight,b.height);if(this.isBorderBox)a+=this.borderBoxOffset;if(a!=this.height){CSS.setStyle(d,'height',a+'px');this.height=a;Arbiter.inform('reflow');this.inform('resize');}}else if(this.metrics){this.metrics.destroy();this.metrics=null;}},resetHeight:function(){this.height=-1;this.update();},_handleFocus:function(){this.width=null;}});
function KeyEventController(){this.handlers={};document.onkeyup=this.onkeyevent.bind(this,'onkeyup');document.onkeydown=this.onkeyevent.bind(this,'onkeydown');document.onkeypress=this.onkeyevent.bind(this,'onkeypress');}copy_properties(KeyEventController,{instance:null,getInstance:function(){return KeyEventController.instance||(KeyEventController.instance=new KeyEventController());},defaultFilter:function(event,a){event=$E(event);return KeyEventController.filterEventTypes(event,a)&&KeyEventController.filterEventTargets(event,a)&&KeyEventController.filterEventModifiers(event,a);},filterEventTypes:function(event,a){if(a==='onkeydown')return true;return false;},filterEventTargets:function(event,b){var a=event.getTarget();return !DOM.isNodeOfType(a,KeyEventController._interactiveElements)||(a.type in KeyEventController._uninterestingTypes)||(DOM.isNodeOfType(a,['input','textarea'])&&a.value.length===0&&event.keyCode in KeyEventController._controlKeys);},filterEventModifiers:function(event,a){if(event.ctrlKey||event.altKey||event.metaKey||event.repeat)return false;return true;},registerKey:function(f,a,d,g){if(d===undefined)d=KeyEventController.defaultFilter;var b=KeyEventController.getInstance();var c=b.mapKey(f);if(is_empty(b.handlers))onleaveRegister(b.resetHandlers.bind(b));for(var e=0;e<c.length;e++){f=c[e];if(!b.handlers[f]||g)b.handlers[f]=[];b.handlers[f].push({callback:a,filter:d});}},keyCodeMap:{BACKSPACE:[8],TAB:[9],RETURN:[13],ESCAPE:[27],LEFT:[37,63234],UP:[38,63232],RIGHT:[39,63235],DOWN:[40,63233],DELETE:[46],COMMA:[188],PERIOD:[190],'`':[192],'[':[219],']':[221]},_interactiveElements:['input','select','textarea','object','embed'],_uninterestingTypes:{checkbox:1,radio:1,submit:1},_controlKeys:{8:1,9:1,13:1,27:1,37:1,63234:1,38:1,63232:1,39:1,63235:1,40:1,63233:1,46:1}});copy_properties(KeyEventController.prototype,{mapKey:function(a){if(a>=0&&a<=9){if(typeof(a)!='number')a=a.charCodeAt(0)-48;return [48+a,96+a];}var b=KeyEventController.keyCodeMap[a.toUpperCase()];if(b)return b;return [a.toUpperCase().charCodeAt(0)];},onkeyevent:function(i,c){c=$E(c);var d=null;var g=this.handlers[c.keyCode];var b,f,a;if(g)for(var h=0;h<g.length;h++){b=g[h].callback;f=g[h].filter;try{if(!f||f(c,i)){a=b(c,i);if(a===false)return Event.kill(c);}}catch(e){}}return true;},resetHandlers:function(){this.handlers={};}});
function rand32(){return Math.floor(Math.random()*4294967295);}function verifyNumber(a){if(typeof a=='undefined'||isNaN(a)||a==Number.POSITIVE_INFINITY||a==Number.NEGATIVE_INFINITY)a=0;return a;}function mod(a,b){var c=a%b;if(c*b<0)c+=b;return c;}function clip(c,b,a){return Math.max(b,Math.min(c,a));}
__d("rect",["vector"],function(d,e,f,c){var b=f('vector');function a(k,j,g,i,h){if(arguments.length===1){if(k instanceof a)return k;if(k instanceof b)return new a(k.y,k.x,k.y,k.x,k.domain);return a.getElementBounds($(k));}copy_properties(this,{t:k,r:j,b:g,l:i,domain:h||'pure'});}copy_properties(a.prototype,{w:function(){return this.r-this.l;},h:function(){return this.b-this.t;},toString:function(){return '(('+this.l+', '+this.t+'), ('+this.r+', '+this.b+'))';},contains:function(h){h=new a(h).convertTo(this.domain);var g=this;return (g.l<=h.l&&g.r>=h.r&&g.t<=h.t&&g.b>=h.b);},add:function(i,j){if(arguments.length==1){if(i.domain!='pure')i=i.convertTo(this.domain);return this.add(i.x,i.y);}var g=parseFloat(i);var h=parseFloat(j);return new a(this.t+h,this.r+g,this.b+h,this.l+g,this.domain);},sub:function(g,h){if(arguments.length==1){return this.add(g.mul(-1));}else return this.add(-g,-h);},boundWithin:function(g){var h=0,i=0;if(this.l<g.l){h=g.l-this.l;}else if(this.r>g.r)h=g.r-this.r;if(this.t<g.t){i=g.t-this.t;}else if(this.b>g.b)i=g.b-this.b;return this.add(h,i);},getCenter:function(){return new b(this.l+this.w()/2,this.t+this.h()/2,this.domain);},getPositionVector:function(){return new b(this.l,this.t,this.domain);},getDimensionVector:function(){return new b(this.w(),this.h(),'pure');},convertTo:function(g){if(this.domain==g)return this;if(g=='pure')return new a(this.t,this.r,this.b,this.l,'pure');if(this.domain=='pure')return new a(0,0,0,0);var h=new b(this.l,this.t,this.domain).convertTo(g);return new a(h.y,h.x+this.w(),h.y+this.h(),h.x,g);}});copy_properties(a,{deserialize:function(h){var g=h.split(':');return new a(g[1],g[2],g[3],g[0]);},newFromVectors:function(h,g){return new a(h.y,h.x+g.x,h.y+g.y,h.x,h.domain);},getElementBounds:function(g){return a.newFromVectors(b.getElementPosition(g),b.getElementDimensions(g));},getViewportBounds:function(){return a.newFromVectors(b.getScrollPosition(),b.getViewportDimensions());},minimumBoundingBox:function(j){var g=new a(Math.min(),Math.max(),Math.max(),Math.min());var i;for(var h=0;h<j.length;h++){i=j[h];g.t=Math.min(g.t,i.t);g.r=Math.max(g.r,i.r);g.b=Math.max(g.b,i.b);g.l=Math.min(g.l,i.l);}return g;}});d.Rect=e.exports=a;},3);
onloadRegister(function(){copy_properties(AsyncRequest.prototype,{setNectarModuleData:function(c){if(this.method=='POST'){var d=Env.module;if(c&&d===undefined){var b={fbpage_fan_confirm:1};var e=null;for(var a=c;a&&a!=document.body;a=a.parentNode){if(!a.id||typeof a.id!=='string')continue;if(a.id.startsWith('pagelet_')){d=a.id;break;}if(!e&&b[a.id])e=a.id;}if(d===undefined&&e)d=e;}if(d!==undefined){if(this.data.nctr===undefined)this.data.nctr={};this.data.nctr._mod=d;}}},setNectarImpressionId:function(){if(this.method=='POST'){var a=env_get('impid');if(a!==undefined){if(this.data.nctr===undefined)this.data.nctr={};this.data.nctr._impid=a;}}}});});
if(window==window.top)!function(){var a=function(){var b=0;return function(){if(!b){b=1;setTimeout(function(){b=0;var c=Vector2.getViewportDimensions();setCookie('wd',c.x+'x'+c.y);if(window.AsyncSignal&&Math.random()<.01)new AsyncSignal('/ajax/dimension_context.php',{'x':c.x,'y':c.y}).send();},100);}};}();onloadRegister(a);onloadRegister(function(){Event.listen(window,'resize',a);});onloadRegister(function(){Event.listen(window,'focus',a);});}();
var ErrorDialog={showAsyncError:function(b){try{return ErrorDialog.show(b.getErrorSummary(),b.getErrorDescription());}catch(a){alert(b);}},show:function(d,c,b,a){return (new Dialog()).setTitle(d).setBody(c).setButtons([Dialog.OK]).setStackable(true).setModal(true).setHandler(b||bagofholding).setButtonsMessage(a||'').show();}};
Hovercard=window.Hovercard||{RESERVED_WIDTH:297,RESERVED_HEIGHT:237,ARROW_LEFT_OFFSET:32,cache:{},active:{},contextElem:null,fetchDelay:150,showDelay:700,loadingDelay:1000,hideDelay:250,fetchTimer:null,showTimer:null,loadingTimer:null,hideTimer:null,init:function(){if(ua.ie()<7)return;Event.listen(document.documentElement,'mouseover',this.handle.bind(this));},handle:function(event){var a=Parent.byTag(event.getTarget(),'a');if(a&&this.setActive(a)){this.process(a);event.stop();}},setActive:function(b){if(!this.isActive(b)){var a;if(!b||!(a=this.getEndpoint(b))){this.active.moveToken&&this.active.moveToken.remove();this.active={};return false;}if(this.active.node!=b){this.active.moveToken&&this.active.moveToken.remove();this.active={node:b,endpoint:a,pos:null};}}return true;},isActive:function(a){return a&&this.contextElem&&this.active.node==a;},getEndpoint:function(a){return a.getAttribute('data-hovercard');},process:function(b){var d=Event.listen(b,'mouseout',function(){clearTimeout(this.fetchTimer);clearTimeout(this.showTimer);d.remove();this.hide();}.bind(this));if(!this.active.moveToken)this.active.moveToken=Event.listen(b,'mousemove',function(event){this.active.pos=Vector2.getEventPosition(event);}.bind(this));clearTimeout(this.fetchTimer);clearTimeout(this.showTimer);clearTimeout(this.hideTimer);var a=this.fetchDelay;var c=this.contextElem?this.hideDelay:this.showDelay;if(b.getAttribute('data-hovercard-instant'))a=c=50;this.fetchTimer=setTimeout(this.fetch.bind(this,b),a);this.showTimer=setTimeout(this.show.bind(this,b),c);},show:function(c,b){this.build();if(this.active.node!=c)return;var a;if(this.cache[this.getEndpoint(c)]){a=this.cache[this.getEndpoint(c)];}else if(b){a={content:'',node:this.loading};}else{var d=this.contextElem?this.hideDelay:this.showDelay;this.loadingTimer=setTimeout(this.show.bind(this,c,true),this.loadingDelay-d);}a&&this.update(a);},hide:function(a){if(!this.contextElem)return;if(a){Arbiter.inform('layer_hidden',{type:'Hovercard'});Arbiter.inform('Hovercard/hide',{node:this.contextElem});if(this.stage&&this.stage.firstChild)this.preload.appendChild(this.stage.firstChild);var b=this.container&&this.container.parentNode;b&&b.removeChild(this.container);this.contextElem=null;ContextualThing.remove(this.overlay);}else this.hideTimer=setTimeout(this.hide.bind(this,true),this.hideDelay);},build:function(){this.build=bagofholding;var c=$N('div',{className:'arrow'},$N('i'));this.loading=$N('div',{className:'loading'},_tx("Loading..."));this.stage=$N('div',{className:'stage'});this.preload=$N('div',{id:'hovercardPreload'},this.loading);this.overlay=$N('div',{className:'HovercardOverlay'});this.container=$N('div',{className:'hovercard clearfix'},[this.stage,c]);Event.listen(window,'scroll',bind(this,'hide',true));Event.listen(this.container,{mouseleave:bind(this,'hide',false),mouseenter:function(){clearTimeout(this.hideTimer);}.bind(this)});var a=null;var b=[];Arbiter.subscribe('Overlay/show',function(d,e){var f=e.overlay;if(f.getContext)if(DOM.contains(this.container,f.getContext())){while(b.length)a.unsubscribe(b.pop());a=f;b=[f.subscribe('mouseenter',function(){clearTimeout(this.hideTimer);}.bind(this)),f.subscribe('mouseleave',bind(this,'hide',false))];}}.bind(this));Arbiter.subscribe('Overlay/hide',function(d,e){if(a===e.overlay){while(b.length)a.unsubscribe(b.pop());a=null;}}.bind(this));Arbiter.subscribe('page_transition',function(){this.abort();this.dirtyAll();}.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe('layer_shown',function(d,e){e.type!='Hovercard'&&e.type!='Overlay'&&this.abort();}.bind(this),Arbiter.SUBSCRIBE_NEW);document.body.appendChild(this.preload);},abort:function(){this.hide(true);clearTimeout(this.showTimer);clearTimeout(this.loadingTimer);},update:function(a){var g=this.contextElem;var f=this.stage.firstChild;var h=(f===this.loading);if(f)this.preload.appendChild(f);var b=a.node;var c=b&&b.getAttribute('data-hovercard-layout');this.container.className='hovercard';c&&CSS.addClass(this.container,c);var d=this.active.node;if(!DOM.contains(document.body,d)){this.hide(true);return;}var e=(d!=g&&!h);if(e)(function(){new AsyncSignal('/ajax/hovercard/shown.php').send();report_data('himp',{ft:{evt:39}});}).defer();var i=OverlayZIndexHelper.getZIndex(d);CSS.setStyle(this.overlay,'z-index',i>200?i:'');this.stage.appendChild(b);this.position(d,d.getAttribute('data-hovercard-fixed'));this.overlay.appendChild(this.container);document.body.appendChild(this.overlay);this.contextElem=d;ContextualThing.register(this.overlay,this.contextElem);if(e){if(g){Arbiter.inform('Hovercard/hide',{node:g});}else Arbiter.inform('layer_shown',{type:'Hovercard'});Arbiter.inform('Hovercard/show',{node:d});}},position:function(f,e){if(!this.wCheck&&e){this.wCheck=$N('div',{className:'HovercardWidthCheck'});document.body.appendChild(this.wCheck);}var h;var c=this.wCheck&&e?this.wCheck.offsetWidth:0;var b=this.getBounds(f);var i=b.getPositionVector().convertTo('viewport');var a=i.y<this.RESERVED_HEIGHT;var k=Vector2.getViewportDimensions();var j=c||k.x;window.ChatSidebar&&(j-=ChatSidebar.getVisibleWidth());var g=j<this.RESERVED_WIDTH+b.l;var d=g?c-b.r:b.l;if(b.w()<2*this.ARROW_LEFT_OFFSET)d+=b.w()/2-this.ARROW_LEFT_OFFSET;if(a){h=e?i.y+b.h():b.b;}else h=e?k.y-i.y:-b.t;CSS.conditionClass(this.container,'HovercardFromRight',g);CSS.conditionClass(this.container,'HovercardBelow',a);CSS.conditionClass(this.container,'HovercardFixed',e);CSS.setStyle(this.container,(g?'right':'left'),d+'px');CSS.setStyle(this.container,(g?'left':'right'),'auto');CSS.setStyle(this.container,(a?'top':'bottom'),h+'px');CSS.setStyle(this.container,(a?'bottom':'top'),'auto');},getBounds:function(e){var a=this.active.pos;var h=e.getClientRects();if(!a||h.length===0)return Rect.getElementBounds(e);var b;var c=false;for(var d=0;d<h.length;d++){var g=new Rect(Math.round(h[d].top),Math.round(h[d].right),Math.round(h[d].bottom),Math.round(h[d].left),'viewport').convertTo('document');var f=g.getPositionVector();var i=f.add(g.getDimensionVector());if(!b||(f.x<=b.l&&f.y>b.t)){if(c)break;b=new Rect(f.y,i.x,i.y,f.x,'document');}else{b.t=Math.min(b.t,f.y);b.b=Math.max(b.b,i.y);b.r=i.x;}if(g.contains(a))c=true;}return b;},fetch:function(c){if(c.id&&this.cache[c.id]!=null)return;var a=this.getEndpoint(c);if(this.cache[a]!=null)return;this.setFetchInProgress(a);var b=function(){this.dirty(a);this.abort();}.bind(this);new AsyncRequest(a).setMethod('GET').setReadOnly(true).setHandler(function(e){var d=e.getPayload();if(!d||!d.content){b();return;}d.node=HTML(d.content).getRootNode();delete d.content;this.setCache(a,d);}.bind(this)).setErrorHandler(b).setTransportErrorHandler(b).send();},setFetchInProgress:function(a){this.cache[a]=false;},setCache:function(b,a){this.build();this.cache[b]=a;if(this.active.endpoint==b&&this.contextElem){this.update(a);}else DOM.appendContent(this.preload,a.node);},contains:function(a){return DOM.contains(this.stage,a);},dirty:function(b){var a=this.cache[b];var c=a.node;var d=c&&c.parentNode;d&&d.removeChild(c);delete this.cache[b];},dirtyAll:function(){for(var a in this.cache)this.cache[a]&&this.dirty(a);}};onloadRegister(Hovercard.init.bind(Hovercard));
function DoublyLinkedListMap(){this._head=null;this._tail=null;this._nodes={};}DoublyLinkedListMap.prototype={get:function(a){return this._nodes[a]?this._nodes[a].data:null;},_insert:function(c,a,f,b){f&&!this._nodes[f]&&(f=null);var d=(f&&this._nodes[f])||(b?this._head:this._tail),e={data:a,key:c,next:null,prev:null};if(d){this.remove(c);if(b){e.prev=d.prev;d.prev&&(d.prev.next=e);d.prev=e;e.next=d;}else{e.next=d.next;d.next&&(d.next.prev=e);d.next=e;e.prev=d;}}e.prev===null&&(this._head=e);e.next===null&&(this._tail=e);this._nodes[c]=e;return this;},insertBefore:function(b,a,c){return this._insert(b,a,c,true);},insertAfter:function(b,a,c){return this._insert(b,a,c,false);},prepend:function(b,a){return this.insertBefore(b,a,this._head&&this._head.key);},append:function(b,a){return this.insertAfter(b,a,this._tail&&this._tail.key);},remove:function(b){var a=this._nodes[b];if(a){var c=a.next,d=a.prev;c&&(c.prev=d);d&&(d.next=c);this._head===a&&(this._head=c);this._tail===a&&(this._tail=d);delete this._nodes[b];}return this;},find:function(b){for(var a=this._head;a;a=a.next)if(b(a.data))return a.key;return null;},reduce:function(b,a){for(var c=this._head;c;c=c.next)a=b(c.data,a);return a;},exists:function(a){return !!this._nodes[a];},isEmpty:function(){return !this._head;}};
function Poller(c,b,a){this._clearOnQuicklingEvent=!a;this._requestCallback=b;this.setTimePeriod(c);}Poller.MIN_TIME_PERIOD=2000;copy_properties(Poller.prototype,{stop:function(){clearTimeout(this._token);this._token=null;this._cancelRequest();},scheduleRequest:function(){this.stop();if(this._timePeriod)this._token=this._makeRequest.bind(this).defer(this._timePeriod,this._clearOnQuicklingEvent);},requestNow:function(){this.stop();this._makeRequest();},_timePeriod:null,setTimePeriod:function(a){a=a||null;if(a&&(isNaN(a)||a<Poller.MIN_TIME_PERIOD))return;if(a&&this._timePeriod==null)this._token=this._makeRequest.bind(this).defer(a,this._clearOnQuicklingEvents);this._timePeriod=a;},_makeRequest:function(){this._cancelRequest();if(!this._isLoadUser())return;var b=new AsyncRequest();var a=true;b.setInitialHandler(function(){return a;});this._cancelRequest=function(){a=false;};b.setFinallyHandler(this.scheduleRequest.bind(this));b.setInitialHandler=bagofholding;b.setFinallyHandler=bagofholding;this._requestCallback(b);if(a)b.send();},_isLoadUser:function(){return Env.user==getCookie('c_user');},_cancelRequest:bagofholding,getTimePeriod:function(){return this._timePeriod;}});
Quickling=window.Quickling||{isActive:function(){return Quickling._is_active||false;},init:function(c,b,a){if(Quickling._is_initialized)return;copy_properties(Quickling,{_is_initialized:true,_is_active:true,_session_length:b,_is_in_transition:false,_title_interval:false,_ie_cache_title:'',_version:c});Quickling._instrumentTimeoutFunc('setInterval');Quickling._instrumentTimeoutFunc('setTimeout');Quickling._inactivePageRegex=new RegExp(a);PageTransitions.registerHandler(Quickling._transitionHandler,1);},_startQuicklingTransition:function(){Quickling._is_in_transition=true;},_stopQuicklingTransition:function(){(function(){Quickling._is_in_transition=false;}).defer();},isPageActive:function(d){if(d=='#')return false;d=new URI(d);if(d.getDomain()&&d.getDomain()!=URI().getDomain())return false;if(d.getPath()=='/l.php'){var b=d.getQueryData().u;if(b){b=URI(unescape(b)).getDomain();if(b&&b!=URI().getDomain())return false;}}var c=d.getPath();var a=d.getQueryData();if(!is_empty(a))c+='?'+URI.implodeQuery(a);return !Quickling._inactivePageRegex.test(c);},_setHTML:function(a,b){if(ua.ie()<=6){a.innerHTML=b;}else DOM.setContent(a,HTML(b).setDeferred(true));},_transitionHandler:function(a){AjaxPipeRequest.setCurrentRequest(null);if(Quickling._isTimeToRefresh())return false;if(!Quickling.isPageActive(a))return false;window.ExitTime=(new Date()).getTime();removeHook('onafterloadhooks');removeHook('onloadhooks');_runHooks('onleavehooks');Arbiter.inform('onload/exit',true);Quickling._startQuicklingTransition();$('content').style.visibility="visible";new QuickPipeRequest(a).setCanvasId('content').send();return true;},_changePageTitle:function(a){a=a||'Facebook';DocumentTitle.set(a);if(ua.ie()){Quickling._ie_cache_title=a;if(!Quickling._title_interval)Quickling._title_interval=window.setInterval(function(){var b=Quickling._ie_cache_title;var c=DocumentTitle.get();if(b!=c)DocumentTitle.set(b);},5000,false);}},_replaceSyndicationLinks:function(d){var c=document.getElementsByTagName('link');for(var b=0;b<c.length;++b){if(c[b].rel!='alternate')continue;DOM.remove(c[b]);}if(d.length){var a=DOM.find(document,'head');a&&DOM.appendContent(a,HTML(d[0]));}},_isTimeToRefresh:function(){Quickling._load_count=(Quickling._load_count||0)+1;return Quickling._load_count>=Quickling._session_length;},_instrumentTimeoutFunc:function(a){window[a+'_native']=(function(c){var b=function b(e,d){return c(e,d);};return b;})(window[a]);window[a]=function _setTimeout(d,c,b){var e=window[a+'_native'](d,c);if(c>0)if(b!==false)onleaveRegister(function(){clearInterval(e);});return e;};}};function QuickPipeRequest(b){var a={version:Quickling._version};this.parent.construct(this,b,{quickling:a});}Class.extend(QuickPipeRequest,'AjaxPipeRequest');QuickPipeRequest.prototype={_preBootloadFirstResponse:function(a){DOMScroll.scrollTo(new Vector2(0,0,'document'),false);return true;},_fireDomContentCallback:function(){this._request.cavalry&&this._request.cavalry.setTimeStamp('t_domcontent');Quickling._stopQuicklingTransition();PageTransitions.transitionComplete();this._onPageDisplayed&&this._onPageDisplayed(this.pipe);this.parent._fireDomContentCallback();},_fireOnloadCallback:function(){if(this._request.cavalry){this._request.cavalry.setTimeStamp('t_hooks');this._request.cavalry.setTimeStamp('t_layout');this._request.cavalry.setTimeStamp('t_onload');}this.parent._fireOnloadCallback();},isPageActive:function(a){return Quickling.isPageActive(a);},_versionCheck:function(a){if(a.version!=Quickling._version){var b=['quickling','ajaxpipe','ajaxpipe_token'];go_or_replace(window.location,URI(a.uri).removeQueryData(b),true);return false;}else return true;},_processFirstResponse:function(c){var b=c.getPayload();Quickling._changePageTitle(b.title);Quickling._replaceSyndicationLinks(b.syndication||[]);var a=b.body_class||'';CSS.setClass(document.body,a);},getSanitizedParameters:function(){return ['quickling'];}};
onloadRegister(function(){Event.listen(document.documentElement,'keyup',function(event){var c=event.getTarget();if(!DOM.isNodeOfType(c,['input','textarea']))return;if(DOM.isNodeOfType(c,'input')&&c.type=='password')return;if(c.getAttribute('data-prevent-auto-flip'))return;var f=Input.getValue(c);var b=(c.style&&c.style.direction);if(!b){for(var d=0;d<f.length;d++){var a=f.charCodeAt(d);if(a>=48){var e=(a>=1470&&a<=1920);CSS.setStyle(c,'direction',e?'rtl':'ltr');return;}}}else if(f.length===0)CSS.setStyle(c,'direction','');});});
onloadRegister(function(){Event.listen(document.documentElement,'submit',function(b){var a=b.getTarget().getElementsByTagName('*');for(var c=0;c<a.length;c++)if(a[c].getAttribute('placeholder')&&Input.isEmpty(a[c]))Input.setValue(a[c],'');});});
onloadRegister(function(){Event.listen(document.documentElement,'submit',function(b){var a=b.getTarget().getElementsByTagName('*');for(var c=0;c<a.length;c++)if(a[c].getAttribute('required')&&Input.isEmpty(a[c])){a[c].focus();return false;}},Event.Priority.URGENT);});
var Live={logAll:false,startup:function(){Live.startup=bagofholding;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('live'),Live.handleMessage.bind(Live));},lookupLiveNode:function(b,a){var c=DOM.scry(document.body,'.live_'+b+'_'+a);c.forEach(function(e){if(DataStore.get(e,'seqnum')===undefined){var d=JSON.parse(e.getAttribute('data-live'));DataStore.set(e,'seqnum',d.seq);}});return c;},handleMessage:function(f,b){var d=b.obj;var c=d.fbid;var a=d.assoc;var e=this.lookupLiveNode(c,a);if(!e)return false;e.forEach(function(l){var k={getRelativeTo:function(){return l;}};if(d.expseq){var i=DataStore.get(l,'seqnum');var g=DataStore.get(l,'message_buffer');if(g===undefined){g={};DataStore.set(l,'message_buffer',g);}var h={obj:d};g[d.expseq]=h;if(d.expseq!=i){Live.log('mismatch',d.fbid,d.expseq,i);return false;}while(true){i=DataStore.get(l,'seqnum');var j=g[i];if(j){Live._applyUpdates(j.obj.updates,k);Live.log('seqmatch',d.fbid,'exp',d.expseq,'cur',i);delete g[i];}else break;}}else Live._applyUpdates(d.updates,k);});},_applyUpdates:function(c,b){try{$A(c).each(function(d){new Function(d).apply(b);});}catch(a){}},log:function(){if(Live.logAll){var a=$A(arguments).join(":");new AsyncSignal('/common/scribe_endpoint.php',{c:'live_sequence',m:a}).send();}}};
function startMessagingNavCountUpdater(h){var d=FutureSideNav.getInstance().getNodeForKey('inbox');if(!d)return;var c=DOM.scry(d,'span.count')[0];var b=DOM.scry(c,'span.countValue')[0];var a=new CounterDisplay('messages_unread',b,c,null,null,true);var f=FutureSideNav.getInstance().getNodeForKey('other');var g=DOM.scry(f,'span.count')[0];var e=DOM.scry(g,'span.countValue')[0];var i=DOM.scry(g,'span.maxCountIndicator')[0];new CounterMaxDisplay('other_unseen',e,g,null,null,true).setMaxCounter(h,i);}function CounterMaxDisplay(){this._maxValue=null;this._maxIndicatorNode=null;var a=[this].concat($A(arguments));return this.parent.construct.apply(this.parent,a);}Class.extend(CounterMaxDisplay,'CounterDisplay');copy_properties(CounterMaxDisplay.prototype,{setMaxCounter:function(a,b){this._maxValue=a;this._maxIndicatorNode=b;},paint:function(){var b=this._maxValue&&this._count>this._maxValue;var a=b?this._maxValue:this._count;if(this._maxIndicatorNode){DOM.setContent(this._maxIndicatorNode,b?'+':'');}else if(b)a=a+'+';DOM.setContent(this._valueNode,a);this._toggleNodes();}});
var MessagingConst={APP_ID:313785040330,XD_MESSAGE:{SANDBOX_READY:'sandbox_ready',SET_CONTENT:'set_content',HTML_SIZE:'html_size',REFRESH_SIZE:'refresh_size'},SHINGLE_SCROLL_TRIGGER:5,EVENTS:{MESSAGE_SENT:'messaging/message_sent'}};
function MessagingJewelMenubarController(b,a){this.parent.construct(this);this._content=ge(a);this._open=false;this._ua=new UserNoOp();Arbiter.subscribe([MessagingConst.EVENTS.MESSAGE_SENT,'chat/message-sent'],this._onSend.bind(this));Toggler.listen(['show','hide'],$(b),this._onToggle.bind(this));this._init();}Class.extend(MessagingJewelMenubarController,'MenubarMessageController');copy_properties(MessagingJewelMenubarController,{FETCH_URI:'/ajax/messaging/jewel_fetch.php',MARK_SEEN_URI:'/ajax/messaging/jewel_mark_seen.php',USER_ACTION_CONTEXT:'jewel',USER_ACTION_NAMESPACE:'messaging',ensureInitialized:function(d,c,a,b){if(MessagingJewelMenubarController.initialized||!ge(c))return false;var e=new MessagingJewelMenubarController(d,c);MessagingJewelMenubarController.instance=e;MenubarMessageController.instance=e;e.ensureInitialized(d,c,a,b);MessagingJewelMenubarController.initialized=true;}});copy_properties(MessagingJewelMenubarController.prototype,{_ua:null,_init:function(){this.initializeEvents();},initializeEvents:function(){var a=null;Event.listen(this._content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&a!=b)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},_fetch:function(){new AsyncRequest().setURI(MessagingJewelMenubarController.FETCH_URI).setMethod('GET').setData({action:'jewelPreview',seen:!this.fetchOnHover}).setReadOnly(true).setHandler(this._onFetchSuccess.bind(this)).setAllowCrossPageTransition(true).send();},_onFetchSuccess:function(){this._ua.add_event('fetch_success');Arbiter.inform.bind(Arbiter,'jewel/messages/fetched').defer(100);},_onSend:function(){this._dirty=true;},onCounterUpdate:function(){this.parent.onCounterUpdate();if(this._open)this.doRefetch();},_onToggle:function(b,a){this._open=(b=="show");this._ua=user_action(MessagingJewelMenubarController.USER_ACTION_CONTEXT).set_namespace(MessagingJewelMenubarController.USER_ACTION_NAMESPACE).set_ua_id('jewel_menu').add_event(b);if(this._open)this.doRefetch();},markSeen:function(){if(this.fetchOnHover)new AsyncSignal(MessagingJewelMenubarController.MARK_SEEN_URI,{action:'markSeen'}).send();}});
var MusicEvents=new Arbiter();var MusicProviders={SPOTIFY:'open.spotify.com'};var MusicConstants={sameURLs:function(a,b){var c=/\/$/;return a&&b&&a.replace(c,'')==b.replace(c,'');},OP:{RESUME:'RESUME',PAUSE:'PAUSE',PLAY:'PLAY',VERSION:'VERSION'},STATUS_CHANGE_OP:{STATUS:'STATUS',LOGIN:'LOGIN',REINFORM:'REINFORM'},STATUS_CHANGE_EVENT:{playing:'PLAY_STATE_CHANGED',track:'TRACK_CHANGED'},DIAGNOSTIC_EVENT:{ALL_PAUSED:'ALL_PAUSED',ALL_OFFLINE:'ALL_OFFLINE',OFFLINE:'OFFLINE',ONLINE:'ONLINE',SEARCHING:'SEARCHING',HIT:'HIT',MISS:'MISS',RESIGN:'RESIGN',IFRAME_POLLING:'IFRAME_POLLING',RELAUNCH:'RELAUNCH',STATE_CHANGE:'STATE_CHANGE',WRONG_VERSION:'WRONG_VERSION',SERVICE_ERROR:'SERVICE_ERROR'},ALLOWED_STATUS_PARAMS:{playing:'playing',track:'track',context:'context',client_version:'client_version',start_time:'start_time',expires_in:'expires_in'},LIVE_LISTEN_OP:{NOW_LEADING:'NOW_LEADING',NOW_LISTENING:'NOW_LISTENING',END_SESSION:'END_SESSION',SONG_PLAYING:'SONG_PLAYING',LISTENER_UPDATE:'LISTENER_UPDATE',QUEUE_SESSION:'QUEUE_SESSION',PLAY_ERROR:'PLAY_ERROR',SESSION_UPDATED:'SESSION_UPDATED'},MUSIC_BUTTON:{ACTIVATE:'ACTIVATE'},ERROR:{1:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM',2:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM_OR_WAIT',3:'SERVICE_UNAVAILABLE_BILLING_ISSUE',4:'SERVICE_UNAVAILABLE_TECHNICAL_ISSUE',5:'AUDIO_AD_PLAYING',99:'SERVICE_TEMPORARILY_UNAVAILABLE',101:'SONG_UNAVAILABLE_WITHOUT_PURCHASE',102:'SONG_UNAVAILABLE_WITHOUT_PREMIUM',103:'SONG_UNAVAILABLE_INDEFINITELY'}};
onloadRegister(function(){add_properties('__behaviors',{});if(__behaviors.TinyViewport)return;__behaviors.TinyViewport=true;var a=document.documentElement;var b=debounce(function(){CSS.conditionClass(a,'tinyViewport',a.clientHeight<400||a.clientWidth<a.scrollWidth);});Event.listen(window,'resize',b);b();});
var MusicButton=function(d,a,f,b,c,e){this.provider=d;this.buttonID=a;this.url=f;this.context=b||{};this.mediaType=c;this.setState(this.STATES.OFFLINE);this.tooltip=e||'';MusicEvents.subscribe(MusicConstants.MUSIC_BUTTON.ACTIVATE,this.processClick.bind(this));};copy_properties(MusicButton,{tracksetableTypes:[]});copy_properties(MusicButton.prototype,{SHOW_LOADING_TIMEOUT:500,HIDE_LOADING_TIMEOUT:4000,RECENTLY_ONLINE_TIMEOUT:6000,STATES:{PLAYING:'music_playing',PAUSED:'music_paused',LOADING:'music_loading',DISABLED:'music_disabled',OFFLINE:'music_offline'},setState:function(b){if(b!==this.STATES.LOADING){this.resetLoadingTimers();this.previousState=this.state||b;}var a=$(this.buttonID);if(b===this.STATES.PLAYING){Tooltip.set(a,this.tooltip);}else Tooltip.set(a,'');var c=a.parentNode;this.state&&CSS.removeClass(c,this.state);this.state=b;CSS.addClass(c,this.state);},isTracksetable:function(a){return MusicButton.tracksetableTypes.indexOf(this.mediaType)!==-1;},handleIncomingEvent:function(d,b){clearTimeout(this._showLoadingTimer);if(b&&b.provider&&b.provider!=this.provider)return;switch(d){case MusicConstants.DIAGNOSTIC_EVENT.ONLINE:case MusicConstants.STATUS_CHANGE_EVENT.track:case MusicConstants.STATUS_CHANGE_EVENT.playing:var c=b&&b.track&&b.track.uri;var a=b&&b.context&&b.context.uri;if(b&&b.playing&&(MusicConstants.sameURLs(c,this.url)||MusicConstants.sameURLs(a,this.url))){this.setState(this.STATES.PLAYING);}else if(this.state===this.STATES.LOADING&&(this.previousState===this.STATES.PAUSED||this.previousState===this.STATES.OFFLINE)){clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=this.setState.bind(this,this.STATES.PAUSED).defer(this.RECENTLY_ONLINE_TIMEOUT,false);}else if(!this._attemptingPlayTimer)this.setState(this.STATES.PAUSED);break;case MusicConstants.DIAGNOSTIC_EVENT.OFFLINE:this.setState(this.STATES.OFFLINE);break;case MusicConstants.DIAGNOSTIC_EVENT.ALL_OFFLINE:this.setState(this.STATES.OFFLINE);break;}},processClick:function(a,h){var d=ge(this.buttonID);if(!d||h!=d){if(this.state===this.STATES.LOADING&&d)this.previousState&&this.setState(this.previousState);return;}var e=this.isTracksetable()&&Parent.byClass(d,'music_trackset_container');var l=[];if(e){var k=e.getAttribute('data-trackset-title');var g=this.provider;var f=DOM.scry(e,'.music_button');for(var i=0;i<f.length;i++){var c=MusicButtonManager.getButton([f[i].id]);if(c&&c.provider==g&&c.isTracksetable())l.push(c.url);}}var j=function(){return (e&&l.length>1)?Music.playPauseSongList(this.provider,this.url,l,k,this.context):Music.playPauseSong(this.provider,this.url,this.context);}.bind(this);if(!window.Music){this.showLoading(true);Bootloader.loadComponents('Music',j);return;}var b=j();this.showLoading(!b);},showLoading:function(a){this.resetLoadingTimers();this._hideLoadingTimer=this._timeout.bind(this,a).defer(this.HIDE_LOADING_TIMEOUT,false);this._showLoadingTimer=this.setState.bind(this,this.STATES.LOADING).defer(this.SHOW_LOADING_TIMEOUT,false);},resetLoadingTimers:function(){clearTimeout(this._hideLoadingTimer);clearTimeout(this._showLoadingTimer);clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=null;},_timeout:function(a){window.Music&&Music.reInform([this.provider]);if(!a&&this.state===this.STATES.LOADING)this.setState(this.STATES.PAUSED);}});
var MusicButtonManager=(function(){var g=null;var b={};var a={};function c(event){var j=$E(event).getTarget();var i=Parent.byClass(j,'music_button');i=i||(!event.getModifiers().any&&d(j));if(!i)return;return f(i,event);}function d(k){var j=Parent.byClass(k,'music_button_trigger')&&Parent.byClass(k,'music_button_trigger_group');if(j){var i=DOM.scry(j,'.music_button');if(i.length)return i[0];}return null;}function f(i,event){event&&$E(event).stop();MusicEvents.inform(MusicConstants.MUSIC_BUTTON.ACTIVATE,i);return false;}function h(i){window.Music&&Music.reInform(i);}function e(k,j){for(var i in b)if(ge(i)){b[i].handleIncomingEvent(k,j);}else MusicButtonManager.removeButton(i);}return {init:function(i){if(g)return;g=true;MusicButton.tracksetableTypes=i||[];Event.listen(document.body,'click',c);MusicEvents.subscribe([MusicConstants.STATUS_CHANGE_EVENT.playing,MusicConstants.STATUS_CHANGE_EVENT.track,MusicConstants.DIAGNOSTIC_EVENT.OFFLINE,MusicConstants.DIAGNOSTIC_EVENT.ALL_OFFLINE,MusicConstants.DIAGNOSTIC_EVENT.ONLINE],e);},getButton:function(i){return b[i];},addButton:function(l,i,m,j,k,n){g||MusicButtonManager.init();if(!ge(i))return;b[i];b[i]=new MusicButton(l,i,m,copy_properties({button_id:i},j),k,n);if(l&&!a[l])a[l]=function(){var o=keys(a);o.length&&h(o);a={};}.defer();return b[i];},removeButton:function(i){b[i]&&b[i].resetLoadingTimers();delete b[i];}};})();
function NotificationList(a){this._list=new DoublyLinkedListMap();this.unreadCount=0;this.contentRoot=a;this.noItemsElement=null;this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';}copy_properties(NotificationList,{ITEM_UNREAD_CLASS:'jewelItemNew',MARK_READ_TYPE:'mark_read',UNREAD_COUNT_CHANGE_TYPE:'unread_count_change',getIdFromDom:function(a){return a.getAttribute('id').replace('notification_','');},localizeUrls:function(a){DOM.scry(a,'a').each(function(b){URI(b.href).isFacebookURI()&&(b.href=URI(b.href).getUnqualifiedURI().getQualifiedURI().setSubdomain(URI(b.href).getSubdomain()).toString());});}});Class.mixin(NotificationList,'Arbiter',{_getField:function(c,b){var a=this._list.get(c);return a&&a[b];},getDomObj:function(a){return this._getField(a,'obj');},fromDom:function(){var e=this.ITEM_TAG+'.'+this.ITEM_CLASS;var c=DOM.scry(this.contentRoot,e);for(var d=0;d<c.length;++d){var b=c[d];var a=NotificationList.getIdFromDom(b);this.insert(a,b.getAttribute('data-notiftime'),null);}},insert:function(c,e,d,k,b){var j=true,i=0;if(this._list.exists(c))if(!(k&&d)){return false;}else{j=this._getField(c,'unread');i=this._getField(c,'time');if(i>e)return false;this.remove(c);}var f=(d&&HTML(d).getRootNode())||$('notification_'+c),l=Math.max(e,i),m=CSS.hasClass(f,NotificationList.ITEM_UNREAD_CLASS),a={id:c,obj:f,time:l,unread:m};var h=null;this._list.find(function(n){var o=n.time<=l;!o&&(h=n.id);return o;});var g=this.getDomObj(h);if(g){this._list.insertAfter(c,a,h);DOM.insertAfter(g,f);}else{this._list.prepend(c,a);DOM.prependContent(this.contentRoot,f);}NotificationList.localizeUrls(f);hide(this.NO_ITEMS_ID);if(m){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);b&&!j&&this.markRead([c]);}return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},_tx("No new notifications."));DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.show(this.NO_ITEMS_ID);},remove:function(a){var b=this._getField(a,'obj');if(!b)return false;this.markRead([a]);this._list.remove(a);DOM.remove(b);this._list.isEmpty()&&this.showNoNotifications();return true;},getUnreadIds:function(){return this._list.reduce(function(a,b){a.unread&&b.push(a.id);return b;},[]);},isUnreadId:function(a){return this._getField(a,'unread');},markRead:function(a){a=a?a.filter(this.isUnreadId.bind(this)):this.getUnreadIds();for(var b=0;b<a.length;b++){var c=this._list.get(a[b]);if(c){this.inform(NotificationList.MARK_READ_TYPE,c.obj);c.unread=false;}}if(a.length){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);}},insertMany:function(d,a){if('object'==typeof d&&!is_empty(d)){for(var c in d){var b=d[c];this.insert(c,b.time,b.markup,true,a);}hide(this.NO_ITEMS_ID);}else this.isEmpty()&&this.showNoNotifications();},isEmpty:function(){return this._list.isEmpty();}});function Notifications(a){this.updateTime=a.updateTime||Date.now();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.counterInFront=a.counterInFront||false;this.wrapperID=a.wrapperID||'notificationsWrapper';this.contentID=a.contentID||'jewelNotifs';this.timeElement='small.time';this.ua=new UserNoOp();this._init();}Notifications.BEEPS_EXPIRED='beeper/beeps_expired';Notifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.needMarkRead=false;this.currentFetchRequest=null;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.jewelFlyout=ge('fbNotificationsFlyout');this.loadingIndicator=ge(this.contentID+'_loading_indicator');NotificationCounter.init(this.counterInFront);this.alertList=new NotificationList(this.content);this._updateCount();window.MinNotifications&&MinNotifications.fetched()&&(this.fetch=bagofholding);Arbiter.subscribe(PresenceMessage.getArbiterMessageType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));this.alertList.subscribe(NotificationList.UNREAD_COUNT_CHANGE_TYPE,this._updateCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this),true);if(this.wrapper)this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');this.initializeEvents();this.fromDom();},fromDom:function(){this.alertList.fromDom();},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&b!=a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});Event.listen(this.wrapper,'mouseover',this.onMouseOver.bind(this));Toggler.listen('show',this.wrapper,this.onClick.bind(this));Toggler.listen('hide',this.wrapper,this.onHide.bind(this));},onMouseOver:function(event){this.ua=user_action('jewel',event.target,event).set_namespace('notifs').set_ua_id('prefetch').add_event('hover');this.fetch();},onClick:function(){window.ArbiterMonitor&&this.fetch!=bagofholding&&Arbiter.registerCallback(bagofholding,['notifs/fetched']);this.ua.add_event('show');this.fetch();this.markRead(true);},onHide:function(){this.ua.add_event('hide');},signalMarkRead:function(a){a=a||[];if(a.length===0&&this.currentFetchRequest){this.needMarkRead=true;return;}data={};for(var b=0;b<a.length;++b)data['alert_ids['+b+']']=a[b];new AsyncSignal('/ajax/notifications/mark_read.php',data).send();},markRead:function(b,a){if(this.alertList.unreadCount===0)return;b&&this.signalMarkRead(a);this.alertList.markRead(a);this._updateCount();},_updateErrorHandler:function(a){},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setErrorHandler(this._updateErrorHandler.bind(this)).setData({user:this.user,notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_handleUpdate:function(b){var a=b.payload.notifications;if(!a.no_change){this.updateTime=b.payload.time;this.latest_notif_time=a.latest_notif;this.latest_read_notif_time=a.latest_read_notif;this._updateDisplayDelayed();this.alertList.insertMany(a.notifications);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(Notifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_updateCount:function(){Arbiter.inform('jewel/count-updated',{jewel:'notifications',count:this.alertList.unreadCount},Arbiter.BEHAVIOR_STATE);},fetch:function(){var a=URI('/ajax/notifications/get.php');if(this.currentFetchRequest)return true;this.ua.add_event('fetch');a.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,locale:Env.locale});this.currentFetchRequest=new AsyncRequest().setURI(a).setStatusElement(this.loadingIndicator).setMethod('GET').setReadOnly(true).setTimeoutHandler(30000,this.fetchErrorHandler.bind(this)).setHandler(this.fetchHandler.bind(this)).setErrorHandler(this.fetchErrorHandler.bind(this)).setAllowCrossPageTransition(true);!this.currentFetchRequest.send()&&this.fetchErrorHandler();return true;},fetchErrorHandler:function(a){this.currentFetchRequest=null;this.ua.add_event('fetch_error');},fetchHandler:function(b){this.ua.add_event('fetch_success');var a=b.getPayload();this.alertList.insertMany(a.notifications,true);this.loadingIndicator&&CSS.hide(this.loadingIndicator);this.loadingIndicator=null;this.currentFetchRequest=null;this.fetch=bagofholding;if(this.needMarkRead){this.needMarkRead=false;this.signalMarkRead();}window.ArbiterMonitor&&Arbiter.inform('notifs/fetched','',Arbiter.BEHAVIOR_STATE);},_mergeNotification:function(b,d,c){var a=!this.alertList.isUnreadId(b);this.alertList.insert(b,d,c,true);this.latest_notif_time=0;if(a)this._updateCount();if(this.isTabOpen())this._merged_mouseover_handler=Event.listen(this.content,'mouseover',(function(){this._merged_mouseover_handler.remove();this.markRead(true);}).bind(this));},_handleNotificationMsg:function(d,a){var b=a.obj;if(typeof this.useDesktopNotifications=='undefined'){var c;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(b.alert_id);});b.time=b.time||Date.now();if(b.markup){this._mergeNotification(b.alert_id,b.time,b.markup);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(c,a){var b=a.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(false,b.alert_ids);this.markRead(false,b.alert_ids);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'openToggler');}};
function OriginalNotifications(a){this.parent.construct(this,a);}Class.extend(OriginalNotifications,'Notifications');copy_properties(OriginalNotifications.prototype,{_init:function(){this.parent._init();this.alertList.subscribe(NotificationList.MARK_READ_TYPE,this._animateMarkRead.bind(this));Arbiter.subscribe('jewel/resize',this._hideOverflow.bind(this));},fetchHandler:function(c){this.parent.fetchHandler(c);var b=c.getPayload();var d=b.generated;var a=Math.round((new Date()).getTime()/1000);if(a-d>15)d=a;Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(d);LiveTimer.startLoop(0);});this._hideOverflow();},_mergeNotification:function(a,c,b){this.parent._mergeNotification(a,c,b);var d=this.alertList.getDomObj(a);if(d)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(d);});},_animateMarkRead:function(a,b){animation(b).duration(5000).checkpoint().from('backgroundColor','#EFF1F7').to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,NotificationList.ITEM_UNREAD_CLASS)).go();},onClick:function(){this.parent.onClick();this._hideOverflow();},_updateCount:function(){this.parent._updateCount();this._hideOverflow();},_hideOverflow:function(){var a=DOM.find(this.jewelFlyout,'.jewelFooter'),d=DOM.scry($('fbNotificationsList'),'.notification');if(!d.length||(CSS.hasClass(document.documentElement,'tinyViewport')&&!CSS.hasClass(document.body,'fixedBody'))){d.each(CSS.show);return;}var b=Vector2.getViewportDimensions().y-Vector2.getElementPosition(d[0],'viewport').y-Vector2.getElementDimensions(a).y,c=0;for(;c<d.length&&b>0;++c){CSS.show(d[c]);b-=Vector2.getElementDimensions(d[c]).y;}b<0&&--c;for(;c<d.length;++c)CSS.hide(d[c]);}});
function OnVisible(b,c,e,a,d){this.element=b;this.handler=c;this.strict=e;this.buffer=coalesce(a,300);this.options=d||{};this.lastY=Vector2.getScrollPosition().y;this.lastTime=Date.now();this.reset();onleaveRegister(this.remove.bind(this));}copy_properties(OnVisible.prototype,{reset:function(){if(this.scrollListener)return;var a=throttle(function(){this.targetY=Vector2.getElementPosition(this.element).y;var g=Vector2.getScrollPosition().y;var e=Vector2.getViewportDimensions().y;var f=g+e+this.buffer;if(f>this.targetY){var d=!this.strict||(g-this.buffer<(this.targetY+Vector2.getElementDimensions(this.element).y));if(d){this.remove();if(this.options.detect_speed){var b=(g-this.lastY);var c=b/(Date.now()-this.lastTime+1);if((c>e/100)||(f>=Vector2.getDocumentDimensions().y&&b>1000))return true;}this.handler();}}if(this.options.detect_speed){this.lastY=g;this.lastTime=Date.now();}return true;}.bind(this),100);this.scrollListener=Event.listen(window,'scroll',a);this.resizeListener=Event.listen(window,'resize',a);a();},remove:function(){if(this.scrollListener){this.scrollListener.remove();this.resizeListener.remove();this.scrollListener=this.resizeListener=null;}}});
function fbpage_set_fan_status(c,f,a,h,g,d,e){g=g?g:function(j){_fbpage_show_change_status_feedback(c,j.getPayload());};var b={fbpage_id:f,add:a,reload:h};if(e!=null)copy_properties(b,e);var i=new AsyncRequest().setURI('/ajax/pages/fan_status.php').setData(b).setNectarModuleDataSafe(c).setHandler(g);if(d)i.setErrorHandler(d);i.send();return false;}function fbpage_set_favorite_status(d,e,a){var f=function(){_fbpage_show_change_status_feedback(d,this.getUserData());};var c={fbpage_id:e,add:a};var b=new AsyncRequest().setMethod('POST').setURI('/ajax/pages/favorite_status.php').setData(c);new Dialog().setAsync(b).setCloseHandler(f).show();return false;}function _fbpage_show_change_status_feedback(b,a){if(!a||!b)return;if(a.reload){fbpage_reload_on_fan_status_changed(a.preserve_tab);}else fbpage_redraw_on_fan_status_changed(b,a.feedback);}function fbpage_reload_on_fan_status_changed(a){var c=URI.getRequestURI();if(a){var b=FutureSideNav.getInstance().selected.textKey;if(!c.getQueryData().sk&&b)c.addQueryData({sk:b});}window.location.href=c;}function fbpage_redraw_on_fan_status_changed(a,b){if(!b)return;var d=document.createElement('span');d.innerHTML=b;CSS.setClass(d,'fan_status_inactive');a.parentNode.replaceChild(d,a);var c=function(){if(data.can_repeat_action)d.parentNode.replaceChild(a,d);};animation(d).duration(3000).checkpoint().to('backgroundColor','#FFFFFF').duration(1000).ondone(c).go();}
var PhotosConst={VIEWER_PERMALINK:0,VIEWER_THEATER:1,VIEWER_SNOWBOX:2,BULK_EDITOR:3,inCenterStage:function(a){return a==PhotosConst.VIEWER_THEATER||a==PhotosConst.VIEWER_SNOWBOX;},SIZE_NORMAL:'n'};
function AlbumScroller(){}AlbumScroller.prototype={init:function(d,e){this.photoGroups={};this.scrollListener={};if(d.length){var b=d.shift(),f=b,a=0,c=b.id;while(f){if(!this.photoGroups[c])this.photoGroups[c]=[];var g=DOM.scry(f,'a.uiScrollableThumb');if(g.length>0)this.photoGroups[c].push(g[0]);f=this.getNextPhotoCell(f);if(++a%e==0){this.scrollListener[c]=new OnVisible(b,this.showPage.bind(this,b));b=d.shift();if(b)c=b.id;}}if(b)this.scrollListener[c]=new OnVisible(b,this.showPage.bind(this,b));}},showPage:function(a){var b=this.photoGroups[a.id];if(b)for(var c=0,d=b.length;c<d;c++)DOM.find(b[c],'i').style.backgroundImage='url('+b[c].getAttribute('data-src')+')';},getNextPhotoCell:function(a){var b=null;if(a.nextSibling){b=a.nextSibling;}else if(a.parentNode.nextSibling)b=a.parentNode.nextSibling.firstChild;if(b&&b.childElementCount!==0)return b;return null;}};
function BulkTagLoader(){}copy_properties(BulkTagLoader,{_requested:false,loadForSet:function(a){if(!BulkTagLoader._requested){BulkTagLoader._requested=true;new AsyncRequest('/ajax/photos/sets/tags_fetch.php').setHandler(bagofholding).setData({set:a}).send();}},loadForAlbum:function(a){if(!BulkTagLoader._requested){BulkTagLoader._requested=true;new AsyncRequest('/ajax/photos/album/tags_fetch.php').setHandler(bagofholding).setData({fbid:a}).send();}},reset:function(){BulkTagLoader._requested=false;}});
var MediaSetLikeButtonController={submit:function(){$('mediaSetUfiLikeLink').firstChild.click();CSS.hide($('mediaSetLikeButton'));}};
var PhotoInlineCaptionEditor=function(a){this.instanceId=a;PhotoInlineCaptionEditor.instances[a]=this;};copy_properties(PhotoInlineCaptionEditor,{instances:{},getInstance:function(a){return this.instances[a];}});PhotoInlineCaptionEditor.prototype={init:function(a){this.element=a;Event.listen(a,'click',this.handleClick.bind(this));var b=DOM.scry(a,'input[name="caption_id"]');if(b.length)b[0].value=this.instanceId;this.inputStr='';var c=DOM.scry(this.element,'textarea.fbPhotoCaptionInput')[0];if(c)this.inputStr=Input.getValue(c);},handleClick:function(event){var a=event.getTarget();if(Parent.byClass(a,'editIcon')||Parent.byClass(a,'noCaption')){this.toggleEditDescription(true);}else if(Parent.byClass(a,'cancelEdit')){Input.setValue(DOM.find(this.element,'textarea.fbPhotoCaptionInput'),this.inputStr);this.toggleEditDescription(false);}},setCaption:function(a){DOM.setContent(DOM.find(this.element,'.fbPhotoCaptionText'),a);this.toggleEditDescription(false);this.inputStr=Input.getValue(DOM.find(this.element,'textarea.fbPhotoCaptionInput'));},getCaption:function(){return DOM.getText(DOM.find(this.element,'.fbPhotoCaptionText'));},toggleEditDescription:function(c){if(!c)DOM.find(this.element,'textarea.fbPhotoCaptionInput').blur();CSS.conditionClass(this.element,'fbPhotoInlineCaptionEditorEditMode',!!c);if(c){var b=DOM.find(this.element,'textarea.fbPhotoCaptionInput');var a=DOMControl.getInstance(b);a&&a.update();b.focus();}else CSS.conditionClass(DOM.find(this.element,'.noCaption'),'hidden_elem',this.getCaption().length);}};
function PhotosTaggingWaterfall(a){PhotosTaggingWaterfall._queueName=a||PhotosTaggingWaterfall._queueName;}copy_properties(PhotosTaggingWaterfall,{BEGIN:"begin",TAG_FACE:"tag_face",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function(b,a){new AsyncSignal('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(b)}).setHandler(a).send();}});
function Typeahead(b,d,a,c){this.args={data:b,view:d,core:a};DataStore.set(c,'Typeahead',this);this.element=c;}Typeahead.getInstance=function(a){var b=Parent.byClass(a,'uiTypeahead');return b?DataStore.get(b,'Typeahead'):null;};Class.mixin(Typeahead,'Arbiter',{init:function(a){this.init=bagofholding;this.getCore();this.proxyEvents();this.initBehaviors(a||[]);this.inform('init',this);this.data.bootstrap();this.core.focus();},getData:function(){if(!this.data){var a=this.args.data;this.data=a;this.data.init();}return this.data;},getView:function(){if(!this.view){var a=this.args.view;var b=ge(a.node_id);if(!b){b=$N('div',{className:'uiTypeaheadView'});DOM.appendContent(this.element,b);}this.view=new window[a.ctor](b,a.options||{});this.view.init();}return this.view;},getCore:function(){if(!this.core){var a=this.args.core;this.core=new window[a.ctor](a.options||{});this.core.init(this.getData(),this.getView(),this.getElement());}return this.core;},getElement:function(){return this.element;},swapData:function(b){var a=this.core;this.data=this.args.data=b;b.init();if(a){a.data=b;a.initData();a.reset();}b.bootstrap();return b;},proxyEvents:function(){[this.data,this.view,this.core].each(function(a){a.subscribe(a.events,this.inform.bind(this));},this);},initBehaviors:function(a){if(window.TypeaheadBehaviors)a.each(function(b){(TypeaheadBehaviors[b]||bagofholding)(this);},this);}});
var TypeaheadUtil=(function(){var b=/[ ]+/g;var c=/[^ ]+/g;var a=/[.,+*?$|#{}()\^\-\[\]\\\/!@%'"~=<>_:;\u2010\u2011\u2012\u2013\u2014\u2015\u30fb]/g;var d={};var r={a:"\u0430 \u00e0 \u00e1 \u00e2 \u00e3 \u00e4 \u00e5",b:"\u0431",c:"\u0446 \u00e7 \u010d",d:"\u0434 \u00f0 \u010f \u0111",e:"\u044d \u0435 \u00e8 \u00e9 \u00ea \u00eb \u011b",f:"\u0444",g:"\u0433 \u011f",h:"\u0445 \u0127",i:"\u0438 \u00ec \u00ed \u00ee \u00ef \u0131",j:"\u0439",k:"\u043a \u0138",l:"\u043b \u013e \u013a \u0140 \u0142",m:"\u043c",n:"\u043d \u00f1 \u0148 \u0149 \u014b",o:"\u043e \u00f8 \u00f6 \u00f5 \u00f4 \u00f3 \u00f2",p:"\u043f",r:"\u0440 \u0159 \u0155",s:"\u0441 \u015f \u0161 \u017f",t:"\u0442 \u0165 \u0167 \u00fe",u:"\u0443 \u044e \u00fc \u00fb \u00fa \u00f9 \u016f",v:"\u0432",y:"\u044b \u00ff \u00fd",z:"\u0437 \u017e",ae:"\u00e6",oe:"\u0153",ts:"\u0446",ch:"\u0447",ij:"\u0133",sh:"\u0448",ss:"\u00df",ya:"\u044f"};for(var m in r){var f=r[m].split(' ');for(var h=0;h<f.length;h++)d[f[h]]=m;}var p={};function e(s){return s?s.replace(a,' '):'';}function g(v){v=(''+v).toLowerCase();var u='';var s='';for(var t=v.length;t--;){s=v.charAt(t);u=(d[s]||s)+u;}return u.replace(b,' ');}function q(t){var u=[];var s=c.exec(t);while(s){s=s[0];u.push(s);s=c.exec(t);}return u;}function o(v,u){v=''+v;if(!p.hasOwnProperty(v)){var t=g(v);var s=e(t);p[v]={value:v,flatValue:t,tokens:q(s),isPrefixQuery:s&&s[s.length-1]!=' '};}if(u&&typeof p[v].sortedTokens=='undefined'){p[v].sortedTokens=copy_properties([],p[v].tokens);p[v].sortedTokens.sort(function(w,x){return x.length-w.length;});}return p[v];}function j(t,z,v){var y=o(z,t=='prefix');var za=t=='prefix'?y.sortedTokens:y.tokens;var w=o(v).tokens;var u={};var x=y.isPrefixQuery&&t=='query'?za.length-1:null;var s=function(zd,zc){for(var zb=0;zb<w.length;++zb){var ze=w[zb];if(!u[zb]&&(ze==zd||((t=='query'&&zc===x||t=='prefix')&&ze.indexOf(zd)===0)))return (u[zb]=true);}return false;};return za.length&&za.every(s);}var i=j.curry('exact');var l=j.curry('query');var k=j.curry('prefix');var n={parse:o,isExactMatch:i,isQueryMatch:l,isPrefixMatch:k};return n;})();
function DataSource(a){this._maxResults=a.maxResults||10;this.token=a.token;this.queryData=a.queryData||{};this.queryEndpoint=a.queryEndpoint||'';this.bootstrapData=a.bootstrapData||{};this.bootstrapEndpoint=a.bootstrapEndpoint||'';this._exclusions=a.exclusions||[];this._indexedFields=a.indexedFields||['text','tokens'];this._alwaysPrefixMatch=a.alwaysPrefixMatch||false;this._minExactMatchLength=4;}Class.mixin(DataSource,'Arbiter',{events:['activity','query','respond'],init:function(){this.init=bagofholding;this._fields=Object.from(this._indexedFields);this._activeQueries=0;this.dirty();},dirty:function(){this.value='';this._bootstrapped=false;this._data={};this.localCache={};this.queryCache={};this.inform('dirty',{});},bootstrap:function(){if(this._bootstrapped)return;this.bootstrapWithoutToken();this._bootstrapped=true;},bootstrapWithoutToken:function(){this.fetch(this.bootstrapEndpoint,this.bootstrapData,{bootstrap:true,token:this.token});},bootstrapWithToken:function(){var a=copy_properties({},this.bootstrapData);a.token=this.token;this.fetch(this.bootstrapEndpoint,a,{bootstrap:true,replaceCache:true});},query:function(f,c,a){this.inform('beforeQuery',{value:f});var e=this.buildUids(f,[],a);var d=this.respond(f,e);this.value=f;this.inform('query',{value:f,results:d});var b=TypeaheadUtil.parse(f).flatValue;if(c||!b||!this.queryEndpoint||this.getQueryCache().hasOwnProperty(b)||!this.shouldFetchMoreResults(d))return false;this.inform('queryEndpoint',{value:f});this.fetch(this.queryEndpoint,this.getQueryData(f,e),{value:f,exclusions:a});return true;},shouldFetchMoreResults:function(a){return a.length<this._maxResults;},getQueryData:function(c,b){var a=copy_properties({value:c},this.queryData||{});b=b||[];if(b.length)a.existing_ids=b.join(',');return a;},setQueryData:function(a,b){if(b)this.queryData={};copy_properties(this.queryData,a);return this;},setBootstrapData:function(a,b){if(b)this.bootstrapData={};copy_properties(this.bootstrapData,a);return this;},getExclusions:function(){return $A(this._exclusions);},setExclusions:function(a){this._exclusions=a||[];},setFilter:function(a){this.filter=a;},respond:function(d,c,a){var b=this.buildData(c);this.inform('respond',{value:d,results:b,isAsync:!!a});return b;},asyncErrorHandler:bagofholding,fetch:function(c,b,d){if(!c)return;var a=new AsyncRequest().setURI(c).setData(b).setMethod('GET').setReadOnly(true).setHandler(function(e){this.fetchHandler(e,d||{});}.bind(this)).setFinallyHandler(function(){this._activeQueries--;if(!this._activeQueries)this.inform('activity',{activity:false});}.bind(this));a.setErrorHandler(this.asyncErrorHandler);this.inform('beforeFetch',{request:a,fetch_context:d});a.send();if(!this._activeQueries)this.inform('activity',{activity:true});this._activeQueries++;},fetchHandler:function(d,b){var e=b.value;var a=b.exclusions;if(!e&&b.replaceCache)this.localCache={};this.addEntries(d.getPayload().entries,e);this.inform('fetchComplete',{response:d,value:e,fetch_context:b});var c=(!e&&this.value)?this.value:e;this.respond(c,this.buildUids(c,[],a),true);if(!e&&b.token&&d.getPayload().token!==b.token)this.bootstrapWithToken();},addEntries:function(b,e){var c=this.processEntries($A(b||[]),e);var a=this.buildUids(e,c);if(e){var d=this.getQueryCache();d[TypeaheadUtil.parse(e).flatValue]=a;}else this.fillCache(a);},processEntries:function(a,b){return a.map(function(e,d){var f=(e.uid=e.uid+'');var c=this.getEntry(f);if(!c){c=e;c.query=b;this.setEntry(f,c);}else copy_properties(c,e);c.index===undefined&&(c.index=d);return f;},this);},getAllEntries:function(){return this._data||{};},getEntry:function(a){return this._data[a]||null;},setEntry:function(b,a){this._data[b]=a;},fillCache:function(b){var a=this.localCache;b.each(function(g){var d=this.getEntry(g);if(!d)return;d.bootstrapped=true;var f=TypeaheadUtil.parse(this.getTextToIndex(d)).tokens;for(var c=0,e=f.length;c<e;++c){var h=f[c];if(!a.hasOwnProperty(h))a[h]={};a[h][g]=true;}},this);},getTextToIndex:function(c){if(c.textToIndex)return c.textToIndex;var d=[];for(var b in this._fields){var a=c[b];if(a)d.push(a.join?a.join(' '):a);}return (c.textToIndex=d.join(' '));},mergeUids:function(a,c,b,e){var d=function(f,g){var h=this.getEntry(f);var i=this.getEntry(g);if(h.extended_match!==i.extended_match)return h.extended_match?1:-1;if(h.index!==i.index)return h.index-i.index;if(h.text.length!==i.text.length)return h.text.length-i.text.length;return h.uid<i.uid;}.bind(this);this._checkExtendedMatch(e,a);return a.sort(d).concat(c,b);},_checkExtendedMatch:function(e,d){var b=this._alwaysPrefixMatch?TypeaheadUtil.isPrefixMatch:TypeaheadUtil.isQueryMatch;for(var a=0;a<d.length;++a){var c=this.getEntry(d[a]);c.extended_match=c.tokens?!b(e,c.text):false;}},buildUids:function(h,d,a){if(!d)d=[];if(!h)return d;if(!a)a=[];var b=this.buildCacheResults(h,this.localCache);var f=this.buildQueryResults(h);var e=this.mergeUids(b,f,d,h);var g=Object.from(a.concat(this._exclusions));var c=e.filter(function(i){if(g.hasOwnProperty(i)||!this.getEntry(i))return false;if(this.filter&&!this.filter(this.getEntry(i)))return false;return (g[i]=true);},this);return this.uidsIncludingExact(h,c,g);},uidsIncludingExact:function(g,d,f){var e=d.length;if(g.length<this._minExactMatchLength||e<=this._maxResults)return d;for(var c=0;c<e;++c){var a=this.getEntry(d[c]);a.text_lower||(a.text_lower=a.text.toLowerCase());if(a.text_lower===TypeaheadUtil.parse(g).flatValue){if(c>=this._maxResults){var b=d.splice(c,1);d.splice(this._maxResults-1,0,b);}break;}}return d;},buildData:function(d){var c=[];var b=Math.min(d.length,this._maxResults);for(var a=0;a<b;++a)c.push(this.getEntry(d[a]));return c;},findQueryCache:function(e){var b=0;var a=null;var d=this.getQueryCache();for(var c in d)if(e.indexOf(c)==0&&c.length>b){b=c.length;a=c;}return d[a]||[];},buildQueryResults:function(c){var a=TypeaheadUtil.parse(c).flatValue;var b=this.findQueryCache(a);if(this.getQueryCache().hasOwnProperty(a))return b;return this.filterQueryResults(c,b);},filterQueryResults:function(c,b){var a=this._alwaysPrefixMatch?TypeaheadUtil.isPrefixMatch:TypeaheadUtil.isQueryMatch;return b.filter(function(d){return a(c,this.getTextToIndex(this.getEntry(d)));},this);},buildCacheResults:function(r,a){var k=TypeaheadUtil.parse(r,this._alwaysPrefixMatch);var l=this._alwaysPrefixMatch?k.sortedTokens:k.tokens;var h=l.length;var i=k.isPrefixQuery?h-1:null;var e={};var j={};var o={};var f=[];var c=false;var q={};var p=0;for(var d=0;d<h;++d){var m=l[d];if(!q.hasOwnProperty(m)){p++;q[m]=true;}else continue;for(var g in a)if((!e.hasOwnProperty(g)&&g===m)||((this._alwaysPrefixMatch||i===d)&&g.indexOf(m)===0)){if(g===m){if(j.hasOwnProperty(g))c=true;e[g]=true;}else{if(e.hasOwnProperty(g)||j.hasOwnProperty(g))c=true;j[g]=true;}for(var n in a[g])if(d===0||(o.hasOwnProperty(n)&&o[n]==p-1))o[n]=p;}}for(var b in o)if(o[b]==p)f.push(b);if(c||p<h)f=this.filterQueryResults(r,f);return f;},getQueryCache:function(){return this.queryCache;},setMaxResults:function(a){this._maxResults=a;this.value&&this.respond(this.value,this.buildUids(this.value));},updateToken:function(a){this.token=a;this.dirty();return this;}});
function photos_viewer_version(){if(CSS.hasClass(document.documentElement,'theaterMode')){return PhotosConst.VIEWER_SNOWBOX;}else return PhotosConst.VIEWER_PERMALINK;}
function PhotoTagger(a){this.version=a;PhotoTagger.instances[a]=this;}PhotoTagger.instances={};PhotoTagger.ACTIVATE_TAGGING='PhotoTagger.ACTIVATE_TAGGING';PhotoTagger.getInstance=function(a){return PhotoTagger.instances[a];};copy_properties(PhotoTagger.prototype,{TAG_BOX_SIZE:100,datasources:{},photoData:{},elemNames:{1:{tagger:'div.theaterTagger',addTagLink:'div.fbPhotosTheaterActions',overlayActions:'div.fbPhotoTheaterButtons',tagAction:'fbPhotosTheaterActionsTag',image:'div.stage img'},2:{tagger:'div.snowboxTagger',addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons',tagAction:'fbPhotosPhotoActionsTag',image:'div.stage img'}},userActionData:{action:'tagging',namespace:'snowbox'},init:function(a,b){this.setupUserActionLogging();this.root=a;this.tokenizer=b;this._qn=null;this.typeahead=b.getTypeahead();this.clickState=DOM.find(this.root,'div.stageActions');this.tagger=DOM.find(this.clickState,this.elemNames[this.version].tagger);this.faceBox=DOM.find(this.tagger,'div.faceBox');this.newTagBox=DOM.find(this.clickState,'div.newTagBox');this.addTagLink=DOM.find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=DOM.find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());return this;},setupUserActionLogging:function(){this.ua=user_action(this.userActionData.action).set_namespace(this.userActionData.namespace).set_ua_id('tagging').add_event('init');},logUserActionEvent:function(a){this.ua.add_event(a);},fetchTaggingSuggestions:function(b){this.logUserActionEvent('sugg_fetch');new AsyncRequest().setURI('/ajax/photos/theater/tags_init.php').setData(b).setOption('retries',1).setHandler(function(c){this.typeahead.getView().setSuggestions(c.getPayload().taggees);this.logUserActionEvent('sugg_fetch_done');}.bind(this)).send();var a=this.typeahead.subscribe('activity',function(c,d){if(d&&!d.activity){this.updateWithSuggestions();this.typeahead.unsubscribe(a);this.typeahead.subscribe('focus',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(e,f){if(f&&!f.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));},setupHandlers:function(){this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(window,'resize',this.hideTagger.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];if(this.version==PhotosConst.VIEWER_THEATER){this.subscriptions=[Arbiter.subscribe(PhotoTheater.PAGE,this.restartTagging.bind(this)),Arbiter.subscribe(PhotoTheater.DATA_CHANGE,this.setPhotoData.bind(this)),Arbiter.subscribe(PhotoTheater.CLOSE,this.deactivateTagging.bind(this))];}else if(this.version==PhotosConst.VIEWER_SNOWBOX)this.subscriptions=[Arbiter.subscribe(PhotoSnowbox.PAGE,this.restartTagging.bind(this)),Arbiter.subscribe(PhotoSnowbox.DATA_CHANGE,this.setPhotoData.bind(this)),Arbiter.subscribe(PhotoSnowbox.CLOSE,this.deactivateTagging.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},getTaggingSource:function(){if(this.version==PhotosConst.VIEWER_SNOWBOX){return 'snowbox';}else if(this.version==PhotosConst.VIEWER_THEATER){return 'center_stage';}else return null;},updateWithSuggestions:function(a,c){var e=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!e.length)return;var d=this.typeahead.getData().respond('',e);for(var b=0;b<d.length;b++)d[b].index=-1000+b;},addSuggestion:function(a,b){var c=b.info&&b.info.uid;if(c)this.typeahead.getView().addSuggestion(c);},setQueueName:function(a){this._qn=a;return this;},_sendWaterfallLogSignal:function(a){PhotosTaggingWaterfall.sendSignal({qn:this._qn,source:this.getTaggingSource(),step:a,pid:this.photoData.pid});},_bumpQueueName:function(){if(this._qn)this._qn+=1;},activateTagging:function(){this.logUserActionEvent('activate');Arbiter.inform(PhotoTagger.ACTIVATE_TAGGING);if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new AsyncRequest('/ajax/photos/theater/fetch_datasource.php').setData({fbid:this.photoData.fbid,version:this.version}).send();},restartTagging:function(){this.hideNewTag();this.hideTagger();if(this.taggingMode===true)this.activateTagging();},getDataSource:function(){return this.datasources[this.getDataSourceKey()];},getDataSourceKey:function(){if(this.photoData.ownertype=='user'&&!this.photoData.obj_id)return 'friends';return this.photoData.obj_id||this.photoData.owner;},setDataSource:function(a){if(this.typeahead.getData()!=a)this.typeahead.swapData(a);this.datasources[this.getDataSourceKey()]=a;},dataSourceFetched:function(a){this.taggingMode=true;CSS.addClass(this.root,'taggingMode');this._bumpQueueName();this._sendWaterfallLogSignal(PhotosTaggingWaterfall.BEGIN);this.setDataSource(a);},deactivateTagging:function(){this.logUserActionEvent('deactivate');if(this.taggingMode===true)this._sendWaterfallLogSignal(PhotosTaggingWaterfall.FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();CSS.removeClass(this.root,'taggingMode');},checkActions:function(event){var a=event.getTarget();if(Parent.byClass(a,this.elemNames[this.version].tagAction))this.taggingMode?this.deactivateTagging():this.activateTagging();},hideTagger:function(){CSS.hide(this.tagger);},showTagger:function(){CSS.show(this.tagger);var a=DOM.find(this.tagger,'input.textInput');Input.reset(a);a.focus();this.updateWithSuggestions();this.hideNewTag();},showNewTag:function(a){if(!this.newTagBox)return;DOM.setContent(DOM.find(this.newTagBox,'div.tagName'),$N('span',null,a));CSS.show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);},hideNewTag:function(){if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}CSS.hide(this.newTagBox);},getTaggerPositioningOrigin:function(){return Vector2.getElementPosition(this.clickState,'document');},addTag:function(event){var d=event.getTarget();if(!this.taggingMode||Parent.byClass(d,'fbPhotosPhotoButtons')||Parent.byClass(d,'photoTagTypeahead'))return;var b=this.getPhotoOnStage();var a=Vector2.getEventPosition(event);var c=this.calcTaggerPosition(b,a);this.calcClickPoint(b,a);if(!c){this.hideTagger();return;}c.setElementPosition(this.tagger);if(this.newTagBox)c.setElementPosition(this.newTagBox);this.showTagger();this._sendWaterfallLogSignal(PhotosTaggingWaterfall.TAG_FACE);},getPhotoOnStage:function(){return DOM.find(this.root,this.elemNames[this.version].image);},calcTaggerPosition:function(h,b){var e=Vector2.getElementPosition(h);var d=Vector2.getElementDimensions(h);var a=new Vector2(this.TAG_BOX_SIZE/2,this.TAG_BOX_SIZE/2);var g=b.sub(e);for(var c in g){if(b[c]<e[c]||b[c]>e[c]+d[c])return null;if(g[c]<(this.TAG_BOX_SIZE/2)){a[c]=g[c];}else if(d[c]<g[c]+(this.TAG_BOX_SIZE/2))a[c]=this.TAG_BOX_SIZE-(d[c]-g[c]);}var f=b.sub(this.getTaggerPositioningOrigin());return f.sub(a.x,a.y);},calcClickPoint:function(d,b){var c=Vector2.getElementDimensions(d);var a=Vector2.getElementPosition(d);var e=b.sub(a);this.clickPoint={x:e.x/c.x,y:e.y/c.y};},saveTag:function(a,c){var b=this.getTaggingData('add',c.isFreeform()?'':c.getValue(),c.getText());b.x=this.clickPoint.x*100;b.y=this.clickPoint.y*100;this.logUserActionEvent('save');new AsyncRequest().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(b).setAllowCrossPageTransition(true).setHandler(function(d){this.tagsChangeHandler(d);this.logUserActionEvent('save_done');}.bind(this)).setErrorHandler(this.checkError.bind(this,c)).send();this.showNewTag(c.getText());this.hideTagger();},getTaggingData:function(a,c,b){return {cs_ver:this.version,pid:this.photoData.pid,id:this.photoData.owner,subject:c,name:b,action:a,source:this.getTaggingSource(),qn:this._qn,position:this.getPosition()};},getPosition:function(){var a=this.getPhotoViewerObj();return a&&a.position;},getPhotoViewerObj:function(){if(this.version==PhotosConst.VIEWER_THEATER){return window.PhotoTheater;}else if(this.version==PhotosConst.VIEWER_SNOWBOX)return window.PhotoSnowbox;return null;},tagsChangeHandler:function(b){var a=this.getPhotoViewerObj();if(a&&a.isOpen)a.saveTagComplete(b);},checkError:function(b,a){if(a.getPayload()&&a.getPayload().clear_tag){b.already_untagged=true;this.tokenizer.removeToken(b);}ErrorDialog.showAsyncError(a);},removeTag:function(a,c){if(c.already_untagged)return;var b='remove';if(DOM.scry(c.element,'a.pending')[0])b='retract';if(c.blockUser)b='remove_block';this.logUserActionEvent('save');new AsyncRequest().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(this.getTaggingData(b,c.isFreeform()?'':c.getInfo().uid,c.getInfo().text)).setHandler(function(d){this.tagsChangeHandler(d);this.logUserActionEvent('save_done');}.bind(this)).setAllowCrossPageTransition(true).send();},removeTagByID:function(b,c){var d=this.tokenizer.tokens;for(var a=0;a<d.length;a++)if(d[a].info.uid==c)return this.removeTag(null,d[a]);},setPhotoData:function(a,b){this.photoData=b;return this;},markTagAsSpam:function(a,b){new AsyncRequest().setURI('/ajax/photo_tagging_ajax.php').setMethod('POST').setData(this.getTaggingData('mark_as_spam',b,null)).send();}});
function PhotosUtils(){}PhotosUtils.getNearestBox=function(e,l,k,j,c,a){var f=e.sub(l);var d=k.magnitude();var g=null;for(var b in a){var h=a[b];var i=new Rect(h.t/100*k.y*j,h.r/100*k.x*j,h.b/100*k.y*j,h.l/100*k.x*j);var m=i.getCenter().sub(f);if(Math.abs(m.x)<=c&&Math.abs(m.y)<=c&&m.magnitude()<=d){d=m.magnitude();g=b;if(0===d)break;}}return g;};
function PhotoStreamCache(){}copy_properties(PhotoStreamCache,{ERROR:'error',HTML:'html',IMAGE_DATA:'image',EXTRA:'extra',BUFFER_SIZE:3,INIT_BUCKET_SIZE:4,FULL_BUCKET_SIZE:12,ERROR_ID:-1});copy_properties(PhotoStreamCache.prototype,{init:function(a){this.version=a;this.bufferSize=PhotoStreamCache.BUFFER_SIZE;this.initBucketSize=PhotoStreamCache.INIT_BUCKET_SIZE;this.fullBucketSize=PhotoStreamCache.FULL_BUCKET_SIZE;this.initError=false;this.isActive=true;this.leftLock=false;this.rightLock=false;this.reset();},reset:function(){this.cache={image:{},extra:{},html:{}};this.fbidList=[];this.loaded=false;this.allLoaded=false;this.permalinkMap={};this.position=0;this.totalCount=null;this.firstCursor=null;this.firstCursorIndex=null;},destroy:function(){this.reset();this.isActive=false;},isLoaded:function(){return this.loaded;},canPage:function(){if(this.totalCount!==null)return this.totalCount>1;return this.getLength()>1;},errorInCurrent:function(){if(this.initError){return true;}else if(!this.isLoaded())return false;return this.checkErrorAt(this.getCursor());},getLength:function(){return this.fbidList.length;},getPhotoSet:function(){return this.photoSetQuery.set;},getCurrentImageData:function(){return this.getImageData(this.getCursor());},getImageData:function(a){return this.getCacheContent(a,PhotoStreamCache.IMAGE_DATA);},getCurrentHtml:function(){return this.getCacheContent(this.getCursor(),PhotoStreamCache.HTML);},getCurrentExtraData:function(){return this.getCacheContent(this.getCursor(),PhotoStreamCache.EXTRA);},getCacheContent:function(a,b){if(!a||a===PhotoStreamCache.ERROR_ID)return null;return this.cache[b][a];},getCursorPos:function(){return this.position;},getCursor:function(){if(this.position>=0&&this.position<this.getLength())return this.fbidList[this.position];return null;},getCursorForURI:function(a){return this.permalinkMap[a];},calculatePositionForMovement:function(a){var b=this.position+a;if(this.allLoaded){var c=this.getLength();b=(c+b%c)%c;}return b;},isValidMovement:function(a){if(!this.isLoaded()||!this.canPage())return false;var b=this.calculatePositionForMovement(a);return this.getCursor()>0||(b>=0&&b<this.getLength());},moveCursor:function(a){if(!this.isValidMovement(a))return;this.position=this.calculatePositionForMovement(a);if(a!==0)this.loadMoreIfNeccessary(a>0);},checkErrorAt:function(a){if(!this.isLoaded())return false;if(a===PhotoStreamCache.ERROR_ID)return true;return false;},getRelativeMovement:function(a){for(var b=0;b<this.getLength();b++)if(this.fbidList[b]===a)return b-this.position;return null;},preloadImages:function(){var e,c;var f=this.getLength();var b=this.cache.image;var a=PhotoStreamCache.BUFFER_SIZE;if(f>a*2){e=(this.position+f-a%f)%f;c=(this.position+a)%f;}else{e=0;c=f-1;}while(e!=c){var d=this.fbidList[e];if(b[d]&&!b[d].resource&&b[d].url){b[d].resource=new Image();b[d].resource.src=b[d].url;}e=(e+1)%f;}},loadMoreIfNeccessary:function(c){if(this.allLoaded||(c&&this.rightLock)||(!c&&this.leftLock))return;var d=c?1:-1;var a=this.fullBucketSize*d;var b=this.position+this.bufferSize*d;if(b<0&&!this.checkErrorAt(this.getEndCursor(false))){this.leftLock=true;this.fetch(this.fullBucketSize,false);}else if(b>this.getLength()&&!this.checkErrorAt(this.getEndCursor(true))){this.rightLock=true;this.fetch(this.fullBucketSize,true);}},getEndCursor:function(a){return a?this.fbidList[this.getLength()-1]:this.fbidList[0];},calculateRelativeIndex:function(c,a,d){if(!this.totalCount)return null;var b=this.fbidList.indexOf(a);var e=this.fbidList.indexOf(d);if(b===-1||e===-1)return null;var f=e-b;return (c+f+this.totalCount)%this.totalCount;},fetch:function(a,d){var c=this.getEndCursor(d);var b=copy_properties({cursor:c,version:this.version,end:this.getEndCursor(!d),fetchSize:d?a:-1*a},this.photoSetQuery);if(this.totalCount&&this.firstCursorIndex!==null){b.total=this.totalCount;b.cursorIndex=this.calculateRelativeIndex(this.firstCursorIndex,this.firstCursor,c);}UIPagelet.loadFromEndpoint('PhotoViewerPagelet',null,b,{usePipe:true,jsNonblock:true,crossPage:true});},storeToCache:function(a){var b={};if(!this.isActive)return b;if('error' in a){this.processErrorResult(a.error);b.error=true;return b;}if('init' in a){this.processInitResult(a.init);b.init={logids:a.init.logids,fbid:a.init.fbid,loggedin:a.init.loggedin};}if('image' in a){this.processImageResult(a.image);b.image=true;}if('data' in a){this.processDataResult(a.data);b.data=true;}return b;},processInitResult:function(a){if(this.loaded)return;this.loaded=true;this.photoSetQuery=a.query;if(a.bufferSize)this.bufferSize=a.bufferSize;if(a.initBucketSize)this.initBucketSize=a.initBucketSize;if(a.fullBucketSize)this.fullBucketSize=a.fullBucketSize;this.fbidList.push(a.fbid);this.firstCursor=a.fbid;if('initIndex' in a&&'totalCount' in a){this.firstCursorIndex=a.initIndex;this.totalCount=a.totalCount;}this.rightLock=true;this.fetch(this.initBucketSize,true);},processImageResult:function(b){for(var a in b){this.cache.image[a]=b[a];if(b[a].dimensions)this.cache.image[a].dimensions=Vector2.deserialize(b[a].dimensions);this.permalinkMap[URI(b[a].info.permalink).getUnqualifiedURI().toString()]=a;}},attachToFbidsList:function(d,e,a){if(this.allLoaded)return;if(e===-1){for(var b=d.length-1;b>=0;b--){this.fbidList.unshift(d[b]);this.position++;}this.leftLock=false;}else{for(var c=0;c<d.length;c++)this.fbidList.push(d[c]);this.rightLock=false;}if(a)this.setAllLoaded();},setAllLoaded:function(){this.allLoaded=true;if(this.getCursor()===null)this.position=this.calculatePositionForMovement(0);},processDataResult:function(a){for(var b in a){if(!this.cache.html[b])this.cache.html[b]={};for(var d in a[b].html){var c=HTML(a[b].html[d]).getRootNode();this.cache.html[b][d]=$A(c.childNodes);}if(!('extra' in a[b])){this.cache.extra[b]=null;continue;}this.cache.extra[b]={tagRects:{}};if(a[b].extra.tagRects)for(var e in a[b].extra.tagRects)if(a[b].extra.tagRects[e])this.cache.extra[b].tagRects[e]=Rect.deserialize(a[b].extra.tagRects[e]);}},processErrorResult:function(b){if(!this.isLoaded()){this.initError=true;return;}var c=b.side;var a=[PhotoStreamCache.ERROR_ID];this.attachToFbidsList(a,c);},setTotalCount:function(a){this.totalCount=a;},setFirstCursorIndex:function(a){this.firstCursorIndex=a;}});
function PhotoInlineEditor(a){this.version=a;PhotoInlineEditor.instances[a]=this;}PhotoInlineEditor.CANCEL_INLINE_EDITING='CANCEL_INLINE_EDITING';PhotoInlineEditor.instances={};PhotoInlineEditor.getInstance=function(a){return PhotoInlineEditor.instances[a];};copy_properties(PhotoInlineEditor.prototype,{cancel:function(a){var b=Parent.byClass(a,'photoUfiContainer');if(!b)return;this.setVisible(b,'.fbPhotosPhotoCaption',true);this.setVisible(b,'.fbPhotoTagList',true);this.setVisible(b,'.fbPhotosPhotoEdit',true);this.setVisible(b,'.fbPhotosPhotoDisabledEdit',false);this.setVisible(b,'.fbPhotoInlineEditor',false);Arbiter.unsubscribe(this.arbiterToken);Arbiter.inform(PhotoInlineEditor.CANCEL_INLINE_EDITING);},setVisible:function(c,a,d){var b=DOM.scry(c,a)[0];b&&CSS[d?'show':'hide'](b);},subscribeCancel:function(a){var b=[PhotoSnowbox.PAGE,PhotoSnowbox.CLOSE,PhotoSnowbox.OPEN,PhotoTagger.ACTIVATE_TAGGING];this.arbiterToken=Arbiter.subscribe(b,this.cancel.bind(this,a),Arbiter.SUBSCRIBE_NEW);}});
var PhotoSnowbox=window.PhotoSnowbox||{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',CLOSE:'PhotoSnowbox.CLOSE',DATA_CHANGE:'PhotoSnowbox.DATA_CHANGE',GO:'PhotoSnowbox.GO',OPEN:'PhotoSnowbox.OPEN',PAGE:'PhotoSnowbox.PAGE',RESET_HELP:'PhotoSnowbox.RESET_HELP',LOADING_TIMEOUT:2000,STAGE_MAX:{x:960,y:960},STAGE_MIN:{x:720,y:402},STAGE_CHROME:{x:225,y:117},WIDE_ADS:855,MIN_TAG_DISTANCE:83,ADS_REFRESH_RATE:30000,switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,normalSize:null,thumbSrc:null,ua:new UserNoOp(),bootstrap:function(b,a){this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=user_action('snowbox',a,null).set_namespace('snowbox').set_ua_id('open');this.returningToStart=false;this.loading&&CSS.removeClass(this.loading,'loading');if(a){CSS.addClass((this.loading=a),'loading');this.getThumbAndSize(a);}else this.loading=null;Arbiter.inform(PhotoSnowbox.GO,b,Arbiter.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getThumbAndSize:function(b){this.normalSize=null;this.thumbSrc=null;var e=URI(b.getAttribute('ajaxify')).getQueryData();if(!e.size)return;var a=Vector2.deserialize(e.size);if(!a.x||!a.y)return;this.normalSize=a;if(!CSS.hasClass(b,'uiMediaThumb')&&!CSS.hasClass(b,'uiPhotoThumb')&&!CSS.hasClass(b,'uiScaledThumb'))return;var d=DOM.scry(b,'img')[0];var c=DOM.scry(b,'i')[0];if(d){thumbSrc=d.src;}else if(c){thumbSrc=CSS.getStyle(c,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=thumbSrc;},loadFrameIfUninitialized:function(){if(this.root)return;new AsyncRequest('/ajax/photos/snowbox/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(a){var b=ge('fbPhotoSnowbox');if(!b){b=DOM.appendContent(document.body,a)[0];this.initialLoad=false;}if(this.root==b)return;this.initializeNodes(b);if(!this.subscription){LinkController.registerHandler(this.handleNavigateAway.bind(this));this.subscription=Arbiter.subscribe(PhotoSnowbox.GO,function(c,d){this.openExplicitly=true;this.loading&&CSS.removeClass(this.loading,'loading');this.open(d);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;PageTransitions.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;},initializeNodes:function(a){this.root=a;this.closeTheater=DOM.find(a,'a.closeTheater');this.container=DOM.find(a,'div.container');this.infoWrapper=DOM.find(a,'div.photoInfoWrapper');this.stageWrapper=DOM.find(a,'div.stageWrapper');this.errorBox=DOM.find(this.stageWrapper,'div.stageError');this.image=DOM.find(this.stageWrapper,'img.spotlight');this.pivotBar=DOM.find(this.stageWrapper,'div.pivotWrapper');this.stage=DOM.find(this.stageWrapper,'div.stage');this.videoStage=DOM.find(this.stageWrapper,'div.videoStage');this.stagePagers=DOM.find(a,'div.stagePagers');this.stageActions=DOM.find(a,'div.stageActions');this.buttonActions=DOM.find(this.stageActions,'div.fbPhotosPhotoButtons');this.actionList=$('fbPhotoSnowboxActions');this.sideAdUnit=$('fbPhotoSnowboxAdsSide');this.bottomAdUnit=$('fbPhotoSnowboxAdsBottom');},getRoot:function(){return this.root;},openHandler:function(a){if(this.isOpen||a.getPath()!='/photo.php'||this.returningToStart||a.getQueryData().closeTheater||a.getQueryData().permPage||a.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(a);this._uriStack.push(URI(a).getQualifiedURI().toString());PageTransitions.transitionComplete();return true;},open:function(c){var a=URI(c).getQueryData();var b=a.src;if(b)delete a.src;if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){a.firstLoad=true;this.initialLoad=true;}this.loadQuery=a;this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.lastAdsLoad=0;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.stream=new PhotoStreamCache();this.stream.init(PhotosConst.VIEWER_SNOWBOX);this.fetchInitialData();this.setLoadingState(PhotoSnowbox.STATE_HTML,true);KeyEventController.registerKey('ESCAPE',this.closeListener.bind(this));Bootloader.loadComponents(['fb-photos-photo-css','fb-photos-snowbox-css'],function(){this._open(c,b);}.bind(this));},_open:function(d,c){this.createLoader(c);CSS.show(this.root);(function(){var e=Vector2.getScrollPosition();CSS.addClass(document.documentElement,'theaterMode');CSS.addClass(document.body,'chatFixNoOp');DOMScroll.scrollTo(e,0);}).defer();this.ua.add_event('frame');Arbiter.inform('layer_shown',{type:'PhotoSnowbox'});Arbiter.inform(PhotoSnowbox.OPEN);Bootloader.loadComponents(['hovercard','live-js','photocrop2','PhotoTag','PhotoTagger','TagToken','TagTokenizer','ui-ufi-css']);this.stageHandlers=[Event.listen(window,'resize',this.adjustForResize.bind(this)),Event.listen(this.root,'click',this.closeListener.bind(this)),Event.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this))];var a=ge('fbPhotoSnowboxFeedback');if(a)this.stageHandlers.push(Event.listen(a,'click',function(event){if(Parent.byClass(event.getTarget(),'like_link'))CSS.toggleClass(DOM.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this)));var b=ge('fbPhotoSnowboxOnProfile');if(b)this.stageHandlers.push(Event.listen(b,'click',function(event){if(Parent.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!c)this.setLoadingState(PhotoSnowbox.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){PageTransitions.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}PhotoSessionLog.initLogging(PhotoSessionLog.SNOWBOX);ua.firefox()&&this.turnFlashAutoplayOff.defer();(function(){this.adjustForResize();if(ua.ie()){this.container.focus();}else this.root.focus();}).bind(this).defer();},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua.add_event('init_data');new AsyncRequest('/ajax/photos/snowbox/load.php').setAllowCrossPageTransition(true).setData(this.loadQuery).setHandler(this.storeFromResponse.bind(this)).setMethod('GET').setReadOnly(true).send();},turnFlashAutoplayOff:function(){DOM.scry(document,'div.swfObject').each(function(d){var b=d.getAttribute('data-swfid');if(b&&window[b]){var c=window[b];c.addParam('autostart','false');c.addParam('autoplay','false');c.addParam('play','false');c.addVariable('video_autoplay','0');c.addVariable('autoplay','0');c.addVariable('play','0');var a=URI(c.getAttribute('swf'));a.addQueryData({autoplay:'0'});a.setPath(a.getPath().replace('autoplay=1','autoplay=0'));c.setAttribute('swf',a.toString());c.write(d);}});},closeHandler:function(){if(!this.isOpen)return;if(URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.close();this.returnToStartingURI(this.refreshOnClose);},returnToStartingURI:function(d,b){if(!d)if(b){this.squashNextTransition(goURI.curry(b));}else this.squashNextTransition();this.returningToStart=true;var e=Arbiter.subscribe('page_transition',function(){this.returningToStart=false;Arbiter.unsubscribe(e);});var a=d||isNaN(ua.opera());var g=this._uriStack.length;if(a&&g<window.history.length){window.history.go(-g);}else{var f=PhotoSnowbox.startingURI;var c=new URI(f).removeQueryData('closeTheater');if(f.getQueryData().sk=='approve'&&f.getPath()=='/profile.php'){c.removeQueryData('highlight');c.removeQueryData('notif_t');}goURI(c);}},squashNextTransition:function(a){PhotoSnowbox.squashNext=true;PageTransitions.registerHandler(function _squash(){if(PhotoSnowbox.squashNext){PhotoSnowbox.squashNext=false;if(a)a.defer();PageTransitions.transitionComplete();return true;}return false;});},handleNavigateAway:function(b){var a=_computeRelativeURI(window.PageTransitions._most_recent_uri.getQualifiedURI(),b.getAttribute('href'));if(this.isOpen&&(a instanceof URI)&&a.getUnqualifiedURI().toString()!=this.startingURI.toString()&&a.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=PhotoSessionLog.NAVIGATE;this.close();this.returnToStartingURI(false,a);return false;}return true;},closeListener:function(event){if(this.isOpen&&!(window.Dialog&&Dialog.getCurrent())){var c=event.getTarget();var a=Parent.byClass(c,'closeTheater');var b=(a||c==this.root||c==this.infoWrapper);if(b){if(a){this.closingAction=PhotoSessionLog.X;}else this.closingAction=PhotoSessionLog.OUTSIDE;Event.kill(event);this.closeHandler();}else if(Event.getKeyCode(event)==KEYS.ESC){this.closingAction=PhotoSessionLog.ESC;Event.kill(event);this.closeHandler();}}},close:function(){if(!this.isOpen)return;CSS.hide(this.root);this.openExplicitly=false;this.closeCleanup.bind(this).defer();},closeCleanup:function(){var b=Vector2.getScrollPosition();CSS.removeClass(document.documentElement,'theaterMode');CSS.removeClass(document.body,'chatFixNoOp');CSS.removeClass(this.root,'dataLoaded');DOMScroll.scrollTo(b,0);KeyEventController.getInstance().resetHandlers();PhotoSessionLog.logPhotoViews(this.closingAction);this.destroy();CSS.hide(this.errorBox);CSS.hide(this.image);this.normalSize=null;this.thumbSrc=null;CSS.removeClass(this.stageWrapper,'showVideo');DOM.empty(this.videoStage);this.currentMinSize=null;this.pinPagers=false;CSS.removeClass(this.stagePagers,'pagingReady');this.recacheData();DOM.empty(this.sideAdUnit);DOM.empty(this.bottomAdUnit);this.stream.destroy();var a=this.closingAction===PhotoSessionLog.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){PageTransitions.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}Arbiter.inform('layer_hidden',{type:'PhotoSnowbox'});Arbiter.inform(PhotoSnowbox.CLOSE,a);this.root.setAttribute('aria-busy','true');this.isOpen=false;},createLoader:function(b){if(this.thumbSrc!==null&&this.normalSize!==null){var a=this.getMaxImageSize(this.normalSize);this.useImage($N('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:a.x+'px',height:a.y+'px'}}),a,false);}this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(b)(function(){var c=new Image();c.onload=async_callback(function(){if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(b,this.normalSize);this.ua.add_event('image');}}.bind(this),'photo_theater');c.src=b;}).bind(this).defer();CSS.hide(this.stageActions);CSS.addClass(this.stagePagers,'pagingDisabled');},initDataFetched:function(a){PhotoSessionLog.setPhotoSet(this.stream.getPhotoSet());PhotoSessionLog.setLogFbids(a.logids);PhotoSessionLog.addPhotoView(this.stream.getCurrentImageData().info);this.position=this.stream.getCursor();var b={click:this.pageListener.bind(this),mouseleave:this.mouseLeaveListener.bind(this),mousemove:this.mouseMoveListener.bind(this)};if(!this.pageHandlers){this.pageHandlers=values(Event.listen(this.root,b));KeyEventController.registerKey('LEFT',this.pageListener.bind(this));KeyEventController.registerKey('RIGHT',this.pageListener.bind(this));}CSS.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=a.loggedin;this.loadAds();},adjustForResize:function(){this.currentMinSize=null;this.pinPagers=false;this.adjustStageSize();this.adjustForNewData();},getMaxImageSize:function(c){var f=Vector2.getViewportDimensions();var e=f.sub(new Vector2(PhotoSnowbox.STAGE_CHROME.x,PhotoSnowbox.STAGE_CHROME.y));var a=new Vector2(Math.min(c.x,e.x,PhotoSnowbox.STAGE_MAX.x),Math.min(c.y,e.y,PhotoSnowbox.STAGE_MAX.y));if(a.x===0&&a.y===0)return new Vector2(0,0);var d=c.x/c.y;var b=a.x/a.y;if(b<d)return new Vector2(a.x,Math.round(a.x/d));return new Vector2(Math.round(a.y*d),a.y);},adjustStageSize:function(c){var a;var b=this.stream&&this.stream.getCurrentImageData();if(c){a=c;}else if(b&&b.dimensions){a=b.dimensions;}else if(this.image&&this.image.src&&image_has_loaded(this.image)){a=Vector2.getElementDimensions(this.image);}else return;var d=this.getMaxImageSize(a);if(!this.currentMinSize){this.currentMinSize=new Vector2(Math.max(d.x,PhotoSnowbox.STAGE_MIN.x),Math.max(d.y,PhotoSnowbox.STAGE_MIN.y));}else this.currentMinSize=new Vector2(Math.max(d.x,this.currentMinSize.x),Math.max(d.y,PhotoSnowbox.STAGE_MIN.y));CSS.setStyle(this.container,'width',this.currentMinSize.x+'px');CSS.setStyle(this.stageWrapper,'height',this.currentMinSize.y+'px');CSS.setStyle(this.stage,'lineHeight',this.currentMinSize.y+'px');CSS.setStyle(this.videoStage,'lineHeight',this.currentMinSize.y+'px');CSS.conditionClass(this.container,'adsOnSide',this.currentMinSize.x>=PhotoSnowbox.WIDE_ADS);this.adjustForAdUnit();if(!this.pinPagers)CSS.setStyle(this.stagePagers,'height',this.currentMinSize.y/2+'px');this.pinPagers=true;},adjustForNewData:function(){if(!this.image)return;var c=DOM.scry(this.stage,'div.tagsWrapper')[0];var a=Vector2.getElementDimensions(this.image);if(c){CSS.setStyle(c,'width',a.x+'px');CSS.setStyle(c,'height',a.y+'px');if(ua.ie()<=7){var b=DOM.scry(this.root,'div.tagContainer')[0];if(b)CSS.conditionClass(c,'ie7VerticalFix',Vector2.getElementDimensions(b).y>a.y);}}},setLoadingState:function(b,a){switch(b){case PhotoSnowbox.STATE_IMAGE_PIXELS:CSS.conditionClass(this.root,'imagePixelsLoading',a);break;case PhotoSnowbox.STATE_IMAGE_DATA:this.loadingStates[b]=a;CSS.conditionClass(this.root,'imageLoading',a);break;case PhotoSnowbox.STATE_HTML:this.loadingStates[b]=a;CSS.conditionClass(this.root,'dataLoading',a);CSS.conditionClass(this.root,'dataLoaded',!a);this.infoWrapper.setAttribute('aria-busy',a?'true':'false');break;}},destroy:function(){this.stageHandlers.each(function(a){a.remove();});if(this.pageHandlers){this.pageHandlers.each(function(a){a.remove();});this.pageHandlers=null;}},checkState:function(b){if(b!=PhotoSnowbox.STATE_ERROR&&!this.loadingStates[b])return;switch(b){case PhotoSnowbox.STATE_IMAGE_DATA:var a=this.stream.getCurrentImageData();if(a){if(a.url){this.switchImage(a.url,null,true);}else if(a.video)this.switchVideo(a.video,true);this.setLoadingState(b,false);}break;case PhotoSnowbox.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(b,false);}break;default:if(this.stream.errorInCurrent()){CSS.hide(this.image);CSS.show(this.errorBox);}break;}},buttonListener:function(event){var b=event.getTarget();var a=Date.now();if(a-this.lastPage<350){if(Parent.byClass(b,'tagApproveIgnore'))Event.kill(event);return;}if(Parent.byClass(b,'likeButton')){DOM.find($('fbPhotoSnowboxFeedback'),'button.like_link').click();}else if(Parent.byClass(b,'commentButton')){DOM.find(this.root,'div.commentBox textarea').focus();this.root.scrollTop=this.root.scrollHeight;}else if(Parent.byClass(b,'tagApproveIgnore'))this.updateTagBox(event,b);},rotateListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'rotateRight')){this.rotate('right');}else if(Parent.byClass(a,'rotateLeft'))this.rotate('left');},updateTagBox:function(event,c){var a;if(Parent.byClass(c,'approveTag')){a=true;}else if(Parent.byClass(c,'ignoreTag')){a=false;}else return;this.unhiliteAllTags();var b=Parent.byClass(c,'tagBoxPending');CSS.addClass(b,'tagBox tagBoxPendingResponse');CSS.removeClass(b,'tagBoxPending');CSS.hide(DOM.find(b,'span.tagForm'));if(a){CSS.show(DOM.find(b,'span.tagApproved'));}else CSS.show(DOM.find(b,'span.tagIgnored'));},rotate:function(c){var d=this.stream.getCursor();if(this.getVideoOnStage()){var b=(c=='left')?270:90;Bootloader.loadComponents(['video-rotate-snowbox'],new VideoRotate(d,this.actionList).motionRotate(b));return;}var a={fbid:d,cs_ver:PhotosConst.VIEWER_SNOWBOX};a[c]=1;this.setLoadingState(PhotoSnowbox.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);CSS.hide(this.image);new AsyncRequest('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(a).setErrorHandler(this.rotationError.bind(this,d)).setHandler(this.rotationComplete.bind(this,d)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(a,b){this.storeResponseForRotate(a,b);if(a==this.stream.getCursor()){this.setLoadingState(PhotoSnowbox.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}this.refreshOnClose=true;},storeResponseForRotate:function(a,c){this.storeFromResponse(c);var b=this.stream.getImageData(a);b.url=c.getPayload().new_urls[PhotosConst.SIZE_NORMAL];b.dimensions=Vector2.deserialize(c.getPayload().dimensions);},rotationError:function(a,b){if(a==this.stream.getCursor()){this.setLoadingState(PhotoSnowbox.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);AsyncResponse.defaultErrorHandler(b);}},saveTagComplete:function(a){this.saveTagsFromPayload(a.getPayload());},saveTagsFromPayload:function(a){this.refreshOnClose=true;this.storeFromData(a);if('data' in a&&this.stream.getCursor() in a.data)this.swapData();},mouseLeaveListener:function(event){this.unhiliteAllTags();this.hiliteLeftmostPendingTag();},mouseMoveListener:function(event){var b=event.getTarget();var a=(Parent.byClass(b,'stageActions')||Parent.byClass(b,'stageWrapper'));if(!a)CSS.hide(this.pivotBar);if(this.hasPivotData()&&!this.loadingStates.html)CSS.show(this.pivotBar);this.hiliteTagsOnMouseMove(event);},hasPivotData:function(){var a=this.stream.getCurrentHtml();return a&&a.fbPhotoSnowboxPivots;},unhiliteAllTags:function(){DOM.scry(this.stage,'div.tagsWrapper div.hover').each(function(a){CSS.removeClass(a,'hover');});this.hilitedTag=null;},switchHilitedTags:function(b){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}var a=ge(this.hilitedTag);a&&CSS.removeClass(a,'hover');this.unhiliteAllTags();if(b){this.hilitedTag=b;CSS.addClass($(this.hilitedTag),'hover');}},hiliteLeftmostPendingTag:function(){var a=ge(this.hilitedTag);if(a&&CSS.hasClass(a,'tagBoxPending'))return;var b=DOM.scry(this.stage,'div.tagsWrapper div.tagBoxPending')[0];if(b)this.switchHilitedTags(b.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var i=Parent.byClass(event.getTarget(),'tagBoxPending');var d=(this.hilitedTag&&CSS.hasClass($(this.hilitedTag),'tagBoxPending'));var l=((!this.hilitedTag&&i)||(!d&&i));if(l){this.switchHilitedTags(i.id);return;}if(i&&(i.id==this.hilitedTag))return;var a=250;var h=Vector2.getEventPosition(event);var f=Vector2.getElementPosition(this.image);var e=Vector2.getElementDimensions(this.image);var j=this.stream.getCurrentImageData().dimensions;var k=e.x/j.x;var g=PhotosUtils.getNearestBox(h,f,j,k,PhotoSnowbox.MIN_TAG_DISTANCE*k,this.stream.getCurrentExtraData().tagRects);if(!g){if(!d){this.unhiliteAllTags();this.hiliteLeftmostPendingTag();}return;}var b=null;if(d){var c={};c[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];b=PhotosUtils.getNearestBox(h,f,j,k,PhotoSnowbox.MIN_TAG_DISTANCE*k,c);}if(b!==null&&d)return;if(this.hilitedTag!=g)if(d){this.switchTimer=this.switchHilitedTags.bind(this,g).defer(a);}else this.switchHilitedTags(g);},getVideoOnStage:function(){var a=this.stream&&this.stream.getCurrentImageData();return a&&a.video;},shouldGoForward:function(a,c){var d=(a==KEYS.RIGHT||Parent.byClass(c,'next'));if(d)return true;var b=(this.getVideoOnStage()||CSS.hasClass(this.root,'taggingMode')||Parent.byClass(c,'tagBoxPending')||Parent.byClass(c,'tagBoxPendingResponse'));if(b)return false;return DOM.isNode(c)&&Parent.byClass(c,'stage');},pageListener:function(event){var a=Event.getKeyCode(event);var b=event.getTarget();if(a==KEYS.LEFT||Parent.byClass(b,'prev')){this.page(-1);user_action('a',b,event);return;}if(this.shouldGoForward(a,b)){this.page(1);user_action('a',b,event);}},page:function(c,b){if(!this.stream.isValidMovement(c))return;this.lastPage=Date.now();this.unhiliteAllTags();var d=this.getVideoOnStage();if(d)this.switchVideo(d,false);Arbiter.inform(PhotoSnowbox.PAGE);this.recacheData();this.stream.moveCursor(c);CSS.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(PhotoSnowbox.STATE_HTML,true);CSS.show(this.errorBox);return;}var a=this.stream.getCurrentImageData();if(a){if(a.url){this.switchImage(a.url,null,true);}else if(a.video)this.switchVideo(a.video,true);if(!b){this.replaceUrl=true;goURI(a.info.permalink);}}else{this.setLoadingState(PhotoSnowbox.STATE_IMAGE_PIXELS,true);this.setLoadingState(PhotoSnowbox.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(PhotoSnowbox.STATE_HTML,true);this.hiliteLeftmostPendingTag();this.loadAds();},loadAds:function(){if(!this.isLoggedInViewer)return;var a=Date.now();if(a-this.lastAdsLoad>PhotoSnowbox.ADS_REFRESH_RATE){UIPagelet.loadFromEndpoint('WebEgoPane','fbPhotoSnowboxAdsSide',{pid:34,data:[]},{crossPage:true});this.lastAdsLoad=a;}},adjustForAdUnit:function(){var b=this.sideAdUnit.childNodes;var a=this.bottomAdUnit.childNodes;if(CSS.hasClass(this.container,'adsOnSide')){if(a.length>0&&b.length===0)DOM.setContent(this.sideAdUnit,$A(a));DOM.empty(this.bottomAdUnit);}else if(b.length>0){DOM.setContent(this.bottomAdUnit,$A(b));DOM.empty(this.sideAdUnit);}},transitionHandler:function(c){if(c.getQueryData().closeTheater||c.getQueryData().permPage||c.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(c.getQualifiedURI().toString());PageTransitions.transitionComplete();return true;}var d=this._uriStack.length;if(d>=2&&this._uriStack[d-2]==c.getQualifiedURI().toString())this._uriStack.pop();var a=this.stream.getCursorForURI(c.getUnqualifiedURI().toString());if(a){var b=this.stream.getRelativeMovement(a);this.page(b,true);PageTransitions.transitionComplete();return true;}if(this.isOpen){this.close();PageTransitions.transitionComplete();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var a=this.stream.getCurrentHtml();for(var b in a){a[b]=$A($(b).childNodes);DOM.empty($(b));}}},reloadIfTimeout:function(){if(!image_has_loaded(this.image)){var a=this.makeNewImage(this.image.src,true);Event.listen(a,'load',this.useImage.bind(this,a,null,true));}},useImage:function(c,a,b){if(b&&image_has_loaded(this.image))return;DOM.replace(this.image,c);this.image=c;this.adjustStageSize(a);},makeNewImage:function(c,a){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!a)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),PhotoSnowbox.LOADING_TIMEOUT);var b=$N('img',{className:'spotlight',alt:''});b.setAttribute('aria-describedby','fbPhotosSnowboxCaption');b.setAttribute('aria-busy','true');Event.listen(b,'load',async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){this.adjustStageSize();this.adjustForNewData();}).bind(this).defer();}.bind(this),'photo_theater'));b.src=c;return b;},switchImage:function(d,b,c){CSS.hide(this.image);CSS.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var a=this.stream&&this.stream.getCurrentImageData();if(a)PhotoSessionLog.addPhotoView(a.info);this.useImage(this.makeNewImage(d,false),b,false);if(c)this.stream.preloadImages();},switchVideo:function(c,a){var b='swf_'+c;if(a){CSS.addClass(this.stageWrapper,'showVideo');this.videoStage.id=c;if(window[b]&&!ge(b))window[b].write(c);this.adjustStageSizeForVideo.bind(this,b).defer();}else{this.videoStage.id='fbVideoStage';window[b]&&window[b].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);DOM.empty(this.videoStage);CSS.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(a){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);video=this.getVideoOnStage();if(!video){return;}else{currentSwfID='swf_'+video;if(a!==currentSwfID)return;this.adjustStageSizeForVideo(a);}},adjustStageSizeForVideo:function(a){var b=ge(a);if(!b){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,a),200);}else this.adjustStageSize(new Vector2(b.width,b.height));},setErrorBoxContent:function(a){DOM.setContent(this.errorBox,a);},swapData:function(){var b,c=this.stream.getCurrentHtml();if(c){this.setLoadingState(PhotoSnowbox.STATE_HTML,false);for(var d in c){b=ge(d);b&&DOM.setContent(b,c[d]);}var e=DOM.scry(this.root,'div.fbVideoTagApproval')[0];if(e&&e.children.length===0)CSS.hide(e);var a=DOM.scry($('fbPhotoSnowboxCaption'),'div.fbPhotoInlineCaptionEditor');if(a.length)new PhotoInlineCaptionEditor('snowbox').init(a[0]);Arbiter.inform(PhotoSnowbox.DATA_CHANGE,this.stream.getCurrentImageData().info,Arbiter.BEHAVIOR_STATE);this.position=this.stream.getCursor();if(ge(this.hilitedTag)){CSS.addClass($(this.hilitedTag),'hover');}else this.hiliteLeftmostPendingTag();}this.adjustForNewData();},updateTotalCount:function(c,b,a){element=ge('fbPhotoSnowboxPositionAndCount');element&&DOM.setContent(element,a);this.stream.setTotalCount(c);this.stream.setFirstCursorIndex(b);},addPhotoFbids:function(b,c,a){var d=this.stream.getCursor()===null;this.stream.attachToFbidsList(b,c,a);if(a&&d)this.page(0,true);if(!this.pagersShown&&this.stream.canPage())this.setStagePagersReady();},storeFromResponse:function(a){window.ArbiterMonitor&&ArbiterMonitor.stopTtiMeasurement();this.storeFromData(a.getPayload());},storeFromData:function(a){if(!this.isOpen)return;var b=this.stream.storeToCache(a);if('error' in b){this.checkState(PhotoSnowbox.STATE_ERROR);return;}if('init' in b){this.initDataFetched(b.init);if(this.openExplicitly){this.replaceUrl=true;goURI(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersReady();this.ua.add_event('ufi');}if('image' in b)this.checkState(PhotoSnowbox.STATE_IMAGE_DATA);if('data' in b)this.checkState(PhotoSnowbox.STATE_HTML);},setStagePagersReady:function(){CSS.removeClass(this.stagePagers,'pagingDisabled');CSS.addClass(this.stagePagers,'pagingReady');this.pagersShown=true;this.ua.add_event('arrows');},deletePhoto:function(a){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();}};
var TooltipLink={setTooltipText:function(a,b){a=Parent.byClass(a,'uiTooltip');if(a)DOM.setContent(DOM.find(a,'span.uiTooltipText'),b);}};
var Selector=function(){var a;var i=false;function b(k){return Parent.byClass(k,'uiSelector');}function c(k){return Parent.byClass(k,'uiSelectorButton');}function e(k){return DOM.scry(k,'select')[0];}function d(k){return DOM.find(k,'div.uiSelectorMenuWrapper');}function f(){f=bagofholding;Menu.subscribe('select',function(k,m){if(!a||!m||m.menu!==Selector.getSelectorMenu(a))return;var n=g(a);var p=h(m.item);if(p){var l=a;var o=Selector.isOptionSelected(m.item);var q=Selector.inform('select',{selector:l,option:m.item});if(q===false)return;if(n||!o){Selector.setSelected(l,Selector.getOptionValue(m.item),!o);Selector.inform('toggle',{selector:l,option:m.item});Selector.inform('change',{selector:l});Arbiter.inform('Form/change',{node:l});if(j(l))DataStore.set(l,'dirty',true);}}if(!n||!p)a&&Selector.toggle(a);});}function g(k){return !!k.getAttribute('data-multiple');}function h(k){return CSS.hasClass(k,'uiSelectorOption');}function j(k){return !!k.getAttribute('data-autosubmit');}onloadRegister(function(){var k={};k.keydown=function(event){var m=event.getTarget();if(DOM.isNodeOfType(m,['input','textarea']))return;switch(Event.getKeyCode(event)){case KEYS.DOWN:case KEYS.SPACE:case KEYS.UP:i=true;if(c(m)){var l=b(m);Selector.toggle(l);return false;}break;case KEYS.ESC:i=true;if(a){Selector.toggle(a);return false;}break;case KEYS.RETURN:i=true;break;}};k.keyup=function(){!function(){i=false;}.defer();};Event.listen(document.body,k);Toggler.subscribe(['show','hide'],function(s,r){var o=b(r.getActive());if(o){f();var l=Selector.getSelectorButton(o);var m=Selector.getSelectorMenu(o);var p=s==='show';if(p){a=o;if(CSS.hasClass(l,'uiButtonDisabled')){Selector.setEnabled(o,false);return false;}m=m||Selector.loadMenu(o);if(m){Menu.register(m);if(i){var n=Menu.getCheckedItems(m);if(!n.length)n=Menu.getEnabledItems(m);Menu.focusItem(n[0]);}}}else{a=null;m&&Menu.unregister(m);i&&l.focus();if(j(o)&&DataStore.get(o,'dirty')){var q=DOM.scry(o,'input.submitButton')[0];q&&q.click();DataStore.remove(o,'dirty');}}CSS.conditionClass(Selector.getSelectorButton(o),'selected',p);Selector.inform(p?'open':'close',{selector:o});}});});return copy_properties(new Arbiter(),{attachMenu:function(o,k,m){o=b(o);if(o){a&&Menu.unregister(Selector.getSelectorMenu(a));DOM.setContent(d(o),k);a&&Menu.register(Selector.getSelectorMenu(o));if(m){var l=o.getAttribute('data-name');l&&m.setAttribute('name',l);if(!g(o))m.setAttribute('multiple',false);var n=e(o);if(n){DOM.replace(n,m);}else DOM.insertAfter(o.firstChild,m);}return true;}},getOption:function(m,n){var l=Selector.getOptions(m),k=l.length;while(k--)if(n===Selector.getOptionValue(l[k]))return l[k];return null;},getOptions:function(l){var k=Menu.getItems(Selector.getSelectorMenu(l));return k.filter(h);},getEnabledOptions:function(l){var k=Menu.getEnabledItems(Selector.getSelectorMenu(l));return k.filter(h);},getSelectedOptions:function(k){return Menu.getCheckedItems(Selector.getSelectorMenu(k));},getOptionText:function(k){return Menu.getItemLabel(k);},getOptionValue:function(l){var n=b(l);var m=e(n);var k=Selector.getOptions(n).indexOf(l);return k>=0?m.options[k+1].value:'';},getSelectorButton:function(k){return DOM.find(k,'a.uiSelectorButton');},getSelectorMenu:function(k){return DOM.scry(k,'div.uiSelectorMenu')[0];},getValue:function(o){var m=e(o);if(!m)return null;if(!g(o))return m.value;var p=[];var l=m.options;for(var k=1,n=l.length;k<n;k++)if(l[k].selected)p.push(l[k].value);return p;},isOptionSelected:function(k){return Menu.isItemChecked(k);},listen:function(l,m,k){return this.subscribe(m,function(o,n){if(n.selector===l)return k(n,o);});},loadMenu:function(n){var m=Selector.getSelectorMenu(n);if(!m){var l=Selector.getSelectorButton(n);var k=l.getAttribute('ajaxify');if(k){var o=HTML('<div class="uiSelectorMenuWrapper uiToggleFlyout">'+'<div class="uiMenu uiSelectorMenu loading">'+'<ul class="uiMenuInner">'+'<li><span></span></li>'+'</ul>'+'</div>'+'</div>');DOM.appendContent(l.parentNode,o);Bootloader.loadComponents('async',function(){AsyncRequest.bootstrap(k,l);});m=Selector.getSelectorMenu(n);l.removeAttribute('onmouseover');}}return m;},setButtonLabel:function(n,l){var k=Selector.getSelectorButton(n);var m=parseInt(k.getAttribute('data-length'),10);l=l||k.getAttribute('data-label')||'';Button.setLabel(k,l);if(typeof l==='string'){CSS.conditionClass(k,'uiSelectorBigButtonLabel',l.length>m);if(m&&l.length>m){k.setAttribute('title',l);}else k.removeAttribute('title');}},setButtonTooltip:function(m,l){var k=Selector.getSelectorButton(m);TooltipLink.setTooltipText(k,l||k.getAttribute('data-tooltip')||'');},setEnabled:function(l,k){if(!k&&a&&b(l)===a)Selector.toggle(l);Button.setEnabled(Selector.getSelectorButton(l),k);},setOptionEnabled:function(l,k){Menu.setItemEnabled(l,k);},setSelected:function(o,p,m){m=m!==false;var l=Selector.getOption(o,p);if(!l)return;var k=Selector.isOptionSelected(l);if(m!==k){if(!g(o)&&!k){var n=Selector.getSelectedOptions(o)[0];n&&Menu.toggleItem(n);}Menu.toggleItem(l);Selector.updateSelector(o);}},toggle:function(k){Toggler.toggle(DOM.scry(b(k),'div.wrap')[0]);},updateSelector:function(v){var s=Selector.getOptions(v);var u=Selector.getSelectedOptions(v);var p=e(v).options;var r=[];var x=[];for(var o=0,q=s.length;o<q;o++){var t=u.contains(s[o]);p[o+1].selected=t;if(t){var w=Selector.getOptionText(s[o]);r.push(w);x.push(s[o].getAttribute('data-tooltip')||w);}}p[0].selected=!u.length;var m=CSS.hasClass(v,'uiSelectorDynamicLabel');var n=CSS.hasClass(v,'uiSelectorDynamicTooltip');if(m||n){var l='';if(g(v)){var k=Selector.getSelectorButton(v);l=k.getAttribute('data-delimiter')||', ';}r=r.join(l);x=x.join(l);m&&Selector.setButtonLabel(v,r);n&&Selector.setButtonTooltip(v,x);}}});}();
var DynamicIconSelector=function(){onloadRegister(function(){Selector.subscribe('change',function(a,b){var c=b.selector;if(CSS.hasClass(c,'dynamicIconSelector'))DynamicIconSelector.swapIcon(c);});});return {swapIcon:function(e){var d=Selector.getSelectedOptions(e)[0];var c=d&&DOM.scry(d,'.itemIcon')[0];var a=Selector.getSelectorButton(e);if(c){Button.setIcon(a,c.cloneNode(true));}else{var b=DOM.scry(a,'.img')[0];b&&DOM.remove(b);}CSS.conditionClass(a,'uiSelectorChevronOnly',!c);}};}();
var PrivacyBaseValue={FRIENDS_MINUS_ACQUAINTANCES:127,FACEBOOK_EMPLOYEES:112,CUSTOM:111,EVERYONE:80,NETWORKS_FRIENDS_OF_FRIENDS:60,NETWORKS_FRIENDS:55,FRIENDS_OF_FRIENDS:50,ALL_FRIENDS:40,SELF:10,NOBODY:0};var PrivacyFriendsValue={EVERYONE:80,NETWORKS_FRIENDS:55,FRIENDS_OF_FRIENDS:50,ALL_FRIENDS:40,SOME_FRIENDS:30,SELF:10,NO_FRIENDS:0};var PrivacySpecialPreset={ONLY_CORP_NETWORK:200,COLLEGE_NETWORK_FRIENDS_OF_FRIENDS:201,COLLEGE_NETWORK_FRIENDS:202};var PrivacyNetworkTypes={TYPE_COLLEGE:1,TYPE_HS:2,TYPE_CORP:3,TYPE_GEO:4,TYPE_MANAGED:14,TYPE_TEST:50};var PrivacyNetworksAll=1;copy_properties(PrivacyBaseValue,PrivacySpecialPreset);function PrivacyModel(){this.value=PrivacyBaseValue.ALL_FRIENDS;this.friends=PrivacyFriendsValue.NO_FRIENDS;this.networks=[];this.objects=[];this.lists=[];this.lists_x=[];this.list_anon=0;this.ids_anon=[];this.list_x_anon=0;this.ids_x_anon=[];this.tdata={};return this;}copy_properties(PrivacyModel.prototype,{init:function(k,a,h,i,f,g,d,b,e,c,j){this.value=k;this.friends=a;this.networks=h.clone();this.objects=i.clone();this.lists=f.clone();this.lists_x=g.clone();this.list_anon=d;this.ids_anon=b.clone();this.list_x_anon=e;this.ids_x_anon=c.clone();j=j||{};copy_properties(this.tdata,j);},clone:function(){var a=new PrivacyModel();a.init(this.value,this.friends,this.networks,this.objects,this.lists,this.lists_x,this.list_anon,this.ids_anon,this.list_x_anon,this.ids_x_anon,this.tdata);return a;},getData:function(){var b=['value','friends','networks','objects','lists','lists_x','list_anon','ids_anon','list_x_anon','ids_x_anon'];var d={};for(var c=0;c<b.length;++c){var a=b[c];d[a]=this[a];}return d;}});
var AudienceSelector=function(){onloadRegister(function(){Selector.subscribe('select',function(a,b){if(!CSS.hasClass(b.selector,'audienceSelector'))return;var e=Selector.getOptionValue(b.option);if(e==PrivacyBaseValue.CUSTOM){Selector.toggle(b.selector);return false;}if(CSS.hasClass(b.selector,'dataTooltip')){var c=DOM.find(b.option,'.itemAnchor').getAttribute('data-tooltip');Selector.setButtonTooltip(b.selector,c||null);}if(!CSS.hasClass(b.option,'specialOption'))return;var d=DOM.find(b.option,'a').getAttribute('data-type');if(CSS.hasClass(b.option,'moreOption')){CSS.addClass(b.selector,d);CSS.addClass(b.selector,'showSecondaryOptions');return false;}else if(CSS.hasClass(b.option,'returnOption')){CSS.removeClass(b.selector,'showSecondaryOptions');CSS.removeClass(b.selector,'friendList');return false;}});Arbiter.subscribe('CustomPrivacyOption/update',function(a,b){if(!CSS.hasClass(b.selector,'audienceSelector'))return;Selector.setSelected(b.selector,Selector.getOptionValue(b.option));DynamicIconSelector.swapIcon(b.selector);Selector.setButtonTooltip(b.selector,b.tooltip);Arbiter.inform('AudienceSelector/update',b.selector);});});}();
var ComposerAudienceSelector=function(){var b={};var a={};onloadRegister(function(){Selector.subscribe('select',function(c,d){if(!CSS.hasClass(d.selector,'composerAudienceSelector'))return;if(!CSS.hasClass(d.option,'groupOption'))Arbiter.inform('ComposerAudienceSelector/nongroup');if(!CSS.hasClass(d.option,'specialOption'))return;var e=DOM.find(d.option,'a').getAttribute('data-type');if(e=='group')Arbiter.inform('ComposerAudienceSelector/group',{group:Selector.getOptionValue(d.option)});});Arbiter.subscribe('CustomPrivacyOption/update',function(c,d){if(CSS.hasClass(d.selector,'composerAudienceSelector'))Arbiter.inform('ComposerAudienceSelector/nongroup');});Selector.subscribe('close',function(c,d){if(!CSS.hasClass(d.selector,'composerAudienceSelector'))return;var e=Selector.getSelectedOptions(d.selector)[0];CSS.conditionClass(d.selector,'showSecondaryGroups',CSS.hasClass(e,'secondaryGroup'));});});return {syncSelector:function(e){b[e]&&Selector.setSelected(e,b[e]);if(b[e]==PrivacyBaseValue.CUSTOM&&a[e]){var c=Selector.getOption(e,PrivacyBaseValue.CUSTOM+'');var d=a[e];(function(){CustomPrivacyOption.update(c.id,d.data,d.audience,d.tooltip);}).defer();}}};}();
function CustomPrivacyOption(){}copy_properties(CustomPrivacyOption,{_instances:{},update:function(c,b,a,e){var d=CustomPrivacyOption._instances[c];d._update(b,a)._updateSelector(a,e);Arbiter.inform('Form/change',{node:d._container});},getData:function(a){return CustomPrivacyOption._instances[a]._privacyData;}});CustomPrivacyOption.prototype={init:function(d,c,b,e,a){(function(){var g=ge(d);if(!g)return;CustomPrivacyOption._instances[d]=this;this._selector=Parent.byClass(g,'uiSelector');this._container=DOM.find(g,'.customPrivacyInputs');this._id=c;this._privacyData={};var f=Form.serialize(this._container);if(f.audience)this._privacyData=f.audience[c];Event.listen(g,'click',function(h){var i=new AsyncRequest('/ajax/privacy/custom_dialog/').setData({option_id:d,id:this._id,privacy_data:this._privacyData,explain_tags:b,autosave:a});new Dialog().setAsync(i).setModal(true).show();}.bind(this));Selector.listen(this._selector,'select',function(h){if(h.option._id!=this._id)this._clear();}.bind(this));if(e)Selector.setButtonTooltip(this._selector,e);}).bind(this).defer();},_updateSelector:function(c,b){var a=Selector.getOption(this._selector,c)||Selector.getOption(this._selector,PrivacyBaseValue.CUSTOM+'');Arbiter.inform('CustomPrivacyOption/update',{selector:this._selector,option:a,tooltip:b});return this;},_clear:function(){this._privacyData={};DOM.empty(this._container);},_update:function(b,a){this._clear();this._privacyData=copy_properties({},b);var c=(a==PrivacyBaseValue.CUSTOM||!Selector.getOption(this._selector,a));if(c){var d=this._selector.getAttribute('data-name');if(d){d=d.slice(0,-'[value]'.length);var e={};e[d]=b;Form.createHiddenInputs(e,this._container,null,true);}}return this;}};
var FriendListPrivacyOptions=(function(){var e=false;var d=false;var a=null;var c={};var b=function(g){if(is_empty(c))PageTransitions.registerHandler(function(){c={};e=false;d=false;});var f=g.getAttribute('data-name');c[f]=g;Selector.listen(g,'select',function(h){var l=h.option;var k=DOM.find(l,'a.itemAnchor');var j=k.getAttribute('data-flid');if(!j)return;var i=k.getAttribute('data-dynamic');if(i&&e){FriendListPrivacyOptions.showSmartListNux(l,j);}else if(!i&&d)FriendListPrivacyOptions.showDumbListNux([j]);});};return {listen:function(h,j,f){var g=ge(h);if(!g)return;var i=Parent.byClass(g,'audienceSelector');if(i){b(i);e=j;d=f;}},showSmartListNux:function(g,f){new AsyncRequest('/ajax/friends/lists/smart_list_publish_nux.php').setData({option_id:g.id,flid:f}).send();e=false;},setContextualDialog:function(f,g){var h=Parent.byClass(g,'audienceSelector');if(h){f.setContext(h);f.show();var i=Arbiter.subscribe('composer/publish',function(){f.hide();});f.subscribe('hide',function(){Arbiter.unsubscribe(i);});}},showDumbListNux:function(f){new AsyncRequest('/ajax/friends/lists/dumb_list_publish_nux.php').setData({flids:f}).send();d=false;},showBothListsNux:function(g,f){a=g;FriendListPrivacyOptions.showDumbListNux(f);},setDialog:function(){if(!a)return;var f=Dialog.getCurrent();if(f)f.setCloseHandler(function(){FriendListPrivacyOptions.showSmartListNux(a);a=null;});}};})();
function FriendsPrivacyOption(){}FriendsPrivacyOption.prototype={init:function(a,b){this._selector=Parent.byClass(a,'composerAudienceSelector');if(!this._selector)return;this._elem=a;this._hasRestricted=b;this._plusLabel=DOM.find(a,'.plusLabel');this._tags=[];this._recalculateTooltipAndLabel();this._updateSelector();Arbiter.subscribe('Composer/changedtags',function(c,d){this._tags=d.withTags.map(function(g){return g.getText();});var f=d.withTags.map(function(g){return g.getValue();});for(var e in d.mention)if(d.mention[e].type=='user'&&d.mention[e].uid!=Env.user){this._tags.push(d.mention[e].text);f.push(d.mention[e].uid);}if(this._recalculateTooltipAndLabel()&&this._updateSelector())Arbiter.inform('FriendsPrivacyOption/changed',f);}.bind(this));Selector.listen(this._selector,'change',this._updateSelector.bind(this));},_recalculateTooltipAndLabel:function(){var a=this._tags.length,b=this._tooltip;if(a>2){this._tooltip=this._hasRestricted?_tx("Your friends and friends of anyone tagged; Except: Restricted"):_tx("Your friends and friends of anyone tagged");}else if(a==2){if(this._hasRestricted){this._tooltip=_tx("Your friends, {user}'s friends and {user2}'s friends; Except: Restricted ",{user:this._tags[0],user2:this._tags[1]});}else this._tooltip=_tx("Your friends, {user}'s friends and {user2}'s friends",{user:this._tags[0],user2:this._tags[1]});}else if(a==1){if(this._hasRestricted){this._tooltip=_tx("Your friends and {user}'s friends; Except: Restricted",{user:this._tags[0]});}else this._tooltip=_tx("Your friends and {user}'s friends",{user:this._tags[0]});}else this._tooltip=this._hasRestricted?_tx("Your friends; Except: Restricted"):_tx("Your friends");CSS.conditionShow(this._plusLabel,this._tags.length);return b!=this._tooltip;},_updateSelector:function(){if(!Selector.isOptionSelected(this._elem))return false;var a=this._elem.getAttribute('data-label');if(this._tags.length)a+=' (+)';Selector.setButtonLabel(this._selector,a);Selector.setButtonTooltip(this._selector,this._tooltip);return true;}};
function MetaComposerEdDialog(){}MetaComposerEdDialog.prototype={init:function(a,b){MetaComposerEdDialog.timesEnabled=b;if(MetaComposerEdDialog.singleton){a.destroy();return;}MetaComposerEdDialog.singleton=this;this._dialog=a;Arbiter.subscribe('FriendsPrivacyOption/changed',function(c,d){if(!this._updateContext())return;this._async&&this._async.abort();this._async=new AsyncRequest('/ajax/composer/audience_education');this._async.setData({ids:d,num:MetaComposerEdDialog.timesEnabled}).setHandler(this._handler.bind(this)).send();}.bind(this));Selector.subscribe('open',this._killAnim.bind(this));},_updateContext:function(){var a=DOM.scry(document.body,'div.composerAudienceWrapper')[0];var b=Vector2.getElementPosition(a);if(a&&b.x>0&&b.y>0){this._dialog.setContext(a);return true;}return false;},_handler:function(c){var d=c.payload;if(!d||!this._updateContext())return;var a=this._dialog.getContent();DOM.setContent(a,HTML(d));this._dialog.setDestroyOnHide(false).show();var b=Parent.byClass(a,'metaComposerUserEd');if(this._anim){this._anim.stop();this._anim=animation(b);}else this._anim=animation(b).from('opacity',0);this._anim.by('opacity',1).checkpoint().duration(3000).checkpoint().to('opacity',0).checkpoint().ondone(this._killAnim.bind(this)).go();},_killAnim:function(a,b){if(this._anim){this._anim.stop();this._dialog.hide(false);this._anim=null;}}};
var FBXLoadMoreExperiences={reveal:function(b,a){var c=b.offsetHeight;a=DOM.replace(b,a)[0];animation(a).from('height',c).to('height','auto').duration(400).blind().ease(animation.ease.both).go();}};
var QuestionsOpinionPollForm={replaceRow:function(c,b,a){var d='.pollRow_'+b;DOM.scry(c,d).map(function(e){DOM.replace(e,a);});}};
function ScrollingPager(d,c,a,b){this.scroll_loader_id=d;this.pagelet_src=c;this.data=a;this.options=b||{};if(this.options.target_id){this.target_id=this.options.target_id;this.options.append=true;}else this.target_id=d;this.handler=null;}ScrollingPager.prototype={register:function(){this.onvisible=new OnVisible($(this.scroll_loader_id),this.getHandler(),false,this.options.buffer,this.options);},getHandler:function(){if(this.handler)return this.handler;function a(){var c=ge(this.scroll_loader_id);if(!c){this.onvisible.remove();return;}CSS.addClass(c.firstChild,'async_saving');var b=this.options.handler;this.options.handler=function(){Arbiter.inform('ScrollingPager/loadingComplete');b&&b.apply(null,arguments);};UIPagelet.loadFromEndpoint(this.pagelet_src,this.target_id,this.data,this.options);}return a.bind(this);},setHandler:function(a){this.handler=a;}};
function SearchDataSource(b){this._token=b.token||'';this._lazyonload=b.lazyonload===false?false:true;this._leanOnAllTypes=b.leanOnAllTypes;this._extraTypes=b.extraTypes;var a=b.maxResults||8;this.parent.construct(this,b);this._numResults={min:3,max:a};this._genTime=b.genTime;}Class.extend(SearchDataSource,'DataSource');SearchDataSource.prototype={init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this._criticalOnly=true;this._updateMaxResults();Event.listen(window,'resize',this._updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this._fetchOnUseRequests=[];},asyncErrorHandler:function(a){if(window.Dialog&&Dialog.getCurrent()==null&&a.getError()==1400003)AsyncResponse.verboseErrorHandler(a);},fetch:function(b,a,c){c=c||{};c.fetch_start=Date.now();this.parent.fetch(b,a,c);},fetchHandler:function(f,c){var e=f.getPayload();var g=copy_properties({fetch_end:Date.now()},c);var b=g.value?Arbiter.BEHAVIOR_EVENT:Arbiter.BEHAVIOR_PERSISTENT;if(c.type=='lean'){this._leanPayload=e;this._processLean();}else{this.parent.fetchHandler(f,c);if(c.bootstrap&&!f.getRequest().getData().no_cache)g.browserCacheHit=(e.timestamp<this._genTime);if(c.bootstrap&&!e.no_data&&this._bootstrapRequestsPending>0)if(e.num_remaining_pieces){c.remaining_pieces=e.num_remaining_pieces;for(var d=0;d<e.num_remaining_pieces;++d){var a=copy_properties({},f.getRequest().getData());a.piece_idx=d;this.fetch(this.bootstrapEndpoint,a,c);}}else{--c.remaining_pieces;if(!c.remaining_pieces){c.bootstrap=false;--this._bootstrapRequestsPending;}!this._bootstrapRequestsPending&&this._bootstrapPostProcess();}if(e.no_data||e.token!==this._token){var a=copy_properties({},f.getRequest().getData());if(a.lazy){delete a.lazy;a.token=this._token;this._fetchOnUse(a,c);}}}this.inform('endpointStats',g,b);},_bootstrapPostProcess:function(){var a={time:Date.now()};this.inform('bootstrapped',a,Arbiter.BEHAVIOR_PERSISTENT);this._processLean();},_processLean:function(){if(this._leanPayload){var b;var a=this._leanPayload.entries;for(var c in a){b=this.getEntry(c);b&&(b.index=a[c]);}this._leanPayload=null;}},_updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight;this.setMaxResults(Math.max(this._numResults.min,Math.min(this._numResults.max,Math.ceil(2+((a-370)/56)))));},_multifetch:function(e,b){var d=copy_properties(b,this.bootstrapData);for(var f=0;f<e.length;++f){var a=copy_properties({filter:e[f]},d);var c={bootstrap:true,remaining_pieces:1,type:e[f].length===1?e[f][0]:'other'};this.fetch(this.bootstrapEndpoint,a,c);++this._bootstrapRequestsPending;}},_fetchOnUse:function(a,b){for(var c in this.bootstrapData)!a.hasOwnProperty(c)&&(a[c]=this.bootstrapData[c]);if(this._criticalOnly){this._fetchOnUseRequests.push({args:a,ctx:b});}else this.fetch(this.bootstrapEndpoint,a,b);},_fetchLean:function(){var a={filter:['user'],no_cache:1};if(this._leanOnAllTypes)a={no_cache:1};a.options=$A(a.options);a.options.push('lean');this._fetchOnUse(a,{type:'lean'});},bootstrap:function(a){if(!a){this._criticalOnly=false;this._flushFetchOnUseRequests();}if(this._bootstrapped)return;if(this.bootstrapData.filter){this.fetch(this.bootstrapEndpoint,this.bootstrapData);}else{var b={filter:['event'],no_cache:1};this._fetchOnUse(b,{type:'event'});var d=['app','page','group'];d=d.concat(this._extraTypes||[]);d=[['user'],d];var c=this._criticalOnly&&this._lazyonload?{lazy:1}:{};this._multifetch(d,c);}this._fetchLean();this._bootstrapped=true;},_flushFetchOnUseRequests:function(){var c=this._fetchOnUseRequests.length;for(var b=0;b<c;++b){var a=this._fetchOnUseRequests[b];this.fetch(this.bootstrapEndpoint,a.args,a.ctx);}this._fetchOnUseRequests=[];},onLoad:function(a,b){this.inform('onload',{time:Date.now()},Arbiter.BEHAVIOR_PERSISTENT);if(a)this.bootstrap.bind(this,b).defer();}};
function TypeaheadCore(a){copy_properties(this,a);}Class.mixin(TypeaheadCore,'Arbiter',{events:['blur','focus','unselect'],keepFocused:true,resetOnSelect:false,resetOnKeyup:true,setValueOnSelect:false,queryTimeout:250,preventFocusChangeOnTab:false,init:function(b,d,c){this.init=bagofholding;this.data=b;this.view=d;this.root=c;this.element=DOM.find(c,'.textInput');var a=DOM.scry(this.element,'input')[0];if(a)this.element=a;this.inputWrap=DOM.find(c,'div.wrap');this.hiddenInput=DOM.find(c,'input.hiddenInput');this.value='';this.selectedText=null;if(this.setValueOnSelect&&CSS.hasClass(this.inputWrap,'selected'))this.selectedText=this.getValue();this.initView();this.initData();this.initEvents();this.initToggle();this._exclusions=[];},initView:function(){this.view.subscribe('highlight',function(){this.element.focus();}.bind(this));this.view.subscribe('select',function(a,b){this.select(b.selected);}.bind(this));this.view.subscribe('afterSelect',function(){this.afterSelect();}.bind(this));},initData:function(){this.data.subscribe('respond',function(a,b){if(b.forceDisplay||b.value==this.getValue()&&!this.element.disabled)this.view.render(b.value,b.results,b.isAsync);}.bind(this));this.data.subscribe('activity',function(a,b){this.fetching=b.activity;if(!this.fetching)this.nextQuery&&this.performQuery();}.bind(this));},initEvents:function(){Event.listen(this.view.getElement(),{mouseup:this.viewMouseup.bind(this),mousedown:this.viewMousedown.bind(this)});var a={blur:bind(this,'blur'),focus:bind(this,'focus'),click:bind(this,'click'),keyup:bind(this,'keyup'),keydown:bind(this,'keydown')};if(ua.firefox())a.text=a.keyup;if(ua.firefox()<4){a.keypress=a.keydown;delete a.keydown;}Event.listen(this.element,a);Event.listen(this.element,'keypress',this.keypress.bind(this));},initToggle:function(){var b=this.root.parentNode;var d=CSS.getStyle(b,'position')!='static'?b:this.root;var c=this.view;var a='uiTypeaheadFocused';this.subscribe('focus',function(){c.show();CSS.addClass(d,a);});this.subscribe('blur',function(){c.hide();CSS.removeClass(d,a);});},viewMousedown:function(){this.selecting=true;},viewMouseup:function(){this.selecting=false;},blur:function(){if(this.selecting){this.selecting=false;return;}this.inform('blur');},click:function(){this.element.select();},focus:function(){this.checkValue();this.inform('focus');},keyup:function(){if(this.resetOnKeyup&&!this.getValue())this.view.reset();this.checkValue();},keydown:function(event){if(!this.view.isVisible()||this.view.isEmpty()){this.checkValue.bind(this).defer();return;}switch(Event.getKeyCode(event)){case KEYS.TAB:this.handleTab(event);return;case KEYS.UP:this.view.prev();break;case KEYS.DOWN:this.view.next();break;case KEYS.ESC:this.view.reset();break;default:this.checkValue.bind(this).defer();return;}event.kill();},keypress:function(event){if(this.view.getSelection()&&Event.getKeyCode(event)==KEYS.RETURN){this.view.select();event.kill();}},handleTab:function(event){this.view.select();this.preventFocusChangeOnTab&&event.kill();},select:function(a){if(a&&this.setValueOnSelect){this.setValue(a.text);this.setHiddenValue(a.uid);this.selectedText=a.text;CSS.addClass(this.inputWrap,'selected');}},afterSelect:function(){this.resetOnSelect?this.reset():this.view.reset();this.keepFocused?this.element.focus():this.element.blur();},unselect:function(){if(this.setValueOnSelect){this.selectedText=null;CSS.removeClass(this.inputWrap,'selected');}this.setHiddenValue();this.inform('unselect',this);},setEnabled:function(b){var a=b===false;this.element.disabled=a;CSS.conditionClass(this.root,'uiTypeaheadDisabled',a);},reset:function(){this.unselect();this.setValue();!this.keepFocused&&Input.reset(this.element);this.view.reset();this.inform('reset');},getElement:function(){return this.element;},setExclusions:function(a){this._exclusions=a;},getExclusions:function(){return this._exclusions;},setValue:function(a){this.value=this.nextQuery=a||'';Input.setValue(this.element,this.value);},setHiddenValue:function(a){this.hiddenInput.value=(a||a===0)?a:'';Arbiter.inform('Form/change',{node:this.hiddenInput});},getValue:function(){return Input.getValue(this.element);},getHiddenValue:function(){return this.hiddenInput.value||'';},checkValue:function(){var c=this.getValue();if(c==this.value)return;if(this.selectedText&&this.selectedText!=c)this.unselect();var b=Date.now();var a=b-this.time;this.time=b;this.value=this.nextQuery=c;this.performQuery(a);},performQuery:function(a){if(this.selectedText)return;a=a||0;if(this.fetching&&a<this.queryTimeout){this.data.query(this.nextQuery,true,this._exclusions);}else{this.data.query(this.nextQuery,false,this._exclusions);this.nextQuery=null;}}});
function SearchTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(SearchTypeaheadCore,'TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,f,d){this.parent.init(a,f,d);var b=Parent.byTag(d,'form'),c=this.reset.bind(this);if(b){var e=DOM.find(b,'input.search_sid_input');Event.listen(b,'submit',function(){if(this.data&&this.data.queryData)e.value=this.data.queryData.sid;c.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var a=this.view.getQuerySuggestion(this.value);if(a){Input.setValue(this.element,a);this.checkValue();event.kill();}else this.parent.handleTab(event);}};
function SearchTypeaheadRecorder(a){this.init(a);this.initEvents();}SearchTypeaheadRecorder.prototype={_endPoint:'/ajax/typeahead/record_metrics.php',init:function(a){this.core=a.getCore();this.data=a.getData();this.view=a.getView();this.element=this.core.getElement();this.initTime=Date.now();this._onloadTime=0;this.initStartTime=$('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};this.appendStats={};this._backspacing=false;this._inflightRequests={};var a=Math.random();this.data.setQueryData({sid:a});this.view.setSid(a);this.recordStat('sid',a);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats['session_start_time'])this.recordStat('session_start_time',Date.now());}.bind(this));this.core.subscribe('blur',function(event){var b=Date.now();for(var d in this._inflightRequests){var c=this._inflightRequests[d];var a=b-c;this.recordAvgStat('search_endpoint_ms_from_js',a);}this.recordStat('session_end_time',b);this.submit();}.bind(this));this.view.subscribe('select',function(a,b){this.recordSelectInfo(b);}.bind(this));this.view.subscribe('render',function(a,b){this.recordRender(b);}.bind(this));this.data.subscribe('activity',function(a,b){this.recordStat('pending_request',b.activity);}.bind(this));this.data.subscribe('beforeQuery',function(a,b){if(!b.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',Date.now());this.query=b.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(a,b){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',b.value.length);this._inflightRequests[b.value]=Date.now();}.bind(this));this.data.subscribe('onload',function(a,b){this._onloadTime=b.time;}.bind(this));this.data.subscribe('bootstrapped',function(a,b){this.bootstrapStats.endTime=b.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(a,c){var b=c.fetch_end-c.fetch_start;if(c.value){this.recordAvgStat('search_endpoint_ms_from_js',b);}else this.bootstrapStats[c.type]=b;if(typeof c.browserCacheHit!='undefined')this.recordCountStat(c.browserCacheHit?'bootstrap_cachehits':'bootstrap_cachemisses');if(this._inflightRequests[c.value])delete this._inflightRequests[c.value];}.bind(this));this.data.subscribe('query',function(a,b){this.recordAvgStat('num_results_from_cache',b.results.length);}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE){if(!this._backspacing){this._backspacing=true;this.recordAppendStat('before_backspace_queries',this.query);}}else this._backspacing=false;}.bind(this));},recordStat:function(a,b){this.stats[a]=b;},recordCountStat:function(a){var b=this.stats[a];this.stats[a]=b?b+1:1;},recordAvgStat:function(a,b){if(this.avgStats[a]){this.avgStats[a][0]+=b;++this.avgStats[a][1];}else this.avgStats[a]=[b,1];},recordAppendStat:function(a,b){if(!this.appendStats.hasOwnProperty(a))this.appendStats[a]=[];this.appendStats[a].push(b);},recordRender:function(a){this.results=a.filter(function(b){return b.uid!='search'&&b.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',Date.now());},recordSelectInfo:function(c){var f=c.selected;var b=c.index-f.groupIndex-1;var d={href:f.path};var a=f.dataGT?{gt:JSON.parse(f.dataGT)}:{};user_action('click',d,null,null,a);if(f.uid=='search'){this.recordStat('selected_search',1);}else{var g=f.rankType||f.render_type||f.type;var e=(g=='friend'?'user':g);this.recordStat('selected_'+e,1);this.recordStat('selected_position',b);this.recordStat('selected_type',g);this.recordStat('selected_name_length',f.text.length);this.recordStat('selected_id',f.uid);this.recordStat('selected_degree',f.bootstrapped?1:2);}this.recordStat('selected_with_mouse',c.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.other);this.bootstrapStats.endTime=0;}this.recordStat('max_results',this.data._maxResults);var b=this.stats;for(var d in this.avgStats){var c=this.avgStats[d];b[d]=c[0]/c[1];}for(var a in this.appendStats)b[a]=JSON.stringify(this.appendStats[a]);return b;},buildResults:function(){var a=(this.results||[]).map(function(d,c){var e=d.rankType||d.render_type||d.type;var b=d.bootstrapped?1:0;if(typeof d.groupIndex=='number')return [d.groupIndex,d.indexInGroup,d.uid,e,b];return [0,c,d.uid,e,b];});return JSON.stringify(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(b){a.retry=true;new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('asynchronous',false).send();}.bind(this)).send();this._reset();}};
function TypeaheadView(a,b){this.element=this.content=$(a);copy_properties(this,b);}Class.mixin(TypeaheadView,'Arbiter',{events:['highlight','render','reset','select'],renderer:'basic',autoSelect:false,init:function(){this.init=bagofholding;this.initializeEvents();this.reset();},initializeEvents:function(){Event.listen(this.element,{mouseup:this.mouseup.bind(this),mouseover:this.mouseover.bind(this)});},getElement:function(){return this.element;},mouseup:function(event){this.select(true);event.kill();},mouseover:function(event){if(this.visible)this.highlight(this.getIndex(event));},reset:function(a){if(!a)this.disableAutoSelect=false;this.index=-1;this.items=[];this.results=[];this.value='';this.content.innerHTML='';this.inform('reset');return this;},getIndex:function(event){return this.items.indexOf(Parent.byTag(event.getTarget(),'li'));},getSelection:function(){var a=this.results[this.index]||null;return this.visible?a:null;},isEmpty:function(){return !this.results.length;},isVisible:function(){return this.visible;},show:function(){CSS.show(this.element);this.visible=true;return this;},hide:function(){CSS.hide(this.element);this.visible=false;return this;},render:function(h,e,f){this.value=h;if(!e.length){this.reset(true);return;}var c={results:e,value:h};this.inform('beforeRender',c);e=c.results;var d=this.getDefaultIndex(e);if(this.index>0&&this.index!==this.getDefaultIndex(this.results)){var a=this.results[this.index];for(var b=0,g=e.length;b<g;++b)if(a.uid==e[b].uid){d=b;break;}}this.results=e;DOM.setContent(this.content,this.buildResults(e));this.items=this.getItems();this.highlight(d,false);this.inform('render',e);},getItems:function(){return DOM.scry(this.content,'li');},buildResults:function(d){var c;var a=null;if(typeof this.renderer=='function'){c=this.renderer;}else{c=TypeaheadRenderers[this.renderer];a=this.renderer;}c=c.bind(this);var b=d.map(function(e,f){return e.node||c(e,f);});return $N('ul',{className:a},b);},getDefaultIndex:function(b){var a=(this.autoSelect&&!this.disableAutoSelect);return this.index<0&&!a?-1:0;},next:function(){this.highlight(this.index+1);},prev:function(){this.highlight(this.index-1);},highlight:function(a,b){this.selected&&CSS.removeClass(this.selected,'selected');if(a>this.items.length-1){a=-1;}else if(a<-1)a=this.items.length-1;if(a>=0&&a<this.items.length){this.selected=this.items[a];CSS.addClass(this.selected,'selected');}this.index=a;this.disableAutoSelect=(a==-1);if(b!==false)this.inform('highlight',{index:a,selected:this.results[a]});},select:function(a){var b=this.index;var c=this.results[b];if(c){this.inform('select',{index:b,clicked:!!a,selected:c});this.inform('afterSelect');}}});
function BucketedTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(BucketedTypeaheadView,'TypeaheadView');BucketedTypeaheadView.prototype={render:function(c,a,b){a=this.buildBuckets(c,a);return this.parent.render(c,a,b);},highlight:function(a,b){if(a==-1&&this.index!==0)a=this.index;if(a>=0&&a<this.items.length&&this.results[a].type=='header')a=a+1;this.parent.highlight(a,b);},buildBuckets:function(i,f){if(!this.typeObjects)return f;var b=[];var h={};for(var d=0;d<f.length;++d){var c=f[d];var g=c.render_type||c.type;if(!h.hasOwnProperty(g)){h[g]=b.length;b.push([this.buildBucketHeader(g)]);}c.classNames=g;c.groupIndex=h[g];c.indexInGroup=b[c.groupIndex].length-1;b[c.groupIndex].push(c);}var a=[];for(var e=0;e<b.length;++e)a=a.concat(b[e]);return a;},buildBucketHeader:function(b){var a=this.typeObjects[b];if(a.markup){a.text=a.markup;delete a.markup;}return this.typeObjects[b];},buildResults:function(b){var a=this.parent.buildResults(b);return $N('div',{className:'bucketed'},[a]);},select:function(a){var b=this.results[this.index];if(b&&b.type!='header')this.parent.select(a);},getDefaultIndex:function(c){var a=(this.autoSelect&&!this.disableAutoSelect);var b=c.length===0?-1:(c[0].type=='header'?1:0);return this.index<0&&!a?-1:b;},prev:function(){var a=this.results[this.index-1];if(a&&a.type=='header')this.index--;return this.parent.prev();},next:function(){var a=this.results[this.index+1];if(a&&a.type=='header')this.index++;return this.parent.next();}};
function SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(SearchTypeaheadView,'BucketedTypeaheadView');SearchTypeaheadView.prototype={ignoreClick:function(event){event.prevent();},shouldShowSeeMore:true,queryData:{init:'quick'},buildBuckets:function(c,b){var a=b.length;b=this.parent.buildBuckets(c,b);if(c&&this.shouldShowSeeMore)b.push(this.buildSeeMore(c,a));return b;},buildSeeMore:function(e,c){var d=c>0?_tx("See more results for {query}",{query:e}):_tx("See results for {query}",{query:e});var a=c==1?_tx("Displaying top result"):_tx("Displaying top {number} results",{number:c});var b=$N('li',{className:'calltoaction'},[$N('a',{href:this.getEndpoint(e),rel:'ignore'},[$N('span',{className:'text'},[$N('span',{className:'seeMore'},[d,$N('span',{className:'arrow'})]),$N('span',{className:'subtext'},[a])])])]);return {uid:'search',node:b,search:true};},searchPageQueryData:function(a){return copy_properties({q:a},this.queryData||{});},select:function(b){var d=this.index;var e=this.results[d];if(!e||e.type=='header')return;var c=this.items[d];var a=DOM.scry(c,'a')[0];if(e.song){if(a)MusicEvents.inform(MusicConstants.MUSIC_BUTTON.ACTIVATE,a);b&&this.inform('highlight',{index:d,selected:e});}else{this.parent.select(b);if(a&&a.href)if(a.target=='_blank'){window.open(a.href);}else goURI(a.href);}},setSid:function(a){this.queryData.tas=a;},getEndpoint:function(c){var b=Parent.byTag(this.element,'form');var a=Form.getAttribute(b,'action');return URI(a).addQueryData(this.searchPageQueryData(c))+'';},show:function(){Arbiter.inform('layer_shown',{type:'SearchTypeahead'});this.parent.show();},hide:function(){Arbiter.inform('layer_hidden',{type:'SearchTypeahead'});this.parent.hide();},getQuerySuggestion:function(c){var a=this.results[this.index];var b=a&&a.type!='header'?a.text.toLowerCase():'';return b==c.toLowerCase()?'':b;}};
add_properties('TypeaheadBehaviors',{buildBestAvailableNames:function(a){var b=a.getView();b.subscribe('beforeRender',function(c,e){var h=e.value;for(var d=0;d<e.results.length;++d){var g=e.results[d];if(g.alternate_names==null)continue;if(TypeaheadUtil.isQueryMatch(h,g.default_name)){g.text=g.default_name;return;}for(var f=0;f<g.alternate_names.length;f++)if(TypeaheadUtil.isQueryMatch(h,g.alternate_names[f])){g.text=g.alternate_names[f];return;}g.text=g.default_name;}});}});
add_properties('TypeaheadBehaviors',{initFilters:function(a){Arbiter.subscribe('search/typeahead/updateFilter',function(c,b){a.getView().queryData.type=b.filter_type;});Arbiter.subscribe('page_transition',function(c,b){delete a.getView().queryData.type;},Arbiter.SUBSCRIBE_NEW);}});
add_properties('TypeaheadBehaviors',{searchRecorderBasic:function(a){a.subscribe('init',function(b,c){new SearchTypeaheadRecorder(a);});}});
function UIIntentionalStream(j,e,h,i,c,m,n,d,g,b,f,a,k,l){if(!j)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:j.id,root:j,instanceName:e,newest:h,oldest:i,oldestMR:i,firstLoadIDs:d,shouldShowHidden:false,defaultFilter:c,currentFilterKey:b,sourceType:m,streamStoryCount:n,maxUnseenStoryCount:g,lastSeenTime:f,hasPendingRefresh:false,pauseAutoInsert:false,unseenStoryCount:0,streamHeader:ge('pagelet_stream_header'),error:DOM.scry(j,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(j,'div.uiMorePager')[0],filterNullState:DOM.scry(j,'div.friendListFilterNullState')[0],streamContent:DOM.find(j,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,boulderFeed:a,scrollPosition:k,lastViewStateID:0,shouldRenderCount:l,scrollListener:null,conowingoCount:0,conowingoNewest:0,headerCounts:{},collapseHeaderOnMove:false});this.setUpStreamHeader();if(this.streamStoryCount>0)this.updateLiveFeedCount(this.streamStoryCount);onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[e]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();this.highlightsBlockData={};Arbiter.inform(UIIntentionalStreamMessage.INITIALIZE_COMPLETE,{},Arbiter.BEHAVIOR_PERSISTENT);}UIIntentionalStream.isHighlightsFilter=function(a){if(!a)return false;var b=a.startsWith(UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);return b;};UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addComposerContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));if(this.boulderFeed){this.scrollListener=Event.listen(window,'scroll',this.checkScroll.bind(this));this.checkScroll();}};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);this.subscriptions=null;if(this.scrollListener){this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;UIIntentionalStreamRefresh.instance&&UIIntentionalStreamRefresh.instance.unload();};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights()&&(!this.boulderFeed||this.shouldRenderCount))return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(b){var a={filter:this.getCurrentFilterKey(),oldest:this.oldest,oldestMR:this.oldestMR,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount,scroll_position:this.scrollPosition,last_viewstate_id:this.lastViewStateID,position_data:this.highlightsBlockData};a=merge(a,b);this.loadWithParams(a);};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}UIPagelet.loadFromEndpoint('/pagelet/home/morestories.php','home_stream',a,{usePipe:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(b,a,c){if(window.disableScrollLoad)return;var e=function(){if(window.disableScrollLoad)return;if(window.ArbiterMonitor){var h=user_action('scroll',null,null,'FORCE',{gt:{ua_id:'stream:scroll:auto'}});ArbiterMonitor.initUA(h);}var g={delay_load_count:a};if(this.scrollLoadCount==1&&this.firstLoadIDs&&this.firstLoadIDs.length>0)g=merge(g,{first_load_ids:this.firstLoadIDs,show_hidden:this.shouldShowHidden,query_time:c});this.loadOlderPosts(g);}.bind(this);var f=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!f.length)return;var d=f[f.length-b-1];if(d){this.currentScrollListener=new OnVisible(d,e,null,0,{detect_speed:this.scrollLoadCount>1});}else e();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updateOldestMR=function(a){if(!this.oldestMR||a<this.oldestMR)this.oldestMR=a;};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=URI.getMostRecentURI().getQueryData();if(a&&a.sk){this.currentFilterKey=a.sk;}else if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.resetFilterKey=function(a){this.currentFilterKey=a;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(b){if(!this.newest)return;b=b||{};var a=this.getCurrentParams();a.newest=this.newest;if(b.ignoreSelf)a.ignore_self=true;a.load_newer=true;var c=coalesce(b.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,a,b);return this;};UIIntentionalStream.prototype.expandRecentStories=function(){if(!this.shouldRenderCount)return;this.shouldRenderCount=false;var d=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');var c=this.removeHeader();CSS.addClass(d.firstChild,'uiStreamFirstStory');if(c)DOM.prependContent(d,c);var b=this.getCurrentParams();b.newest=this.newest;b.active_mode=true;if(this.conowingoNewest>this.newest)this.newest=this.conowingoNewest;var f=bagofholding;var e=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.addClass(e,'async_saving');var a=d.childNodes.length;if((c&&this.conowingoCount==a-1)||(!c&&this.conowingoCount==a)){f=function(){CSS.hide(e);this.shiftPrefetchStories();}.bind(this);}else if(this.conowingoCount>20)b.replace_pager=true;this.slideIn(d,f);this.refresh(UIIntentionalStream.REFRESH_BUBBLE,b,{});};UIIntentionalStream.prototype.showRecentStoriesPager=function(b){if(!b)return;var a=this.streamContent.firstChild;if(a)CSS.removeClass(a,'uiStreamFirstStory');animation(b).from('opacity',0).to('opacity',1).show().ondone(function(){Arbiter.inform('reflow');}).go();new AsyncSignal('ajax/feed/show_pager.php',{count:this.conowingoCount}).send();};UIIntentionalStream.prototype.slideIn=function(b,a){var f=b.parentNode;var d=$N('div',{style:{marginTop:'-10000px'}},b);var e=$N('div',{style:{overflow:'hidden'}},d);CSS.setStyle(d,'opacity',0);CSS.show(b);DOM.prependContent(f,e);var c=Vector2.getElementDimensions(d).y;CSS.setStyle(d,'marginTop','-'+c+'px');animation(d).to('marginTop',0).ease(animation.ease.both).checkpoint(.5).to('opacity',1).ondone(function(){DOM.replace(e,b);a();}).go();};UIIntentionalStream.prototype.shiftPrefetchStories=function(){var b=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');if(!b.childNodes.length)return;var a=this.streamContent.firstChild;if(a)CSS.removeClass(a,'uiStreamFirstStory');DOM.prependContent(this.streamContent,$A(b.childNodes));CSS.hide(b);var c=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.removeClass(c,'async_saving');Arbiter.inform('reflow');};UIIntentionalStream.prototype.checkScroll=function(){if(this.scrollListener&&Vector2.getScrollPosition().y>0){var a=ge('highlight_header');new AsyncSignal('ajax/feed/scroll_detect.php',{hasHeader:!!a}).send();this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.getCurrentParams=function(){var a={};var b=URI.getMostRecentURI().getQueryData();b.filter=this.getCurrentFilterKey();var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.updateBlockData=function(a){this.highlightsBlockData=a;};UIIntentionalStream.prototype.setConowingoCount=function(a){this.conowingoCount=a;this.shouldRenderCount=!!this.conowingoCount;};UIIntentionalStream.prototype.setConowingoNewest=function(a){if(a>this.conowingoNewest)this.conowingoNewest=a;};UIIntentionalStream.prototype.updateRecentStoryCount=function(b){this.setConowingoCount(b);if(this.boulderFeed){var c=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');if(this.shouldRenderCount){var d=DOM.find(c,'span.fbStreamRecentStoriesText');var a;if(this.conowingoCount==1){a=_tx("{count} NEW STORY",{count:b});}else if(b<=100){a=_tx("{count} NEW STORIES",{count:b});}else a=_tx("100+ NEW STORIES");DOM.setContent(d,a);if(CSS.hasClass(c,'hidden_elem'))this.showRecentStoriesPager(c);}else CSS.hide(c);}};UIIntentionalStream.prototype.updateRenderedStories=function(b){if(this.boulderFeed&&this.shouldRenderCount){var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');DOM.setContent(a,HTML(b));}};UIIntentionalStream.prototype.scrollToOrLoadRecentStories=function(){if(this.scrollToRecentStories()){new AsyncSignal('ajax/feed/scroll_link.php',{}).send();}else{DOMScroll.scrollTo(ge('pagelet_stream_pager'));this.loadOlderPosts({impatient_mode:true,max_stories:10});}};UIIntentionalStream.prototype.scrollToRecentStories=function(){var a=ge('recent_header');if(a){CSS.removeClass(a,'uiStreamHeaderHideLink');DOMScroll.scrollTo(a,true,false,Vector2.getViewportDimensions().y-50);return true;}else return false;};UIIntentionalStream.prototype.scrollToTopStories=function(){DOMScroll.scrollTo(ge('highlight_header'),true,true);};UIIntentionalStream.prototype.incrementTransitionalNux=function(a){if(this.incrementedTransitionalNux)return;this.incrementedTransitionalNux=true;var c='/ajax/feed/nux/transitional_increment';var b={location:a};new AsyncSignal(c,b).send();};UIIntentionalStream.prototype.refresh=function(j,a,f){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=a.filter;if(a.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(UIIntentionalStream.isHighlightsFilter(a.filter)||a.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;f=f||{};var h=++this.requestNum;var i=coalesce(f.showLoader,true);var e=this.instanceName;var d=function(k){UIIntentionalStream.getInstance(e).handleResponse(h,j,k,f);};var b=function(k){UIIntentionalStream.getInstance(e).handleError(h,j,k,f);};var c=function(k){UIIntentionalStream.getInstance(e).handleFinally(j,a.filter,k);};if(!(a.request_type=j))a.request_type='none';if(a.filter){f.show_hidden=a.show_hidden?a.show_hidden:false;}else f.show_hidden=this.shouldShowHidden;a=copy_properties(this.getCurrentParams(),a);this.hasPendingRefresh=true;var g;if(j==UIIntentionalStream.REFRESH_APPEND&&i)g=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(a).setHandler(d).setStatusElement(g).setErrorHandler(b).setFinallyHandler(c).send();if(j==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(i)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addComposerContent=function(a,b){if(this.boulderFeed&&this.isOnNewsFeedFilter()){CSS.addClass(a,'uiStreamBoulderHighlight');}else CSS.removeClass(a,'uiStreamBoulderStyle');this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var d;var f=Vector2.getScrollPosition().y;var c=Vector2.getElementPosition(this.streamContent).y;var g=this.scrollOnPrepend&&f>=c;if(g){var e=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};d=animation.insert.curry(this.streamContent,a,(function(i,h){this.prependAfterHeader(h);Arbiter.inform('reflow');window.scrollBy(0,h.offsetHeight);DOM.scry(h,'img').forEach(e);}).bind(this));}else d=(function(){CSS.setStyle(a,'opacity',0);this.prependAfterHeader(a);Arbiter.inform('reflow');animation(a).from('opacity',0).to('opacity',1).duration(400).go();}).bind(this);if(b){setTimeout(d,b);}else d();};UIIntentionalStream.prototype.prependAfterHeader=function(c){CSS.addClass(c,'uiStreamFirstStory');var b=this.removeHeader();if(b){DOM.prependContent(this.streamContent,b);DOM.insertAfter(b,c);}else{var a=this.streamContent.firstChild;if(a)CSS.removeClass(a,'uiStreamFirstStory');DOM.prependContent(this.streamContent,c);}};UIIntentionalStream.prototype.removeHeader=function(){var a=ge('stream_movable_header');if(a){if(a.parentNode!=this.streamContent)return null;var b=a.nextSibling;CSS.removeClass(b,'uiStreamFirstStory');DOM.remove(a);CSS.show(a);if(this.collapseHeaderOnMove)CSS.addClass(a,'uiStreamHeaderCollapsed');}return a;};UIIntentionalStream.prototype.setCollapseHeaderOnMove=function(a){this.collapseHeaderOnMove=a;this.updateHeaderCounts(this.headerCounts);};UIIntentionalStream.prototype.updateHeaderCounts=function(a){this.headerCounts=a;var d=a.highlight;var h=a.recent;if(this.collapseHeaderOnMove){if(d>1){var g=DOM.scry(this.streamContent,'#stream_movable_header .uiStreamHeaderText');if(g.length==1){var b={total:d+h,highlight:d};var c=_tx("{total} RECENT STORIES, {highlight} MARKED AS TOP",b);g[0].innerHTML=c;}}}else{if(d){var e=DOM.scry(this.streamContent,'#highlight_header .uiStreamHeaderTextLeft');if(e.length==1){var f;if(d==1){f=_tx("NEW TOP STORY",{count:d});}else if(d<20){f=_tx("TOP STORIES SINCE YOUR LAST VISIT ({count})",{count:d});}else f=_tx("TOP STORIES SINCE YOUR LAST VISIT (20+)");e[0].innerHTML=f;}}if(h){var i=DOM.scry(this.streamContent,'#highlight_header .uiStreamHeaderTextRight');if(i.length==1){var j;if(h==1){j=_tx("{count} MORE RECENT STORY",{count:h});}else if(h<100){j=_tx("{count} MORE RECENT STORIES",{count:h});}else j=_tx("100+ MORE RECENT STORIES");i[0].innerHTML=j;}}}};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(e,h,f,c){c=c||{};var d=f.getPayload();this.filterNullState&&DOM.remove(this.filterNullState);if(is_empty(d))return;if(d.streamHeader&&this.streamHeader){DOM.setContent(this.streamHeader,HTML(d.streamHeader));if(this.isOnNewsFeedFilter())this.setUpStreamHeader();NewHigh.reset();}if(d.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,d.autoRefreshConfig);this.setHomeFilterLoading(false);if(h==UIIntentionalStream.REFRESH_EXPAND){var g=DOM.find($(c.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(g);CSS.removeClass(g,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(e!=this.requestNum)return;if('show_hidden' in c)this.shouldShowHidden=c.show_hidden;if('newestStoryTime' in d&&d.newestStoryTime>this.newest)this.newest=d.newestStoryTime;if('oldestStoryTime' in d&&(!this.oldest||d.oldestStoryTime<this.oldest))this.oldest=d.oldestStoryTime;if('streamStoryCount' in d)this.updateLiveFeedCount(d.streamStoryCount);if(this.boulderFeed&&'conowingoCount' in d){this.updateRecentStoryCount(d.conowingoCount);if('conowingoHTML' in d)this.updateRenderedStories(d.conowingoHTML);if('conowingoNewest' in d)this.setConowingoNewest(d.conowingoNewest);}else if(d.storyCount&&!this.boulderFeed)this.updateLiveFeedCount(d.storyCount,true);if(!d.html){if(h==UIIntentionalStream.REFRESH_BUBBLE)this.shiftPrefetchStories();}else{var a=HTML(d.html).getNodes();switch(h){case UIIntentionalStream.REFRESH_BUBBLE:if(d.replaceCurrentStories){DOM.empty(this.streamContent);this.scrollPosition=d.scrollPosition;this.lastViewStateID=d.lastViewStateID;this.oldest=d.oldest;this.highlightsBlockData={is_highlight:false,highlight_blocks:0,nonhighlight_blocks:1};}this.addContentPrepend(a);this.shiftPrefetchStories();break;case UIIntentionalStream.REFRESH_COUNT:case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(a);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(a);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,a);var b=this.streamContent.firstChild;if(this.shouldRenderCount&&b)CSS.removeClass(b,'uiStreamFirstStory');if(!c.noScroll)DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(c.expandStoryID),a);break;case UIIntentionalStream.DELAYED_STREAM:this.addContentAppend(a);break;}Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.updateLiveFeedCount=function(c,b){var d=(this.unseenStoryCount==0||!b);if(b){this.unseenStoryCount+=c;}else this.unseenStoryCount=c;if(this.unseenStoryCount>0&&this.liveFeedCount){var a='';if(this.unseenStoryCount>this.maxUnseenStoryCount){a=this.maxUnseenStoryCount+'+';}else a=this.unseenStoryCount.toString();DOM.setContent(this.liveFeedCount,HTML(a));if(d)CSS.show(this.liveFeedBubble);}};UIIntentionalStream.prototype.handleError=function(c,f,d,b){if(c!=this.requestNum)return;this.setHomeFilterLoading(false);var a=d.getError();if(a==1357001)AsyncResponse.defaultErrorHandler(d);if(f==UIIntentionalStream.REFRESH_EXPAND){var e=DOM.find($(b.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(e,'UIIntentionalStory_CollapsedStoriesLoading');}if(!b.delayLoadCount&&f!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(b,a){if(b==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (UIIntentionalStream.isHighlightsFilter(a)||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&UIIntentionalStream.isHighlightsFilter(this.defaultFilter)));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||UIIntentionalStream.isHighlightsFilter(a)||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(b,a){if(b!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=a.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.setUpStreamHeader=function(){if(!this.streamHeader)return;this.liveFeedBubble=DOM.scry(this.streamHeader,'span.uiBubbleCount')[0];if(!this.liveFeedBubble)return;this.liveFeedCount=DOM.scry(this.liveFeedBubble,'span.number')[0];if(!this.maxUnseenStoryCount)this.maxUnseenStoryCount=UIIntentionalStream.MAX_UNSEEN_STORY_COUNT;};UIIntentionalStream.prototype.refreshStream=function(e,a){if(e!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&a.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var f=UIIntentionalStream.isHighlightsFilter(c);var b={filter:c};if(f)b.pending=f;var d={filter:c};a.noScroll&&(d.noScroll=1);this.refresh(UIIntentionalStream.REFRESH_TRANSITION,b,d);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,REFRESH_BUBBLE:7,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php',MAX_UNSEEN_STORY_COUNT:300});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:Date.now()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.activeRefreshInterval=setInterval(this.checkActiveRefresh.bind(this),this.checkActiveRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000,CHECK_ACTIVE_REFRESH_TIME:5*60*1000,ACTIVE_REFRESH_TIME:30*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(b,a){if(b==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(a);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=Date.now();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.activeRefresh=coalesce(a.active_refresh,false);this.checkActiveRefreshTimeInterval=coalesce(a.check_active_refresh_interval,UIIntentionalStreamRefresh.CHECK_ACTIVE_REFRESH_TIME);this.activeRefreshTimeInterval=coalesce(a.active_refresh_interval,UIIntentionalStreamRefresh.ACTIVE_REFRESH_TIME);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=Date.now();this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return Date.now()-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return Date.now()-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(b,a){if(b!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(b,c){this.isAutoRefreshing=b;if(b){var a=c?0:this.getRefreshInterval();this.schedulePoll(a);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.checkActiveRefresh=function(){if(!this.allowAutoRefresh)return;if(this.getMSSinceLastRefresh()<this.activeRefreshTimeInterval)return;if(this.getMSSinceLastActivity()<this.activeRefreshTimeInterval)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};
function tz_calculate(f){var a=new Date();var b=a.getTimezoneOffset()/30;var e=a.getTime()/1000;var d=Math.round((f-e)/1800);var c=Math.round(b+d)%48;if(c==0){return 0;}else if(c>24){c-=Math.ceil(c/48)*48;}else if(c<-28)c+=Math.ceil(c/-48)*48;return c*30;}function tz_autoset(d,c){if(!d||undefined==c)return;if(window.tz_autoset.calculated)return;window.tz_autoset.calculated=true;var b=-tz_calculate(d);if(b!=c){var a='/ajax/autoset_timezone_ajax.php';new AsyncRequest().setURI(a).setData({gmt_off:b}).setErrorHandler(bagofholding).setTransportErrorHandler(bagofholding).setOption('suppressErrorAlerts',true).send();}}
function ufi_add_ft_hidden_node(c){if(c.link_data)return;var a=collect_data_attrib(c,'ft');if(count(a)){var b=$N('input',{type:'hidden',name:'link_data',value:JSON.stringify(a)});c.appendChild(b);}}function ufi_add_all_link_data(){Bootloader.loadComponents('dom-collect',function(){DOM.scry(document.body,'form.commentable_item').forEach(ufi_add_ft_hidden_node);});}
onloadRegister(function(){Selector.subscribe('close',function(a,b){if(CSS.hasClass(b.selector,'commentHideSelector')){var c=Selector.getValue(b.selector);c&&Selector.setSelected.curry(b.selector,c,false).defer();}});});
onloadRegister(function(){add_properties('__behaviors',{});if(__behaviors.Scrollable)return;__behaviors.Scrollable=true;var c='scrollable';var b=function(event){var j=Parent.byClass(event.getTarget(),c);if(!j)return;if((typeof event.axis!=='undefined'&&event.axis===event.HORIZONTAL_AXIS)||(event.wheelDeltaX&&!event.wheelDeltaY)){event.prevent();return;}var e=event.wheelDelta?event.wheelDelta:-event.detail;var h=j.scrollHeight;var d=j.clientHeight;if(h>d){var i=j.scrollTop;if((e>0&&i===0)||(e<0&&i>=h-d)){event.prevent();}else if(ua.ie()<9){var g=CSS.getStyle(j,'font-size');if(g.indexOf('px')<0){var f=$N('div');f.style.fontSize=g;f.style.height='1em';g=f.style.pixelHeight;}else g=parseInt(g,10);j.scrollTop=i-Math.round(e/120*g);event.prevent();}}};var a=document.documentElement;if(ua.firefox()){a.addEventListener('DOMMouseScroll',b,false);}else Event.listen(a,'mousewheel',b);});
function MentionsInput(a){DataStore.set(a,'MentionsInput',this);this._root=a;}MentionsInput.getInstance=function(a){var b=Parent.byClass(a,'uiMentionsInput');return b?DataStore.get(b,'MentionsInput'):null;};(function(){var a='@\\uff20';var e='.,+*?$|#{}()\\^\\-\\[\\]\\\\\/!%&\'"~=<>_:;';var f=e+'@';var d='\\b[A-Z][^ A-Z'+e+']';var g='([^'+a+f+']|['+e+'][^ '+e+'])';var c='(?:^|\\s)(?:['+a+']('+g+'{0,20}))';var b='(?:(?:'+d+'+)|'+c+')';var h='(?:'+d+'{4,})';MentionsInput.prototype={_matcher:new RegExp(c+'$'),_autoMatcher:new RegExp(b+'$'),_userMatcher:new RegExp(h+'$')};})();Class.mixin(MentionsInput,'Arbiter',{init:function(a,b){this.init=bagofholding;this._initialized=true;this._typeahead=Typeahead.getInstance(DOM.find(this._root,'.mentionsTypeahead'));this._highlighter=DOM.find(this._root,'.highlighter');this._highlighterInner=this._highlighter.firstChild;this._highlighterContent=DOM.find(this._root,'.highlighterContent');this._hiddenInput=DOM.find(this._root,'.mentionsHidden');this._input=this._typeahead.getCore().getElement();this._placeholder=this._input.getAttribute('placeholder')||'';this._maxMentions=a.max||6;if(ua.firefox()<4){this._input.blur();setTimeout(function(){this._input.focus();}.bind(this));}if(!this._hiddenInput.name){var c=this._input.name;this._input.name=c+'_text';this._hiddenInput.name=c;}this._initEvents();this._initTypeahead();this.reset(b);this.inform('init',null,Arbiter.BEHAVIOR_STATE);},reset:function(b){if(!this._initialized)return;this._mentioned={};this._orderedUIDs=[];this._numMentioned=0;this._filterData=null;this._hiddenInput&&(this._hiddenInput.value='');this._highlighterContent&&DOM.empty(this._highlighterContent);this._highlighterAuxContent&&DOM.remove(this._highlighterAuxContent);this._highlighterAuxContent=null;Input.setPlaceholder(this._input,this._placeholder);CSS.setStyle(this._typeahead.getElement(),'height','auto');if(b){Input.setValue(this._input,b.flattened);for(var a in b.mention_data)this._addToken({uid:a,text:b.mention_data[a],type:'unknown'});}this._updateTypeahead();this._updateWidth();this._update();},getRawValue:function(){return Input.getValue(this._hiddenInput);},getTypeahead:function(){return this._typeahead;},_initEvents:function(){var a=this._update.bind(this);Event.listen(this._input,{input:a,keyup:a,change:a,focus:this._updateWidth.bind(this)});},_initTypeahead:function(){this._typeahead.subscribe('select',function(e,f){var g=f.selected;this._addToken({uid:g.uid,text:g.text,type:g.type});this.updateValue();}.bind(this));var b=this._input;var d=null;var a=function(){if(d===null){d=Input.getSubmitOnEnter(b);Input.setSubmitOnEnter(b,false);}};var c=function(){if(d!==null){Input.setSubmitOnEnter(b,d);d=null;}};this._typeahead.subscribe('render',a);this._typeahead.subscribe('reset',c);this._typeahead.subscribe('highlight',function(e,f){f.index>=0?a():c();});this._typeahead.subscribe('query',function(){this._filterData=null;}.bind(this));this._typeahead.getCore().suffix='';this._typeahead.getData().setFilter(this._filterResults.bind(this));},_filterResults:function(d){if(this._filterData===null){var a=Input.getSelection(this._input).start||0;for(var c=0;c<this._offsets.length;c++){var e=this._offsets[c];if(a>e[0]&&a<=e[1]){this._filterData={caretIsInsideMention:true};return false;}}var b=this._typeahead.getCore();this._filterData={value:b.getValue(),rawValue:b.getRawValue()};}if(this._filterData.caretIsInsideMention)return false;if(this._matcher.test(this._filterData.rawValue))return true;if(d.type!='user')return false;if(this._userMatcher.test(this._filterData.value))return true;return TypeaheadUtil.isExactMatch(this._filterData.value,this._typeahead.getData().getTextToIndex(d));},_addToken:function(a){var b=a.uid;if(!this._mentioned.hasOwnProperty(b)){this._mentioned[b]=a;this._orderedUIDs.push(b);this._numMentioned++;this._updateTypeahead();}},_removeToken:function(a){if(this._mentioned.hasOwnProperty(a)){delete this._mentioned[a];this._orderedUIDs.remove(a);this._numMentioned--;this._updateTypeahead();}},_reduceToken:function(f,d){var e=d.split(' ');var b=[];for(var a=0;a<e.length;a++)if(f.indexOf(e[a])!=-1)b.push(e[a]);e=b;for(a=1;a<e.length;a++)for(var c=1;c<e[a-1].length+1;c++)if(f.indexOf(e[a-1].substr(0,c)+e[a])!=-1)e.splice(a-1,1);while(f.indexOf(e.join(' '))==-1)e.splice(0,1);return e.join(' ');},_update:function(){var a=Input.getValue(this._input);if(a==this._value)return;this._value=a;this._updateTokens();this.updateValue();},_updateTokens:function(){var f=Input.getValue(this._input);for(var a=0;a<this._orderedUIDs.length;++a){var e=this._orderedUIDs[a];var b=this._mentioned[e];var d=b.text;var c;if(b.type=='user'&&(c=this._reduceToken(f,d))!==''){b.text=c;}else if(!d||f.indexOf(d)==-1||typeof d!=='string')this._removeToken(e);}},updateValue:function(){var g=Input.getValue(this._input);var f=this._orderedUIDs;var c=[];var a,d,e,b;for(b=0;b<f.length;++b){d=this._mentioned[f[b]].text;g=g.replace(d,function(h,i){c.push([i,i+d.length]);return d;});}for(b=0;b<f.length;++b){e=f[b];d=this._mentioned[e].text;g=g.replace(d,'@['+e+':]');}a=htmlize(g);for(b=0;b<f.length;++b){e=f[b];d=this._mentioned[e].text;a=a.replace('@['+e+':]','<b>'+htmlize(d)+'</b>');d=d.replace(/[\\\]:]/g,function(h){return '\\'+h;});g=g.replace('@['+e+':]','@['+e+':'+d+']');}if(ua.ie())a=a.replace(/ {2}/g,'&nbsp; ');this._offsets=c;this._hiddenInput.value=g;DOM.setContent(this._highlighterContent,HTML(a));this._updateHeight();},_updateWidth:function(){var a=CSS.getStyleFloat.curry(this._input);var b=this._input.offsetWidth-a('paddingLeft')-a('paddingRight')-a('borderLeftWidth')-a('borderRightWidth');if(ua.firefox())b-=2;if(ua.ie()<=7){b-=CSS.getStyleFloat(this._highlighterInner,'paddingLeft');this._highlighter.style.zoom=1;}this._highlighterInner.style.width=Math.max(b,0)+'px';},_updateHeight:function(){if(this._highlighterAuxContent){var a=this._highlighter.offsetHeight;var b=this._typeahead.getElement();if(a>b.offsetHeight){CSS.setStyle(b,'height',a+'px');Arbiter.inform('reflow');}}},_updateTypeahead:function(){var a=this._typeahead.getCore();var b=null;if(!this._maxMentions||this._numMentioned<this._maxMentions)b=this._autoMatcher;a.matcher=b;a.setExclusions(this._orderedUIDs);this.inform('update',{mentioned:this._mentioned});},setAuxContent:function(a){if(this._highlighterContent){if(!this._highlighterAuxContent){this._highlighterAuxContent=$N('span',{className:'highlighterAuxContent'});DOM.insertAfter(this._highlighterContent,this._highlighterAuxContent);}DOM.setContent(this._highlighterAuxContent,a);if(a){Input.setPlaceholder(this._input,'');}else Input.setPlaceholder(this._input,this._placeholder);this._updateHeight();}},getAuxContentRoot:function(){return this._highlighterAuxContent;},addMention:function(a){var b=Input.getValue(this._input);Input.setValue(this._input,b+" "+a.text);this._addToken(a);this._update();},getMentions:function(){return this._mentioned;}});
function MultiBootstrapDataSource(a){this._bootstrapEndpoints=a.bootstrapEndpoints;this.parent.construct(this,a);}Class.extend(MultiBootstrapDataSource,'DataSource');MultiBootstrapDataSource.prototype={bootstrapWithoutToken:function(){for(var a=0;a<this._bootstrapEndpoints.length;a++)this.fetch(this._bootstrapEndpoints[a].endpoint,this._bootstrapEndpoints[a].data||{},this._bootstrapEndpoints[a].token);},bootstrapWithToken:function(){for(var b=0;b<this._bootstrapEndpoints.length;b++){var a=copy_properties({},this._bootstrapEndpoints[b].data||{});a.token=this._bootstrapEndpoints[b].token;this.fetch(this._bootstrapEndpoints[b].endpoint,a,{replaceCache:true});}}};
function TypeaheadAreaCore(a){this.parent.construct(this,a);this.matcher=new RegExp(this.matcher+'$');this.preventFocusChangeOnTab=true;}Class.extend(TypeaheadAreaCore,'TypeaheadCore');TypeaheadAreaCore.prototype={prefix:'',suffix:', ',matcher:"\\b[^,]*",click:bagofholding,select:function(a){this.parent.select(a);var e=this.element.value;var d=this.prefix+a.text+this.suffix;this.expandBounds(e,d);var b=e.substring(0,this.start);var c=e.substring(this.end);this.element.value=b+d+c;Input.setSelection(this.element,b.length+d.length);},expandBounds:function(g,f){g=g.toLowerCase().trim();f=f.toLowerCase();var b,e,c,d;var a=/\s/;e=g.substring(this.start,this.end);c=f.indexOf(e);b=this.start;while(b>=0&&c>=0){d=g.charAt(b-1);if(!d||a.test(d))this.start=b;e=d+e;c=f.indexOf(e);b--;}e=g.substring(this.start,this.end);c=f.indexOf(e);b=this.end;while(b<=g.length&&c>=0){d=g.charAt(b);if(!d||a.test(d))this.end=b;e=e+d;c=f.indexOf(e);b++;}},getRawValue:function(){var a=Input.getSelection(this.element).start||0;return this.parent.getValue().substring(0,a);},getValue:function(){var a=this.matcher&&this.matcher.exec(this.getRawValue());if(!a)return '';var e=a[0];var d=a.index+e.length;e=e.replace(/^\s/,'');var b=e.length;e=e.replace(/\s$/,'');var c=b-e.length;this.start=d-b;this.end=d+c;return a[1]||a[0];}};
add_properties('TypeaheadBehaviors',{hoistFriends:function(a){var b=a.getView();b.subscribe('beforeRender',function(c,f){var g=[];var d=[];for(var e=0;e<f.results.length;++e){var h=f.results[e];if(h.type=='user'&&h.bootstrapped){d.push(h);}else g.push(h);}f.results=d.concat(g);});}});
add_properties('TypeaheadBehaviors',{showLoadingIndicator:function(a){a.subscribe('activity',function(b,c){CSS.conditionClass(a.getElement(),'typeaheadLoading',c.activity);});}});
add_properties('TypeaheadRenderers',{basic:function(a,b){var c=[];if(a.icon)c.push($N('img',{alt:'',src:a.icon}));if(a.text)c.push($N('span',{className:'text'},[a.text]));if(a.subtext)c.push($N('span',{className:'subtext'},[a.subtext]));return $N('li',{className:a.type||''},c);}});
add_properties('TypeaheadRenderers',{compact:function(c,d){var e=[];var f=c.photo;if(f){if(f instanceof Array){var g=[$N('span',{className:'splitpic leftpic'},[$N('img',{alt:'',src:f[0]})]),$N('span',{className:'splitpic'+(f[2]?' toppic':'')},[$N('img',{alt:'',src:f[1]})])];if(f[2])g.push($N('span',{className:'splitpic bottompic'},[$N('img',{alt:'',src:f[2]})]));f=$N('span',{className:'splitpics clearfix'},g);}else f=$N('img',{alt:'',src:f});e.push(f);}if(c.text)e.push($N('span',{className:'text'},[c.text]));var h=c.subtext;var a=c.category;if(h||a){var b=[];h&&b.push(h);h&&a&&b.push(" \u00b7 ");a&&b.push(a);e.push($N('span',{className:'subtext'},b));}return $N('li',{className:c.type||''},e);}});
add_properties('TypeaheadRenderers',{search:function(c,e){var g=[];if(c.photo){g.push($N('img',{className:'photo',alt:'',src:c.photo}));if(c.song){g.push($N('span',{className:'playButton'}));g.push($N('span',{className:'playLoader'}));}}if(c.text)g.push($N('span',{className:'text'},[c.text]));if(c.category){var a=[c.category];if(c.is_external)a.push($N('span',{className:'arrow'}));g.push($N('span',{className:'category'},a));}if(c.subtext)g.push($N('span',{className:'subtext'},[c.subtext]));var b=c.classNames||c.type||'';var h=c.is_external?'_blank':'';var d=!c.song&&c.path||'';if(d){if(!(/^https?\:\/\//).test(d))d=Env.www_base+d.substr(1);d+=(d.indexOf('?')>0?'&':'?')+'ref=ts';}var f=$N('a',{href:d,rel:'ignore',target:h},g);if(c.song){f.id='mb_'+(Math.random()*1e+06|0);MusicButtonManager.addButton.curry(c.song.provider,f.id,c.song.url,c.song.context,c.song.media_type).defer();f.onclick=this.ignoreClick;}return $N('li',{className:b},[f]);}});
WidgetArbiter={_findSiblings:function(){if(WidgetArbiter._siblings)return;WidgetArbiter._siblings=[];for(var b=parent.frames.length-1;b>=0;b--)try{if(parent.frames[b]&&parent.frames[b].Arbiter&&parent.frames[b].Arbiter.inform)WidgetArbiter._siblings.push(parent.frames[b].Arbiter);}catch(a){}},inform:function(){WidgetArbiter._findSiblings();var a=$A(arguments);WidgetArbiter._siblings.each(function(b){b.inform.apply(b,a);});}};
var PlatformOptInPopup=function(){};copy_properties(PlatformOptInPopup,{DIALOG_URL:'/connect/uiserver.php',DIALOG_WIDTH:420,DIALOG_HEIGHT:450,APP_ID:127760087237610,open:function(d,c,a){if(!d)d='generic';if(!c)c='opt.in';var b=new URI(PlatformOptInPopup.DIALOG_URL);b.addQueryData({social_plugin:d,method:c,display:'popup',secure:URI.getRequestURI().isSecure(),app_id:PlatformOptInPopup.APP_ID});if(a)b.addQueryData(a);return PopupResizer.open(b.toString(),PlatformOptInPopup.DIALOG_WIDTH,PlatformOptInPopup.DIALOG_HEIGHT);}});